<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeFreebies</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- åŸæœ¬è¿™é‡Œæœ‰â€œé¡µé¢åŠ è½½æ—¶æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜â€çš„è„šæœ¬
         å·²ç§»é™¤ï¼Œæ”¹ä¸ºä»…åœ¨ç”¨æˆ·ä¸»åŠ¨é€€å‡ºç™»å½•æ—¶æ¸…é™¤æœ¬åœ°æ•°æ® -->

    <!-- Firebase SDK - å¤šé‡åŠ è½½ç­–ç•¥ -->
    <script>
        // Firebase SDK åŠ è½½ç®¡ç†å™¨
        (function () {
            let loadAttempt = 0;
            const maxAttempts = 4;

            // å®šä¹‰å¤šä¸ª CDN æº
            const cdnSources = [
                {
                    name: 'Google Official CDN',
                    app: 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js',
                    database: 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js'
                },
                {
                    name: 'jsDelivr CDN',
                    app: 'https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-app-compat.js',
                    database: 'https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-database-compat.js'
                },
                {
                    name: 'unpkg CDN',
                    app: 'https://unpkg.com/firebase@9.23.0/firebase-app-compat.js',
                    database: 'https://unpkg.com/firebase@9.23.0/firebase-database-compat.js'
                },
                {
                    name: 'CloudFlare CDN',
                    app: 'https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js',
                    database: 'https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js'
                }
            ];

            function loadFirebaseSDK(sourceIndex = 0) {
                if (sourceIndex >= cdnSources.length) {
                    console.error('âŒ æ‰€æœ‰ Firebase CDN æºå‡åŠ è½½å¤±è´¥');
                    console.log('ğŸ’¡ åº”ç”¨å°†ä»¥æœ¬åœ°æ¨¡å¼è¿è¡Œ');
                    window.firebaseLoadFailed = true;
                    return;
                }

                const source = cdnSources[sourceIndex];
                console.log(`ğŸ”„ [${sourceIndex + 1}/${cdnSources.length}] å°è¯•ä» ${source.name} åŠ è½½ Firebase SDK...`);

                // åˆ›å»º app script
                const appScript = document.createElement('script');
                appScript.src = source.app;
                appScript.crossOrigin = 'anonymous';

                // åˆ›å»º database script
                const dbScript = document.createElement('script');
                dbScript.src = source.database;
                dbScript.crossOrigin = 'anonymous';

                let appLoaded = false;
                let dbLoaded = false;

                // è¶…æ—¶å¤„ç†
                const timeout = setTimeout(() => {
                    if (!appLoaded || !dbLoaded) {
                        console.warn(`â±ï¸ ${source.name} åŠ è½½è¶…æ—¶ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæº...`);
                        loadFirebaseSDK(sourceIndex + 1);
                    }
                }, 10000); // 10ç§’è¶…æ—¶

                appScript.onload = function () {
                    appLoaded = true;
                    console.log(`âœ… Firebase App å·²ä» ${source.name} åŠ è½½`);

                    // åŠ è½½ database script
                    dbScript.onload = function () {
                        dbLoaded = true;
                        console.log(`âœ… Firebase Database å·²ä» ${source.name} åŠ è½½`);
                        clearTimeout(timeout);

                        // éªŒè¯ Firebase å¯¹è±¡
                        setTimeout(() => {
                            if (typeof firebase !== 'undefined') {
                                console.log('âœ…âœ… Firebase SDK å®Œå…¨åŠ è½½æˆåŠŸï¼');
                                console.log('ğŸ“¦ Firebase ç‰ˆæœ¬:', firebase.SDK_VERSION || 'unknown');
                                window.firebaseLoadSuccess = true;
                            } else {
                                console.error('âŒ Firebase å¯¹è±¡æœªå®šä¹‰ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæº...');
                                loadFirebaseSDK(sourceIndex + 1);
                            }
                        }, 500);
                    };

                    dbScript.onerror = function () {
                        console.error(`âŒ Firebase Database ä» ${source.name} åŠ è½½å¤±è´¥`);
                        clearTimeout(timeout);
                        loadFirebaseSDK(sourceIndex + 1);
                    };

                    document.head.appendChild(dbScript);
                };

                appScript.onerror = function () {
                    console.error(`âŒ Firebase App ä» ${source.name} åŠ è½½å¤±è´¥`);
                    clearTimeout(timeout);
                    loadFirebaseSDK(sourceIndex + 1);
                };

                document.head.appendChild(appScript);
            }

            // å¼€å§‹åŠ è½½
            loadFirebaseSDK(0);
        })();
        // çª—å£å¤§å°æ”¹å˜æ—¶å¤„ç†
        window.addEventListener('resize', function () {
            // ç§»åŠ¨ç«¯å¯¼èˆªæ”¹ä¸ºé»˜è®¤å±•ç¤ºï¼Œæ— éœ€åœ¨ resize æ—¶åŠ¨æ€åˆ›å»º/åˆ é™¤
        });
    </script>

    <!-- é¦–æ¬¡è¿›å…¥é¡µé¢æ—¶æ¸…ç©ºæœ¬åœ°æ•°æ®ï¼ˆä»…å½“å‰æµè§ˆå™¨ä¼šè¯æ‰§è¡Œä¸€æ¬¡ï¼Œé¿å…åˆ·æ–°åé‡å¤æ¸…ç©ºå¯¼è‡´é‡æ–°ç™»å½•ï¼‰ -->
    <script>
        (function () {
            try {
                const FLAG_KEY = 'initialClearDone';

                // ä½¿ç”¨ sessionStorage ä½œä¸ºâ€œæœ¬ä¼šè¯å·²æ¸…ç†â€çš„æ ‡è®°
                if (!sessionStorage.getItem(FLAG_KEY)) {
                    console.log('ğŸ§¹ é¦–æ¬¡è¿›å…¥é¡µé¢ï¼Œå¼€å§‹æ¸…ç©ºæœ¬åœ°æ‰€æœ‰æ•°æ®ï¼ˆlocalStorage / IndexedDB / Cacheï¼‰...');

                    // 1. æ¸…ç©º localStorage
                    try {
                        localStorage.clear();
                        console.log('âœ… localStorage å·²æ¸…ç©º');
                    } catch (e) {
                        console.warn('æ¸…ç©º localStorage æ—¶å‡ºé”™:', e);
                    }

                    // 2. å°è¯•æ¸…ç©º IndexedDB
                    try {
                        if ('indexedDB' in window && indexedDB.databases) {
                            indexedDB.databases().then(databases => {
                                databases.forEach(db => {
                                    if (db.name) {
                                        indexedDB.deleteDatabase(db.name);
                                        console.log(`âœ… å·²æ¸…é™¤ IndexedDB: ${db.name}`);
                                    }
                                });
                            }).catch(e => {
                                console.warn('æ¸…é™¤ IndexedDB æ—¶å‡ºé”™:', e);
                            });
                        }
                    } catch (e) {
                        console.warn('è®¿é—® IndexedDB æ—¶å‡ºé”™:', e);
                    }

                    // 3. å°è¯•æ¸…ç©º Service Worker ç¼“å­˜
                    try {
                        if ('caches' in window) {
                            caches.keys().then(names => {
                                names.forEach(name => {
                                    caches.delete(name);
                                    console.log(`âœ… å·²æ¸…é™¤ Service Worker ç¼“å­˜: ${name}`);
                                });
                            }).catch(e => {
                                console.warn('æ¸…é™¤ Service Worker ç¼“å­˜æ—¶å‡ºé”™:', e);
                            });
                        }
                    } catch (e) {
                        console.warn('è®¿é—® Service Worker ç¼“å­˜æ—¶å‡ºé”™:', e);
                    }

                    // é‡è¦ï¼šä¸æ¸…ç©º sessionStorageï¼Œä»¥ä¾¿æœ¬æ¬¡ä¼šè¯åç»­åˆ·æ–°ä¸å†é‡å¤æ¸…ç†
                    sessionStorage.setItem(FLAG_KEY, '1');
                    console.log('âœ… åˆæ¬¡è¿›å…¥é¡µé¢çš„æœ¬åœ°æ•°æ®æ¸…ç†å·²å®Œæˆï¼Œæœ¬ä¼šè¯åç»­ä¸å†é‡å¤æ‰§è¡Œ');
                } else {
                    console.log('â„¹ï¸ æœ¬æµè§ˆå™¨ä¼šè¯å·²å®Œæˆè¿‡åˆå§‹æ¸…ç†ï¼Œä¸å†é‡å¤æ¸…ç©ºæœ¬åœ°æ•°æ®');
                }
            } catch (e) {
                console.warn('åˆå§‹åŒ–æœ¬åœ°æ•°æ®æ¸…ç†é€»è¾‘æ—¶å‡ºé”™:', e);
            }
        })();
    </script>

    <style>
        :root {
            /* å¾®è½¯é£æ ¼é…è‰²ç³»ç»Ÿ */
            --primary: #0078d4;
            --primary-hover: #106ebe;
            --primary-light: #deecf9;
            --primary-soft: rgba(0, 120, 212, 0.1);
            --secondary: #107c10;
            --secondary-soft: rgba(16, 124, 16, 0.1);
            --danger: #d13438;
            --warning: #ffaa44;
            --dark: #323130;
            --dark-soft: rgba(50, 49, 48, 0.06);
            --light: #faf9f8;
            --gray: #605e5c;
            --gray-light: #8a8886;
            --border-subtle: rgba(0, 0, 0, 0.1);
            --shadow-soft: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.12);
            --radius-lg: 4px;
            --radius-md: 4px;
            --radius-sm: 2px;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'PingFang SC',
                'Microsoft Yahei', sans-serif;
        }

        body {
            background: #ffffff;
            color: var(--dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        /* é¡µé¢åŠ è½½é®ç½© */
        #page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        #page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* äº§å“è¯„ä»·å¡ç‰‡ */
        .review-item {
            position: relative;
        }

        .review-admin-actions {
            position: absolute;
            top: 12px;
            right: 16px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .review-item:hover .review-admin-actions {
            opacity: 1;
        }

        .review-admin-actions .btn-icon {
            border: none;
            background: transparent;
            color: #999;
            cursor: pointer;
            padding: 4px;
        }

        .review-admin-actions .btn-icon:hover {
            color: #d9534f;
        }

        /* å•æ¡ç”¨æˆ·å›å¤ï¼ˆå°è¯„è®ºï¼‰ç®¡ç†å‘˜æ“ä½œæŒ‰é’® */
        .customer-reply-item {
            position: relative;
        }

        .customer-reply-admin-actions {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .customer-reply-item:hover .customer-reply-admin-actions {
            opacity: 1;
        }
        
        .loader-text {
            font-size: 18px;
            color: #666;
            font-weight: 500;
        }
        
        .loader-progress {
            margin-top: 15px;
            font-size: 14px;
            color: #999;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* é¡µé¢å†…å®¹åˆå§‹éšè— */
        body.loading .container,
        body.loading nav {
            opacity: 0;
            pointer-events: none;
        }

        .container {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 24px 80px;
        }

        /* å¯¼èˆªæ æ ·å¼ - å¾®è½¯é£æ ¼ */
        .navbar {
            background: #ffffff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        /* åº•éƒ¨å¯¼èˆªï¼ˆç§»åŠ¨ç«¯ï¼‰ - æµ®èµ·å¼åœ†è§’æ¡å½¢å¯¼èˆª */
        .bottom-nav {
            display: none;
        }

        .bottom-nav-item {
            flex: 1;
            height: 100%;
            border: none;
            background: none;
            font-size: 13px;
            color: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: color var(--transition-fast), transform var(--transition-fast);
        }

        .bottom-nav-item span {
            pointer-events: none;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            gap: 24px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.04em;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            min-height: 60px;
            min-width: 180px;
            margin-left: 8px;
        }
        
        .logo img {
            height: 52px;
            max-width: 260px;
            width: auto;
            object-fit: contain;
            display: block;
        }

        .nav-links {
            display: flex;
            list-style: none;
            padding: 0;
            border-radius: 0;
            background: transparent;
            border: none;
            gap: 0;
        }

        .nav-links li {
            margin-left: 0;
            display: flex;
            align-items: center;
        }

        .nav-links a {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            border-radius: 0;
            text-decoration: none;
            color: var(--gray);
            font-weight: 400;
            font-size: 15px;
            line-height: 1.4;
            min-height: 48px;
            transition: color var(--transition-fast), background-color var(--transition-fast);
        }

        .nav-links a:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .nav-links a.active {
            color: var(--primary);
            background: transparent;
            border-bottom: 2px solid var(--primary);
        }

        .search-bar {
            display: flex;
            width: 42%;
            max-width: 520px;
            border-radius: 2px;
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.2);
            overflow: hidden;
            box-shadow: none;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .search-bar:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary);
        }

        /* ç”µè¯è¾“å…¥æ ·å¼ï¼ˆå¸¦+1å‰ç¼€ï¼‰ */
        .phone-input-wrapper {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            background: #fff;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .phone-input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary);
        }

        .phone-prefix {
            padding: 10px 12px;
            background: #f3f2f1;
            border-right: 1px solid #ddd;
            font-weight: 600;
            color: var(--dark);
            letter-spacing: 0.05em;
        }

        .phone-input-wrapper .phone-input {
            border: none;
            flex: 1;
            padding: 10px 12px;
            font-size: 14px;
            outline: none;
        }

        .phone-input-wrapper.error {
            border-color: #d32f2f;
            box-shadow: 0 0 0 1px rgba(211, 47, 47, 0.3);
        }

        .phone-input-hint {
            font-size: 12px;
            color: #6b6a69;
            margin-top: 6px;
        }

        .admin-pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }

        .admin-pagination .pagination-actions {
            display: flex;
            gap: 8px;
        }

        .admin-pagination button {
            padding: 6px 14px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #4b5563;
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast);
        }

        .admin-pagination button:hover:not(:disabled) {
            background: var(--primary-light);
            color: var(--primary);
        }

        .admin-pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .admin-pagination .pagination-info {
            font-size: 13px;
            color: #6b7280;
        }

        .search-bar input {
            flex: 1;
            padding: 10px 16px;
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            color: var(--dark);
        }

        .search-bar input::placeholder {
            color: #9ca3af;
        }

        .search-bar button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 400;
            transition: background var(--transition-fast);
        }

        .search-bar button:hover {
            background: var(--primary-hover);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-actions a {
            margin-left: 0;
            color: var(--dark);
            text-decoration: none;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 2px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            background: #ffffff;
            transition: background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast);
        }

        .user-actions a:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .user-actions i {
            font-size: 18px;
        }

        /* è½®æ’­å›¾æ ·å¼ */
        .carousel {
            position: relative;
            width: 100%;
            aspect-ratio: 21 / 9;
            overflow: hidden;
            border-radius: var(--radius-lg);
            margin: 32px 0 48px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease;
            background-size: cover;
            background-position: center;
        }

        .carousel-slide.active {
            opacity: 1;
        }

        .carousel-content {
            display: none; /* éšè—è½®æ’­å›¾ä¸­çš„æ–‡å­—å’ŒæŒ‰é’® */
        }

        .carousel-content h2 {
            margin-bottom: 10px;
            font-size: 28px;
        }

        .carousel-content p {
            margin-bottom: 15px;
        }

        .carousel-btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 2px;
            text-decoration: none;
            font-weight: 400;
            transition: background var(--transition-fast);
        }

        .carousel-btn:hover {
            background: var(--primary-hover);
        }

        .carousel-indicators {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
        }

        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            margin: 0 5px;
            cursor: pointer;
        }

        .indicator.active {
            background: white;
        }

        /* è½®æ’­å›¾å·¦å³åˆ‡æ¢æŒ‰é’® */
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.65);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 3;
            transition: background 0.2s ease, opacity 0.2s ease, transform 0.2s ease;
            user-select: none;
            opacity: 1; /* å§‹ç»ˆå¯è§ */
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
            font-size: 24px;
            line-height: 1;
        }

        .carousel-arrow:hover {
            background: rgba(0, 0, 0, 0.85);
            opacity: 1;
            transform: translateY(-50%) scale(1.08);
        }

        .carousel-arrow.prev {
            left: 16px;
        }

        .carousel-arrow.next {
            right: 16px;
        }

        /* äº§å“ç½‘æ ¼æ ·å¼ */
        .section-title {
            margin: 64px 0 32px;
            font-size: 36px;
            color: var(--dark);
            border-left: 4px solid var(--primary);
            padding-left: 20px;
            font-weight: 300;
            line-height: 1.2;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 80px;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
        }


        .product-card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            transition: box-shadow var(--transition-normal), transform var(--transition-normal);
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.16), 0 2px 4px rgba(0, 0, 0, 0.23);
            transform: translateY(-2px);
        }

        .product-image {
            aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢æ¯”ä¾‹ */
            width: 100%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #faf9f8;
            position: relative;
            padding: 24px;
        }

        .product-info {
            padding: 20px 24px 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* é¦–é¡µç²¾é€‰åŒºåŸŸå•ç‹¬æ§åˆ¶å¡ç‰‡å°ºå¯¸ */
        #featured-showcase #products-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 28px;
            max-width: 1350px;
        }

        #featured-showcase .product-card {
            max-width: 300px;
            min-height: 460px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        #featured-showcase .product-image {
            aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢æ¯”ä¾‹ */
            width: 100%;
        }

        #featured-showcase .product-info {
            padding: 18px;
            display: flex;
            flex-direction: column;
            flex: 1;
            justify-content: space-between;
        }

        .product-title {
            font-size: 16px;
            font-weight: 400;
            margin-bottom: 12px;
            color: var(--dark);
            line-height: 1.5;
            min-height: 48px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-price {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 16px;
            margin-top: auto;
        }

        .product-actions {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 6px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 400;
            letter-spacing: 0;
            transition: background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast);
            font-size: 14px;
            flex: 1;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 40px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: none;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: #0e6b0e;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: none;
        }

        .btn-danger:hover {
            background: #a4262c;
        }

        /* é¦–é¡µç²¾é€‰å±•ç¤º */
        .featured-showcase {
            margin-top: 48px;
            background: #ffffff;
            border-radius: var(--radius-lg);
            padding: 48px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .featured-head {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
            margin-bottom: 32px;
        }

        .featured-head h2 {
            margin: 0;
            font-size: 36px;
            color: var(--dark);
            font-weight: 300;
            line-height: 1.2;
        }

        .featured-head p {
            margin: 12px 0 0;
            color: var(--gray);
            max-width: 600px;
            font-size: 16px;
            line-height: 1.6;
        }

        .featured-meta {
            font-size: 13px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .featured-meta i {
            color: var(--primary);
        }

        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 32px 0 24px;
        }

        .category-item {
            padding: 10px 20px;
            border-radius: 2px;
            background: #ffffff;
            color: var(--gray);
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid rgba(0, 0, 0, 0.15);
            font-weight: 400;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .category-item:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .category-item.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 120, 212, 0.2);
        }

        #products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 28px;
        }

        .home-feature-card {
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            border: 1px solid rgba(15, 23, 42, 0.05);
        }

        .home-feature-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.12);
        }

        .home-feature-image {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢æ¯”ä¾‹ */
            overflow: hidden;
        }

        .home-feature-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .home-feature-tag {
            position: absolute;
            top: 14px;
            left: 14px;
            padding: 4px 12px;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.65);
            color: #fff;
            font-size: 12px;
        }

        .home-feature-body {
            padding: 22px 24px 26px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: calc(100% - 220px);
        }

        .home-feature-body h3 {
            margin: 0;
            font-size: 20px;
            color: var(--dark);
        }

        .home-feature-price {
            font-size: 26px;
            color: #ef4444;
            margin: 6px 0;
        }

        .home-feature-stock {
            font-size: 14px;
            color: #9ca3af;
        }

        .home-feature-actions {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            margin-top: auto;
        }


        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 2px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-subtle);
        }

        .modal-header {
            padding: 20px 24px;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-weight: 400;
            font-size: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* WhatsAppæ¨¡æ€æ¡†æ ·å¼ */
        .whatsapp-modal-content {
            max-width: 450px;
            text-align: center;
        }
        
        .whatsapp-modal-body {
            padding: 40px 30px;
        }
        
        .whatsapp-message {
            margin-bottom: 30px;
        }
        
        .whatsapp-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
            line-height: 1.5;
        }
        
        .whatsapp-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            margin-top: 20px;
        }
        
        .click-here-text {
            font-size: 16px;
            color: #25D366;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        .arrow-container {
            display: flex;
            align-items: center;
        }
        
        .arrow {
            font-size: 32px;
            color: #25D366;
            animation: arrowBounce 1.5s infinite;
            font-weight: bold;
        }
        
        .whatsapp-icon-link {
            display: inline-block;
            text-decoration: none;
            transition: transform 0.3s ease;
        }
        
        .whatsapp-icon-link:hover {
            transform: scale(1.1);
        }
        
        .whatsapp-icon {
            font-size: 64px;
            color: #25D366;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
        }
        
        .whatsapp-icon:hover {
            transform: scale(1.15);
            filter: drop-shadow(0 4px 8px rgba(37, 211, 102, 0.4));
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
        
        @keyframes arrowBounce {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(10px);
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 2px;
            font-size: 15px;
            background: #ffffff;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            min-height: 40px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary);
        }

        .form-control::placeholder {
            color: var(--gray-light);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }

        #signup-cancel-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        #signup-cancel-btn:hover {
            background: #e5e7eb;
        }

        #signup-submit-btn {
            background: #22c55e;
            border-color: #1faa52;
        }

        #signup-submit-btn:hover {
            background: #1faa52;
        }

        /* å•†å“è¯¦æƒ…é¡µæ ·å¼ */
        .product-detail {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .product-detail-content {
            display: flex;
            gap: 30px;
        }

        .product-detail-image {
            flex: 1;
            max-width: 520px;
        }

        .product-gallery {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .product-gallery-main {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fb;
            border: 1px solid var(--border-subtle);
            min-height: 360px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-gallery-slides {
            width: 100%;
            height: 100%;
        }

        .product-gallery-slide {
            display: none;
            width: 100%;
            height: 100%;
        }

        .product-gallery-slide.active {
            display: block;
        }

        /* åˆ‡æ¢å›¾ç‰‡æ»‘åŠ¨åŠ¨ç”»ï¼ˆä¸æ”¹å˜å¸ƒå±€ï¼Œåªåšè½»å¾®å¹³ç§»åŠ¨ç”»ï¼‰ */
        .product-gallery-slide.slide-from-left {
            animation: gallerySlideFromLeft 0.25s ease-out;
        }

        .product-gallery-slide.slide-from-right {
            animation: gallerySlideFromRight 0.25s ease-out;
        }

        @keyframes gallerySlideFromLeft {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes gallerySlideFromRight {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .product-gallery-slide img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #fff;
        }

        .product-gallery-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.45);
            border: none;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
            transition: background var(--transition-fast), opacity var(--transition-fast);
            opacity: 0;
            pointer-events: none;
        }

        .product-gallery-arrow:hover {
            background: rgba(0, 0, 0, 0.65);
        }

        .product-gallery-arrow[data-action="prev"] {
            left: 12px;
        }

        .product-gallery-arrow[data-action="next"] {
            right: 12px;
        }

        /* æ‚¬åœæ—¶æ˜¾ç¤ºå›¾ç‰‡åˆ‡æ¢ç®­å¤´ */
        .product-gallery-main:hover .product-gallery-arrow {
            opacity: 1;
            pointer-events: auto;
        }

        /* é¡¶éƒ¨è½®æ’­ç®­å¤´ï¼šé»˜è®¤åŠé€æ˜ï¼Œæ‚¬åœæ—¶æ›´æ¸…æ™°ï¼Œä¸Šé¢ hover å·²å¤„ç† */

        .product-gallery-thumbs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .product-gallery-thumb {
            width: 70px;
            height: 70px;
            border-radius: 6px;
            border: 2px solid transparent;
            overflow: hidden;
            padding: 0;
            background: none;
            cursor: pointer;
            transition: border var(--transition-fast), transform var(--transition-fast);
        }

        .product-gallery-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .product-gallery-thumb:hover {
            transform: translateY(-2px);
            border-color: var(--primary-light);
        }

        .product-gallery-thumb.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(0, 120, 212, 0.15);
        }

        .product-detail-info {
            flex: 1;
        }

        .product-detail-title {
            font-size: 28px;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .product-detail-price {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .product-detail-description {
            line-height: 1.8;
            margin-bottom: 25px;
            color: #666;
        }

        .product-detail-actions {
            display: flex;
            gap: 15px;
        }

        .product-image-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .product-image-inputs input {
            width: 100%;
        }

        /* WhatsAppè”ç³»æŒ‰é’®æ ·å¼ */
        .whatsapp-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            background: #25D366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
            transition: transform 0.3s, box-shadow 0.3s;
            text-decoration: none;
        }

        .whatsapp-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
        }

        /* ç”¨æˆ·ä¸­å¿ƒæ ·å¼ */
        .user-center {
            display: none;
            margin: 30px 0;
        }
        
        .user-center.show {
            display: grid !important;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }
        
        .user-center.show.sidebar-hidden {
            grid-template-columns: 1fr;
        }

        /* ä¸ªäººä¸­å¿ƒèœœç½å¾½ç«  */
        .user-points-badge {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.06);
            color: #1f2937;
            font-size: 12px;
            border: 1px solid rgba(37, 99, 235, 0.25);
            cursor: pointer;
        }

        .user-points-badge span {
            font-weight: 600;
            color: #1d4ed8;
        }

        .honey-icon {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }

        .honey-tooltip {
            position: absolute;
            top: 120%;
            right: 0;
            min-width: 260px;
            padding: 12px 14px;
            border-radius: 10px;
            background: #0f172a;
            color: #e5e7eb;
            font-size: 13px;
            line-height: 1.7;
            box-shadow: 0 14px 30px rgba(15, 23, 42, 0.35);
            opacity: 0;
            pointer-events: none;
            transform: translateY(4px);
            transition: opacity 0.18s ease-out, transform 0.18s ease-out;
            z-index: 40;
            text-align: left;
        }

        .honey-tooltip::before {
            content: "";
            position: absolute;
            top: -6px;
            right: 16px;
            border-width: 6px;
            border-style: solid;
            border-color: transparent transparent #0f172a transparent;
        }

        .user-points-badge:hover .honey-tooltip {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .honey-highlight {
            color: #ffd700;
            font-weight: bold;
        }

        .user-sidebar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
        }

        .user-details h3 {
            margin-bottom: 5px;
        }

        .user-menu {
            list-style: none;
        }

        .user-menu li {
            margin-bottom: 10px;
        }

        .user-menu a {
            display: block;
            padding: 10px;
            color: var(--dark);
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .user-menu a.active,
        .user-menu a:hover {
            background: var(--light);
            color: var(--primary);
        }

        .user-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        /* é€šç”¨ï¼šé¿å… user-content åœ¨ç§»åŠ¨ç«¯äº§ç”Ÿæ¨ªå‘æº¢å‡º */
        .user-content {
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        /* å…è®¸ä½œä¸ºç½‘æ ¼/å¼¹æ€§å­é¡¹æ—¶åœ¨å°å±æ­£å¸¸æ”¶ç¼©ï¼Œé¿å…æ¨ªå‘æº¢å‡º */
        .user-content,
        .user-page {
            min-width: 0;
        }
        .user-content img,
        .user-content video,
        .user-content canvas,
        .user-content iframe {
            max-width: 100%;
            height: auto;
            display: block;
        }
        .user-content pre {
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .user-content table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }
        /* å°å±å¹•ä¸‹ï¼Œè¡¨æ ¼å®¹å™¨å…è®¸æ¨ªå‘æ»šåŠ¨ä»¥é˜²æˆªæ–­ */
        @media (max-width: 768px) {
            .user-content table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        .order-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            /* é»˜è®¤ä¸æ¢è¡Œï¼Œé¿å…æ ‡ç­¾è¿‡å¤šæ—¶æŒ¤å‹å˜å½¢ */
            flex-wrap: nowrap;
        }

        .order-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .order-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        /* ç§»åŠ¨ç«¯ï¼šè®¢å•çŠ¶æ€æ ‡ç­¾æ”¯æŒå·¦å³æ»‘åŠ¨ï¼Œé¿å…è¢«æˆªæ–­ */
        @media (max-width: 768px) {
            .order-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
                border-bottom: none;
                padding-bottom: 4px;
                gap: 8px;
                scroll-snap-type: x proximity; /* æ›´é¡ºæ»‘çš„åˆ†é¡µæ„Ÿ */
            }

            .order-tab {
                flex: 0 0 auto;
                margin-right: 8px;
                padding: 8px 14px;
                border-radius: 999px;
                border: 1px solid #e5e7eb;
                font-size: 13px;
                background-color: #f9fafb;
                border-bottom-width: 1px;
                scroll-snap-align: start;
            }

            .order-tab.active {
                background: linear-gradient(135deg, #60a5fa, #2563eb);
                color: #ffffff;
                border-color: transparent;
            }
            /* ç”¨æˆ·ä¸­å¿ƒä¸¤æ åœ¨å°å±æ”¹ä¸ºå•åˆ—ï¼Œé¿å…æ¨ªå‘æŒ¤å‹é€ æˆæº¢å‡º */
            .user-center.show {
                grid-template-columns: 1fr;
            }
        }

        .order-list {
            display: none;
        }

        .order-list.active {
            display: block;
        }

        .order-item {
            display: flex;
            align-items: flex-start;
            padding: 14px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 14px;
            background: #fff;
        }
        
        .order-image {
            width: 96px;
            height: 96px;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-right: 14px;
            flex-shrink: 0;
        }

        .order-details {
            flex: 1;
        }

        .order-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .order-price {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-bottom: 5px;
        }

        .order-date {
            color: #666;
            font-size: 12px;
        }

        .order-price-old {
            text-decoration: line-through;
            color: #999;
            font-size: 0.95em;
        }

        .order-price-new {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.1em;
        }

        .order-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* è¯„ä»·å®Œæˆåçš„æ„Ÿè°¢æç¤º */
        .review-thankyou-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 500;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(34, 197, 94, 0.25);
            border: none;
            cursor: default;
            white-space: nowrap;
        }

        .review-thankyou-badge i {
            margin-right: 8px;
        }

        .order-copy-btn {
            flex: 0;
            padding: 4px 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #6c757d;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            width: auto;
            min-width: auto;
            font-size: 12px;
            gap: 4px;
        }

        .order-copy-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            color: #495057;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-review {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-shipping {
            background: #e7d5f5;
            color: #6a1b9a;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-cancelled {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        /* ç”¨æˆ·é¡µé¢æ ·å¼ */
        .user-page {
            display: none;
        }

        .user-page.active {
            display: block;
        }

        .address-header {
            margin-bottom: 20px;
        }

        .address-header h3 {
            font-size: 28px;
            font-weight: 400;
            margin: 0 0 20px 0;
        }

        .address-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Add Address å¡ç‰‡ */
        .add-address-card {
            background: white;
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .add-address-card:hover {
            border-color: var(--primary);
            background: #f8f9ff;
        }

        .add-address-icon {
            font-size: 48px;
            color: #999;
            margin-bottom: 10px;
        }

        .add-address-text {
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }

        /* åœ°å€å¡ç‰‡ */
        .address-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .address-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .address-item.default {
            border-color: #e47911;
        }

        .address-default-badge {
            display: inline-block;
            background: #e47911;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .address-info {
            flex: 1;
            margin-bottom: 15px;
        }

        .address-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 8px;
            color: #111;
        }

        .address-full {
            color: #111;
            line-height: 1.5;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .address-phone {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .address-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .address-actions a {
            color: #0066c0;
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
        }

        .address-actions a:hover {
            text-decoration: underline;
            color: #c45500;
        }

        .address-actions .separator {
            color: #ddd;
            margin: 0 4px;
        }

        .security-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .security-section h4 {
            margin-bottom: 20px;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .security-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .security-item:last-child {
            border-bottom: none;
        }

        .security-info h5 {
            margin-bottom: 5px;
            color: var(--dark);
        }

        .security-info p {
            color: var(--gray);
            font-size: 14px;
            margin: 0;
        }

        /* å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        /* åå°ç®¡ç†æ ·å¼ */
        .admin-panel {
            display: none;
            margin: 30px 0;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .admin-nav-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .admin-nav-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .admin-nav-btn:hover {
            color: var(--primary);
        }

        .admin-page {
            display: none;
        }

        .admin-page.active {
            display: block;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .admin-table th,
        .admin-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .admin-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }

        .admin-table tbody tr:hover {
            background: #f8f9fa;
        }

        .users-table-container,
        .orders-table-container {
            overflow-x: auto;
        }

        /* ç”¨æˆ·è¡¨æ ¼åˆ—å®½ä¼˜åŒ– */
        #users-table th:nth-child(1),
        #users-table td:nth-child(1) {
            width: 50px;
            min-width: 50px;
            text-align: center;
        }
        .user-select-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        #users-table th:nth-child(2),
        #users-table td:nth-child(2) {
            width: 80px;
            min-width: 80px;
        }

        #users-table th:nth-child(3),
        #users-table td:nth-child(3) {
            width: 140px;
            min-width: 140px;
        }

        #users-table th:nth-child(4),
        #users-table td:nth-child(4) {
            width: 160px;
            min-width: 160px;
        }

        #users-table th:nth-child(5),
        #users-table td:nth-child(5) {
            width: 110px;
            min-width: 110px;
        }

        #users-table th:nth-child(6),
        #users-table td:nth-child(6) {
            width: 110px;
            min-width: 110px;
            text-align: center;
        }

        #users-table th:nth-child(7),
        #users-table td:nth-child(7) {
            width: 180px;
            min-width: 180px;
        }

        #users-table th:nth-child(8),
        #users-table td:nth-child(8) {
            width: 90px;
            min-width: 90px;
            text-align: center;
        }
        
        #users-table th:nth-child(9),
        #users-table td:nth-child(9) {
            width: 110px;
            min-width: 110px;
            text-align: center;
        }
        
        #users-table th:nth-child(10),
        #users-table td:nth-child(10) {
            width: 160px;
            min-width: 160px;
            text-align: center;
        }

        #orders-table th:nth-child(1),
        #orders-table td:nth-child(1) {
            width: 50px;
            min-width: 50px;
            text-align: center;
        }

        /* è®¢å•çŠ¶æ€åˆ—å®½åº¦ä¼˜åŒ– */
        #orders-table th:nth-child(6),
        #orders-table td:nth-child(6) {
            min-width: 100px;
            width: auto;
            white-space: nowrap;
        }

        #orders-table td:nth-child(6) {
            text-align: center;
        }

        .danger-zone {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #fed3d3;
            border-radius: 10px;
            background: #fff6f6;
        }

        .danger-zone h4 {
            margin-bottom: 10px;
            color: #c0392b;
        }

        .danger-zone p {
            margin-bottom: 15px;
            color: #8f231b;
            font-size: 14px;
        }

        .order-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .order-filters .form-control {
            min-width: 200px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-info h3 {
            font-size: 32px;
            margin: 0;
            color: var(--dark);
        }

        .stat-info p {
            margin: 5px 0 0 0;
            color: var(--gray);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 400;
            display: inline-block;
            white-space: nowrap;
            text-align: center;
            min-width: 60px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-banned {
            background: #f8d7da;
            color: #721c24;
            font-weight: 600;
        }

        /* ä¸»é¡µç®¡ç†æ ·å¼ */
        .homepage-editor {
            display: grid;
            gap: 30px;
        }

        .editor-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .editor-section h3 {
            margin-bottom: 20px;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .carousel-manager {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .carousel-tabs {
            display: inline-flex;
            gap: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 4px;
            background: #f9fafb;
            width: fit-content;
        }

        .carousel-tab {
            border: none;
            background: transparent;
            padding: 8px 18px;
            border-radius: 6px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .carousel-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }

        .carousel-panel {
            display: none;
            flex-direction: column;
            gap: 15px;
        }

        .carousel-panel.active {
            display: flex;
        }

        .carousel-list {
            display: grid;
            gap: 15px;
        }

        .carousel-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .carousel-preview {
            width: 120px;
            height: 80px;
            background-size: cover;
            background-position: center;
            border-radius: 4px;
            margin-right: 15px;
        }

        .carousel-info {
            flex: 1;
        }

        .carousel-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .carousel-desc {
            color: #666;
            font-size: 14px;
        }

        .carousel-actions {
            display: flex;
            gap: 10px;
        }

        .user-detail-grid {
            display: grid;
            gap: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-item label {
            font-weight: 600;
            min-width: 100px;
            margin-right: 15px;
        }

        .password-field {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .role-badge.admin {
            background: #d4edda;
            color: #155724;
        }

        .role-badge.user {
            background: #cce5ff;
            color: #004085;
        }

        /* æŒ‰é’®é«˜äº®æ•ˆæœ */
        .btn-refreshing {
            background: var(--secondary) !important;
            color: white !important;
            transform: scale(0.95);
            transition: all 0.3s ease;
        }

        .btn-refreshing::after {
            content: " ğŸ”„";
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .btn-success {
            background: var(--secondary) !important;
            color: white !important;
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        .btn-success::after {
            content: " âœ…";
        }

        /* é€šçŸ¥åŠ¨ç”» */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* æ€§èƒ½ä¼˜åŒ– */
        .lazy-load {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .lazy-load.loaded {
            opacity: 1;
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .admin-table {
                font-size: 14px;
            }

            .admin-table th,
            .admin-table td {
                padding: 8px 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 15px;
            }
        }

        .admin-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .admin-search {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            background: #fff;
            min-width: 260px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .admin-search i {
            color: var(--gray-light);
        }

        .admin-search-input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 14px;
        }

        .admin-search-input::placeholder {
            color: var(--gray-light);
        }

        .admin-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        /* ä¸»é¡µç®¡ç†ä¼˜åŒ–æ ·å¼ */
        .homepage-editor {
            max-width: 1200px;
            margin: 0 auto;
        }

        .editor-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .editor-section h3 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .editor-section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary);
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .carousel-manager {
            background: white;
            padding: 20px;
            border-radius: 6px;
        }

        .carousel-list {
            margin-bottom: 20px;
        }

        .carousel-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            transition: all 0.3s;
        }

        .carousel-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .carousel-preview {
            width: 120px;
            height: 80px;
            border-radius: 6px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .carousel-info {
            flex: 1;
        }

        .carousel-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .carousel-desc {
            color: var(--gray);
            font-size: 14px;
        }

        .carousel-actions {
            display: flex;
            gap: 10px;
        }

        .excel-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .excel-upload:hover {
            border-color: var(--primary);
        }

        .excel-upload i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        /* Excelä¸Šä¼ ç›¸å…³æ ·å¼ */
        .excel-upload.processing {
            border-color: var(--primary);
            background: #f8f9fa;
        }

        .excel-upload.success {
            border-color: var(--secondary);
            background: #f8fff9;
        }

        .excel-upload.error {
            border-color: var(--danger);
            background: #fff5f5;
        }

        .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .excel-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .excel-preview h4 {
            margin-bottom: 15px;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .preview-info {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
        }

        .preview-products {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .preview-product-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.3s;
        }

        .preview-product-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .preview-product-image {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            background-size: cover;
            background-position: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .preview-product-info {
            flex: 1;
        }

        .preview-product-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .preview-product-price {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 3px;
        }

        .preview-product-category {
            font-size: 12px;
            color: var(--gray);
            background: var(--light);
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .preview-product-status {
            margin-left: 15px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .product-category {
            font-size: 12px;
            color: var(--gray);
            background: var(--light);
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 10px;
        }

        /* æ§åˆ¶é¢æ¿æŒ‰é’®æ ·å¼ï¼ˆå½“å‰æš‚ä¸ä½¿ç”¨ï¼Œæ•´ä½“éšè—æ§åˆ¶é¢æ¿ UIï¼‰ */
        #admin-control-panel {
            display: none !important;
        }

        #control-panel-btn:hover {
            background: #2980b9 !important;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        #control-panel-dropdown button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }

            .logo {
                margin-left: 0;
                min-width: auto;
            }

            .search-bar {
                flex: 1;
                width: auto;
                margin: 0;
            }

            .nav-links,
            .nav-links li,
            .nav-links a {
                display: none !important;
                visibility: hidden;
                pointer-events: none;
                margin: 0;
                padding: 0;
            }

            #main-home-link,
            #admin-link,
            #user-center-link,
            #my-orders-link {
                display: none !important;
            }

            .user-actions {
                margin-top: 8px;
                width: auto;
                justify-content: flex-end;
            }

            /* åº•éƒ¨å›ºå®šå¯¼èˆªæ  */
            .bottom-nav {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                height: 54px;
                background: #ffffff;
                border-top: 1px solid #e5e7eb;
                box-shadow: 0 -2px 6px rgba(15, 23, 42, 0.08);
                display: flex;
                z-index: 1100;
            }

            /* é¢„ç•™ç©ºé—´é¿å…åº•éƒ¨å†…å®¹è¢«å¯¼èˆªæ é®æŒ¡ */
            body {
                padding-bottom: 64px;
            }

            .carousel {
                height: 300px;
            }

            .carousel-content {
                left: 20px;
                bottom: 20px;
                padding: 15px;
            }

            .carousel-content h2 {
                font-size: 22px;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }

            .product-image {
                aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢æ¯”ä¾‹ */
                width: 100%;
            }

            .product-detail-content {
                flex-direction: column;
            }

            .product-detail-image {
                max-width: 100%;
            }

            .chat-window {
                width: 300px;
                height: 400px;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .product-card {
                max-width: 50%;
            }
        }

        /* ========== ç§»åŠ¨ç«¯å¸ƒå±€ä¼˜åŒ– ========== */

        /* å¯¼èˆªæ ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .nav-container {
                display: flex;
                flex-wrap: nowrap;
                align-items: center;
                padding: 10px 15px;
                gap: 10px;
            }

            .logo {
                font-size: 18px;
                min-height: 40px;
                margin: 0;
                flex-shrink: 0;
                order: 1;
                display: flex;
                align-items: center;
            }
            
            .logo img {
                height: 40px;
                max-width: 150px;
            }

            /* æ±‰å ¡èœå•æŒ‰é’® */
            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                background: none;
                border: none;
                font-size: 24px;
                color: var(--dark);
                cursor: pointer;
                padding: 8px 10px;
                margin: 0;
                flex-shrink: 0;
                order: 2;
                min-width: 44px;
                min-height: 44px;
            }

            .nav-links {
                display: none !important;
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                background: white;
                flex-direction: column;
                margin: 0;
                padding: 10px 0;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                max-height: calc(100vh - 60px);
                overflow-y: auto;
                border-top: 1px solid #eee;
            }

            .nav-links.show {
                display: flex !important;
            }

            .nav-links li {
                margin: 0;
                padding: 0;
                width: 100%;
            }

            .nav-links a {
                display: block;
                padding: 12px 20px;
                border-bottom: 1px solid #eee;
                width: 100%;
                box-sizing: border-box;
            }

            .nav-links li:last-child a {
                border-bottom: none;
            }

            .search-bar {
                flex: 1;
                min-width: 0;
                order: 3;
                margin: 0;
                display: flex;
            }

            .search-bar input {
                font-size: 16px;
                padding: 10px 12px;
                flex: 1;
                min-width: 0;
            }

            .search-bar button {
                padding: 0 15px;
                flex-shrink: 0;
            }

            .user-actions {
                display: flex;
                align-items: center;
                gap: 6px;
                margin: 0;
                flex-shrink: 0;
                order: 4;
                flex-wrap: nowrap;
            }

            .user-actions > * {
                flex-shrink: 0;
            }

            .language-selector {
                margin: 0 !important;
                margin-left: auto !important;
            }

            .language-selector select {
                padding: 6px 8px !important;
                font-size: 12px !important;
                min-width: 80px;
            }

            #admin-control-panel {
                margin: 0 !important;
            }

            #control-panel-btn {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }

            #control-panel-btn span {
                display: none;
            }

            .user-actions a {
                margin: 0;
                font-size: 13px;
                padding: 10px 16px;
                background: var(--primary);
                color: white;
                border-radius: 2px;
                white-space: nowrap;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                font-weight: 400;
                box-shadow: none;
                transition: background var(--transition-fast);
                min-height: 40px;
                border: none;
            }

            .user-actions a:hover {
                background: var(--primary-hover);
            }

            .user-actions a i {
                font-size: 14px;
            }

            /* é€€å‡ºæŒ‰é’®ä¼˜åŒ– */
            #logout-link {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }
        }

        /* ç§»åŠ¨ç«¯å¯¼èˆªé‡æ’ï¼šç›´æ¥å±•ç¤ºèœå• */
        @media (max-width: 768px) {
            .nav-container {
                flex-wrap: nowrap;
                align-items: center;
                gap: 10px;
                padding: 10px 15px;
            }

            .logo {
                margin: 0;
                flex: 0 0 auto;
                order: 1;
                min-width: 120px;
                max-width: 150px;
            }

            .logo img {
                margin: 0;
                height: 40px;
                max-width: 100%;
            }

            .menu-toggle {
                order: 2;
            }

            .nav-links {
                display: none !important;
                width: 100%;
                padding: 0;
                margin: 0;
            }

            .search-bar {
                order: 3;
                flex: 1;
                min-width: 0;
                margin: 0;
            }

            .user-actions {
                order: 4;
                flex: 0 0 auto;
                flex-wrap: nowrap;
                justify-content: flex-end;
                gap: 8px;
            }

            .user-actions > * {
                margin-left: 0 !important;
            }

            .language-selector {
                width: auto;
                margin-left: 0 !important;
                order: 5;
            }
        }

        /* æ›´å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            .nav-container {
                padding: 8px 10px;
                gap: 6px;
                flex-wrap: nowrap;
            }

            .logo {
                font-size: 16px;
                min-height: 40px;
                flex: 0 0 auto;
                min-width: 100px;
                max-width: 120px;
            }
            
            .logo img {
                height: 35px;
                max-width: 100%;
            }

            .menu-toggle {
                font-size: 20px;
                padding: 6px 8px;
                min-width: 40px;
                min-height: 40px;
            }

            .search-bar {
                flex: 1;
                min-width: 0;
            }

            .search-bar input {
                font-size: 14px;
                padding: 8px 10px;
            }

            .search-bar button {
                padding: 0 12px;
            }

            .user-actions {
                gap: 4px;
                flex-wrap: nowrap;
            }

            .user-actions a {
                font-size: 11px;
                padding: 8px 12px;
                min-height: 36px;
            }

            .user-actions a i {
                font-size: 12px;
            }

            .language-selector select {
                padding: 5px 6px !important;
                font-size: 11px !important;
                min-width: 70px;
            }

            #control-panel-btn {
                padding: 5px 8px !important;
                font-size: 11px !important;
            }

            .user-actions a {
                font-size: 11px;
                padding: 5px 8px;
            }

            /* ç¡®ä¿å¯¼èˆªé“¾æ¥åœ¨å°å±å¹•ä¸Šä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤º */
            .nav-links {
                max-height: 70vh;
            }

            .nav-links a {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        @media (min-width: 769px) {
            .menu-toggle {
                display: none;
            }
        }

        /* è½®æ’­å›¾ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .carousel {
                width: 100%;
                aspect-ratio: 21 / 9;
                /* ç§»åŠ¨ç«¯ä¹Ÿä½¿ç”¨21:9æ¯”ä¾‹ */
                margin: 15px 0;
            }

            .carousel-content {
                left: 15px;
                bottom: 15px;
                right: 15px;
                /* æ·»åŠ å³è¾¹è· */
                max-width: none;
                padding: 15px;
            }

            .carousel-content h2 {
                font-size: 20px;
                margin-bottom: 8px;
            }

            .carousel-content p {
                font-size: 14px;
                margin-bottom: 10px;
                line-height: 1.4;
            }

            .carousel-btn {
                padding: 8px 16px;
                font-size: 14px;
            }

            .carousel-indicators {
                display: none; /* ç§»åŠ¨ç«¯éšè—è½®æ’­ç‚¹ */
            }

            .indicator {
                display: none; /* ç§»åŠ¨ç«¯éšè—è½®æ’­ç‚¹ */
            }
        }

        /* äº§å“ç½‘æ ¼ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            .section-title {
                font-size: 18px;
                margin: 15px 0 12px;
                padding-left: 5px;
            }

            /* é¦–é¡µç²¾é€‰å±•ç¤ºä¼˜åŒ– */
            #featured-showcase {
                padding: 15px 10px;
                margin-top: 15px;
            }

            #featured-showcase .featured-head {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            #featured-showcase .featured-head h2 {
                font-size: 24px;
            }

            #featured-showcase .featured-meta {
                justify-content: center;
            }

            /* åˆ†ç±»ç­›é€‰å™¨ä¼˜åŒ– - å¯æ¨ªå‘æ»šåŠ¨ */
            .category-filter {
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                /* å¹³æ»‘æ»šåŠ¨ */
                padding-bottom: 5px;
                margin: 20px 0 15px;
            }

            .category-item {
                display: inline-block;
                padding: 8px 16px;
                font-size: 13px;
                margin: 0 5px 0 0;
                white-space: nowrap;
            }

            /* äº§å“å¡ç‰‡ä¼˜åŒ– */
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important;
                /* å¼ºåˆ¶ä½¿ç”¨å°å°ºå¯¸ */
                gap: 15px;
                margin-bottom: 2000px;
                /* ä¿æŒåŸæœ‰çš„å·¨å¤§åº•éƒ¨é—´è· */
            }

            .product-card {
                margin: 0 !important;
                /* ç§»é™¤è‡ªåŠ¨å¤–è¾¹è· */
                min-height: auto !important;
            }

            .product-info {
                padding: 12px;
            }

            .product-title {
                font-size: 14px;
                margin-bottom: 8px;
                height: auto;
                /* æ‰‹æœºç«¯ä¸ç”µè„‘ç«¯ä¿æŒä¸€è‡´ï¼šæ ‡é¢˜æœ€å¤šæ˜¾ç¤ºä¸¤è¡Œï¼Œè¶…å‡ºéƒ¨åˆ†çœç•¥ */
                -webkit-line-clamp: 2;
                line-clamp: 2;
            }

            .product-price {
                font-size: 18px;
                margin-bottom: 12px;
            }

            .product-image {
                aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢æ¯”ä¾‹ */
                width: 100%;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            /* é¦–é¡µç²¾é€‰å¡ç‰‡ä¼˜åŒ– - ç§»åŠ¨ç«¯2åˆ—å¸ƒå±€ */
            #products-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
                padding: 0 5px;
            }

            .home-feature-card {
                max-width: 100% !important;
                margin: 0 !important;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .home-feature-image {
                aspect-ratio: 1 / 1;
                width: 100%;
                position: relative;
                background: #f7f8fa;
            }

            .home-feature-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .home-feature-tag {
                top: 8px;
                left: 8px;
                padding: 3px 8px;
                font-size: 10px;
            }

            .home-feature-body {
                padding: 10px 8px 12px !important;
                gap: 6px;
            }

            .home-feature-body h3 {
                font-size: 12px;
                line-height: 1.4;
                margin: 0 0 6px 0;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                height: 32px;
                color: #333;
                font-weight: 500;
            }

            .home-feature-price {
                font-size: 14px !important;
                margin: 4px 0;
                display: flex;
                align-items: center;
                gap: 6px;
                flex-wrap: wrap;
            }

            .home-feature-price span:first-child {
                font-size: 11px;
                color: #999;
            }

            .home-feature-price span:last-child {
                font-size: 16px;
                font-weight: bold;
                color: #e74c3c;
            }

            .home-feature-stock {
                font-size: 10px;
                color: #666;
                margin-top: 4px;
            }

            .home-feature-actions {
                grid-template-columns: 1fr;
                gap: 6px;
                margin-top: 8px;
            }

            .home-feature-actions .btn {
                padding: 6px 8px;
                font-size: 11px;
                border-radius: 4px;
            }
        }

        @media (max-width: 480px) {
            /* å°å±å¹•è¿›ä¸€æ­¥ä¼˜åŒ– */
            #products-grid {
                gap: 8px !important;
                padding: 0 3px;
            }

            .home-feature-body {
                padding: 8px 6px 10px !important;
            }

            .home-feature-body h3 {
                font-size: 11px;
                height: 28px;
            }

            .home-feature-price {
                font-size: 12px !important;
            }

            .home-feature-price span:last-child {
                font-size: 14px;
            }

            .home-feature-actions .btn {
                padding: 5px 6px;
                font-size: 10px;
            }
        }

        /* ç§»åŠ¨ç«¯æ•´ä½“ä¼˜åŒ– */
        @media (max-width: 768px) {
            /* äº§å“è¯¦æƒ…é¡µç§»åŠ¨ç«¯ä¼˜åŒ– */
            .product-detail {
                padding: 20px 15px;
                margin: 15px 0;
            }

            .product-detail-image {
                max-width: 100%;
                margin-bottom: 20px;
            }

            .product-detail-title {
                font-size: 22px;
                margin-bottom: 10px;
            }

            .product-detail-price {
                font-size: 24px;
                margin-bottom: 15px;
            }

            .product-detail-description {
                font-size: 14px;
                line-height: 1.6;
            }

            .product-detail-actions {
                flex-direction: column;
                gap: 10px;
            }

            /* ç”¨æˆ·ä¸­å¿ƒç§»åŠ¨ç«¯ä¼˜åŒ– */
            .user-center.show {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .user-center {
                margin: 15px 0;
            }

            .user-sidebar {
                margin-bottom: 15px;
            }

            .user-info {
                padding: 15px;
            }

            .user-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
                margin-right: 10px;
            }

            .user-menu a {
                padding: 12px 15px;
                font-size: 15px;
            }

            .order-item {
                flex-direction: row;
                align-items: flex-start;
                padding: 12px;
            }
            
            .order-image {
                width: 90px;
                height: 90px;
                margin-right: 12px;
                margin-bottom: 0;
            }
            
            .order-details {
                padding-left: 0;
            }

            /* åœ°å€ç®¡ç†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .address-item {
                padding: 15px;
            }

            .address-actions {
                flex-wrap: wrap;
                gap: 8px;
            }

            .address-actions .btn {
                flex: 1;
                min-width: 80px;
                padding: 6px 12px;
                font-size: 13px;
            }

            /* æ¨¡æ€æ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 10px;
                border-radius: 10px;
            }

            .modal-body {
                padding: 20px 15px;
                max-height: 80vh;
            }

            .form-group {
                margin-bottom: 12px;
            }

            .form-control {
                font-size: 16px;
                /* é˜²æ­¢iOSç¼©æ”¾ */
                padding: 12px;
            }

            .form-actions {
                flex-direction: column;
                gap: 10px;
            }

            .form-actions .btn {
                width: 100%;
            }

            /* äº§å“ç¼–è¾‘æ¨¡æ€æ¡† */
            #edit-product-modal .form-control,
            #signup-modal .form-control,
            #address-modal .form-control {
                font-size: 16px;
            }

            /* åœ°å€é€‰æ‹©å™¨æ ·å¼ */
            #signup-address-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            #signup-address-select {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                background-color: white;
            }

            #signup-address-btn {
                padding: 12px;
                font-size: 14px;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.3s;
            }

            #signup-address-btn:hover {
                opacity: 0.9;
            }

            /* æŠ¥åè¡¨å•å•è¡Œè¾“å…¥ */
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-row .form-group {
                width: 100%;
            }

            /* åå°ç®¡ç†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .admin-nav {
                flex-wrap: wrap;
                gap: 5px;
            }

            .admin-nav-btn {
                padding: 8px 12px;
                font-size: 14px;
                flex: 1;
                text-align: center;
            }

            .admin-actions {
                flex-wrap: wrap;
                gap: 8px;
            }

            .admin-actions .btn {
                flex: 1;
                min-width: 120px;
                font-size: 13px;
                padding: 8px 12px;
            }

            /* Excelä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
            .excel-upload {
                padding: 20px;
            }

            .excel-upload h3 {
                font-size: 18px;
            }

            .excel-upload p {
                font-size: 14px;
            }

            .excel-upload i {
                font-size: 36px;
            }

            /* è¡¨æ ¼ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .users-table-container,
            .orders-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 15px;
            }

            .admin-table {
                font-size: 13px;
                min-width: 800px;
                display: table;
                table-layout: auto;
                /* é˜²æ­¢è¡¨æ ¼å¤ªæŒ¤ */
            }

            .admin-table thead {
                display: table-header-group;
            }

            .admin-table tbody {
                display: table-row-group;
            }

            .admin-table th,
            .admin-table td {
                display: table-cell;
                padding: 8px 10px;
                vertical-align: middle;
            }

        .user-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-filters .form-control {
            min-width: 160px;
            flex: 0 0 auto;
        }

            /* ç»Ÿè®¡å¡ç‰‡ä¼˜åŒ– */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .stat-info h3 {
                font-size: 24px;
            }

            /* WhatsAppæŒ‰é’®ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .whatsapp-button {
                width: 55px;
                height: 55px;
                font-size: 24px;
                bottom: 85px;
                right: 15px;
            }

            /* è§¦æ‘¸ä¼˜åŒ– */
            .btn,
            .btn-primary,
            .btn-secondary,
            .btn-danger,
            .category-item,
            .indicator,
            .product-checkbox {
                min-height: 44px;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* é˜²æ­¢ç‚¹å‡»ç¼©æ”¾ */
            input,
            select,
            textarea,
            button {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            /* æ·»åŠ è§¦æ‘¸åé¦ˆ */
            .product-card:active,
            .home-feature-card:active,
            .carousel-btn:active,
            .btn:active {
                transform: scale(0.98);
            }

            /* ç®¡ç†å‘˜æ§åˆ¶é¢æ¿ç§»åŠ¨ç«¯ä¼˜åŒ– */
            #admin-control-panel {
                margin-right: 10px;
            }

            #control-panel-btn {
                font-size: 12px;
                padding: 6px 10px;
            }

            #control-panel-dropdown {
                min-width: 250px;
                max-width: 90vw;
                right: -10px;
            }

            #control-panel-dropdown button {
                font-size: 12px;
                padding: 8px;
            }
        }

        /* åŠ è½½å’Œé”™è¯¯çŠ¶æ€ä¼˜åŒ– */
        .excel-upload.processing,
        .excel-upload.success,
        .excel-upload.error {
            padding: 25px 20px;
        }

        .excel-upload.processing i,
        .excel-upload.success i,
        .excel-upload.error i {
            font-size: 36px;
        }

        /* åŠ¨ç”»ä¼˜åŒ– */
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* é€šçŸ¥æ¶ˆæ¯ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .notification {
            padding: 12px 16px;
            font-size: 14px;
            max-width: 90%;
        }

        /* ç¡®ä¿æ‰€æœ‰æ¨¡æ€æ¡†éƒ½æœ‰åˆé€‚çš„z-index */
        .modal {
            z-index: 2000;
        }
    </style>
</head>

<body class="loading">
    <!-- é¡µé¢åŠ è½½é®ç½© -->
    <div id="page-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text" data-i18n="loading">Loading data, please wait...</div>
        <div class="loader-progress" id="loader-progress">Initializing...</div>
    </div>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo" id="home-link">
                <img id="site-logo-img" src="https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_acd40833aec9706776e6e1e4432f7198_ProductImage_PT02" alt="Bee freebies" style="height: 60px; max-width: 300px; width: auto; object-fit: contain; display: block;" onerror="this.style.display='none'; console.error('Logoå›¾ç‰‡åŠ è½½å¤±è´¥');">
            </div>

            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search products...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>

            <ul class="nav-links">
                <li><a href="#" class="active" id="main-home-link">Home</a></li>
                <li><a href="#" id="admin-link" style="display:none">Admin Panel</a></li>
                <li><a href="#" id="user-center-link" style="display:none">Account</a></li>
                <li><a href="#" id="my-orders-link" style="display:none" data-tab="orders">My Orders</a></li>
            </ul>

            <div class="user-actions">
                <!-- è¯­è¨€é€‰æ‹©å™¨ -->
                <div class="language-selector" style="position: relative; margin-right: 15px;">
                    <select id="language-select" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 14px;">
                        <option value="zh">Chinese</option>
                        <option value="en" selected>English</option>
                    </select>
                </div>

                <!-- ç®¡ç†å‘˜æ§åˆ¶é¢æ¿ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
                <div id="admin-control-panel" style="display:none; position:relative; margin-right:15px;">
                    <button id="control-panel-btn"
                        style="background:#3498db; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:14px; transition:all 0.3s;">
                        <i class="fas fa-cog"></i>
                        <span id="current-mode-text">â˜ï¸ äº‘ç«¯æ¨¡å¼</span>
                        <i class="fas fa-chevron-down" style="font-size:10px;"></i>
                    </button>

                    <!-- ä¸‹æ‹‰èœå• -->
                    <div id="control-panel-dropdown"
                        style="display:none; position:absolute; top:45px; right:0; background:white; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); min-width:280px; z-index:1000;">
                        <div style="padding:15px; border-bottom:1px solid #eee;">
                            <div
                                style="font-weight:600; color:#2c3e50; margin-bottom:10px; display:flex; align-items:center; gap:8px;">
                                <i class="fas fa-database"></i>
                                æ•°æ®æºæ¨¡å¼
                            </div>
                            <div style="padding:12px; background:#e3f2fd; border:2px solid #3498db; border-radius:8px;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <i class="fas fa-cloud" style="color:#3498db; font-size:20px;"></i>
                                    <div style="flex:1;">
                                        <div style="font-weight:600; color:#3498db; font-size:14px;">â˜ï¸ äº‘ç«¯æ¨¡å¼</div>
                                        <div style="font-size:12px; color:#7f8c8d;">æ‰€æœ‰æ•°æ®å®æ—¶åŒæ­¥äº‘ç«¯</div>
                                    </div>
                                    <i class="fas fa-check-circle" style="color:#27ae60; font-size:18px;"></i>
                                </div>
                            </div>
                        </div>

                        <div style="padding:15px; border-bottom:1px solid #eee;">
                            <div
                                style="font-weight:600; color:#2c3e50; margin-bottom:10px; display:flex; align-items:center; gap:8px;">
                                <i class="fas fa-vial"></i>
                                æµ‹è¯•åŠŸèƒ½
                            </div>
                            <button id="test-cloud-connection"
                                style="width:100%; padding:10px; background:#27ae60; color:white; border:none; border-radius:6px; cursor:pointer; margin-bottom:8px; font-size:13px; transition:all 0.3s;">
                                <i class="fas fa-cloud"></i> æµ‹è¯•äº‘ç«¯è¿æ¥
                            </button>
                            <button id="force-sync"
                                style="width:100%; padding:10px; background:#e67e22; color:white; border:none; border-radius:6px; cursor:pointer; margin-bottom:8px; font-size:13px; transition:all 0.3s;">
                                <i class="fas fa-sync-alt"></i> å¼ºåˆ¶åŒæ­¥æ•°æ®
                            </button>
                            <button id="clear-cache"
                                style="width:100%; padding:10px; background:#e74c3c; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; transition:all 0.3s;">
                                <i class="fas fa-trash"></i> æ¸…é™¤æœ¬åœ°ç¼“å­˜
                            </button>
                        </div>

                        <div style="padding:12px; background:#f8f9fa; border-radius:0 0 8px 8px;">
                            <div style="font-size:12px; color:#7f8c8d; display:flex; align-items:center; gap:6px;">
                                <i class="fas fa-info-circle"></i>
                                <span id="sync-status-text">çŠ¶æ€ï¼šå·²è¿æ¥</span>
                            </div>
                        </div>
                    </div>
                </div>

                <a href="#" id="login-link"><i class="fas fa-user"></i> Login</a>
                <a href="#" id="register-link"><i class="fas fa-user-plus"></i> Register</a>
                <a href="#" id="logout-link" style="display:none"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </nav>

    <!-- åº•éƒ¨å¯¼èˆªï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
    <div class="bottom-nav">
        <button type="button" class="bottom-nav-item" onclick="document.getElementById('main-home-link').click()">
            <span>Home</span>
        </button>
        <button type="button" class="bottom-nav-item" id="bottom-admin-btn" style="display:none" onclick="document.getElementById('admin-link').click()">
            <span>Admin Panel</span>
        </button>
        <button type="button" class="bottom-nav-item" onclick="document.getElementById('user-center-link').click()">
            <span>Account</span>
        </button>
        <button type="button" class="bottom-nav-item" onclick="document.getElementById('my-orders-link').click()">
            <span>My Orders</span>
        </button>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="container">
        <!-- é¦–é¡µå†…å®¹ -->
        <div id="home-page">
            <!-- è½®æ’­å›¾ -->
            <div class="carousel">
                <div class="carousel-arrow prev">&#10094;</div>
                <div class="carousel-slide active"
                    style="background-image: url('https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_74a4f2a269eeee0e43f867fff8416a45_ProductImage_MAIN')">
                    <div class="carousel-content">
                        <h2>New Arrivals</h2>
                        <p>Explore our latest product series and enjoy limited-time offers</p>
                        <a href="#" class="carousel-btn">Buy Now</a>
                    </div>
                </div>
                <div class="carousel-slide"
                    style="background-image: url('https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_0c7821e20b2ca904579150a5c33caa82_ProductImage_PT01')">
                    <div class="carousel-content">
                        <h2>Limited Time Offer</h2>
                        <p>Selected items up to 50% off, don't miss out</p>
                        <a href="#" class="carousel-btn">View Details</a>
                    </div>
                </div>
                <div class="carousel-arrow next">&#10095;</div>
                <div class="carousel-indicators">
                    <div class="indicator active"></div>
                    <div class="indicator"></div>
                </div>
            </div>

            <section class="featured-showcase" id="featured-showcase">
                <div class="featured-head">
                    <div>
                        <h2 data-i18n="featuredTitle">Featured Recommendations</h2>
                        <p data-i18n="featuredDesc">We select the hottest products in real-time and provide exclusive claim channels. Click to view details quickly.</p>
                    </div>
                    <div class="featured-meta" style="display: none;">
                        <!-- å·²éšè—ï¼šå®æ—¶åˆ·æ–°Â·äº‘ç«¯åŒæ­¥æŒ‰é’® -->
                    </div>
                </div>

                <div class="category-filter">
                    <div class="category-item active" data-category="all">å…¨éƒ¨å•†å“</div>
                    <div class="category-item" data-category="electronics">ç”µå­äº§å“</div>
                    <div class="category-item" data-category="home">å®¶å±…ç”¨å“</div>
                    <div class="category-item" data-category="clothing">æœè£…é‹å¸½</div>
                    <div class="category-item" data-category="beauty">ç¾å¦†æŠ¤è‚¤</div>
                </div>

                <div id="products-grid">
                    <!-- åŠ¨æ€æ¸²æŸ“ -->
                </div>

                <div class="product-detail" id="product-detail">
                    <!-- è¯¦æƒ…å†…å®¹ -->
                </div>
            </section>
        </div>

        <!-- ç”¨æˆ·ä¸­å¿ƒ -->
        <div class="user-center" id="user-center">
            <div class="user-sidebar">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <h3 id="username-display">${t('username') || 'ç”¨æˆ·å'}</h3>
                        <p id="user-member-type">${t('regularMember') || 'æ™®é€šä¼šå‘˜'}</p>
                        <div id="user-points-badge" class="user-points-badge">
                            <img src="https://d92ap0lo8fr10.cloudfront.net/A19TTJV74BN2OJ_3f7009240e98f5796e6ac33338216e01_ProductImage_PT03" alt="" class="honey-icon">
                            <span data-i18n="pointsBalance">${t('pointsBalance') || 'å½“å‰èœœç½'}</span>ï¼š
                            <span id="user-points-value">2</span>
                            <div class="honey-tooltip">
                                *Claiming a product deducts 1 Honey.<br>
                                *Writing a review rewards 2 Honey.<br>
                                *Need more Honey? Contact Support.
                            </div>
                        </div>
                    </div>
                </div>
                <ul class="user-menu">
                    <li><a href="#" data-tab="profile" data-i18n="profile">${t('profile') || 'ä¸ªäººä¿¡æ¯'}</a></li>
                    <li><a href="#" data-tab="address" data-i18n="address">${t('address') || 'æ”¶è´§åœ°å€'}</a></li>
                    <li><a href="#" data-tab="my-reviews" data-i18n="myReview">${t('myReview') || 'æˆ‘çš„è¯„ä»·'}</a></li>
                    <li><a href="#" data-tab="security" data-i18n="security">${t('security') || 'è´¦æˆ·å®‰å…¨'}</a></li>
                </ul>
            </div>

            <div class="user-content">
                <!-- æˆ‘çš„æŠ¥åé¡µé¢ -->
                <div class="user-page active" id="user-orders">
                    <div class="order-tabs">
                        <div class="order-tab active" data-status="all">å…¨éƒ¨è®¢å•</div>
                        <div class="order-tab" data-status="review">å¾…ä¸Šä¼ </div>
                        <div class="order-tab" data-status="shipping">è¿è¾“ä¸­</div>
                        <div class="order-tab" data-status="completed">å·²å®Œæˆ</div>
                        <div class="order-tab" data-status="rejected">å·²é©³å›</div>
                        <div class="order-tab" data-status="cancelled">å·²å–æ¶ˆ</div>
                    </div>

                    <div class="order-list active" id="order-all">
                        <!-- è®¢å•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <div class="order-list" id="order-review">
                        <!-- å¾…ä¸Šä¼ è®¢å• -->
                    </div>

                    <div class="order-list" id="order-shipping">
                        <!-- è¿è¾“ä¸­è®¢å• -->
                    </div>

                    <div class="order-list" id="order-completed">
                        <!-- å·²å®Œæˆè®¢å• -->
                    </div>

                    <div class="order-list" id="order-rejected">
                        <!-- å·²é©³å›è®¢å• -->
                    </div>

                    <div class="order-list" id="order-cancelled">
                        <!-- å·²å–æ¶ˆè®¢å• -->
                    </div>
                </div>

                <!-- ä¸ªäººä¿¡æ¯é¡µé¢ -->
                <div class="user-page" id="user-profile">
                    <h3 data-i18n="profile">${t('profile') || 'ä¸ªäººä¿¡æ¯'}</h3>
                    <form id="profile-form">
                        <div class="form-group">
                            <label for="profile-username" data-i18n="username">${t('username') || 'ç”¨æˆ·å'}</label>
                            <input type="text" id="profile-username" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label for="profile-account" data-i18n="account">${t('account') || 'è´¦å·'}</label>
                            <input type="text" id="profile-account" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label for="profile-nickname" data-i18n="nickname">${t('nickname') || 'æ˜µç§°'}</label>
                            <input type="text" id="profile-nickname" class="form-control" data-i18n-placeholder="enterNickname" placeholder="${t('enterNickname') || 'è¯·è¾“å…¥æ˜µç§°'}">
                        </div>
                        <div class="form-group">
                            <label for="profile-phone" data-i18n="phone">${t('phone') || 'æ‰‹æœºå·'}</label>
                            <div class="phone-input-wrapper">
                                <span class="phone-prefix">+1</span>
                                <input type="tel" id="profile-phone" class="phone-input" maxlength="10" data-i18n-placeholder="enterPhone" placeholder="${t('enterPhone') || 'è¯·è¾“å…¥æ‰‹æœºå·'}">
                            </div>
                            <small class="phone-input-hint" data-i18n="usPhoneHint">${t('usPhoneHint') || 'è¯·è¾“å…¥ç¾å›½æ‰‹æœºå·ï¼ˆ+1å¼€å¤´çš„10ä½æ•°å­—ï¼‰'}</small>
                        </div>
                        <div class="form-group">
                            <label for="profile-email" data-i18n="email">${t('email') || 'é‚®ç®±'}</label>
                            <input type="email" id="profile-email" class="form-control" data-i18n-placeholder="enterEmail" placeholder="${t('enterEmail') || 'è¯·è¾“å…¥é‚®ç®±'}">
                        </div>
                        <div class="form-group">
                            <label for="profile-birthday" data-i18n="birthday">${t('birthday') || 'ç”Ÿæ—¥'}</label>
                            <input type="date" id="profile-birthday" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="profile-gender" data-i18n="gender">${t('gender') || 'æ€§åˆ«'}</label>
                            <select id="profile-gender" class="form-control">
                                <option value="" data-i18n="pleaseSelect">${t('pleaseSelect') || 'è¯·é€‰æ‹©'}</option>
                                <option value="male" data-i18n="male">${t('male') || 'ç”·'}</option>
                                <option value="female" data-i18n="female">${t('female') || 'å¥³'}</option>
                                <option value="other" data-i18n="other">${t('other') || 'å…¶ä»–'}</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" data-i18n="saveChanges">${t('saveChanges') || 'ä¿å­˜ä¿®æ”¹'}</button>
                        </div>
                    </form>

                </div>

                <!-- æ”¶è´§åœ°å€é¡µé¢ -->
                <div class="user-page" id="user-address">
                    <div class="address-header">
                        <h3>Your Addresses</h3>
                    </div>
                    <div class="address-list" id="address-list">
                        <!-- åœ°å€åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <button class="btn btn-primary" id="add-address-btn" style="display: none;" data-i18n="addAddress">${t('addAddress') || 'æ·»åŠ åœ°å€'}</button>
                </div>

                <!-- æˆ‘çš„è¯„ä»·é¡µé¢ -->
                <div class="user-page" id="user-my-reviews">
                    <h3>${t('myReview') || 'æˆ‘çš„è¯„ä»·'}</h3>
                    <div id="my-reviews-empty" style="display:none; padding: 30px; text-align: center; color: #777;">
                        <p>${t('noReviews') || 'æš‚æ— è¯„ä»·'}</p>
                    </div>
                    <div id="my-reviews-list" style="display:flex; flex-direction:column; gap:16px;"></div>
                </div>

                <!-- è´¦æˆ·å®‰å…¨é¡µé¢ -->
                <div class="user-page" id="user-security">
                    <h3 data-i18n="security">${t('security') || 'è´¦æˆ·å®‰å…¨'}</h3>

                    <div class="security-section">
                        <h4 data-i18n="changePassword">${t('changePassword') || 'ä¿®æ”¹å¯†ç '}</h4>
                        <form id="change-password-form">
                            <div class="form-group">
                                <label for="current-password" data-i18n="currentPassword">${t('currentPassword') || 'å½“å‰å¯†ç '}</label>
                                <input type="password" id="current-password" class="form-control" data-i18n-placeholder="enterCurrentPassword" placeholder="${t('enterCurrentPassword') || 'è¯·è¾“å…¥å½“å‰å¯†ç '}">
                            </div>
                            <div class="form-group">
                                <label for="new-password" data-i18n="newPassword">${t('newPassword') || 'æ–°å¯†ç '}</label>
                                <input type="password" id="new-password" class="form-control" data-i18n-placeholder="enterNewPassword" placeholder="${t('enterNewPassword') || 'è¯·è¾“å…¥æ–°å¯†ç '}">
                            </div>
                            <div class="form-group">
                                <label for="confirm-password" data-i18n="confirmNewPassword">${t('confirmNewPassword') || 'ç¡®è®¤æ–°å¯†ç '}</label>
                                <input type="password" id="confirm-password" class="form-control"
                                    data-i18n-placeholder="enterNewPasswordAgain" placeholder="${t('enterNewPasswordAgain') || 'è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç '}">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary" data-i18n="changePassword">${t('changePassword') || 'ä¿®æ”¹å¯†ç '}</button>
                            </div>
                        </form>
                    </div>

                    <!-- å®‰å…¨è®¾ç½®éƒ¨åˆ†å·²ç§»é™¤ -->

                    <!-- äº‘ç«¯åŒæ­¥è®¾ç½® - å·²éšè—,ç”¨æˆ·æ— éœ€å…³å¿ƒæŠ€æœ¯ç»†èŠ‚ -->
                    <div class="security-section" style="display:none;">
                        <h4>äº‘ç«¯åŒæ­¥</h4>
                        <div class="security-item">
                            <div class="security-info">
                                <h5>è‡ªåŠ¨åŒæ­¥</h5>
                                <p>è‡ªåŠ¨å°†æ•°æ®åŒæ­¥åˆ°äº‘ç«¯ï¼Œæ”¯æŒå¤šè®¾å¤‡è®¿é—®</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="auto-sync" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="security-item">
                            <div class="security-info">
                                <h5>æ•°æ®åŒæ­¥çŠ¶æ€</h5>
                                <p id="sync-status-text">æœªåŒæ­¥</p>
                            </div>
                            <button class="btn btn-primary" id="manual-sync-btn">
                                <i class="fas fa-sync-alt"></i> ç«‹å³åŒæ­¥
                            </button>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <p style="margin: 0; color: #666; font-size: 14px;">
                                <i class="fas fa-info-circle"></i>
                                äº‘ç«¯åŒæ­¥åŠŸèƒ½å¯ä»¥å°†æ‚¨çš„è®¢å•ã€åœ°å€ç­‰æ•°æ®ä¿å­˜åˆ°äº‘ç«¯ï¼Œ
                                è®©æ‚¨åœ¨ä¸åŒè®¾å¤‡ä¸Šéƒ½èƒ½è®¿é—®ç›¸åŒçš„æ•°æ®ã€‚
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åå°ç®¡ç† -->
        <div class="admin-panel" id="admin-panel">
            <h2 class="section-title">åå°ç®¡ç†ç³»ç»Ÿ</h2>

            <!-- ç®¡ç†å¯¼èˆª -->
            <div class="admin-nav">
                <button class="admin-nav-btn active" data-tab="products">äº§å“ç®¡ç†</button>
                <button class="admin-nav-btn" data-tab="users">ç”¨æˆ·ç®¡ç†</button>
                <button class="admin-nav-btn" data-tab="orders">è®¢å•ç®¡ç†</button>
                <button class="admin-nav-btn" data-tab="reviews">è¯„ä»·ç®¡ç†</button>
                <button class="admin-nav-btn" data-tab="homepage">ä¸»é¡µç®¡ç†</button>
                <button class="admin-nav-btn" data-tab="statistics">æ•°æ®ç»Ÿè®¡</button>
            </div>

            <!-- äº§å“ç®¡ç†é¡µé¢ -->
            <div class="admin-page active" id="admin-products">
                <div class="admin-actions">
                    <button class="btn btn-primary" id="add-product-btn">æ·»åŠ äº§å“</button>
                    <button class="btn btn-secondary" id="excel-upload-btn">Excelæ‰¹é‡ä¸Šä¼ </button>
                    <button class="btn btn-success" id="load-demo-btn" onclick="loadDemoProducts()"
                        style="background: #28a745;">
                        <i class="fas fa-database"></i> åŠ è½½æ¼”ç¤ºæ•°æ®
                    </button>
                    <div style="flex: 1;"></div>
                    <div class="admin-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="admin-product-search" class="admin-search-input"
                            placeholder="æœç´¢äº§å“åç§°/åˆ†ç±»/ID">
                    </div>
                    <label style="margin-right: 15px; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="select-all-products"
                            style="width: 18px; height: 18px; cursor: pointer;">
                        <span>å…¨é€‰</span>
                    </label>
                    <button class="btn btn-warning" id="batch-edit-btn" style="display: none;">æ‰¹é‡ç¼–è¾‘</button>
                    <button class="btn btn-danger" id="batch-delete-btn" style="display: none;">æ‰¹é‡åˆ é™¤</button>
                </div>

                <div class="admin-content">
                    <div class="excel-upload" id="excel-upload-area">
                        <i class="fas fa-file-excel"></i>
                        <h3>ç‚¹å‡»ä¸Šä¼ Excelæ–‡ä»¶</h3>
                        <p>æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼ï¼Œç”¨äºæ‰¹é‡ç¼–è¾‘äº§å“ä¿¡æ¯</p>
                        <p><small>è¯·ç¡®ä¿ExcelåŒ…å«"å›¾ç‰‡URL"åˆ—</small></p>
                        <p><small>æˆ–å°†Excelæ–‡ä»¶æ‹–æ‹½åˆ°æ­¤å¤„</small></p>
                        <input type="file" id="excel-file" accept=".xlsx, .xls" style="display: none;">
                    </div>

                    <div class="products-grid" id="admin-products-grid">
                        <!-- äº§å“ç®¡ç†å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="admin-pagination" id="admin-products-pagination"></div>
                </div>
            </div>

            <!-- ç”¨æˆ·ç®¡ç†é¡µé¢ -->
            <div class="admin-page" id="admin-users">
                <div class="admin-actions">
                    <button class="btn btn-primary" id="refresh-users-btn">åˆ·æ–°ç”¨æˆ·åˆ—è¡¨</button>
                    <button class="btn btn-secondary" id="export-users-btn">å¯¼å‡ºç”¨æˆ·æ•°æ®</button>
                    <button class="btn btn-danger" id="delete-selected-users-btn" style="display: none;">æ‰¹é‡åˆ é™¤è´¦å·</button>
                    <button class="btn btn-danger" id="clear-cloud-users-btn" style="margin-left: auto; background-color: #c0392b; border-color: #c0392b;">
                        æ¸…ç†usersï¼ˆä¿ç•™ä¸allUsersä¸€è‡´ï¼‰
                    </button>
                </div>

                <div class="admin-content">
                    <!-- è®¾å¤‡æ³¨å†Œé™åˆ¶ç®¡ç†åŒºåŸŸ -->
                    <div class="device-limit-section" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 16px; color: #333;">è®¾å¤‡æ³¨å†Œé™åˆ¶ç®¡ç†</h3>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="device-limit-device-input" class="form-control" placeholder="è¾“å…¥è®¾å¤‡ID" style="flex: 1; min-width: 200px;">
                            <input type="number" id="device-limit-value-input" class="form-control" placeholder="æ³¨å†Œé™åˆ¶æ•°é‡" min="0" max="100" value="2" style="width: 150px;">
                            <button class="btn btn-primary" id="set-device-limit-btn">è®¾ç½®é™åˆ¶</button>
                            <button class="btn btn-secondary" id="view-device-limits-btn">æŸ¥çœ‹æ‰€æœ‰é™åˆ¶</button>
                            <button class="btn btn-danger" id="reset-device-limit-btn">é‡ç½®ä¸ºé»˜è®¤(2)</button>
                        </div>
                        <div id="device-limits-list" style="margin-top: 15px; display: none;">
                            <h4 style="font-size: 14px; margin-bottom: 10px;">å½“å‰è®¾å¤‡æ³¨å†Œé™åˆ¶ï¼š</h4>
                            <div id="device-limits-content" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <div class="user-filters">
                        <select id="user-role-filter" class="form-control">
                            <option value="">å…¨éƒ¨è§’è‰²</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                            <option value="user">æ™®é€šç”¨æˆ·</option>
                        </select>
                        <select id="user-status-filter" class="form-control">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="active">æ­£å¸¸</option>
                            <option value="banned">å·²ç¦ç”¨</option>
                        </select>
                        <input type="text" id="user-device-filter" class="form-control" placeholder="æŒ‰è®¾å¤‡å·/æ ‡è®°ç­›é€‰">
                        <input type="text" id="user-search-input" class="form-control" placeholder="æœç´¢ç”¨æˆ·å/è´¦å·/é‚®ç®±/ç”µè¯">
                    </div>

                    <div class="users-table-container">
                        <table class="admin-table" id="users-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-users"></th>
                                    <th>ID</th>
                                    <th>ç”¨æˆ·å</th>
                                    <th>è´¦å·</th>
                                    <th>å¯†ç </th>
                                    <th>è§’è‰²</th>
                                    <th>æ³¨å†Œæ—¶é—´</th>
                                    <th>èœœç½</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- ç”¨æˆ·æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                    <div class="admin-pagination" id="admin-users-pagination"></div>
                </div>
            </div>

            <!-- è®¢å•ç®¡ç†é¡µé¢ -->
            <div class="admin-page" id="admin-orders">
                <div class="admin-actions">
                    <button class="btn btn-primary" id="refresh-orders-btn">åˆ·æ–°è®¢å•åˆ—è¡¨</button>
                    <button class="btn btn-secondary" id="export-orders-btn">å¯¼å‡ºè®¢å•æ•°æ®</button>
                    <button class="btn btn-danger" id="delete-selected-orders-btn" style="display:none;">æ‰¹é‡åˆ é™¤è®¢å•</button>
                </div>

                <div class="admin-content">
                    <div class="order-filters">
                        <select id="order-status-filter" class="form-control">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending">å¾…ä¸Šä¼ </option>
                            <option value="review">å®¡æ ¸ä¸­</option>
                            <option value="shipping">è¿è¾“ä¸­</option>
                            <option value="rejected">å·²é©³å›</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                            <option value="completed">å·²å®Œæˆ</option>
                        </select>
                        <select id="order-search-field" class="form-control">
                            <option value="all">å…¨éƒ¨å­—æ®µ</option>
                            <option value="id">è®¢å•ID</option>
                            <option value="productName">äº§å“åç§°</option>
                            <option value="username">ç”¨æˆ·å</option>
                        </select>
                        <input type="text" id="order-search" class="form-control" placeholder="æœç´¢è®¢å•...">
                    </div>

                    <div class="orders-table-container">
                        <table class="admin-table" id="orders-table">
                            <thead>
                                <tr>
                                    <th style="width:50px; text-align:center;"><input type="checkbox" id="select-all-orders"></th>
                                    <th>è®¢å•ID</th>
                                    <th>äº§å“åç§°</th>
                                    <th>ç”¨æˆ·å</th>
                                    <th>è®¢å•çŠ¶æ€</th>
                                    <th>å¿«é€’å•å·</th>
                                    <th>ä¸‹å•æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                <!-- è®¢å•æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                    <div class="admin-pagination" id="admin-orders-pagination"></div>
                </div>
            </div>

            <!-- è¯„ä»·ç®¡ç†é¡µé¢ -->
            <div class="admin-page" id="admin-reviews">
                <div class="admin-actions">
                    <button class="btn btn-primary" id="refresh-reviews-btn">åˆ·æ–°è¯„ä»·åˆ—è¡¨</button>
                    <div style="flex: 1;"></div>
                    <div class="admin-search">
                        <select id="reviews-filter-category" class="admin-search-input" style="flex: 0 0 120px;">
                            <option value="all">å…¨éƒ¨å­—æ®µ</option>
                            <option value="product">æŒ‰äº§å“</option>
                            <option value="user">æŒ‰ç”¨æˆ·</option>
                            <option value="comment">æŒ‰è¯„ä»·å†…å®¹</option>
                            <option value="rating">æŒ‰è¯„åˆ†</option>
                            <option value="reply">æŒ‰ç®¡ç†å‘˜å›å¤</option>
                        </select>
                        <input
                            type="text"
                            id="reviews-search-input"
                            class="admin-search-input"
                            placeholder="æœç´¢è¯„ä»·ï¼ˆäº§å“å/ç”¨æˆ·/å†…å®¹ç­‰ï¼‰"
                        >
                    </div>
                </div>
                <div class="admin-content">
                    <div class="reviews-table-container">
                        <table class="admin-table" id="reviews-table">
                            <thead>
                                <tr>
                                    <th>è¯„ä»·ID</th>
                                    <th>äº§å“</th>
                                    <th>ç”¨æˆ·</th>
                                    <th>è¯„åˆ†</th>
                                    <th>è¯„ä»·å†…å®¹</th>
                                    <th>ç®¡ç†å‘˜å›å¤</th>
                                    <th>æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="reviews-table-body">
                                <tr><td colspan="8" style="text-align:center; padding:40px;">æš‚æ— è¯„ä»·æ•°æ®</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="admin-pagination" id="admin-reviews-pagination"></div>
                </div>
            </div>

            <!-- ä¸»é¡µç®¡ç†é¡µé¢ -->
            <div class="admin-page" id="admin-homepage">
                <div class="admin-actions">
                    <button class="btn btn-primary" id="preview-homepage-btn">é¢„è§ˆä¸»é¡µ</button>
                    <button class="btn btn-secondary" id="reset-homepage-btn">é‡ç½®ä¸»é¡µ</button>
                    <button class="btn btn-success" id="save-homepage-btn">ä¿å­˜è®¾ç½®</button>
                </div>

                <div class="admin-content">
                    <div class="homepage-editor">
                        <!-- è½®æ’­å›¾ç®¡ç† -->
                        <div class="editor-section">
                            <h3>è½®æ’­å›¾ç®¡ç†</h3>
                            <div class="carousel-manager">
                                <div class="carousel-tabs">
                                    <button type="button" class="carousel-tab active" data-carousel-tab="desktop">PCç«¯è½®æ’­</button>
                                    <button type="button" class="carousel-tab" data-carousel-tab="mobile">ç§»åŠ¨ç«¯è½®æ’­</button>
                                </div>
                                <div class="carousel-panel active" data-carousel-panel="desktop">
                                    <div class="carousel-list" id="carousel-list-desktop">
                                        <!-- PCè½®æ’­å›¾åˆ—è¡¨ -->
                                    </div>
                                    <button class="btn btn-primary" id="add-carousel-btn-desktop">æ·»åŠ PCè½®æ’­å›¾</button>
                                </div>
                                <div class="carousel-panel" data-carousel-panel="mobile">
                                    <div class="carousel-list" id="carousel-list-mobile">
                                        <!-- ç§»åŠ¨ç«¯è½®æ’­å›¾åˆ—è¡¨ -->
                                    </div>
                                    <button class="btn btn-primary" id="add-carousel-btn-mobile">æ·»åŠ ç§»åŠ¨ç«¯è½®æ’­å›¾</button>
                                </div>
                            </div>
                        </div>

                        <!-- ç½‘ç«™ä¿¡æ¯ç®¡ç† -->
                        <div class="editor-section">
                            <h3>ç½‘ç«™ä¿¡æ¯</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="site-title">ç½‘ç«™æ ‡é¢˜</label>
                                    <input type="text" id="site-title" class="form-control" value="ç”µå•†å¹³å°">
                                </div>
                                <div class="form-group">
                                    <label for="site-slogan">ç½‘ç«™æ ‡è¯­</label>
                                    <input type="text" id="site-slogan" class="form-control" value="ä¼˜è´¨å•†å“ï¼Œå€¼å¾—ä¿¡èµ–">
                                </div>
                                <div class="form-group">
                                    <label for="site-logo">ç½‘ç«™Logo URL</label>
                                    <input type="text" id="site-logo" class="form-control"
                                        placeholder="https://example.com/logo.png">
                                </div>
                            </div>
                        </div>

                        <!-- ä¸»é¢˜è®¾ç½® -->
                        <div class="editor-section">
                            <h3>ä¸»é¢˜è®¾ç½®</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="primary-color">ä¸»è‰²è°ƒ</label>
                                    <input type="color" id="primary-color" class="form-control" value="#3498db">
                                </div>
                                <div class="form-group">
                                    <label for="secondary-color">è¾…åŠ©è‰²</label>
                                    <input type="color" id="secondary-color" class="form-control" value="#2ecc71">
                                </div>
                                <div class="form-group">
                                    <label for="font-family">å­—ä½“</label>
                                    <select id="font-family" class="form-control">
                                        <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">ç³»ç»Ÿé»˜è®¤</option>
                                        <option value="'Microsoft YaHei', sans-serif">å¾®è½¯é›…é»‘</option>
                                        <option value="'PingFang SC', sans-serif">è‹¹æ–¹</option>
                                        <option value="'Helvetica Neue', Arial, sans-serif">Helvetica</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- å¸ƒå±€è®¾ç½® -->
                        <div class="editor-section">
                            <h3>å¸ƒå±€è®¾ç½®</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="products-per-row">æ¯è¡Œäº§å“æ•°é‡</label>
                                    <select id="products-per-row" class="form-control">
                                        <option value="3">3ä¸ª</option>
                                        <option value="4" selected>4ä¸ª</option>
                                        <option value="5">5ä¸ª</option>
                                        <option value="6">6ä¸ª</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="show-categories">æ˜¾ç¤ºåˆ†ç±»ç­›é€‰</label>
                                    <input type="checkbox" id="show-categories" class="form-control" checked>
                                </div>
                                <div class="form-group">
                                    <label for="show-search">æ˜¾ç¤ºæœç´¢æ¡†</label>
                                    <input type="checkbox" id="show-search" class="form-control" checked>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®ç»Ÿè®¡é¡µé¢ -->
            <div class="admin-page" id="admin-statistics">
                <div class="admin-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-users">0</h3>
                                <p>æ€»ç”¨æˆ·æ•°</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-products">0</h3>
                                <p>äº§å“æ€»æ•°</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-orders">0</h3>
                                <p>è®¢å•æ€»æ•°</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="pending-orders">0</h3>
                                <p>å¾…å¤„ç†è®¢å•</p>
                            </div>
                        </div>
                    </div>

                    <!-- æ•°æ®åº“å¤‡ä»½/æ¢å¤åŠŸèƒ½ -->
                    <div class="database-backup-section" style="margin-top: 40px; background: #ffffff; border-radius: 4px; padding: 32px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24); border: 1px solid rgba(0, 0, 0, 0.08);">
                        <h3 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 300; color: var(--dark);">æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤</h3>
                        <p style="margin: 0 0 24px 0; color: var(--gray); font-size: 14px; line-height: 1.6;">
                            å¤‡ä»½æ‰€æœ‰ç½‘ç«™æ•°æ®ï¼ˆäº§å“ã€è®¢å•ã€ç”¨æˆ·ã€è®¾ç½®ç­‰ï¼‰åˆ°æœ¬åœ°æ–‡ä»¶ï¼Œæˆ–ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®ã€‚æ­¤æ“ä½œä¼šè¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œã€‚
                        </p>
                        
                        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                            <button id="download-database-btn" class="btn btn-primary" style="flex: 0 0 auto;">
                                <i class="fas fa-download"></i> ä¸‹è½½æ•°æ®åº“å¤‡ä»½
                            </button>
                            <label for="upload-database-input" class="btn btn-secondary" style="flex: 0 0 auto; cursor: pointer; margin: 0;">
                                <i class="fas fa-upload"></i> ä¸Šä¼ æ•°æ®åº“å¤‡ä»½
                                <input type="file" id="upload-database-input" accept=".json" style="display: none;" onchange="handleDatabaseUpload(event)">
                            </label>
                        </div>

                        <div id="database-backup-info" style="margin-top: 24px; padding: 16px; background: var(--primary-light); border-radius: 2px; border-left: 4px solid var(--primary); display: none;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <i class="fas fa-info-circle" style="color: var(--primary); font-size: 18px; margin-top: 2px;"></i>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: var(--dark); margin-bottom: 4px;">å¤‡ä»½ä¿¡æ¯</div>
                                    <div id="database-backup-details" style="font-size: 13px; color: var(--gray); line-height: 1.6;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsAppè”ç³»æŒ‰é’® -->
    <a href="https://wa.me/+17077902826" target="_blank" class="whatsapp-button" title="é€šè¿‡WhatsAppè”ç³»æˆ‘ä»¬">
        <i class="fab fa-whatsapp"></i>
    </a>


    <!-- ç™»å½•/æ³¨å†Œé€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal" id="auth-choice-modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>è¯·å…ˆç™»å½•æˆ–æ³¨å†Œ</h3>
                <button class="close-modal">&times;</button>
                </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <p style="margin-bottom: 30px; color: #666; font-size: 16px;">é¢†å–äº§å“éœ€è¦ç™»å½•è´¦å·ï¼Œè¯·é€‰æ‹©ï¼š</p>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button id="goto-login-btn" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 16px;">
                        <i class="fas fa-sign-in-alt"></i> å·²æœ‰è´¦å·ï¼Œç«‹å³ç™»å½•
                    </button>
                    <button id="goto-register-btn" class="btn btn-secondary" style="width: 100%; padding: 12px; font-size: 16px;">
                        <i class="fas fa-user-plus"></i> æ²¡æœ‰è´¦å·ï¼Œç«‹å³æ³¨å†Œ
                    </button>
                </div>
                </div>
            </div>
            </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç”¨æˆ·ç™»å½•</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-account">æ‰‹æœºå·æˆ–é‚®ç®±</label>
                        <input type="text" id="login-account" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·æˆ–é‚®ç®±" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">å¯†ç </label>
                        <input type="password" id="login-password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ç™»å½•</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal" id="register-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç”¨æˆ·æ³¨å†Œ</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-account">æ‰‹æœºå·æˆ–é‚®ç®±</label>
                        <input type="text" id="register-account" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·æˆ–é‚®ç®±" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">å¯†ç </label>
                        <input type="password" id="register-password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="form-group">
                        <label for="register-confirm">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="register-confirm" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
                            required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æŠ¥åæ¨¡æ€æ¡† -->
    <div class="modal" id="signup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="signup-modal-title">äº§å“æŠ¥å</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- ä¿®æ”¹è¿™é‡Œçš„è¡¨å• -->
                <form id="signup-form" class="signup-form" action="https://formspree.io/f/mrbobwnd" method="POST">
                    <!-- Formspree å¿…è¦å­—æ®µ -->
                    <input type="hidden" name="_subject" value="ğŸ¯ æ–°çš„äº§å“æŠ¥å - ç”µå•†å¹³å°">
                    <input type="hidden" name="_replyto" id="signup-email-input">
                    <input type="hidden" name="_next" value="https://your-domain.com/success.html"> <!-- ä¿®æ”¹ä¸ºä½ çš„æˆåŠŸé¡µé¢ -->

                    <div class="form-group">
                        <label id="signup-product-label">æŠ¥åäº§å“</label>
                        <input type="text" id="signup-product-name" name="äº§å“åç§°" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="signup-email" id="signup-email-label">é‚®ç®±</label>
                        <input type="email" id="signup-email" name="é‚®ç®±" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-address" id="signup-address-label">åœ°å€</label>
                        <div id="signup-address-container">
                            <!-- åœ°å€é€‰æ‹©å™¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            <select id="signup-address-select" name="åœ°å€" class="form-control" style="display: none;">
                                <option value="">è¯·é€‰æ‹©åœ°å€</option>
                            </select>
                            <button type="button" id="signup-address-btn" class="btn btn-primary" style="display: none; width: 100%; margin-top: 10px;">
                                <i class="fas fa-map-marker-alt"></i> <span id="signup-address-btn-text">å‰å¾€ç”¨æˆ·ä¸­å¿ƒæ·»åŠ åœ°å€</span>
                            </button>
                            <input type="hidden" id="signup-address-hidden" name="åœ°å€">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="signup-notes" id="signup-notes-label">å¤‡æ³¨</label>
                        <textarea id="signup-notes" name="å¤‡æ³¨" class="form-control" rows="3"
                            placeholder="è¯·è¾“å…¥æ‚¨çš„ç‰¹æ®Šéœ€æ±‚æˆ–å¤‡æ³¨"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="signup-cancel-btn" onclick="closeModal('signup-modal')">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary" id="signup-submit-btn">æäº¤æŠ¥å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- WhatsAppæç¤ºæ¨¡æ€æ¡† -->
    <div class="modal" id="whatsapp-modal">
        <div class="modal-content whatsapp-modal-content">
            <div class="modal-header" style="background: #25D366;">
                <h3 style="color: white;">Get Your Product!</h3>
                <button class="close-modal" onclick="closeModal('whatsapp-modal')">&times;</button>
            </div>
            <div class="modal-body whatsapp-modal-body">
                <div class="whatsapp-message">
                    <p class="whatsapp-text">Message 'FREE' on WhatsApp to get your product!</p>
                </div>
                <div class="whatsapp-container">
                    <div class="click-here-text">Click here</div>
                    <div class="arrow-container">
                        <div class="arrow">â†’</div>
                    </div>
                    <a href="#" class="whatsapp-icon-link" id="whatsapp-link" onclick="openWhatsAppWithOrder(); return false;">
                        <i class="fab fa-whatsapp whatsapp-icon"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- äº§å“ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="edit-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘äº§å“</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-product-form">
                    <input type="hidden" id="edit-product-id">
                    <div class="form-group">
                        <label for="edit-product-name">äº§å“åç§°</label>
                        <input type="text" id="edit-product-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-price">åŸä»·</label>
                        <input type="number" id="edit-product-price" class="form-control" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-new-price">æ–°ä»·æ ¼ï¼ˆæ˜¾ç¤ºä»·æ ¼ï¼‰</label>
                        <input type="number" id="edit-product-new-price" class="form-control" step="0.01" min="0" value="0" placeholder="é»˜è®¤ä¸º0">
                        <small style="color: #666; font-size: 12px;">æ­¤ä»·æ ¼å°†æ˜¾ç¤ºåœ¨äº§å“é¡µé¢ä¸Šï¼ŒåŸä»·ä¼šæ˜¾ç¤ºåˆ é™¤çº¿</small>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-stock">åº“å­˜</label>
                        <input type="number" id="edit-product-stock" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-category">åˆ†ç±»</label>
                        <select id="edit-product-category" class="form-control" required>
                            <option value="electronics">ç”µå­äº§å“</option>
                            <option value="home">å®¶å±…ç”¨å“</option>
                            <option value="clothing">æœè£…é‹å¸½</option>
                            <option value="beauty">ç¾å¦†æŠ¤è‚¤</option>
                            <option value="sports">è¿åŠ¨æˆ·å¤–</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å›¾ç‰‡URLï¼ˆæœ€å¤š6å¼ ï¼‰</label>
                        <div class="product-image-inputs">
                            <input type="url" id="edit-product-image-1" class="form-control edit-product-image-url" placeholder="å›¾ç‰‡URL 1ï¼ˆå°é¢ï¼‰" required>
                            <input type="url" id="edit-product-image-2" class="form-control edit-product-image-url" placeholder="å›¾ç‰‡URL 2ï¼ˆå¯é€‰ï¼‰">
                            <input type="url" id="edit-product-image-3" class="form-control edit-product-image-url" placeholder="å›¾ç‰‡URL 3ï¼ˆå¯é€‰ï¼‰">
                            <input type="url" id="edit-product-image-4" class="form-control edit-product-image-url" placeholder="å›¾ç‰‡URL 4ï¼ˆå¯é€‰ï¼‰">
                            <input type="url" id="edit-product-image-5" class="form-control edit-product-image-url" placeholder="å›¾ç‰‡URL 5ï¼ˆå¯é€‰ï¼‰">
                            <input type="url" id="edit-product-image-6" class="form-control edit-product-image-url" placeholder="å›¾ç‰‡URL 6ï¼ˆå¯é€‰ï¼‰">
                        </div>
                        <small style="color: #666; font-size: 12px;">ç•™ç©ºçš„è¾“å…¥æ¡†ä¼šè‡ªåŠ¨å¿½ç•¥</small>
                    </div>
                    <div class="form-group">
                        <label for="edit-product-description">äº§å“æè¿°</label>
                        <textarea id="edit-product-description" class="form-control" rows="4" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                        <button type="button" class="btn btn-secondary" id="cancel-edit-btn">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡ç¼–è¾‘äº§å“æ¨¡æ€æ¡† -->
    <div class="modal" id="batch-edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ‰¹é‡ç¼–è¾‘äº§å“</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="batch-edit-form">
                    <div class="alert alert-info"
                        style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                        <i class="fas fa-info-circle"></i>
                        å·²é€‰æ‹© <strong id="batch-edit-count">0</strong> ä¸ªäº§å“ã€‚ç•™ç©ºçš„å­—æ®µå°†ä¸ä¼šè¢«ä¿®æ”¹ã€‚
                    </div>
                    <div class="form-group">
                        <label for="batch-edit-price-action">ä»·æ ¼æ“ä½œ</label>
                        <select id="batch-edit-price-action" class="form-control">
                            <option value="">ä¸ä¿®æ”¹</option>
                            <option value="set">è®¾ç½®ä¸ºå›ºå®šå€¼</option>
                            <option value="increase">å¢åŠ é‡‘é¢</option>
                            <option value="decrease">å‡å°‘é‡‘é¢</option>
                            <option value="multiply">ä¹˜ä»¥å€æ•°</option>
                        </select>
                    </div>
                    <div class="form-group" id="batch-price-value-group" style="display: none;">
                        <label for="batch-edit-price-value">ä»·æ ¼å€¼</label>
                        <input type="number" id="batch-edit-price-value" class="form-control" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="batch-edit-stock-action">åº“å­˜æ“ä½œ</label>
                        <select id="batch-edit-stock-action" class="form-control">
                            <option value="">ä¸ä¿®æ”¹</option>
                            <option value="set">è®¾ç½®ä¸ºå›ºå®šå€¼</option>
                            <option value="increase">å¢åŠ æ•°é‡</option>
                            <option value="decrease">å‡å°‘æ•°é‡</option>
                        </select>
                    </div>
                    <div class="form-group" id="batch-stock-value-group" style="display: none;">
                        <label for="batch-edit-stock-value">åº“å­˜å€¼</label>
                        <input type="number" id="batch-edit-stock-value" class="form-control" min="0">
                    </div>
                    <div class="form-group">
                        <label for="batch-edit-category">ä¿®æ”¹åˆ†ç±»</label>
                        <select id="batch-edit-category" class="form-control">
                            <option value="">ä¸ä¿®æ”¹</option>
                            <option value="electronics">ç”µå­äº§å“</option>
                            <option value="home">å®¶å±…ç”¨å“</option>
                            <option value="clothing">æœè£…é‹å¸½</option>
                            <option value="beauty">ç¾å¦†æŠ¤è‚¤</option>
                            <option value="sports">è¿åŠ¨æˆ·å¤–</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">åº”ç”¨ä¿®æ”¹</button>
                        <button type="button" class="btn btn-secondary close-modal">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- åœ°å€ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="address-modal">
        <div class="modal-content" style="max-width: 600px; margin: 20px auto; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="border-bottom: 1px solid #ddd; padding: 20px 30px 15px 30px;">
                <h3 id="address-modal-title" style="font-size: 24px; font-weight: 600; margin: 0;">Add a new address</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px 30px;">
                <form id="address-form">
                    <input type="hidden" id="address-id">
                    <input type="hidden" id="address-country" value="US">
                    
                    <!-- å›½å®¶/åœ°åŒºï¼ˆå›ºå®šä¸ºç¾å›½ï¼Œä¸å¯é€‰æ‹©ï¼‰ -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Country/Region</label>
                        <div style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background: #f5f5f5; color: #333;">
                            United States
                    </div>
                    </div>

                    <!-- å…¨å -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="address-name" style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Full name (First and Last name)</label>
                        <input type="text" id="address-name" class="form-control" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>

                    <!-- ç”µè¯å·ç  -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="address-phone" data-i18n="phone" style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Phone number</label>
                        <div class="phone-input-wrapper">
                            <span class="phone-prefix">+1</span>
                            <input type="tel" id="address-phone" class="phone-input" required maxlength="10" placeholder="1234567890" style="font-size: 14px;">
                        </div>
                        <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">May be used to assist delivery</small>
                    </div>

                    <!-- è¡—é“åœ°å€ -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="address-detail" style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Street address</label>
                        <input type="text" id="address-detail" class="form-control" required placeholder="Street address or P.O. Box" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>

                    <!-- å•å…ƒ/å¥—æˆ¿å· -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="address-unit" style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Unit or suite number</label>
                        <input type="text" id="address-unit" class="form-control" placeholder="Apt, suite, unit, building, floor, etc." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>

                    <!-- åŸå¸‚ -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="address-city" style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">City</label>
                        <input type="text" id="address-city" class="form-control" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>

                    <!-- å·å’Œé‚®ç¼–ï¼ˆåŒä¸€è¡Œï¼‰ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                            <label for="address-state" style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">State</label>
                            <select id="address-state" class="form-control" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <option value="">Select</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                            </select>
                    </div>
                    <div class="form-group">
                            <label for="address-postal" style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">ZIP Code</label>
                            <input type="text" id="address-postal" class="form-control" required pattern="[0-9]{5}(-[0-9]{4})?" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                    </div>

                    <!-- è®¾ä¸ºé»˜è®¤åœ°å€ -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="address-default" style="margin-right: 8px; width: 18px; height: 18px;">
                            <span style="font-size: 14px;">Make this my default address</span>
                        </label>
                    </div>

                    <!-- æäº¤æŒ‰é’® -->
                    <div class="form-actions" style="margin-top: 30px; padding-bottom: 10px;">
                        <button type="submit" class="btn btn-primary" style="background: #FFD814; border: none; color: #000; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%;">Add address</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ========== å·¥å…·å‡½æ•°åº“ ==========
        // localStorage å·¥å…·å‡½æ•° - ç»Ÿä¸€å¤„ç† JSON åºåˆ—åŒ–å’Œé”™è¯¯å¤„ç†
        const Storage = {
            get(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error(`è¯»å– localStorage[${key}] å¤±è´¥:`, error);
                    return defaultValue;
                }
            },
            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    console.error(`å†™å…¥ localStorage[${key}] å¤±è´¥:`, error);
                    // å¦‚æœå­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•æ¸…ç†æ—§æ•°æ®
                    if (error.name === 'QuotaExceededError') {
                        console.warn('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•æ¸…ç†ç¼“å­˜...');
                        this.clearCache();
                        try {
                            localStorage.setItem(key, JSON.stringify(value));
                            return true;
                        } catch (e) {
                            console.error('æ¸…ç†åä»æ— æ³•å†™å…¥:', e);
                        }
                    }
                    return false;
                }
            },
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error(`åˆ é™¤ localStorage[${key}] å¤±è´¥:`, error);
                    return false;
                }
            },
            clearCache() {
                // æ¸…ç†ç¼“å­˜æ•°æ®ï¼Œä¿ç•™é‡è¦æ•°æ®
                const importantKeys = ['currentUser', 'allUsers', 'deviceRegisterLimits', 'language'];
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('cache_') && !importantKeys.includes(key)) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
            }
        };

        // DOM æŸ¥è¯¢ç¼“å­˜
        const DOMCache = {
            cache: new Map(),
            get(selector, useCache = true) {
                if (useCache && this.cache.has(selector)) {
                    const cached = this.cache.get(selector);
                    if (document.contains(cached)) {
                        return cached;
                    }
                    this.cache.delete(selector);
                }
                const element = document.querySelector(selector);
                if (element && useCache) {
                    this.cache.set(selector, element);
                }
                return element;
            },
            getAll(selector) {
                return document.querySelectorAll(selector);
            },
            clear() {
                this.cache.clear();
            }
        };

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait, immediate = false) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    timeout = null;
                    if (!immediate) func.apply(this, args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(this, args);
            };
        }

        // èŠ‚æµå‡½æ•°
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // å®‰å…¨çš„ HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å®‰å…¨çš„å±æ€§è®¾ç½®
        function setSafeAttribute(element, attr, value) {
            if (element && value != null) {
                element.setAttribute(attr, String(value));
            }
        }

        // æ‰¹é‡ DOM æ“ä½œä¼˜åŒ–
        function batchDOMUpdate(callback) {
            if (document.createDocumentFragment) {
                const fragment = document.createDocumentFragment();
                callback(fragment);
                return fragment;
            }
            return callback(null);
        }

        function resetPagination(key) {
            if (paginationState[key]) {
                paginationState[key].page = 1;
            }
        }

        function getPaginatedItems(items = [], key) {
            const state = paginationState[key];
            if (!state) {
                return { items, totalItems: items.length, totalPages: 1 };
            }

            const totalItems = items.length;
            const totalPages = totalItems === 0 ? 1 : Math.ceil(totalItems / state.pageSize);

            if (totalItems === 0) {
                state.page = 1;
                return { items: [], totalItems, totalPages };
            }

            if (state.page > totalPages) {
                state.page = totalPages;
            }
            if (state.page < 1) {
                state.page = 1;
            }

            const startIndex = (state.page - 1) * state.pageSize;
            const paginatedItems = items.slice(startIndex, startIndex + state.pageSize);
            return { items: paginatedItems, totalItems, totalPages };
        }

        function updatePaginationControls(key, totalItems, onPageChange) {
            const containerId = paginationContainers[key];
            const container = containerId ? document.getElementById(containerId) : null;
            const state = paginationState[key];

            if (!container || !state) return;

            const totalPages = totalItems === 0 ? 1 : Math.ceil(totalItems / state.pageSize);
            if (totalItems === 0) {
                state.page = 1;
            } else if (state.page > totalPages) {
                state.page = totalPages;
            }

            container.innerHTML = `
                <div class="pagination-info">
                    ${totalItems === 0 ? 'æš‚æ— æ•°æ®' : `å…± ${totalItems} æ¡ Â· ç¬¬ ${state.page} / ${totalPages} é¡µ`}
                </div>
                <div class="pagination-actions">
                    <button type="button" data-direction="prev" ${state.page <= 1 || totalItems === 0 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                    <button type="button" data-direction="next" ${state.page >= totalPages || totalItems === 0 ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                </div>
            `;

            container.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const direction = btn.getAttribute('data-direction');
                    if (direction === 'prev' && state.page > 1) {
                        state.page--;
                    } else if (direction === 'next' && state.page < totalPages) {
                        state.page++;
                    } else {
                        return;
                    }

                    if (typeof onPageChange === 'function') {
                        onPageChange();
                    }
                });
            });
        }

        // ========== æ•°æ®å­˜å‚¨ - å§‹ç»ˆä»äº‘ç«¯åŠ è½½æœ€æ–°æ•°æ® ==========
        // æ³¨æ„:ä¸å†ä»localStorageåˆå§‹åŒ–æ•°æ®,è€Œæ˜¯åœ¨ç™»å½•åä»äº‘ç«¯åŒæ­¥
        // è¿™ç¡®ä¿ç”¨æˆ·å§‹ç»ˆè·å–æœ€æ–°çš„äº‘ç«¯æ•°æ®,é¿å…æœ¬åœ°ç¼“å­˜è¿‡æœŸé—®é¢˜

let products = [];  // äº§å“æ•°æ®å°†åœ¨ç™»å½•åä»äº‘ç«¯åŠ è½½
let userOrders = [];  // å½“å‰ç”¨æˆ·çš„è®¢å•æ•°æ®
let allOrders = [];  // æ‰€æœ‰ç”¨æˆ·çš„è®¢å•æ•°æ®ï¼ˆç”¨äºåå°ç®¡ç†ï¼‰
let userAddresses = [];  // åœ°å€æ•°æ®å°†åœ¨ç™»å½•åä»äº‘ç«¯åŠ è½½
let userProfile = {};  // ç”¨æˆ·èµ„æ–™å°†åœ¨ç™»å½•åä»äº‘ç«¯åŠ è½½
let allUsers = [];  // æ‰€æœ‰ç”¨æˆ·æ•°æ®(ä»…ç®¡ç†å‘˜ä½¿ç”¨,ä»äº‘ç«¯åŠ è½½)
// è®¾å¤‡æ³¨å†Œé™åˆ¶é…ç½®ï¼š{ deviceId: limit }ï¼Œé»˜è®¤é™åˆ¶ä¸º2
let deviceRegisterLimits = Storage.get('deviceRegisterLimits', {});
const DEFAULT_DEVICE_REGISTER_LIMIT = 2; // é»˜è®¤æ¯ä¸ªè®¾å¤‡æœ€å¤šæ³¨å†Œ2ä¸ªè´¦å·
let currentProduct = null;
let pendingSignupProduct = null; // è®°å½•å¾…é¢†å–çš„äº§å“ï¼ˆç”¨æˆ·ç™»å½•åéœ€è¦æ‰“å¼€æŠ¥åæ¨¡æ€æ¡†ï¼‰
let pendingSignupFormData = null; // è®°å½•ç”¨æˆ·å·²å¡«å†™çš„æŠ¥åè¡¨å•æ•°æ®
let shouldReturnToSignup = false; // æ·»åŠ åœ°å€åæ˜¯å¦éœ€è¦è¿”å›æŠ¥åè¡¨å•
let currentUser = Storage.get('currentUser', null);
const selectedUserAccounts = new Set(); // åå°ç”¨æˆ·æ‰¹é‡æ“ä½œé€‰æ‹©é›†åˆ
const selectedOrderIds = new Set(); // åå°è®¢å•æ‰¹é‡æ“ä½œé€‰æ‹©é›†åˆ
let userFilterRole = '';
let userFilterStatus = '';
let userDeviceFilter = '';
let userSearchTerm = '';
let adminProductSearchTerm = '';
let reviewSearchTerm = '';
let reviewSearchCategory = 'all';
const paginationState = {
    products: { page: 1, pageSize: 30 },
    users: { page: 1, pageSize: 10 },
    orders: { page: 1, pageSize: 10 },
    reviews: { page: 1, pageSize: 10 }
};
const paginationContainers = {
    products: 'admin-products-pagination',
    users: 'admin-users-pagination',
    orders: 'admin-orders-pagination',
    reviews: 'admin-reviews-pagination'
};
        
        // åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
        function isCurrentUserAdmin() {
            return !!(currentUser && currentUser.role === 'admin');
        }

        function refreshCurrentUserSnapshot(targetAccount) {
            if (!currentUser || currentUser.role === 'admin') return;
            const account = targetAccount || currentUser.account;
            if (!account || !Array.isArray(allUsers) || allUsers.length === 0) return;
            const latestUser = allUsers.find(u => u.account === account);
            if (!latestUser) return;
            
            // ä¿å­˜æ›´æ–°å‰çš„çŠ¶æ€ç”¨äºå¯¹æ¯”
            const previousStatus = currentUser.status;
            const previousPoints = currentUser.points;
            const previousUsername = currentUser.username;
            
            // æ›´æ–° currentUser å¯¹è±¡ï¼ˆä¿ç•™ roleï¼Œå› ä¸ºç®¡ç†å‘˜è´¦å·ä¸åœ¨ allUsers ä¸­ï¼‰
            currentUser = {
                ...currentUser,
                ...latestUser,
                role: currentUser.role || latestUser.role || 'user'
            };
            saveCurrentUser();
            
            // å¦‚æœçŠ¶æ€ã€ç§¯åˆ†æˆ–ç”¨æˆ·åå‘ç”Ÿå˜åŒ–ï¼Œè®°å½•æ—¥å¿—
            if (previousStatus !== latestUser.status) {
                console.log(`ğŸ”„ ç”¨æˆ·çŠ¶æ€å·²æ›´æ–°: ${previousStatus} -> ${latestUser.status}`);
            }
            if (previousPoints !== latestUser.points) {
                console.log(`ğŸ”„ ç”¨æˆ·ç§¯åˆ†å·²æ›´æ–°: ${previousPoints} -> ${latestUser.points}`);
            }
            if (previousUsername !== latestUser.username) {
                console.log(`ğŸ”„ ç”¨æˆ·åå·²æ›´æ–°: ${previousUsername} -> ${latestUser.username}`);
            }
        }

        // è¯­è¨€è®¾ç½®
        let currentLanguage = localStorage.getItem('language') || 'en';
        
        // è¯­è¨€åŒ…
        const translations = {
            zh: {
                // å¯¼èˆª
                'navHome': 'é¦–é¡µ',
                'admin': 'åå°ç®¡ç†',
                'userCenter': 'ç”¨æˆ·ä¸­å¿ƒ',
                'login': 'ç™»å½•',
                'register': 'æ³¨å†Œ',
                'logout': 'é€€å‡º',
                'searchPlaceholder': 'æœç´¢å•†å“...',
                // è´§å¸
                'currency': '$',
                'currencySymbol': '$',
                // é¦–é¡µ
                'featuredTitle': 'ç²¾é€‰å¥½ç‰©æ¨è',
                'featuredDesc': 'æˆ‘ä»¬å®æ—¶æŒ‘é€‰çƒ­åº¦æœ€é«˜çš„å•†å“ï¼Œå¹¶æä¾›ä¸“å±é¢†å–é€šé“ï¼Œç‚¹å‡»å³å¯å¿«é€ŸæŸ¥çœ‹è¯¦æƒ…ã€‚',
                'newArrival': 'æ–°å“ä¸Šå¸‚',
                'newArrivalDesc': 'æ¢ç´¢æˆ‘ä»¬æœ€æ–°çš„äº§å“ç³»åˆ—ï¼Œäº«å—é™æ—¶ä¼˜æƒ ',
                'limitedOffer': 'é™æ—¶ç‰¹æƒ ',
                'limitedOfferDesc': 'ç²¾é€‰å•†å“ä½è‡³5æŠ˜ï¼Œé”™è¿‡å†ç­‰ä¸€å¹´',
                'buyNow': 'ç«‹å³è´­ä¹°',
                'viewDetails': 'æŸ¥çœ‹è¯¦æƒ…',
                'viewDetail': 'ç‚¹å‡»è¯¦æƒ…',
                'claimNow': 'ç‚¹å‡»é¢†å–',
                'stock': 'åº“å­˜',
                'pieces': 'ä»¶',
                'noProducts': 'æš‚æ— å•†å“',
                'registerNow': 'ç«‹å³æŠ¥å',
                'returnToList': 'è¿”å›åˆ—è¡¨',
                // åˆ†ç±»
                'allProducts': 'å…¨éƒ¨å•†å“',
                'electronics': 'ç”µå­äº§å“',
                'home': 'å®¶å±…ç”¨å“',
                'clothing': 'æœè£…é‹å¸½',
                'beauty': 'ç¾å¦†æŠ¤è‚¤',
                // è®¢å•çŠ¶æ€
                'orderAll': 'å…¨éƒ¨è®¢å•',
                'orderReview': 'å¾…ä¸Šä¼ ',
                'orderShipping': 'è¿è¾“ä¸­',
                'orderRejected': 'å·²é©³å›',
                'orderCancelled': 'å·²å–æ¶ˆ',
                'orderCompleted': 'å·²å®Œæˆ',
                'noOrders': 'æš‚æ— æŠ¥åè®°å½•',
                'noReviewOrders': 'æš‚æ— å¾…ä¸Šä¼ è®¢å•',
                'noShippingOrders': 'æš‚æ— è¿è¾“ä¸­è®¢å•',
                'noCompletedOrders': 'æš‚æ— å·²å®Œæˆè®¢å•',
                'noRejectedOrders': 'æš‚æ— å·²é©³å›è®¢å•',
                'noCancelledOrders': 'æš‚æ— å·²å–æ¶ˆè®¢å•',
                'cancelOrder': 'å–æ¶ˆè®¢å•',
                'confirmCancelOrder': 'ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—ï¼Ÿ',
                'orderCancelled': 'è®¢å•å·²å–æ¶ˆ',
                // è®¢å•è¯¦æƒ…
                'orderDetails': 'è®¢å•è¯¦æƒ…',
                'orderId': 'è®¢å•ID',
                'orderStatus': 'è®¢å•çŠ¶æ€',
                'allStatus': 'å…¨éƒ¨çŠ¶æ€',
                'orderTime': 'ä¸‹å•æ—¶é—´',
                'trackingNumber': 'å¿«é€’å•å·',
                'trackingNumberPlaceholder': 'è¯·è¾“å…¥å¿«é€’å•å·',
                'trackingNumberInfo': 'æ‚¨å¯ä»¥é€šè¿‡å¿«é€’å•å·åœ¨å¿«é€’å…¬å¸å®˜ç½‘æŸ¥è¯¢ç‰©æµä¿¡æ¯',
                'trackPackage': 'Track package',
                'notFilled': 'æœªå¡«å†™',
                'save': 'ä¿å­˜',
                'edit': 'ç¼–è¾‘',
                'copy': 'å¤åˆ¶',
                'copyOrderId': 'å¤åˆ¶è®¢å•å·',
                'orderIdCopied': 'è®¢å•å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
                'customerInfo': 'å®¢æˆ·ä¿¡æ¯',
                'expressInfo': 'å¿«é€’ä¿¡æ¯',
                'trackingNumberSaved': 'å¿«é€’å•å·å·²ä¿å­˜',
                'trackingNumberUpdated': 'å¿«é€’å•å·å·²æ›´æ–°',
                'enterTrackingNumber': 'è¯·è¾“å…¥å¿«é€’å•å·ï¼š',
                'updateOrderStatus': 'æ›´æ–°è®¢å•çŠ¶æ€',
                'noTrackingInfo': 'æš‚æ— ç‰©æµä¿¡æ¯',
                'orderInfo': 'è®¢å•ä¿¡æ¯',
                'currentStatus': 'å½“å‰çŠ¶æ€',
                'selectNewStatus': 'é€‰æ‹©æ–°çŠ¶æ€',
                'confirmStatusUpdate': 'ç¡®å®šè¦å°†è®¢å•çŠ¶æ€æ›´æ–°ä¸º',
                'statusUpdated': 'è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º',
                'price': 'ä»·æ ¼',
                'orderNotFound': 'æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯',
                // ç”¨æˆ·ä¸­å¿ƒ
                'myOrders': 'æˆ‘çš„æŠ¥å',
                'profile': 'ä¸ªäººä¿¡æ¯',
                'address': 'æ”¶è´§åœ°å€',
                'security': 'è´¦æˆ·å®‰å…¨',
                'regularMember': 'æ™®é€šä¼šå‘˜',
                'points': 'èœœç½',
                'pointsBalance': 'å½“å‰èœœç½',
                'pointsNotEnoughForClaim': 'æ‚¨çš„èœœç½ä¸è¶³ï¼Œæ— æ³•é¢†å–æ–°äº§å“ã€‚è¯·å®Œæˆè¯„ä»·ä»¥è·å–æ›´å¤šèœœç½ã€‚',
                'pointsNotEnoughForSubmit': 'æ‚¨çš„èœœç½ä¸è¶³ï¼Œæ— æ³•å®Œæˆæœ¬æ¬¡é¢†å–ã€‚è¯·å®Œæˆè¯„ä»·ä»¥è·å–æ›´å¤šèœœç½ã€‚',
                'pointsClaimUsed': 'æœ¬æ¬¡é¢†å–å·²æ¶ˆè€— 1 ä¸ªèœœç½',
                'pointsReviewReward': 'è¯„ä»·å¥–åŠ±ï¼šèœœç½ +2',
                'duplicateClaimNotAllowed': 'æ‚¨å·²ç»é¢†å–è¿‡è¯¥å•†å“ï¼Œä¸èƒ½é‡å¤é¢†å–ã€‚',
                'productAlreadyClaimed': 'è¿™ä¸ªäº§å“å·²ç»é¢†å–è¿‡å•¦ï¼Œå¿«å»çœ‹çœ‹å…¶å®ƒå¥½ç‰©å§ï¼',
                'deviceRegisterLimitReached': 'å·²ç»æœ‰è´¦æˆ·å•¦ï¼Œå¿«å»ç™»å½•è´¦æˆ·é¢†å–å¥½ç‰©å§ï¼',
                'username': 'ç”¨æˆ·å',
                'account': 'è´¦å·',
                'nickname': 'æ˜µç§°',
                'enterNickname': 'è¯·è¾“å…¥æ˜µç§°',
                'enterPhone': 'è¯·è¾“å…¥æ‰‹æœºå·',
                'usPhoneHint': 'è¯·è¾“å…¥ç¾å›½æ‰‹æœºå·ï¼ˆ+1å¼€å¤´çš„10ä½æ•°å­—ï¼‰',
                'email': 'é‚®ç®±',
                'enterEmail': 'è¯·è¾“å…¥é‚®ç®±',
                'birthday': 'ç”Ÿæ—¥',
                'gender': 'æ€§åˆ«',
                'pleaseSelect': 'è¯·é€‰æ‹©',
                'male': 'ç”·',
                'female': 'å¥³',
                'other': 'å…¶ä»–',
                'saveChanges': 'ä¿å­˜ä¿®æ”¹',
                'changePassword': 'ä¿®æ”¹å¯†ç ',
                'currentPassword': 'å½“å‰å¯†ç ',
                'enterCurrentPassword': 'è¯·è¾“å…¥å½“å‰å¯†ç ',
                'newPassword': 'æ–°å¯†ç ',
                'enterNewPassword': 'è¯·è¾“å…¥æ–°å¯†ç ',
                'confirmNewPassword': 'ç¡®è®¤æ–°å¯†ç ',
                'enterNewPasswordAgain': 'è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ',
                'securitySettings': 'å®‰å…¨è®¾ç½®',
                'loginProtection': 'ç™»å½•ä¿æŠ¤',
                'loginProtectionDesc': 'å¼€å¯åï¼Œç™»å½•æ—¶éœ€è¦éªŒè¯æ‰‹æœºå·',
                // åœ°å€
                'yourAddresses': 'æ”¶è´§åœ°å€',
                'addAddress': 'æ·»åŠ åœ°å€',
                'goToAddressPage': 'å‰å¾€ç”¨æˆ·ä¸­å¿ƒæ·»åŠ åœ°å€',
                'noAddresses': 'æš‚æ— æ”¶è´§åœ°å€',
                // å…¶ä»–
                'loading': 'æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...',
                'loadComplete': 'åŠ è½½å®Œæˆï¼',
                'syncStatus': 'å®æ—¶åˆ·æ–° Â· äº‘ç«¯åŒæ­¥',
                // äº§å“æŠ¥å
                'productRegistration': 'äº§å“æŠ¥å',
                'registeredProduct': 'æŠ¥åäº§å“',
                'name': 'å§“å',
                'phone': 'ç”µè¯',
                'email': 'é‚®ç®±',
                'address': 'åœ°å€',
                'notes': 'å¤‡æ³¨',
                'notesPlaceholder': 'è¯·è¾“å…¥æ‚¨çš„ç‰¹æ®Šéœ€æ±‚æˆ–å¤‡æ³¨',
                'submitRegistration': 'æäº¤æŠ¥å',
                'cancel': 'å–æ¶ˆ',
                // æç¤ºä¿¡æ¯
                'pleaseLogin': 'è¯·å…ˆç™»å½•',
                'passwordChangedSuccess': 'å¯†ç ä¿®æ”¹æˆåŠŸï¼è¯·ç‰¢è®°æ–°å¯†ç ',
                'currentPasswordIncorrect': 'å½“å‰å¯†ç é”™è¯¯',
                'passwordMismatch': 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´',
                'passwordTooShort': 'æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½',
                'pleaseFillAllFields': 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯',
                'adminPasswordCannotChange': 'ç®¡ç†å‘˜å¯†ç ä¸å…è®¸ä¿®æ”¹ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜',
                'userNotFound': 'æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯',
                'userLogin': 'ç”¨æˆ·ç™»å½•',
                'userRegister': 'ç”¨æˆ·æ³¨å†Œ',
                'phoneOrEmail': 'æ‰‹æœºå·æˆ–é‚®ç®±',
                'enterPhoneOrEmail': 'è¯·è¾“å…¥æ‰‹æœºå·æˆ–é‚®ç®±',
                'password': 'å¯†ç ',
                'enterPassword': 'è¯·è¾“å…¥å¯†ç ',
                'confirmPassword': 'ç¡®è®¤å¯†ç ',
                'enterPasswordAgain': 'è¯·å†æ¬¡è¾“å…¥å¯†ç ',
                'pleaseLoginOrRegister': 'è¯·å…ˆç™»å½•æˆ–æ³¨å†Œ',
                'loginRequired': 'é¢†å–äº§å“éœ€è¦ç™»å½•è´¦å·ï¼Œè¯·é€‰æ‹©ï¼š',
                'haveAccount': 'å·²æœ‰è´¦å·ï¼Œç«‹å³ç™»å½•',
                'noAccount': 'æ²¡æœ‰è´¦å·ï¼Œç«‹å³æ³¨å†Œ',
                'insufficientPermissions': 'æƒé™ä¸è¶³ï¼Œåªæœ‰ç®¡ç†å‘˜æ‰èƒ½è®¿é—®åå°ç®¡ç†',
                'pleaseFillCompleteInfo': 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯',
                'passwordMismatch': 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼',
                'passwordTooShort': 'å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½',
                'registrationSuccess': 'æ³¨å†ŒæˆåŠŸï¼',
                'accountOrPasswordError': 'è´¦å·æˆ–å¯†ç é”™è¯¯ï¼',
                'productNameRequired': 'äº§å“åç§°ä¸èƒ½ä¸ºç©º',
                'productPriceRequired': 'è¯·è¾“å…¥æœ‰æ•ˆçš„äº§å“ä»·æ ¼ï¼ˆå¿…é¡»å¤§äº0ï¼‰',
                'productImageRequired': 'äº§å“å›¾ç‰‡URLä¸èƒ½ä¸ºç©º',
                'productAddFailed': 'äº§å“æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•',
                'productNotFound': 'äº§å“ä¸å­˜åœ¨',
                'productUpdateSuccess': 'âœ… äº§å“æ›´æ–°æˆåŠŸï¼',
                'productUpdateFailed': 'âŒ æ›´æ–°å¤±è´¥ï¼šæœªæ‰¾åˆ°äº§å“',
                'systemError': 'ç³»ç»Ÿé”™è¯¯ï¼šæœªæ‰¾åˆ°äº§å“ä¿¡æ¯',
                'errorTitle': 'é”™è¯¯',
                'successTitle': 'æˆåŠŸ',
                'infoTitle': 'æç¤º',
                'confirmTitle': 'ç¡®è®¤',
                'profileSaveSuccess': 'ä¸ªäººä¿¡æ¯ä¿å­˜æˆåŠŸï¼',
                'pleaseUploadExcel': 'è¯·ä¸Šä¼ Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xls æ ¼å¼ï¼‰',
                'invalidPhoneFormat': 'è¯·è¾“å…¥æ­£ç¡®çš„ç¾å›½æ‰‹æœºå·ï¼ˆ+1å¼€å¤´çš„10ä½æ•°å­—ï¼‰',
                'invalidEmailFormat': 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼',
                'importDataSaveError': 'âŒ å¯¼å…¥å¤±è´¥ï¼šæ•°æ®ä¿å­˜å‡ºé”™',
                'confirmLoadDemo': 'ç¡®å®šè¦åŠ è½½æ¼”ç¤ºäº§å“æ•°æ®å—ï¼Ÿè¿™å°†æ·»åŠ 6ä¸ªæ¼”ç¤ºäº§å“ã€‚',
                'confirmClearCache': 'ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
                'confirmClearCloud': 'ç¡®å®šè¦æ¸…ç©ºäº‘ç«¯æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
                'cannotBeNegative': 'ä¸èƒ½ä¸ºè´Ÿæ•°',
                // è¯„ä»·
                'writeReview': 'å†™è¯„ä»·',
                'myReview': 'æˆ‘çš„è¯„ä»·',
                'reviews': 'è¯„ä»·',
                'noReviews': 'æš‚æ— è¯„ä»·',
                'rating': 'è¯„åˆ†',
                'comment': 'è¯„ä»·å†…å®¹',
                'commentPlaceholder': 'è¯·åˆ†äº«æ‚¨å¯¹äº§å“çš„ä½¿ç”¨ä½“éªŒ...',
                'submitReview': 'æäº¤è¯„ä»·',
                'reviewSubmitted': 'è¯„ä»·å·²æäº¤ï¼Œæ„Ÿè°¢æ‚¨çš„åé¦ˆï¼',
                'reviewThankYou': 'æ„Ÿè°¢æ‚¨åœ¨ BeeFreebies ç•™ä¸‹è¯„ä»·ï¼æˆ‘ä»¬éå¸¸æ„Ÿæ¿€ã€‚',
                'reply': 'å›å¤',
                'replyPlaceholder': 'è¯·è¾“å…¥æ‚¨çš„å›å¤å†…å®¹',
                'replySuccess': 'å›å¤å·²æäº¤',
                'reviewExists': 'æ‚¨å·²ç»è¯„ä»·è¿‡æ­¤è®¢å•äº†',
                'reviewTime': 'è¯„ä»·æ—¶é—´',
                'adminReply': 'ç®¡ç†å‘˜å›å¤',
                'replyReview': 'å›å¤è¯„ä»·',
                'deleteReview': 'åˆ é™¤è¯„ä»·',
                'deleteOrder': 'åˆ é™¤è®¢å•',
                'customerReplies': 'ç”¨æˆ·å›å¤',
                'purchasedProduct': 'è´­ä¹°å•†å“',
                'customerName': 'å®¢æˆ·',
                'stars': 'æ˜Ÿ',
                'reviewRequired': 'è¯·å¡«å†™è¯„ä»·å†…å®¹',
                'ratingRequired': 'è¯·é€‰æ‹©è¯„åˆ†',
                'ok': 'ç¡®å®š',
                'cancel': 'å–æ¶ˆ',
                'confirm': 'ç¡®è®¤',
                'noticeTitle': 'æç¤º',
                'outOfHoneyTitle': 'èœœç½ä¸è¶³',
                'balance': 'ä½™é¢',
                'writeReviewToEarnHoney': 'å®Œæˆè¯„ä»·å¯è·å¾—èœœç½ã€‚',
                'contactSupportForHelp': 'è”ç³»æ”¯æŒè·å–å¸®åŠ©ã€‚',
                'honey': 'èœœç½',
                // ç™»å½•/æ³¨å†Œç›¸å…³
                'accountNotExists': 'è´¦å·ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è´¦å·æ˜¯å¦æ­£ç¡®æˆ–å…ˆæ³¨å†Œ',
                'accountExists': 'è´¦å·å·²å­˜åœ¨',
                'accountDisabled': 'è´¦å·è¢«ç¦ç”¨',
                'loginFailed': 'ç™»å½•å¤±è´¥',
                'loginFailedRetry': 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
                'registerFailed': 'æ³¨å†Œå¤±è´¥',
                'registerFailedRetry': 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
                'pleaseEnterAccount': 'è¯·è¾“å…¥è´¦å·',
                'accountMinLength': 'è´¦å·é•¿åº¦è‡³å°‘ä¸º3ä¸ªå­—ç¬¦',
                'pleaseConfirmPassword': 'è¯·ç¡®è®¤å¯†ç ',
                'passwordMinLength': 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦',
                'passwordMismatchRetry': 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥',
                'passwordFormatError': 'å¯†ç åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦(@$!%*#?&)ï¼Œé•¿åº¦è‡³å°‘6ä½',
                'pleaseEnterAtLeastOneImage': 'è¯·è‡³å°‘è¾“å…¥ä¸€å¼ äº§å“å›¾ç‰‡URL',
                'deleteFailedProductNotFound': 'åˆ é™¤å¤±è´¥ï¼šæœªæ‰¾åˆ°å¯¹åº”äº§å“æ•°æ®',
                'confirmDeleteProduct': 'ç¡®å®šè¦åˆ é™¤äº§å“ "{name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼',
                'productDataError': 'äº§å“æ•°æ®é”™è¯¯',
                'noProductDataDetected': 'æœªæ£€æµ‹åˆ°å¯å¯¼å…¥çš„äº§å“æ•°æ®ï¼Œè¯·æ£€æŸ¥è¡¨å¤´æ˜¯å¦åŒ…å«"äº§å“åç§°"å’Œ"å›¾ç‰‡URL"ã€‚',
                'parseFailed': 'è§£æå¤±è´¥',
                'checkExcelFormat': 'è¯·æ£€æŸ¥Excelæ ¼å¼åé‡è¯•',
                'readFailed': 'è¯»å–å¤±è´¥',
                'fileReadError': 'æ–‡ä»¶è¯»å–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚',
                // ç”¨æˆ·ç®¡ç†ç›¸å…³
                'confirmResetUserData': 'ç¡®å®šè¦é‡ç½®æ­¤ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤ç”¨æˆ·çš„è®¢å•ã€åœ°å€ç­‰ä¿¡æ¯ï¼',
                'userDataReset': 'ç”¨æˆ·æ•°æ®å·²é‡ç½®',
                'confirmBanUser': 'ç¡®å®šè¦ç¦ç”¨æ­¤ç”¨æˆ·å—ï¼Ÿç¦ç”¨åè¯¥ç”¨æˆ·å°†æ— æ³•ç™»å½•ç³»ç»Ÿã€‚',
                'userBanned': 'ç”¨æˆ·å·²ç¦ç”¨',
                'confirmUnbanUser': 'ç¡®å®šè¦è§£ç¦æ­¤ç”¨æˆ·å—ï¼Ÿ',
                'userUnbanned': 'ç”¨æˆ·å·²è§£ç¦',
                'userNotExists': 'ç”¨æˆ·ä¸å­˜åœ¨',
                'confirmDeleteUser': 'âš ï¸ è­¦å‘Šï¼šæ‚¨å³å°†å½»åº•åˆ é™¤ç”¨æˆ·è´¦å·ï¼\n\nç”¨æˆ·ä¿¡æ¯ï¼š\nè´¦å·ï¼š{account}\nç”¨æˆ·åï¼š{username}\næ³¨å†Œæ—¶é—´ï¼š{registerTime}\n\næ­¤æ“ä½œå°†åˆ é™¤ï¼š\nâœ“ ç”¨æˆ·è´¦å·\nâœ“ æ‰€æœ‰è®¢å•è®°å½•\nâœ“ æ”¶è´§åœ°å€\nâœ“ ä¸ªäººèµ„æ–™\n\nâš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
                'finalConfirmDelete': 'æœ€åç¡®è®¤ï¼šè¯·è¾“å…¥ç”¨æˆ·è´¦å· "{account}" ä»¥ç¡®è®¤åˆ é™¤\n\nâš ï¸ è¾“å…¥é”™è¯¯å°†å–æ¶ˆåˆ é™¤æ“ä½œ',
                'accountInputMismatch': 'è´¦å·è¾“å…¥ä¸åŒ¹é…ï¼Œåˆ é™¤æ“ä½œå·²å–æ¶ˆ',
                'userDeletedSuccess': 'âœ… ç”¨æˆ·è´¦å· "{account}" åŠæ‰€æœ‰ç›¸å…³æ•°æ®å·²å½»åº•åˆ é™¤\nåˆ é™¤äº† {orders} ä¸ªè®¢å•å’Œ {addresses} ä¸ªåœ°å€',
                'deleteUserFailed': 'åˆ é™¤ç”¨æˆ·å¤±è´¥',
                'accountDeletedByAdmin': 'æ‚¨çš„è´¦å·å·²è¢«ç®¡ç†å‘˜åˆ é™¤',
                'loggedOutByOtherDevice': 'ä½ çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œæœ¬è®¾å¤‡çš„æ•°æ®å·²åŒæ­¥è‡³äº‘ç«¯å¹¶è‡ªåŠ¨é€€å‡ºã€‚',
                'pleaseSelectAccountsToDelete': 'è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„è´¦å·',
                'confirmDeleteSelectedAccounts': 'ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ {count} ä¸ªè´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
                'deletingAccounts': 'æ­£åœ¨æ‰¹é‡åˆ é™¤è´¦å·ï¼Œè¯·ç¨å€™...',
                'batchDeleteComplete': 'æ‰¹é‡åˆ é™¤å®Œæˆ',
                'pleaseLoginBeforeDeletion': 'è¯·å…ˆç™»å½•åå†è¿›è¡Œè´¦å·æ³¨é”€',
                'confirmDeleteSelfAccount': 'ç¡®å®šè¦æ³¨é”€å½“å‰è´¦å·å—ï¼Ÿè¯¥æ“ä½œä¼šåˆ é™¤æ‰€æœ‰è®¢å•ã€åœ°å€ä¸ä¸ªäººèµ„æ–™ï¼Œä¸”æ— æ³•æ¢å¤ã€‚',
                'finalConfirmDeleteSelf': 'è¯·è¾“å…¥è´¦å· "{account}" ä»¥ç¡®è®¤æ³¨é”€',
                'accountInputMismatchCancel': 'è´¦å·è¾“å…¥ä¸åŒ¹é…ï¼Œæ“ä½œå·²å–æ¶ˆ',
                'accountDeletedSuccess': 'è´¦å·å·²æˆåŠŸæ³¨é”€',
                'deleteAccountFailed': 'æ³¨é”€å¤±è´¥',
                // è®¢å•ç®¡ç†ç›¸å…³
                'noOrdersToDelete': 'æœªæ‰¾åˆ°è¦åˆ é™¤çš„è®¢å•',
                'confirmDeleteSelectedOrders': 'ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ {count} ä¸ªè®¢å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
                'confirmDeleteOrder': 'ç¡®å®šè¦åˆ é™¤è®¢å• {orderLabel} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
                'confirmDeleteReview': 'ç¡®å®šè¦åˆ é™¤è¯¥æ¡è¯„ä»·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
                // äº§å“ç®¡ç†ç›¸å…³
                'confirmDeleteSelectedProducts': 'ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹ {count} ä¸ªäº§å“å—ï¼Ÿ\n\n{productNames}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼',
                // è½®æ’­å›¾ç›¸å…³
                'confirmDeleteCarousel': 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ª{targetLabel}è½®æ’­å›¾å—ï¼Ÿ',
                'confirmResetHomepageSettings': 'ç¡®å®šè¦é‡ç½®æ‰€æœ‰ä¸»é¡µè®¾ç½®å—ï¼Ÿè¿™å°†æ¢å¤é»˜è®¤é…ç½®ã€‚',
                // åŠ è½½æç¤º
                'checkingURLSync': 'æ£€æŸ¥URLåŒæ­¥æ•°æ®...',
                'initializingCloudSync': 'åˆå§‹åŒ–äº‘ç«¯åŒæ­¥...',
                'connectingCloudDatabase': 'è¿æ¥äº‘ç«¯æ•°æ®åº“...',
                'loadingCloudData': 'åŠ è½½äº‘ç«¯æ•°æ®...',
                'cloudSyncTimeout': 'äº‘ç«¯åŒæ­¥è¶…æ—¶...',
                'firebaseNotLoaded': 'FirebaseæœªåŠ è½½...',
                'renderingPage': 'æ¸²æŸ“é¡µé¢å†…å®¹...',
                'loadFailed': 'åŠ è½½å¤±è´¥',
                'testing': 'æµ‹è¯•ä¸­...',
                'statusConnected': 'çŠ¶æ€ï¼šè¿æ¥æ­£å¸¸',
                'statusDisconnected': 'çŠ¶æ€ï¼šæœªè¿æ¥',
                'statusConnectionFailed': 'çŠ¶æ€ï¼šè¿æ¥å¤±è´¥',
                'testCloudConnection': 'æµ‹è¯•äº‘ç«¯è¿æ¥',
                'syncing': 'åŒæ­¥ä¸­...',
                'forceSyncData': 'å¼ºåˆ¶åŒæ­¥æ•°æ®',
                'clearingCloudUsers': 'æ­£åœ¨æ¸…ç†äº‘ç«¯ users...',
                'testingConnection': 'æ­£åœ¨æµ‹è¯•...',
                'connectionSuccess': 'è¿æ¥æˆåŠŸ',
                'cannotReadLocalData': 'æ— æ³•è¯»å–æœ¬åœ°æ•°æ®',
                'logCleared': 'æ—¥å¿—å·²æ¸…ç©º',
                'pleaseSelectAddress': 'è¯·é€‰æ‹©åœ°å€',
                'noUserData': 'æš‚æ— ç”¨æˆ·æ•°æ®',
                'noMatchingUsers': 'æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·',
                'noOrderData': 'æš‚æ— è®¢å•æ•°æ®',
                'noReviewData': 'æš‚æ— è¯„ä»·æ•°æ®',
                'systemDefaultPassword': 'ç³»ç»Ÿé¢„è®¾å¯†ç ',
                'hidePassword': 'éšè—å¯†ç ',
                'showPassword': 'æ˜¾ç¤ºå¯†ç ',
                'operationFailed': 'æ“ä½œå¤±è´¥',
                'noCarouselPC': 'æš‚æ— PCç«¯è½®æ’­å›¾',
                'noCarouselMobile': 'æš‚æ— ç§»åŠ¨ç«¯è½®æ’­å›¾',
                'noProductsAddOrImport': 'æš‚æ— å•†å“ï¼Œè¯·æ·»åŠ æˆ–å¯¼å…¥å•†å“',
                'batchEdit': 'æ‰¹é‡ç¼–è¾‘',
                'batchDelete': 'æ‰¹é‡åˆ é™¤',
                'lastSync': 'ä¸Šæ¬¡åŒæ­¥ï¼š{timeAgo}',
                'waitingFirstSync': 'ç­‰å¾…é¦–æ¬¡åŒæ­¥...',
                'cloudSyncNotEnabled': 'äº‘ç«¯åŒæ­¥æœªå¯ç”¨',
                'editCarouselPC': 'ç¼–è¾‘PCç«¯è½®æ’­å›¾',
                'editCarouselMobile': 'ç¼–è¾‘ç§»åŠ¨ç«¯è½®æ’­å›¾',
                'addCarouselPC': 'æ·»åŠ PCç«¯è½®æ’­å›¾',
                'addCarouselMobile': 'æ·»åŠ ç§»åŠ¨ç«¯è½®æ’­å›¾',
                'editProduct': 'ç¼–è¾‘äº§å“',
                'addProduct': 'æ·»åŠ äº§å“',
                'confirmLoadDemoData': 'ç¡®è®¤åŠ è½½ç¤ºä¾‹æ•°æ®',
                'confirmClearCache': 'ç¡®è®¤æ¸…é™¤ç¼“å­˜',
                // æ•°æ®åº“å¤‡ä»½æ¢å¤ç›¸å…³
                'databaseBackupFailed': 'æ•°æ®åº“å¤‡ä»½å¤±è´¥ï¼š{error}',
                'pleaseUploadJSONFile': 'è¯·ä¸Šä¼ JSONæ ¼å¼çš„å¤‡ä»½æ–‡ä»¶',
                'databaseRestoredSuccess': 'æ•°æ®åº“å·²æˆåŠŸæ¢å¤ï¼',
                'databaseRestoreFailed': 'æ•°æ®åº“æ¢å¤å¤±è´¥ï¼š{error}',
                'dataRestoreFailed': 'æ•°æ®æ¢å¤å¤±è´¥ï¼Œé¡µé¢å¯èƒ½éœ€è¦åˆ·æ–°',
                'readBackupFileFailed': 'è¯»å–å¤‡ä»½æ–‡ä»¶å¤±è´¥ï¼š{error}',
                'readFileFailed': 'è¯»å–æ–‡ä»¶å¤±è´¥',
                // äº‘ç«¯åŒæ­¥ç›¸å…³
                'cloudSyncNotEnabledError': 'äº‘ç«¯åŒæ­¥æœªå¯ç”¨ï¼Œæ— æ³•æ“ä½œäº‘ç«¯ç”¨æˆ·æ•°æ®',
                'onlyAdminCanOperate': 'åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œ',
                'cloudAllUsersEmpty': 'äº‘ç«¯ allUsers ä¸ºç©ºï¼Œå‡ºäºå®‰å…¨è€ƒè™‘å·²è·³è¿‡ users æ¸…ç†ã€‚',
                'clearCloudUsersFailed': 'æ¸…ç†äº‘ç«¯ users å¤±è´¥ï¼š{error}',
                // ç”¨æˆ·ç®¡ç†ç›¸å…³
                'enterNewPassword': 'è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰ï¼š',
                'passwordTooShortError': 'å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½',
                // è®¢å•çŠ¶æ€ç›¸å…³
                'confirmStatusUpdateSuffix': 'å—ï¼Ÿ',
                'updatingOrderStatus': 'æ­£åœ¨æ›´æ–°è®¢å•çŠ¶æ€å¹¶åŒæ­¥åˆ°äº‘ç«¯...',
                // äº§å“ç®¡ç†ç›¸å…³
                'pleaseFillAllRequiredFields': 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ',
                'carouselUpdated': 'è½®æ’­å›¾å·²æ›´æ–°',
                'mobileCarouselAdded': 'ç§»åŠ¨ç«¯è½®æ’­å›¾å·²æ·»åŠ ',
                'pcCarouselAdded': 'PCç«¯è½®æ’­å›¾å·²æ·»åŠ ',
                'pleaseEnterProductName': 'è¯·è¾“å…¥äº§å“åç§°',
                'pleaseEnterValidPrice': 'è¯·è¾“å…¥æœ‰æ•ˆçš„äº§å“ä»·æ ¼',
                'productUpdated': 'äº§å“å·²æ›´æ–°',
                'productUpdateFailedError': 'äº§å“æ›´æ–°å¤±è´¥',
                'productAddedSuccess': 'äº§å“æ·»åŠ æˆåŠŸï¼ID: {id}',
                'productAddFailedError': 'äº§å“æ·»åŠ å¤±è´¥',
                'replyContentCannotBeEmpty': 'å›å¤å†…å®¹ä¸èƒ½ä¸ºç©º',
                'reviewNotFound': 'æœªæ‰¾åˆ°è¯¥è®¢å•å¯¹åº”çš„è¯„ä»·',
                'passwordIncorrect': 'å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥',
                'importProductsSuccess': 'æˆåŠŸå¯¼å…¥ {count} ä¸ªäº§å“ï¼'
            },
            en: {
                // å¯¼èˆª
                'navHome': 'Home',
                'admin': 'Admin Panel',
                'userCenter': 'Account',
                'login': 'Login',
                'register': 'Register',
                'logout': 'Logout',
                'searchPlaceholder': 'Search products...',
                // è´§å¸
                'currency': '$',
                'currencySymbol': '$',
                // é¦–é¡µ
                'featuredTitle': 'Featured Recommendations',
                'featuredDesc': 'We select the hottest products in real-time and provide exclusive claim channels. Click to view details quickly.',
                'newArrival': 'New Arrivals',
                'newArrivalDesc': 'Explore our latest product series and enjoy limited-time offers',
                'limitedOffer': 'Limited Time Offer',
                'limitedOfferDesc': 'Selected items up to 50% off, don\'t miss out',
                'buyNow': 'Buy Now',
                'viewDetails': 'View Details',
                'viewDetail': 'View Details',
                'claimNow': 'Claim Now',
                'stock': 'Stock',
                'pieces': 'pieces',
                'noProducts': 'No products available',
                'registerNow': 'Register Now',
                'returnToList': 'Return to List',
                // åˆ†ç±»
                'allProducts': 'All Products',
                'electronics': 'Electronics',
                'home': 'Home & Living',
                'clothing': 'Clothing & Shoes',
                'beauty': 'Beauty & Skincare',
                // è®¢å•çŠ¶æ€
                'orderAll': 'All Orders',
                'orderReview': 'Pending',
                'orderShipping': 'Shipping',
                'orderRejected': 'Rejected',
                'orderCancelled': 'Cancelled',
                'orderCompleted': 'Completed',
                'noOrders': 'No orders yet',
                'noReviewOrders': 'No pending orders',
                'noShippingOrders': 'No shipping orders',
                'noCompletedOrders': 'No completed orders',
                'noRejectedOrders': 'No rejected orders',
                'noCancelledOrders': 'No cancelled orders',
                'cancelOrder': 'Cancel Order',
                'confirmCancelOrder': 'Are you sure you want to cancel this order?',
                'orderCancelled': 'Order cancelled',
                // è®¢å•è¯¦æƒ…
                'orderDetails': 'Order Details',
                'orderId': 'Order ID',
                'orderStatus': 'Order Status',
                'allStatus': 'All Status',
                'orderTime': 'Order Time',
                'trackingNumber': 'Tracking Number',
                'trackingNumberPlaceholder': 'Please enter tracking number',
                'trackingNumberInfo': 'You can query logistics information on the express company\'s official website using the tracking number',
                'trackPackage': 'Track package',
                'notFilled': 'Not filled',
                'save': 'Save',
                'edit': 'Edit',
                'copy': 'Copy',
                'copyOrderId': 'Copy Order ID',
                'orderIdCopied': 'Order ID copied to clipboard',
                'customerInfo': 'Customer Information',
                'expressInfo': 'Express Information',
                'trackingNumberSaved': 'Tracking number saved',
                'trackingNumberUpdated': 'Tracking number updated',
                'enterTrackingNumber': 'Please enter tracking number:',
                'updateOrderStatus': 'Update Order Status',
                'noTrackingInfo': 'No tracking information',
                'orderInfo': 'Order Information',
                'currentStatus': 'Current Status',
                'selectNewStatus': 'Select New Status',
                'confirmStatusUpdate': 'Are you sure you want to update the order status to',
                'statusUpdated': 'Order status updated to',
                'price': 'Price',
                'orderNotFound': 'Order not found',
                // ç”¨æˆ·ä¸­å¿ƒ
                'myOrders': 'My Orders',
                'profile': 'Profile',
                'address': 'Shipping Address',
                'security': 'Account Security',
                'regularMember': 'Regular Member',
                'points': 'Honey',
                'pointsBalance': 'Honey Balance',
                'pointsNotEnoughForClaim': 'You do not have enough honey to claim a new product. Please complete a review to earn more honey.',
                'pointsNotEnoughForSubmit': 'You do not have enough honey to complete this claim. Please complete a review to earn more honey.',
                'pointsClaimUsed': 'This claim has used 1 honey',
                'pointsReviewReward': 'Review reward: +2 honey',
                'duplicateClaimNotAllowed': 'You have already claimed this product. Duplicate claims are not allowed.',
                'productAlreadyClaimed': 'You have already claimed this product. Check out other great items!',
                'deviceRegisterLimitReached': 'You already have an account. Please log in to claim items!',
                'username': 'Username',
                'account': 'Account',
                'nickname': 'Nickname',
                'enterNickname': 'Please enter nickname',
                'enterPhone': 'Please enter phone number',
                'usPhoneHint': 'US number only (+1 followed by 10 digits)',
                'email': 'Email',
                'enterEmail': 'Please enter email',
                'birthday': 'Birthday',
                'gender': 'Gender',
                'pleaseSelect': 'Please select',
                'male': 'Male',
                'female': 'Female',
                'other': 'Other',
                'saveChanges': 'Save Changes',
                'changePassword': 'Change Password',
                'currentPassword': 'Current Password',
                'enterCurrentPassword': 'Please enter current password',
                'newPassword': 'New Password',
                'enterNewPassword': 'Please enter new password',
                'confirmNewPassword': 'Confirm New Password',
                'enterNewPasswordAgain': 'Please enter new password again',
                'securitySettings': 'Security Settings',
                'loginProtection': 'Login Protection',
                'loginProtectionDesc': 'When enabled, phone verification is required for login',
                // åœ°å€
                'yourAddresses': 'Your Addresses',
                'addAddress': 'Add Address',
                'goToAddressPage': 'Go to User Center to Add Address',
                'noAddresses': 'No addresses saved',
                // å…¶ä»–
                'loading': 'Loading data, please wait...',
                'loadComplete': 'Load Complete!',
                'syncStatus': 'Real-time Refresh Â· Cloud Sync',
                // äº§å“æŠ¥å
                'productRegistration': 'Product Registration',
                'registeredProduct': 'Registered Product',
                'name': 'Name',
                'phone': 'Phone',
                'email': 'Email',
                'address': 'Address',
                'notes': 'Notes',
                'notesPlaceholder': 'Please enter your special requirements or notes',
                'submitRegistration': 'Submit Registration',
                'cancel': 'Cancel',
                // æç¤ºä¿¡æ¯
                'pleaseLogin': 'Please login first',
                'passwordChangedSuccess': 'Password changed successfully! Please remember your new password',
                'currentPasswordIncorrect': 'Current password is incorrect',
                'passwordMismatch': 'The two new passwords do not match',
                'passwordTooShort': 'New password must be at least 6 characters',
                'pleaseFillAllFields': 'Please fill in all fields',
                'adminPasswordCannotChange': 'Admin password cannot be changed. Please contact system administrator',
                'userNotFound': 'User information not found',
                'userLogin': 'User Login',
                'userRegister': 'User Registration',
                'phoneOrEmail': 'Phone number or email',
                'enterPhoneOrEmail': 'Please enter phone number or email',
                'password': 'Password',
                'enterPassword': 'Please enter password',
                'confirmPassword': 'Confirm Password',
                'enterPasswordAgain': 'Please enter password again',
                'pleaseLoginOrRegister': 'Please login or register first',
                'loginRequired': 'You need to login to claim products. Please choose:',
                'haveAccount': 'I have an account, login now',
                'noAccount': 'I don\'t have an account, register now',
                'insufficientPermissions': 'Insufficient permissions. Only administrators can access the admin panel.',
                'pleaseFillCompleteInfo': 'Please fill in complete information',
                'passwordMismatch': 'The two passwords do not match!',
                'passwordTooShort': 'Password must be at least 6 characters',
                'registrationSuccess': 'Registration successful!',
                'accountOrPasswordError': 'Incorrect account or password!',
                'productNameRequired': 'Product name cannot be empty',
                'productPriceRequired': 'Please enter a valid product price (must be greater than 0)',
                'productImageRequired': 'Product image URL cannot be empty',
                'productAddFailed': 'Failed to add product, please try again',
                'productNotFound': 'Product not found',
                'productUpdateSuccess': 'âœ… Product updated successfully!',
                'productUpdateFailed': 'âŒ Update failed: Product not found',
                'systemError': 'System error: Product information not found',
                'errorTitle': 'Error',
                'successTitle': 'Success',
                'infoTitle': 'Notice',
                'confirmTitle': 'Confirm',
                'profileSaveSuccess': 'Profile saved successfully!',
                'pleaseUploadExcel': 'Please upload an Excel file (.xlsx or .xls)',
                'invalidPhoneFormat': 'Please enter a valid US phone number (+1 followed by 10 digits)',
                'invalidEmailFormat': 'Please enter a valid email address',
                'importDataSaveError': 'âŒ Import failed: error while saving data',
                'confirmLoadDemo': 'Are you sure you want to load demo product data? This will add 6 demo products.',
                'confirmClearCache': 'Are you sure you want to clear all local cache data? This operation cannot be undone!',
                'confirmClearCloud': 'Are you sure you want to clear all cloud data? This operation cannot be undone!',
                'cannotBeNegative': 'cannot be negative',
                // è¯„ä»·
                'writeReview': 'Write Review',
                'myReview': 'My Review',
                'reviews': 'Reviews',
                'noReviews': 'No reviews yet',
                'rating': 'Rating',
                'comment': 'Review',
                'commentPlaceholder': 'Please share your experience with this product...',
                'submitReview': 'Submit Review',
                'reviewSubmitted': 'Review submitted, thank you for your feedback!',
                'reviewThankYou': 'Thanks for leaving a review on Beefreebies! We appreciate it.',
                'reply': 'Reply',
                'replyPlaceholder': 'Please enter your reply',
                'replySuccess': 'Reply submitted',
                'reviewExists': 'You have already reviewed this order',
                'reviewTime': 'Review Time',
                'adminReply': 'Admin Reply',
                'replyReview': 'Reply',
                'deleteReview': 'Delete Review',
                'deleteOrder': 'Delete Order',
                'customerReplies': 'Customer Replies',
                'purchasedProduct': 'Purchased Product',
                'customerName': 'Customer',
                'stars': 'stars',
                'reviewRequired': 'Please enter your review',
                'ratingRequired': 'Please select a rating',
                // ç™»å½•/æ³¨å†Œç›¸å…³
                'accountNotExists': 'Account does not exist. Please check if the account is correct or register first',
                'accountExists': 'Account already exists',
                'accountDisabled': 'Account disabled',
                'loginFailed': 'Login failed',
                'loginFailedRetry': 'Login failed, please try again later',
                'registerFailed': 'Registration failed',
                'registerFailedRetry': 'Registration failed, please try again later',
                'pleaseEnterAccount': 'Please enter account',
                'accountMinLength': 'Account must be at least 3 characters',
                'pleaseConfirmPassword': 'Please confirm password',
                'passwordMinLength': 'Password must be at least 6 characters',
                'passwordMismatchRetry': 'The two passwords do not match, please re-enter',
                'passwordFormatError': 'Password can only contain letters, numbers and special characters (@$!%*#?&), at least 6 characters',
                'pleaseEnterAtLeastOneImage': 'Please enter at least one product image URL',
                'deleteFailedProductNotFound': 'Delete failed: Product data not found',
                'confirmDeleteProduct': 'Are you sure you want to delete product "{name}"? This operation cannot be undone!',
                'productDataError': 'Product data error',
                'noProductDataDetected': 'No product data detected. Please check if the header contains "Product Name" and "Image URL".',
                'parseFailed': 'Parse failed',
                'checkExcelFormat': 'Please check Excel format and try again',
                'readFailed': 'Read failed',
                'fileReadError': 'An error occurred while reading the file. Please try again.',
                // ç”¨æˆ·ç®¡ç†ç›¸å…³
                'confirmResetUserData': 'Are you sure you want to reset all data for this user? This will delete the user\'s orders, addresses and other information!',
                'userDataReset': 'User data has been reset',
                'confirmBanUser': 'Are you sure you want to ban this user? Banned users will not be able to log in to the system.',
                'userBanned': 'User has been banned',
                'confirmUnbanUser': 'Are you sure you want to unban this user?',
                'userUnbanned': 'User has been unbanned',
                'userNotExists': 'User does not exist',
                'confirmDeleteUser': 'âš ï¸ Warning: You are about to permanently delete a user account!\n\nUser Information:\nAccount: {account}\nUsername: {username}\nRegistration Time: {registerTime}\n\nThis operation will delete:\nâœ“ User account\nâœ“ All order records\nâœ“ Shipping addresses\nâœ“ Personal information\n\nâš ï¸ This operation cannot be undone! Are you sure you want to continue?',
                'finalConfirmDelete': 'Final confirmation: Please enter user account "{account}" to confirm deletion\n\nâš ï¸ Entering incorrectly will cancel the deletion operation',
                'accountInputMismatch': 'Account input does not match, deletion operation cancelled',
                'userDeletedSuccess': 'âœ… User account "{account}" and all related data have been permanently deleted\nDeleted {orders} orders and {addresses} addresses',
                'deleteUserFailed': 'Failed to delete user',
                'accountDeletedByAdmin': 'Your account has been deleted by the administrator',
                'loggedOutByOtherDevice': 'Your account has been logged in on another device. This device has synced data to the cloud and logged out automatically.',
                'pleaseSelectAccountsToDelete': 'Please select accounts to delete first',
                'confirmDeleteSelectedAccounts': 'Are you sure you want to delete the selected {count} accounts? This operation cannot be undone.',
                'deletingAccounts': 'Deleting accounts in batch, please wait...',
                'batchDeleteComplete': 'Batch deletion completed',
                'pleaseLoginBeforeDeletion': 'Please login before account deletion',
                'confirmDeleteSelfAccount': 'Are you sure you want to delete your current account? This operation will delete all orders, addresses and personal information, and cannot be recovered.',
                'finalConfirmDeleteSelf': 'Please enter account "{account}" to confirm deletion',
                'accountInputMismatchCancel': 'Account input does not match, operation cancelled',
                'accountDeletedSuccess': 'Account successfully deleted',
                'deleteAccountFailed': 'Account deletion failed',
                // è®¢å•ç®¡ç†ç›¸å…³
                'noOrdersToDelete': 'No orders found to delete',
                'confirmDeleteSelectedOrders': 'Are you sure you want to delete the selected {count} orders? This operation cannot be undone.',
                'confirmDeleteOrder': 'Are you sure you want to delete order {orderLabel}? This operation cannot be undone.',
                'confirmDeleteReview': 'Are you sure you want to delete this review? This operation cannot be undone.',
                // äº§å“ç®¡ç†ç›¸å…³
                'confirmDeleteSelectedProducts': 'Are you sure you want to delete the following {count} products?\n\n{productNames}\n\nThis operation cannot be undone!',
                // è½®æ’­å›¾ç›¸å…³
                'confirmDeleteCarousel': 'Are you sure you want to delete this {targetLabel} carousel?',
                'confirmResetHomepageSettings': 'Are you sure you want to reset all homepage settings? This will restore default configuration.',
                // åŠ è½½æç¤º
                'checkingURLSync': 'Checking URL sync data...',
                'initializingCloudSync': 'Initializing cloud sync...',
                'connectingCloudDatabase': 'Connecting to cloud database...',
                'loadingCloudData': 'Loading cloud data...',
                'cloudSyncTimeout': 'Cloud sync timeout...',
                'firebaseNotLoaded': 'Firebase not loaded...',
                'renderingPage': 'Rendering page content...',
                'loadFailed': 'Load failed',
                'testing': 'Testing...',
                'statusConnected': 'Status: Connected',
                'statusDisconnected': 'Status: Disconnected',
                'statusConnectionFailed': 'Status: Connection failed',
                'testCloudConnection': 'Test cloud connection',
                'syncing': 'Syncing...',
                'forceSyncData': 'Force sync data',
                'clearingCloudUsers': 'Clearing cloud users...',
                'testingConnection': 'Testing connection...',
                'connectionSuccess': 'Connection successful',
                'cannotReadLocalData': 'Cannot read local data',
                'logCleared': 'Log cleared',
                'pleaseSelectAddress': 'Please select address',
                'noUserData': 'No user data',
                'noMatchingUsers': 'No matching users found',
                'noOrderData': 'No order data',
                'noReviewData': 'No review data',
                'systemDefaultPassword': 'System default password',
                'hidePassword': 'Hide password',
                'showPassword': 'Show password',
                'operationFailed': 'Operation failed',
                'noCarouselPC': 'No PC carousel',
                'noCarouselMobile': 'No mobile carousel',
                'noProductsAddOrImport': 'No products, please add or import products',
                'batchEdit': 'Batch edit',
                'batchDelete': 'Batch delete',
                'lastSync': 'Last sync: {timeAgo}',
                'waitingFirstSync': 'Waiting for first sync...',
                'cloudSyncNotEnabled': 'Cloud sync not enabled',
                'editCarouselPC': 'Edit PC carousel',
                'editCarouselMobile': 'Edit mobile carousel',
                'addCarouselPC': 'Add PC carousel',
                'addCarouselMobile': 'Add mobile carousel',
                'editProduct': 'Edit product',
                'addProduct': 'Add product',
                'confirmLoadDemoData': 'Confirm load demo data',
                'confirmClearCache': 'Confirm clear cache',
                // æ•°æ®åº“å¤‡ä»½æ¢å¤ç›¸å…³
                'databaseBackupFailed': 'Database backup failed: {error}',
                'pleaseUploadJSONFile': 'Please upload a JSON format backup file',
                'databaseRestoredSuccess': 'Database restored successfully!',
                'databaseRestoreFailed': 'Database restore failed: {error}',
                'dataRestoreFailed': 'Data restore failed, page may need to be refreshed',
                'readBackupFileFailed': 'Failed to read backup file: {error}',
                'readFileFailed': 'Failed to read file',
                // äº‘ç«¯åŒæ­¥ç›¸å…³
                'cloudSyncNotEnabledError': 'Cloud sync not enabled, cannot operate cloud user data',
                'onlyAdminCanOperate': 'Only administrators can perform this operation',
                'cloudAllUsersEmpty': 'Cloud allUsers is empty, skipped users cleanup for security reasons.',
                'clearCloudUsersFailed': 'Failed to clear cloud users: {error}',
                // ç”¨æˆ·ç®¡ç†ç›¸å…³
                'enterNewPassword': 'Please enter new password (at least 6 characters):',
                'passwordTooShortError': 'Password must be at least 6 characters',
                // è®¢å•çŠ¶æ€ç›¸å…³
                'confirmStatusUpdateSuffix': '?',
                'updatingOrderStatus': 'Updating order status and syncing to cloud...',
                // äº§å“ç®¡ç†ç›¸å…³
                'pleaseFillAllRequiredFields': 'Please fill in all required fields',
                'carouselUpdated': 'Carousel updated',
                'mobileCarouselAdded': 'Mobile carousel added',
                'pcCarouselAdded': 'PC carousel added',
                'pleaseEnterProductName': 'Please enter product name',
                'pleaseEnterValidPrice': 'Please enter a valid product price',
                'productUpdated': 'Product updated',
                'productUpdateFailedError': 'Product update failed',
                'productAddedSuccess': 'Product added successfully! ID: {id}',
                'productAddFailedError': 'Product add failed',
                'replyContentCannotBeEmpty': 'Reply content cannot be empty',
                'reviewNotFound': 'Review not found for this order',
                'passwordIncorrect': 'Password incorrect, please re-enter',
                'importProductsSuccess': 'Successfully imported {count} products!'
            }
        };
        
        // è·å–ç¿»è¯‘æ–‡æœ¬
        function t(key) {
            if (!translations || !key) return key;
            const lang = translations[currentLanguage];
            if (lang && lang[key]) return lang[key];
            const zhLang = translations['zh'];
            if (zhLang && zhLang[key]) return zhLang[key];
            return key;
        }
        
        // æ ¼å¼åŒ–è´§å¸
        function formatCurrency(amount) {
            return `$${parseFloat(amount || 0).toFixed(2)}`;
        }

        const PRODUCT_IMAGE_PLACEHOLDER = 'https://via.placeholder.com/600x600?text=No+Image';

        function getProductImageUrls(product) {
            if (!product) return [];
            const urls = [];

            // 1) æ–°ç»“æ„ï¼šimageUrls æ•°ç»„ï¼ˆæŒ‰é¡ºåºä¿ç•™ï¼Œä¸å»é‡ï¼‰
            if (Array.isArray(product.imageUrls)) {
                product.imageUrls.forEach(url => {
                    const normalized = (url || '').trim();
                    if (normalized) {
                        urls.push(normalized);
                    }
                });
            }

            // 2) å…¼å®¹æ—§ç»“æ„ï¼šimageUrl1 ~ imageUrl6ï¼ˆå¦‚æœæ•°ç»„é‡Œæ²¡å¡«æ»¡ï¼Œå°±ç»§ç»­è¡¥ï¼‰
            for (let i = 1; i <= 6 && urls.length < 6; i++) {
                const key = `imageUrl${i}`;
                if (product[key]) {
                    const normalized = (product[key] || '').trim();
                    if (normalized) {
                        urls.push(normalized);
                    }
                }
            }

            // 3) å†å…¼å®¹æœ€è€çš„ image å­—æ®µï¼ˆåªåœ¨å‰é¢éƒ½æ²¡å†…å®¹æ—¶æ‰ç”¨å°é¢å›¾ï¼‰
            if (!urls.length) {
                const legacyImage = (product.image || '').trim();
                if (legacyImage) {
                    urls.push(legacyImage);
                }
            }

            const sanitized = urls.slice(0, 6);
            if (sanitized.length === 0) {
                sanitized.push(PRODUCT_IMAGE_PLACEHOLDER);
            }
            return sanitized;
        }

        function getPrimaryProductImage(product) {
            const urls = getProductImageUrls(product);
            if (urls.length > 0) {
                return urls[0];
            }
            return PRODUCT_IMAGE_PLACEHOLDER;
        }
        
        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(lang) {
            currentLanguage = lang;
            Storage.set('language', lang);
            applyLanguage();
        }
        
        // åº”ç”¨è¯­è¨€è®¾ç½®
        function applyLanguage() {
            // æ›´æ–°å¯¼èˆªæ 
            const homeLink = document.getElementById('main-home-link');
            const adminLink = document.getElementById('admin-link');
            const userCenterLink = document.getElementById('user-center-link');
            const myOrdersLink = document.getElementById('my-orders-link');
            const loginLink = document.getElementById('login-link');
            const registerLink = document.getElementById('register-link');
            const logoutLink = document.getElementById('logout-link');
            const searchInput = document.getElementById('search-input');
            
            if (homeLink) homeLink.textContent = t('navHome');
            if (adminLink) adminLink.textContent = t('admin');
            if (userCenterLink) userCenterLink.textContent = t('userCenter');
            if (myOrdersLink) myOrdersLink.textContent = t('myOrders');
            if (loginLink) loginLink.innerHTML = `<i class="fas fa-user"></i> ${t('login')}`;
            if (registerLink) registerLink.innerHTML = `<i class="fas fa-user-plus"></i> ${t('register')}`;
            if (logoutLink) logoutLink.innerHTML = `<i class="fas fa-sign-out-alt"></i> ${t('logout')}`;
            if (searchInput) searchInput.placeholder = t('searchPlaceholder');
            
            // æ›´æ–°åŠ è½½å™¨æ–‡æœ¬
            const loaderText = document.querySelector('.loader-text');
            if (loaderText) loaderText.textContent = t('loading');
            
            // æ›´æ–°é¦–é¡µæ ‡é¢˜å’Œæè¿°
            const featuredTitle = document.querySelector('#featured-showcase .featured-head h2');
            const featuredDesc = document.querySelector('#featured-showcase .featured-head p');
            const featuredMeta = document.querySelector('#featured-showcase .featured-meta');
            if (featuredTitle) featuredTitle.textContent = t('featuredTitle');
            if (featuredDesc) featuredDesc.textContent = t('featuredDesc');
            // å·²éšè—ï¼šå®æ—¶åˆ·æ–°Â·äº‘ç«¯åŒæ­¥æŒ‰é’®
            // if (featuredMeta) featuredMeta.innerHTML = `<i class="fas fa-sync-alt"></i> ${t('syncStatus')}`;
            
            // æ›´æ–°è½®æ’­å›¾
            const carouselSlides = document.querySelectorAll('.carousel-slide');
            if (carouselSlides.length >= 2) {
                const slide1 = carouselSlides[0];
                const slide2 = carouselSlides[1];
                const slide1H2 = slide1.querySelector('h2');
                const slide1P = slide1.querySelector('p');
                const slide1Btn = slide1.querySelector('.carousel-btn');
                const slide2H2 = slide2.querySelector('h2');
                const slide2P = slide2.querySelector('p');
                const slide2Btn = slide2.querySelector('.carousel-btn');
                if (slide1H2) slide1H2.textContent = t('newArrival');
                if (slide1P) slide1P.textContent = t('newArrivalDesc');
                if (slide1Btn) slide1Btn.textContent = t('buyNow');
                if (slide2H2) slide2H2.textContent = t('limitedOffer');
                if (slide2P) slide2P.textContent = t('limitedOfferDesc');
                if (slide2Btn) slide2Btn.textContent = t('viewDetails');
            }
            
            // æ›´æ–°åˆ†ç±»æ ‡ç­¾
            const categoryItems = document.querySelectorAll('.category-item');
            categoryItems.forEach(item => {
                const category = item.getAttribute('data-category');
                if (category === 'all') item.textContent = t('allProducts');
                else if (category === 'electronics') item.textContent = t('electronics');
                else if (category === 'home') item.textContent = t('home');
                else if (category === 'clothing') item.textContent = t('clothing');
                else if (category === 'beauty') item.textContent = t('beauty');
            });
            
            // æ›´æ–°è®¢å•æ ‡ç­¾
            const orderTabs = document.querySelectorAll('.order-tab');
            orderTabs.forEach(tab => {
                const status = tab.getAttribute('data-status');
                if (status === 'all') tab.textContent = t('orderAll');
                else if (status === 'review') tab.textContent = t('orderReview');
                else if (status === 'shipping') tab.textContent = t('orderShipping');
                else if (status === 'completed') tab.textContent = t('orderCompleted');
                else if (status === 'rejected') tab.textContent = t('orderRejected');
                else if (status === 'cancelled') tab.textContent = t('orderCancelled');
            });
            
            // æ›´æ–°è®¢å•çŠ¶æ€ç­›é€‰ä¸‹æ‹‰æ¡†
            const statusFilter = document.getElementById('order-status-filter');
            if (statusFilter) {
                const selectedValue = statusFilter.value; // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
                statusFilter.innerHTML = '';
                const allStatusOption = document.createElement('option');
                allStatusOption.value = '';
                allStatusOption.textContent = t('allStatus') || 'å…¨éƒ¨çŠ¶æ€';
                statusFilter.appendChild(allStatusOption);
                
                const statusOptions = [
                    { value: 'pending', key: 'orderReview' },
                    { value: 'review', key: 'orderReview' },
                    { value: 'shipping', key: 'orderShipping' },
                    { value: 'rejected', key: 'orderRejected' },
                    { value: 'cancelled', key: 'orderCancelled' },
                    { value: 'completed', key: 'orderCompleted' }
                ];
                
                statusOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = t(opt.key);
                    statusFilter.appendChild(option);
                });
                
                statusFilter.value = selectedValue; // æ¢å¤é€‰ä¸­çš„å€¼
            }
            
            // æ›´æ–°ç”¨æˆ·ä¸­å¿ƒèœå•
            const userMenuItems = document.querySelectorAll('.user-menu a');
            userMenuItems.forEach(item => {
                const tab = item.getAttribute('data-tab');
                if (tab === 'orders') item.textContent = t('myOrders');
                else if (tab === 'profile') item.textContent = t('profile');
                else if (tab === 'address') item.textContent = t('address');
                else if (tab === 'my-reviews') item.textContent = t('myReview');
                else if (tab === 'security') item.textContent = t('security');
            });
            
            // æ›´æ–°ç”¨æˆ·ä¸­å¿ƒä¼šå‘˜ç­‰çº§å’Œç”¨æˆ·å
            const usernameDisplay = document.getElementById('username-display');
            const userMemberType = document.getElementById('user-member-type');
            const userPointsBadge = document.getElementById('user-points-badge');
            if (usernameDisplay) usernameDisplay.textContent = t('username') || 'ç”¨æˆ·å';
            if (userMemberType) userMemberType.textContent = t('regularMember') || 'æ™®é€šä¼šå‘˜';
            if (userPointsBadge) {
                const label = userPointsBadge.querySelector('[data-i18n="pointsBalance"]');
                if (label) label.textContent = t('pointsBalance') || 'å½“å‰èœœç½';
            }
            
            // æ›´æ–°ä¸ªäººä¿¡æ¯é¡µé¢
            const profilePage = document.getElementById('user-profile');
            if (profilePage) {
                const profileH3 = profilePage.querySelector('h3');
                if (profileH3) profileH3.textContent = t('profile');
                
                const profileLabels = profilePage.querySelectorAll('label');
                profileLabels.forEach(label => {
                    const forAttr = label.getAttribute('for');
                    if (forAttr === 'profile-username') label.textContent = t('username');
                    else if (forAttr === 'profile-account') label.textContent = t('account');
                    else if (forAttr === 'profile-nickname') label.textContent = t('nickname');
                    else if (forAttr === 'profile-phone') label.textContent = t('phone');
                    else if (forAttr === 'profile-email') label.textContent = t('email');
                    else if (forAttr === 'profile-birthday') label.textContent = t('birthday');
                    else if (forAttr === 'profile-gender') label.textContent = t('gender');
                });

                const profileInputs = profilePage.querySelectorAll('input[data-i18n-placeholder]');
                profileInputs.forEach(input => {
                    const key = input.getAttribute('data-i18n-placeholder');
                    if (key) input.placeholder = t(key);
                });

                const profileSelect = profilePage.querySelector('#profile-gender');
                if (profileSelect) {
                    const options = profileSelect.querySelectorAll('option');
                    options.forEach(option => {
                        const key = option.getAttribute('data-i18n');
                        if (key) option.textContent = t(key);
                    });
                }

                const saveBtn = profilePage.querySelector('button[type="submit"]');
                if (saveBtn) saveBtn.textContent = t('saveChanges');
            }
            
            // æ›´æ–°åœ°å€é¡µé¢æ ‡é¢˜
            const addressHeader = document.querySelector('#user-address .address-header h3');
            if (addressHeader) addressHeader.textContent = t('yourAddresses');
            
            const addAddressBtn = document.getElementById('add-address-btn');
            if (addAddressBtn) addAddressBtn.textContent = t('addAddress');
            
            // æ›´æ–°è´¦æˆ·å®‰å…¨é¡µé¢
            const securityPage = document.getElementById('user-security');
            if (securityPage) {
                const securityH3 = securityPage.querySelector('h3');
                if (securityH3) securityH3.textContent = t('security');

                const changePasswordH4 = securityPage.querySelector('.security-section h4');
                if (changePasswordH4) changePasswordH4.textContent = t('changePassword');

                const securityLabels = securityPage.querySelectorAll('label');
                securityLabels.forEach(label => {
                    const forAttr = label.getAttribute('for');
                    if (forAttr === 'current-password') label.textContent = t('currentPassword');
                    else if (forAttr === 'new-password') label.textContent = t('newPassword');
                    else if (forAttr === 'confirm-password') label.textContent = t('confirmNewPassword');
                });

                const securityInputs = securityPage.querySelectorAll('input[data-i18n-placeholder]');
                securityInputs.forEach(input => {
                    const key = input.getAttribute('data-i18n-placeholder');
                    if (key) input.placeholder = t(key);
                });

                const changePasswordBtn = securityPage.querySelector('#change-password-form button[type="submit"]');
                if (changePasswordBtn) changePasswordBtn.textContent = t('changePassword');

                const securitySettingsH4 = securityPage.querySelectorAll('.security-section h4');
                if (securitySettingsH4.length > 1) securitySettingsH4[1].textContent = t('securitySettings');

                // ç™»å½•ä¿æŠ¤åŠŸèƒ½å·²åˆ é™¤
            }
            
            // æ›´æ–°ç™»å½•/æ³¨å†Œé€‰æ‹©æ¨¡æ€æ¡†
            const authChoiceModal = document.getElementById('auth-choice-modal');
            if (authChoiceModal) {
                const authChoiceTitle = authChoiceModal.querySelector('.modal-header h3');
                const authChoiceDesc = authChoiceModal.querySelector('.modal-body p');
                const gotoLoginBtn = document.getElementById('goto-login-btn');
                const gotoRegisterBtn = document.getElementById('goto-register-btn');
                
                if (authChoiceTitle) authChoiceTitle.textContent = t('pleaseLoginOrRegister');
                if (authChoiceDesc) authChoiceDesc.textContent = t('loginRequired');
                if (gotoLoginBtn) {
                    gotoLoginBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i> ${t('haveAccount')}`;
                }
                if (gotoRegisterBtn) {
                    gotoRegisterBtn.innerHTML = `<i class="fas fa-user-plus"></i> ${t('noAccount')}`;
                }
            }
            
            // æ›´æ–°ç™»å½•æ¨¡æ€æ¡†
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                const loginTitle = loginModal.querySelector('.modal-header h3');
                const loginAccountLabel = loginModal.querySelector('label[for="login-account"]');
                const loginAccountInput = document.getElementById('login-account');
                const loginPasswordLabel = loginModal.querySelector('label[for="login-password"]');
                const loginPasswordInput = document.getElementById('login-password');
                const loginSubmitBtn = loginModal.querySelector('button[type="submit"]');
                
                if (loginTitle) loginTitle.textContent = t('userLogin');
                if (loginAccountLabel) loginAccountLabel.textContent = t('phoneOrEmail');
                if (loginAccountInput) loginAccountInput.placeholder = t('enterPhoneOrEmail');
                if (loginPasswordLabel) loginPasswordLabel.textContent = t('password');
                if (loginPasswordInput) loginPasswordInput.placeholder = t('enterPassword');
                if (loginSubmitBtn) loginSubmitBtn.textContent = t('login');
            }
            
            // æ›´æ–°æ³¨å†Œæ¨¡æ€æ¡†
            const registerModal = document.getElementById('register-modal');
            if (registerModal) {
                const registerTitle = registerModal.querySelector('.modal-header h3');
                const registerAccountLabel = registerModal.querySelector('label[for="register-account"]');
                const registerAccountInput = document.getElementById('register-account');
                const registerPasswordLabel = registerModal.querySelector('label[for="register-password"]');
                const registerPasswordInput = document.getElementById('register-password');
                const registerConfirmLabel = registerModal.querySelector('label[for="register-confirm"]');
                const registerConfirmInput = document.getElementById('register-confirm');
                const registerSubmitBtn = registerModal.querySelector('button[type="submit"]');
                
                if (registerTitle) registerTitle.textContent = t('userRegister');
                if (registerAccountLabel) registerAccountLabel.textContent = t('phoneOrEmail');
                if (registerAccountInput) registerAccountInput.placeholder = t('enterPhoneOrEmail');
                if (registerPasswordLabel) registerPasswordLabel.textContent = t('password');
                if (registerPasswordInput) registerPasswordInput.placeholder = t('enterPassword');
                if (registerConfirmLabel) registerConfirmLabel.textContent = t('confirmPassword');
                if (registerConfirmInput) registerConfirmInput.placeholder = t('enterPasswordAgain');
                if (registerSubmitBtn) registerSubmitBtn.textContent = t('register');
            }

            attachUSPhoneInputBehavior('profile-phone');
            attachUSPhoneInputBehavior('address-phone');
            
            // æ›´æ–°äº§å“æŠ¥åæ¨¡æ€æ¡†
            const signupModalTitle = document.getElementById('signup-modal-title');
            const signupProductLabel = document.getElementById('signup-product-label');
            const signupNameLabel = document.getElementById('signup-name-label');
            const signupPhoneLabel = document.getElementById('signup-phone-label');
            const signupEmailLabel = document.getElementById('signup-email-label');
            const signupAddressLabel = document.getElementById('signup-address-label');
            const signupNotesLabel = document.getElementById('signup-notes-label');
            const signupNotes = document.getElementById('signup-notes');
            const signupSubmitBtn = document.getElementById('signup-submit-btn');
            const signupCancelBtn = document.getElementById('signup-cancel-btn');
            
            if (signupModalTitle) signupModalTitle.textContent = t('productRegistration');
            if (signupProductLabel) signupProductLabel.textContent = t('registeredProduct');
            if (signupNameLabel) signupNameLabel.textContent = t('name');
            if (signupPhoneLabel) signupPhoneLabel.textContent = t('phone');
            if (signupEmailLabel) signupEmailLabel.textContent = t('email');
            if (signupAddressLabel) signupAddressLabel.textContent = t('address');
            if (signupNotesLabel) signupNotesLabel.textContent = t('notes');
            if (signupNotes) signupNotes.placeholder = t('notesPlaceholder');
            if (signupSubmitBtn) signupSubmitBtn.textContent = t('submitRegistration');
            if (signupCancelBtn) signupCancelBtn.textContent = t('cancel');
            
            // é‡æ–°æ¸²æŸ“è®¢å•å’Œåœ°å€ï¼ˆä¼šä½¿ç”¨æ–°çš„è´§å¸æ ¼å¼ï¼‰
            renderUserOrders();
            renderAddressList();
            renderProducts(products);
        }

        // æ¸…é™¤æœ¬åœ°æ‰€æœ‰ç¼“å­˜æ•°æ®,ç¡®ä¿ä»äº‘ç«¯è·å–æœ€æ–°æ•°æ®
        // æ³¨æ„:åªæœ‰åœ¨é¦–æ¬¡åŠ è½½æ—¶æ¸…ç†,ç™»å½•çŠ¶æ€ä¿ç•™
        console.log('ğŸ”„ æ¸…ç†æœ¬åœ°ç¼“å­˜,å‡†å¤‡ä»äº‘ç«¯åŠ è½½æœ€æ–°æ•°æ®...');

        // é¢„å®šä¹‰ç®¡ç†å‘˜è´¦å·
        const ADMIN_ACCOUNTS = {
            'Udream':  { password: 'Aa123123', role: 'admin', username: 'ç³»ç»Ÿç®¡ç†å‘˜' },
            'Udream1': { password: 'Aa123123', role: 'admin', username: 'ç³»ç»Ÿç®¡ç†å‘˜1' },
            'Udream2': { password: 'Aa123123', role: 'admin', username: 'ç³»ç»Ÿç®¡ç†å‘˜2' },
            'Udream3': { password: 'Aa123123', role: 'admin', username: 'ç³»ç»Ÿç®¡ç†å‘˜3' }
        };

        // äº‘ç«¯æ•°æ®åŒæ­¥é…ç½® - ä½¿ç”¨ç®€å•çš„å…±äº«å­˜å‚¨æ–¹æ¡ˆ
        const CLOUD_STORAGE = {
            enabled: true,
            // ä½¿ç”¨ GitHub Gist ä½œä¸ºå…è´¹çš„æ•°æ®å­˜å‚¨
            baseUrl: 'https://api.github.com/gists',
            gistId: 'your-gist-id-here', // éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„ Gist ID
            accessToken: 'your-github-token-here' // éœ€è¦æ›¿æ¢ä¸º GitHub Token
        };

        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ localStorage çš„è·¨è®¾å¤‡åŒæ­¥
        const CROSS_DEVICE_SYNC = {
            enabled: true,
            syncKey: 'ecommerce_sync_data',
            lastSyncTime: 'ecommerce_last_sync'
        };

        // å…¨å±€äº‘ç«¯åŒæ­¥ç®¡ç†å™¨å®ä¾‹ï¼ˆå°†åœ¨é¡µé¢åŠ è½½ååˆå§‹åŒ–ï¼‰
        let cloudSync = null;

        // ========== Firebase äº‘ç«¯åŒæ­¥ç®¡ç†å™¨ ==========
        class CloudSyncManager {
            constructor() {
                this.db = null;
                this.isInitialized = false;
                // å…¼å®¹æ—§ä»£ç ï¼Œä½†å®é™…ä½¿ç”¨ _syncState.inProgress
                Object.defineProperty(this, 'syncInProgress', {
                    get: () => this._syncState?.inProgress || false,
                    set: (value) => {
                        if (!this._syncState) this._syncState = { inProgress: false, queue: [], lastSyncTime: null, errorCount: 0 };
                        this._syncState.inProgress = value;
                    }
                });
                this.lastSyncTime = null;
                this.syncInterval = null;
                this.listeners = [];
                this.userOrdersRef = null;
                this.pendingOrderUpdate = null;
                this.orderUpdateTimer = null;
                this.userAddressesRef = null;
                this.pendingAddressUpdate = null;
                this.addressUpdateTimer = null;
                this.allOrdersRef = null;
                this.sessionRef = null;
                this.currentSessionId = null;

                // ========== Firebase é…ç½® ==========
                // 
                // âš ï¸ é‡è¦æç¤ºï¼šè·¨è®¾å¤‡åŒæ­¥åŠŸèƒ½éœ€è¦Firebaseé…ç½®
                // 
                // ğŸ”§ å¿«é€Ÿè®¾ç½®æ­¥éª¤ï¼ˆçº¦3åˆ†é’Ÿï¼‰ï¼š
                // 
                // 1ï¸âƒ£ è®¿é—® Firebase æ§åˆ¶å°
                //    https://console.firebase.google.com/
                // 
                // 2ï¸âƒ£ åˆ›å»ºæ–°é¡¹ç›®
                //    - ç‚¹å‡»"æ·»åŠ é¡¹ç›®"
                //    - è¾“å…¥é¡¹ç›®åç§°ï¼ˆå¦‚ï¼šmy-ecommerceï¼‰
                //    - ç¦ç”¨Google Analyticsï¼ˆå¯é€‰ï¼‰
                //    - ç‚¹å‡»"åˆ›å»ºé¡¹ç›®"
                // 
                // 3ï¸âƒ£ æ³¨å†ŒWebåº”ç”¨
                //    - åœ¨é¡¹ç›®æ¦‚è§ˆé¡µï¼Œç‚¹å‡» Web å›¾æ ‡ (</>)
                //    - è¾“å…¥åº”ç”¨æ˜µç§°
                //    - ç‚¹å‡»"æ³¨å†Œåº”ç”¨"
                //    - å¤åˆ¶æ˜¾ç¤ºçš„ firebaseConfig å¯¹è±¡
                // 
                // 4ï¸âƒ£ å¯ç”¨ Realtime Database
                //    - å·¦ä¾§èœå• -> æ„å»º -> Realtime Database
                //    - ç‚¹å‡»"åˆ›å»ºæ•°æ®åº“"
                //    - é€‰æ‹©ä½ç½®ï¼ˆå»ºè®®ï¼šasia-southeast1ï¼‰
                //    - âš ï¸ é‡è¦ï¼šé€‰æ‹©"æµ‹è¯•æ¨¡å¼"ï¼ˆå…è®¸è¯»å†™ï¼‰
                //    - ç‚¹å‡»"å¯ç”¨"
                // 
                // 5ï¸âƒ£ æ›¿æ¢é…ç½®
                //    - å°†ç¬¬3æ­¥å¤åˆ¶çš„ firebaseConfig æ›¿æ¢ä¸‹é¢çš„å†…å®¹
                // 
                // ğŸ“ ç¤ºä¾‹é…ç½®ï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ï¼‰ï¼š
                this.firebaseConfig = {
                    apiKey: "AIzaSyAKHHBPa0LmDjAdFj6vngjH0DuBbTzr7Cg",
                    authDomain: "my-ecommerce-app-2e824.firebaseapp.com",
                    databaseURL: "https://my-ecommerce-app-2e824-default-rtdb.asia-southeast1.firebasedatabase.app",  // âš ï¸ ç§»é™¤äº†æœ«å°¾çš„æ–œæ 
                    projectId: "my-ecommerce-app-2e824",
                    storageBucket: "my-ecommerce-app-2e824.firebasestorage.app",
                    messagingSenderId: "334875308809",
                    appId: "1:334875308809:web:b48e4dac8e6ca2470219d8",
                    measurementId: "G-6454KB4569"
                };

                // ğŸ’¡ æç¤ºï¼š
                // - å¦‚æœä¸é…ç½®Firebaseï¼Œåº”ç”¨ä»å¯æ­£å¸¸ä½¿ç”¨ï¼Œåªæ˜¯æ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°
                // - é…ç½®åï¼Œæ•°æ®å°†è‡ªåŠ¨åœ¨æ‰€æœ‰è®¾å¤‡é—´å®æ—¶åŒæ­¥
                // - æµ‹è¯•æ¨¡å¼çš„æ•°æ®åº“è§„åˆ™ä¼šåœ¨30å¤©åè¿‡æœŸï¼Œå±Šæ—¶éœ€è¦æ›´æ–°è§„åˆ™

                // ä¸åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨ init()ï¼Œè€Œæ˜¯è¿”å›åç«‹å³è°ƒç”¨
                // this.init(); // ç§»é™¤è¿™ä¸€è¡Œ
            }

            // ç­‰å¾… Firebase SDK åŠ è½½å®Œæˆ
            async waitForFirebaseSDK(timeout = 45000) {
                console.log('â³ ç­‰å¾… Firebase SDK åŠ è½½...');

                const startTime = Date.now();
                const checkInterval = 500; // æ¯500msæ£€æŸ¥ä¸€æ¬¡

                return new Promise((resolve) => {
                    const check = () => {
                        // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½æˆåŠŸ
                        if (typeof firebase !== 'undefined') {
                            console.log('âœ… Firebase SDK æ£€æµ‹æˆåŠŸ');
                            resolve(true);
                            return;
                        }

                        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æºéƒ½å¤±è´¥äº†
                        if (window.firebaseLoadFailed) {
                            console.log('âŒ Firebase SDK åŠ è½½å·²ç¡®è®¤å¤±è´¥');
                            resolve(false);
                            return;
                        }

                        // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
                        if (Date.now() - startTime > timeout) {
                            console.log('â±ï¸ Firebase SDK åŠ è½½ç­‰å¾…è¶…æ—¶');
                            resolve(false);
                            return;
                        }

                        // ç»§ç»­ç­‰å¾…
                        setTimeout(check, checkInterval);
                    };

                    check();
                });
            }

            // åˆå§‹åŒ– Firebase
            async init() {
                console.log('ğŸ”§ CloudSyncManager.init() å¼€å§‹æ‰§è¡Œ...');
                console.log('â° åˆå§‹åŒ–æ—¶é—´:', new Date().toLocaleString());

                try {
                    // ç­‰å¾… Firebase SDK åŠ è½½ï¼ˆæœ€å¤šç­‰å¾…5ç§’ï¼ŒåŠ å¿«é€Ÿåº¦ï¼‰
                    console.log('â³ ç­‰å¾… Firebase SDK åŠ è½½...');
                    const sdkLoaded = await this.waitForFirebaseSDK(5000);

                    if (!sdkLoaded) {
                        console.warn('âš ï¸ Firebase SDK åŠ è½½è¶…æ—¶æˆ–å¤±è´¥ï¼Œäº‘ç«¯åŒæ­¥åŠŸèƒ½ä¸å¯ç”¨');
                        console.log('ğŸ’¡ åº”ç”¨å°†ä»¥æœ¬åœ°æ¨¡å¼è¿è¡Œï¼Œæ•°æ®ä»…ä¿å­˜åœ¨å½“å‰è®¾å¤‡');
                        console.log('ğŸ“Œ å¯èƒ½åŸå› ï¼š');
                        console.log('   1. ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œæ— æ³•åŠ è½½ Firebase CDN');
                        console.log('   2. æµè§ˆå™¨æ‰©å±•é˜»æ­¢äº†è„šæœ¬åŠ è½½');
                        console.log('   3. é˜²ç«å¢™æˆ–ä»£ç†è®¾ç½®');
                        console.log('   4. æ‰€æœ‰ CDN æºå‡ä¸å¯ç”¨');
                        this.updateSyncStatusUI(false);
                        return;
                    }

                    console.log('âœ… Firebase SDK å·²æˆåŠŸåŠ è½½');
                    console.log('ğŸ“¦ Firebase ç‰ˆæœ¬:', firebase.SDK_VERSION || 'unknown');
                    console.log('ğŸ“¦ Firebase å¯ç”¨æœåŠ¡:', Object.keys(firebase).filter(k => typeof firebase[k] === 'function').join(', '));

                    // å¿«é€Ÿæ£€æŸ¥é…ç½®ï¼ˆè·³è¿‡è¯¦ç»†è¯Šæ–­ä»¥åŠ å¿«é€Ÿåº¦ï¼‰
                    const isDefaultConfig = this.firebaseConfig.apiKey === 'YOUR_API_KEY_HERE' ||
                        this.firebaseConfig.projectId === 'your-project';

                    if (isDefaultConfig) {
                        console.warn('âš ï¸ Firebase é…ç½®æ— æ•ˆï¼Œäº‘ç«¯åŒæ­¥åŠŸèƒ½ä¸å¯ç”¨');
                        this.updateSyncStatusUI(false);
                        return;
                    }

                    console.log('ğŸ”§ æ­£åœ¨åˆå§‹åŒ– Firebase...');
                    console.log('ğŸ“ é…ç½®ä¿¡æ¯:');
                    console.log('   - é¡¹ç›® ID:', this.firebaseConfig.projectId);
                    console.log('   - è®¤è¯åŸŸ:', this.firebaseConfig.authDomain);
                    console.log('   - æ•°æ®åº“ URL:', this.firebaseConfig.databaseURL);
                    console.log('   - å­˜å‚¨æ¡¶:', this.firebaseConfig.storageBucket);

                    // åˆå§‹åŒ– Firebase
                    if (!firebase.apps.length) {
                        console.log('ğŸ”„ æ‰§è¡Œ firebase.initializeApp()...');
                        try {
                            firebase.initializeApp(this.firebaseConfig);
                            console.log('âœ… Firebase App åˆå§‹åŒ–æˆåŠŸ');
                            console.log('ğŸ“± App åç§°:', firebase.app().name);
                            console.log('ğŸ“± App é€‰é¡¹:', JSON.stringify(firebase.app().options, null, 2));
                        } catch (initError) {
                            console.error('âŒ Firebase App åˆå§‹åŒ–å¤±è´¥:', initError);
                            throw initError;
                        }
                    } else {
                        console.log('â„¹ï¸ Firebase App å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
                        console.log('ğŸ“± ç°æœ‰ App:', firebase.apps.map(app => app.name).join(', '));
                    }

                    console.log('ğŸ”„ è·å– Database å®ä¾‹...');
                    try {
                        this.db = firebase.database();
                        console.log('âœ… Database å®ä¾‹è·å–æˆåŠŸ');
                        console.log('ğŸ”— Database URL:', this.db.ref().toString());
                    } catch (dbError) {
                        console.error('âŒ Database å®ä¾‹è·å–å¤±è´¥:', dbError);
                        throw dbError;
                    }

                    // è·³è¿‡è¿æ¥æµ‹è¯•ä»¥åŠ å¿«é€Ÿåº¦ï¼Œç›´æ¥å°è¯•è¯»å–æ•°æ®éªŒè¯è¿æ¥
                    console.log('ğŸ”„ å¿«é€ŸéªŒè¯æ•°æ®åº“è¿æ¥...');
                    let connectionSuccess = false;
                    
                    try {
                        // å¿«é€Ÿæµ‹è¯•ï¼šå°è¯•è¯»å–ä¸€ä¸ªç®€å•çš„è·¯å¾„ï¼ˆè¶…æ—¶2ç§’ï¼‰
                        await Promise.race([
                            this.db.ref('.info/connected').once('value'),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('è¶…æ—¶')), 2000))
                        ]);
                            connectionSuccess = true;
                        console.log('âœ… æ•°æ®åº“è¿æ¥éªŒè¯æˆåŠŸ');
                        } catch (error) {
                        console.warn('âš ï¸ è¿æ¥éªŒè¯å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•:', error.message);
                        // å³ä½¿éªŒè¯å¤±è´¥ä¹Ÿç»§ç»­ï¼Œè®©å®é™…æ•°æ®åŠ è½½æ¥éªŒè¯
                        connectionSuccess = true;
                    }

                    if (!connectionSuccess) {
                        console.error('âŒ è¿æ¥æµ‹è¯•æœ€ç»ˆå¤±è´¥');
                        throw lastError || new Error('Database connection test failed after 3 attempts');
                    }

                    this.isInitialized = true;
                    console.log('âœ…âœ…âœ… Firebase äº‘ç«¯åŒæ­¥å·²å®Œå…¨å¯ç”¨ï¼');

                    // é¦–å…ˆä»äº‘ç«¯åŠ è½½æ•°æ®
                    console.log('ğŸ“¥ æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...');
                    try {
                        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸²è¡Œ
                        await Promise.all([
                            this.loadProducts().then(() => console.log('âœ… äº§å“æ•°æ®åŠ è½½å®Œæˆ')),
                            this.loadAllUsers().then(() => console.log('âœ… ç”¨æˆ·æ•°æ®åŠ è½½å®Œæˆ')),
                            this.loadHomepageSettings().then(() => console.log('âœ… ä¸»é¡µè®¾ç½®åŠ è½½å®Œæˆ'))
                        ]);
                        console.log('âœ… æ‰€æœ‰äº‘ç«¯æ•°æ®åŠ è½½å®Œæˆ');
                    } catch (loadError) {
                        console.warn('âš ï¸ æ•°æ®åŠ è½½å¤±è´¥:', loadError.message);
                    }

                    // è®¾ç½®å®æ—¶ç›‘å¬
                    console.log('ğŸ”„ è®¾ç½®å®æ—¶ç›‘å¬å™¨...');
                    try {
                        this.setupRealtimeListeners();
                        console.log('âœ… å®æ—¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
                    } catch (listenerError) {
                        console.warn('âš ï¸ å®æ—¶ç›‘å¬å™¨è®¾ç½®å¤±è´¥:', listenerError.message);
                    }

                    // è·³è¿‡é¦–æ¬¡åŒæ­¥ä»¥åŠ å¿«é€Ÿåº¦ï¼ˆæ•°æ®å·²ä»äº‘ç«¯åŠ è½½ï¼‰
                    console.log('â„¹ï¸ è·³è¿‡é¦–æ¬¡åŒæ­¥ï¼ˆæ•°æ®å·²ä»äº‘ç«¯åŠ è½½ï¼‰');

                    // å®šæœŸåŒæ­¥ï¼ˆæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
                    this.syncInterval = setInterval(() => {
                        // åªåœ¨ç”¨æˆ·ä¸åœ¨æ“ä½œæ—¶åŒæ­¥
                        if (!this._syncState.inProgress && document.visibilityState === 'visible') {
                            this.syncAllData().catch(err => {
                                console.warn('âš ï¸ å®šæœŸåŒæ­¥å¤±è´¥:', err.message);
                            });
                        }
                    }, 2000); 
                    console.log('â° å·²è®¾ç½®å®šæœŸåŒæ­¥ (æ¯2ç§’)');

                    // æ›´æ–°UIçŠ¶æ€æŒ‡ç¤ºå™¨
                    this.updateSyncStatusUI(true);

                    console.log('ğŸ‰ğŸ‰ğŸ‰ äº‘ç«¯åŒæ­¥ç³»ç»Ÿå®Œå…¨å°±ç»ªï¼');
                    console.log('â° å®Œæˆæ—¶é—´:', new Date().toLocaleString());
                    // ç§»é™¤å¯åŠ¨æç¤ºï¼Œé¿å…å¹²æ‰°ç”¨æˆ·

                } catch (error) {
                    console.error('âŒâŒâŒ Firebase åˆå§‹åŒ–å¤±è´¥:', error);
                    console.error('é”™è¯¯åç§°:', error.name);
                    console.error('é”™è¯¯ä»£ç :', error.code);
                    console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                    console.error('é”™è¯¯å †æ ˆ:', error.stack);
                    this.isInitialized = false;

                    // æ ¹æ®é”™è¯¯ç±»å‹ç»™å‡ºä¸åŒçš„æç¤º
                    let errorMessage = '';
                    let troubleshootingSteps = [];

                    if (error.code === 'auth/invalid-api-key' || error.message?.includes('API key')) {
                        errorMessage = 'API Key æ— æ•ˆæˆ–ä¸æ­£ç¡®';
                        troubleshootingSteps = [
                            'æ£€æŸ¥ firebaseConfig ä¸­çš„ apiKey æ˜¯å¦æ­£ç¡®',
                            'ç¡®è®¤ API Key æœªè¢«é™åˆ¶æˆ–ç¦ç”¨',
                            'åœ¨ Firebase æ§åˆ¶å°é‡æ–°ç”Ÿæˆ API Key'
                        ];
                    } else if (error.message?.includes('Permission denied') || error.code === 'PERMISSION_DENIED') {
                        errorMessage = 'æ•°æ®åº“æƒé™è¢«æ‹’ç»';
                        troubleshootingSteps = [
                            'è®¿é—® Firebase æ§åˆ¶å° > Realtime Database > è§„åˆ™',
                            'ç¡®ä¿è§„åˆ™è®¾ç½®ä¸ºæµ‹è¯•æ¨¡å¼ (å…è®¸è¯»å†™)',
                            'å‘å¸ƒè§„åˆ™åç­‰å¾…å‡ ç§’é’Ÿç”Ÿæ•ˆ'
                        ];
                    } else if (error.code === 'app/invalid-credential') {
                        errorMessage = 'Firebase é…ç½®ä¿¡æ¯æ— æ•ˆ';
                        troubleshootingSteps = [
                            'æ£€æŸ¥æ‰€æœ‰é…ç½®é¡¹æ˜¯å¦å®Œæ•´',
                            'ç¡®è®¤é¡¹ç›® ID å’Œæ•°æ®åº“ URL åŒ¹é…',
                            'é‡æ–°å¤åˆ¶ Firebase é…ç½®'
                        ];
                    } else if (error.message?.includes('network') || error.message?.includes('fetch')) {
                        errorMessage = 'ç½‘ç»œè¿æ¥é”™è¯¯';
                        troubleshootingSteps = [
                            'æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸',
                            'ç¡®è®¤é˜²ç«å¢™æœªé˜»æ­¢ Firebase åŸŸå',
                            'å°è¯•ç¦ç”¨æµè§ˆå™¨æ‰©å±•'
                        ];
                    } else if (error.message?.includes('databaseURL')) {
                        errorMessage = 'æ•°æ®åº“ URL é…ç½®é”™è¯¯';
                        troubleshootingSteps = [
                            'ç¡®è®¤ databaseURL æ ¼å¼æ­£ç¡®',
                            'ç¡®ä¿ URL æœ«å°¾æ²¡æœ‰æ–œæ ',
                            'æ£€æŸ¥æ•°æ®åº“åŒºåŸŸæ˜¯å¦æ­£ç¡®'
                        ];
                    } else {
                        errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                        troubleshootingSteps = [
                            'æŸ¥çœ‹å®Œæ•´é”™è¯¯å †æ ˆä¿¡æ¯',
                            'æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„è¯¦ç»†æ—¥å¿—',
                            'å°è¯•åœ¨ Firebase æ§åˆ¶å°æµ‹è¯•æ•°æ®åº“è®¿é—®'
                        ];
                    }

                    console.log('');
                    console.log('ğŸ’¡ é”™è¯¯è¯Šæ–­ï¼š');
                    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                    console.log(`âš ï¸ ${errorMessage}`);
                    console.log('');
                    console.log('ğŸ”§ å»ºè®®çš„è§£å†³æ­¥éª¤ï¼š');
                    troubleshootingSteps.forEach((step, index) => {
                        console.log(`   ${index + 1}. ${step}`);
                    });
                    console.log('');
                    console.log('ğŸ“š é€šç”¨è§£å†³æ–¹æ³•ï¼š');
                    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                    console.log('1. è®¿é—® Firebase æ§åˆ¶å°ï¼š');
                    console.log('   https://console.firebase.google.com/');
                    console.log('');
                    console.log('2. é€‰æ‹©é¡¹ç›®: my-ecommerce-app-2e824');
                    console.log('');
                    console.log('3. ç¡®è®¤ Realtime Database å·²åˆ›å»ºä¸”å¯è®¿é—®');
                    console.log('');
                    console.log('4. åœ¨ Database è§„åˆ™ä¸­è®¾ç½®ä¸ºæµ‹è¯•æ¨¡å¼ï¼š');
                    console.log('   {');
                    console.log('     "rules": {');
                    console.log('       ".read": true,');
                    console.log('       ".write": true');
                    console.log('     }');
                    console.log('   }');
                    console.log('');
                    console.log('5. ç¡®ä¿æ•°æ®åº“ URL æ­£ç¡®ï¼š');
                    console.log('   ' + this.firebaseConfig.databaseURL);
                    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                    console.log('');
                    console.log('ğŸ’¡ åº”ç”¨å°†ä»¥æœ¬åœ°æ¨¡å¼ç»§ç»­è¿è¡Œ');
                    console.log('ğŸ“ æ‰€æœ‰æ•°æ®å°†ä¿å­˜åœ¨æœ¬åœ°å­˜å‚¨ä¸­');

                    // æ›´æ–°UIçŠ¶æ€æŒ‡ç¤ºå™¨ä¸ºé”™è¯¯çŠ¶æ€
                    this.updateSyncStatusUI(false);

                    // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤ºï¼ˆå·²æ³¨é‡Šï¼Œä¸æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼‰
                    // showNotification(`âš ï¸ äº‘ç«¯åŒæ­¥åˆå§‹åŒ–å¤±è´¥: ${errorMessage}`, 'error');
                }
            }

            // æ›´æ–°åŒæ­¥çŠ¶æ€UIæŒ‡ç¤ºå™¨
            updateSyncStatusUI(isEnabled) {
                const syncIcon = document.getElementById('sync-icon');
                const syncText = document.getElementById('sync-text');

                if (syncIcon && syncText) {
                    if (isEnabled) {
                        syncIcon.style.color = '#28a745'; // ç»¿è‰²
                        syncText.textContent = 'äº‘ç«¯å·²åŒæ­¥';
                        syncText.style.color = '#28a745';
                    } else {
                        syncIcon.style.color = '#6c757d'; // ç°è‰²
                        syncText.textContent = 'æœ¬åœ°æ¨¡å¼';
                        syncText.style.color = '#6c757d';
                    }
                }
            }

            // æµ‹è¯•Firebaseè¿æ¥
            async testConnection() {
                console.log('');
                console.log('ğŸ” ========== Firebase è¿æ¥æµ‹è¯•å¼€å§‹ ==========');
                const testStartTime = Date.now();

                try {
                    // æµ‹è¯•æ–¹æ³• 1: æ£€æŸ¥ .info/connected
                    console.log('ğŸ“¡ [æµ‹è¯• 1/3] æ£€æŸ¥ Firebase è¿æ¥çŠ¶æ€...');
                    console.log('   - ç›®æ ‡: .info/connected');

                    const connectedRef = this.db.ref('.info/connected');
                    console.log('   - Reference åˆ›å»ºæˆåŠŸ');

                    const connectedSnapshot = await Promise.race([
                        connectedRef.once('value'),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('è¿æ¥çŠ¶æ€æ£€æŸ¥è¶…æ—¶ (15ç§’)')), 15000))
                    ]);

                    const isConnected = connectedSnapshot.val();
                    console.log('   - è¿æ¥çŠ¶æ€è¿”å›å€¼:', isConnected);
                    console.log('   - æ•°æ®ç±»å‹:', typeof isConnected);

                    if (isConnected === true) {
                        console.log('   âœ… Firebase å®æ—¶è¿æ¥å·²å»ºç«‹');
                        console.log('');

                        // é¢å¤–éªŒè¯ï¼šå°è¯•è¯»å–æ ¹èŠ‚ç‚¹
                        console.log('ğŸ“– [æµ‹è¯• 2/3] éªŒè¯è¯»å–æƒé™...');
                        try {
                            const rootRef = this.db.ref('/');
                            await Promise.race([
                                rootRef.once('value'),
                                new Promise((_, reject) => setTimeout(() => reject(new Error('è¯»å–æµ‹è¯•è¶…æ—¶ (10ç§’)')), 10000))
                            ]);
                            console.log('   âœ… è¯»å–æƒé™éªŒè¯æˆåŠŸ');
                        } catch (readError) {
                            console.warn('   âš ï¸ è¯»å–æƒé™éªŒè¯å¤±è´¥:', readError.message);
                            throw readError;
                        }

                        console.log('');
                        const testDuration = Date.now() - testStartTime;
                        console.log(`âœ… ========== è¿æ¥æµ‹è¯•æˆåŠŸ (è€—æ—¶: ${testDuration}ms) ==========`);
                        console.log('');
                        return true;
                    }

                    // å¦‚æœ .info/connected è¿”å› falseï¼Œç»§ç»­å…¶ä»–æµ‹è¯•
                    console.log('   âš ï¸ è¿æ¥çŠ¶æ€æ˜¾ç¤ºæœªè¿æ¥ï¼Œç»§ç»­æ·±åº¦æµ‹è¯•...');
                    console.log('');

                    // æµ‹è¯•æ–¹æ³• 2: å°è¯•å†™å…¥å’Œè¯»å–æµ‹è¯•æ•°æ®
                    console.log('âœï¸ [æµ‹è¯• 3/3] æµ‹è¯•è¯»å†™æƒé™...');
                    const testDataRef = this.db.ref('_connection_test');
                    const testData = {
                        timestamp: Date.now(),
                        status: 'testing',
                        random: Math.random().toString(36).substring(7)
                    };

                    console.log('   - å†™å…¥æµ‹è¯•æ•°æ®...');
                    console.log('   - æµ‹è¯•è·¯å¾„:', testDataRef.toString());
                    console.log('   - æµ‹è¯•æ•°æ®:', JSON.stringify(testData));

                    await Promise.race([
                        testDataRef.set(testData),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('å†™å…¥æµ‹è¯•è¶…æ—¶ (10ç§’)')), 10000))
                    ]);
                    console.log('   âœ… å†™å…¥æˆåŠŸ');

                    console.log('   - è¯»å–éªŒè¯...');
                    const readSnapshot = await Promise.race([
                        testDataRef.once('value'),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('è¯»å–æµ‹è¯•è¶…æ—¶ (10ç§’)')), 10000))
                    ]);

                    const readData = readSnapshot.val();
                    console.log('   - è¯»å–æ•°æ®:', JSON.stringify(readData));

                    if (readData && readData.random === testData.random) {
                        console.log('   âœ… è¯»å–éªŒè¯æˆåŠŸ (æ•°æ®åŒ¹é…)');
                    } else {
                        console.warn('   âš ï¸ è¯»å–æ•°æ®ä¸åŒ¹é…');
                    }

                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    console.log('   - æ¸…ç†æµ‹è¯•æ•°æ®...');
                    await Promise.race([
                        testDataRef.remove(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('æ¸…ç†è¶…æ—¶ (5ç§’)')), 5000))
                    ]);
                    console.log('   âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†');

                    console.log('');
                    const testDuration = Date.now() - testStartTime;
                    console.log(`âœ… ========== è¿æ¥æµ‹è¯•æˆåŠŸ (è€—æ—¶: ${testDuration}ms) ==========`);
                    console.log('ğŸ“ å¤‡æ³¨: .info/connected æ˜¾ç¤ºæœªè¿æ¥ï¼Œä½†è¯»å†™æµ‹è¯•é€šè¿‡');
                    console.log('');

                    return true;

                } catch (error) {
                    console.log('');
                    console.error('âŒ ========== Firebase è¿æ¥æµ‹è¯•å¤±è´¥ ==========');
                    console.error('é”™è¯¯ç±»å‹:', error.name);
                    console.error('é”™è¯¯ä»£ç :', error.code);
                    console.error('é”™è¯¯æ¶ˆæ¯:', error.message);

                    // è¯¦ç»†çš„é”™è¯¯è¯Šæ–­
                    if (error.message?.includes('Permission denied') || error.code === 'PERMISSION_DENIED') {
                        console.error('');
                        console.error('ğŸš« æƒé™è¢«æ‹’ç» - æ•°æ®åº“è§„åˆ™é…ç½®é—®é¢˜');
                        console.error('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                        console.error('è¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯ï¼Œé€šå¸¸æ˜¯å› ä¸ºæ•°æ®åº“è§„åˆ™é™åˆ¶äº†è®¿é—®ã€‚');
                        console.error('');
                        console.error('ğŸ“‹ è§£å†³æ–¹æ³•ï¼š');
                        console.error('1. è®¿é—® Firebase æ§åˆ¶å°');
                        console.error('   https://console.firebase.google.com/project/my-ecommerce-app-2e824/database/rules');
                        console.error('');
                        console.error('2. å°†è§„åˆ™è®¾ç½®ä¸ºæµ‹è¯•æ¨¡å¼ï¼ˆå…è®¸æ‰€æœ‰è¯»å†™ï¼‰ï¼š');
                        console.error('   {');
                        console.error('     "rules": {');
                        console.error('       ".read": true,');
                        console.error('       ".write": true');
                        console.error('     }');
                        console.error('   }');
                        console.error('');
                        console.error('3. ç‚¹å‡»"å‘å¸ƒ"æŒ‰é’®');
                        console.error('4. ç­‰å¾…10-30ç§’è®©è§„åˆ™ç”Ÿæ•ˆ');
                        console.error('5. åˆ·æ–°æ­¤é¡µé¢é‡è¯•');
                        console.error('');
                        console.error('âš ï¸ æ³¨æ„: æµ‹è¯•æ¨¡å¼è§„åˆ™ä¼šåœ¨30å¤©åè¿‡æœŸ');
                        console.error('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

                    } else if (error.message?.includes('timeout') || error.message?.includes('è¶…æ—¶')) {
                        console.error('');
                        console.error('â±ï¸ è¿æ¥è¶…æ—¶ - ç½‘ç»œæˆ–æœåŠ¡å™¨é—®é¢˜');
                        console.error('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                        console.error('ğŸ“‹ å¯èƒ½çš„åŸå› ï¼š');
                        console.error('1. ç½‘ç»œè¿æ¥ä¸ç¨³å®š');
                        console.error('2. Firebase æœåŠ¡å™¨å“åº”ç¼“æ…¢');
                        console.error('3. é˜²ç«å¢™æˆ–ä»£ç†é˜»æ­¢è¿æ¥');
                        console.error('4. æ•°æ®åº“åŒºåŸŸè®¾ç½®ä¸æ­£ç¡®');
                        console.error('');
                        console.error('ğŸ“‹ è§£å†³æ–¹æ³•ï¼š');
                        console.error('1. æ£€æŸ¥ç½‘ç»œè¿æ¥');
                        console.error('2. ç¡®è®¤ databaseURL æ­£ç¡®');
                        console.error('3. å°è¯•åˆ·æ–°é¡µé¢é‡è¯•');
                        console.error('4. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®');
                        console.error('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

                    } else if (error.message?.includes('network') || error.message?.includes('fetch')) {
                        console.error('');
                        console.error('ğŸŒ ç½‘ç»œé”™è¯¯ - æ— æ³•è¿æ¥åˆ° Firebase');
                        console.error('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                        console.error('ğŸ“‹ è§£å†³æ–¹æ³•ï¼š');
                        console.error('1. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
                        console.error('2. ç¡®è®¤å¯ä»¥è®¿é—® Firebase åŸŸå');
                        console.error('3. ç¦ç”¨VPNæˆ–ä»£ç†åé‡è¯•');
                        console.error('4. æ£€æŸ¥æµè§ˆå™¨æ‰©å±•æ˜¯å¦é˜»æ­¢äº†è¯·æ±‚');
                        console.error('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

                    } else {
                        console.error('');
                        console.error('â“ æœªçŸ¥é”™è¯¯');
                        console.error('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                        console.error('å®Œæ•´é”™è¯¯å¯¹è±¡:', error);
                        console.error('é”™è¯¯å †æ ˆ:', error.stack);
                        console.error('');
                        console.error('ğŸ“‹ å»ºè®®ï¼š');
                        console.error('1. æŸ¥çœ‹ä¸Šé¢çš„å®Œæ•´é”™è¯¯ä¿¡æ¯');
                        console.error('2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„ç½‘ç»œæ ‡ç­¾');
                        console.error('3. ç¡®è®¤ Firebase é…ç½®æ­£ç¡®');
                        console.error('4. åœ¨ Firebase æ§åˆ¶å°æµ‹è¯•æ•°æ®åº“è®¿é—®');
                        console.error('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                    }

                    console.error('');
                    console.error('ğŸ”— å¿«é€Ÿé“¾æ¥ï¼š');
                    console.error('Firebase æ§åˆ¶å°: https://console.firebase.google.com/');
                    console.error('é¡¹ç›®é“¾æ¥: https://console.firebase.google.com/project/my-ecommerce-app-2e824');
                    console.error('æ•°æ®åº“è§„åˆ™: https://console.firebase.google.com/project/my-ecommerce-app-2e824/database/rules');
                    console.error('');

                    const testDuration = Date.now() - testStartTime;
                    console.error(`âŒ ========== æµ‹è¯•å¤±è´¥ (è€—æ—¶: ${testDuration}ms) ==========`);
                    console.error('');

                    throw error;
                }
            }

            // è¯Šæ–­Firebaseé…ç½®
            diagnoseConfiguration() {
                console.log('');
                console.log('ğŸ” ========== Firebase é…ç½®è¯Šæ–­ ==========');
                console.log('');

                const checks = [];

                // æ£€æŸ¥ apiKey
                if (!this.firebaseConfig.apiKey) {
                    checks.push({ item: 'API Key', status: 'âŒ ç¼ºå¤±', severity: 'error' });
                } else if (this.firebaseConfig.apiKey === 'YOUR_API_KEY_HERE') {
                    checks.push({ item: 'API Key', status: 'âŒ æœªè®¾ç½® (é»˜è®¤å€¼)', severity: 'error' });
                } else if (this.firebaseConfig.apiKey.length < 30) {
                    checks.push({ item: 'API Key', status: 'âš ï¸ å¯èƒ½æ— æ•ˆ (é•¿åº¦ä¸è¶³)', severity: 'warning' });
                } else {
                    checks.push({ item: 'API Key', status: 'âœ… å·²è®¾ç½®', severity: 'ok' });
                }

                // æ£€æŸ¥ projectId
                if (!this.firebaseConfig.projectId) {
                    checks.push({ item: 'Project ID', status: 'âŒ ç¼ºå¤±', severity: 'error' });
                } else if (this.firebaseConfig.projectId === 'your-project') {
                    checks.push({ item: 'Project ID', status: 'âŒ æœªè®¾ç½® (é»˜è®¤å€¼)', severity: 'error' });
                } else {
                    checks.push({ item: 'Project ID', status: `âœ… ${this.firebaseConfig.projectId}`, severity: 'ok' });
                }

                // æ£€æŸ¥ databaseURL
                if (!this.firebaseConfig.databaseURL) {
                    checks.push({ item: 'Database URL', status: 'âŒ ç¼ºå¤±', severity: 'error' });
                } else if (!this.firebaseConfig.databaseURL.startsWith('https://')) {
                    checks.push({ item: 'Database URL', status: 'âŒ æ ¼å¼é”™è¯¯ (å¿…é¡»ä»¥ https:// å¼€å¤´)', severity: 'error' });
                } else if (this.firebaseConfig.databaseURL.endsWith('/')) {
                    checks.push({ item: 'Database URL', status: 'âš ï¸ URL æœ«å°¾æœ‰æ–œæ  (å»ºè®®ç§»é™¤)', severity: 'warning' });
                } else if (!this.firebaseConfig.databaseURL.includes('firebasedatabase.app')) {
                    checks.push({ item: 'Database URL', status: 'âš ï¸ URLæ ¼å¼å¯èƒ½ä¸æ­£ç¡®', severity: 'warning' });
                } else {
                    checks.push({ item: 'Database URL', status: 'âœ… æ ¼å¼æ­£ç¡®', severity: 'ok' });
                }

                // æ£€æŸ¥ authDomain
                if (!this.firebaseConfig.authDomain) {
                    checks.push({ item: 'Auth Domain', status: 'âš ï¸ ç¼ºå¤±', severity: 'warning' });
                } else {
                    checks.push({ item: 'Auth Domain', status: 'âœ… å·²è®¾ç½®', severity: 'ok' });
                }

                // æ£€æŸ¥ storageBucket
                if (!this.firebaseConfig.storageBucket) {
                    checks.push({ item: 'Storage Bucket', status: 'âš ï¸ ç¼ºå¤±', severity: 'warning' });
                } else {
                    checks.push({ item: 'Storage Bucket', status: 'âœ… å·²è®¾ç½®', severity: 'ok' });
                }

                // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
                console.log('ğŸ“‹ é…ç½®é¡¹æ£€æŸ¥ï¼š');
                console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                checks.forEach(check => {
                    console.log(`${check.item.padEnd(20)} : ${check.status}`);
                });
                console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                console.log('');

                // ç»Ÿè®¡
                const errors = checks.filter(c => c.severity === 'error').length;
                const warnings = checks.filter(c => c.severity === 'warning').length;
                const oks = checks.filter(c => c.severity === 'ok').length;

                console.log('ğŸ“Š ç»Ÿè®¡ï¼š');
                console.log(`   âœ… æ­£å¸¸: ${oks} é¡¹`);
                console.log(`   âš ï¸ è­¦å‘Š: ${warnings} é¡¹`);
                console.log(`   âŒ é”™è¯¯: ${errors} é¡¹`);
                console.log('');

                if (errors > 0) {
                    console.log('âŒ é…ç½®å­˜åœ¨ä¸¥é‡é”™è¯¯ï¼Œäº‘ç«¯åŒæ­¥æ— æ³•å¯ç”¨');
                    console.log('ğŸ’¡ è¯·ä¿®å¤ä¸Šè¿°é”™è¯¯åé‡è¯•');
                } else if (warnings > 0) {
                    console.log('âš ï¸ é…ç½®å­˜åœ¨è­¦å‘Šï¼Œå»ºè®®ä¿®å¤ä»¥ç¡®ä¿æœ€ä½³ä½“éªŒ');
                } else {
                    console.log('âœ… é…ç½®çœ‹èµ·æ¥æ­£å¸¸');
                }

                console.log('');
                console.log('ğŸ”— è·å–æ­£ç¡®é…ç½®ï¼š');
                console.log('   1. è®¿é—® https://console.firebase.google.com/');
                console.log('   2. é€‰æ‹©ä½ çš„é¡¹ç›®');
                console.log('   3. ç‚¹å‡»é¡¹ç›®è®¾ç½® > å¸¸è§„');
                console.log('   4. åœ¨"æ‚¨çš„åº”ç”¨"éƒ¨åˆ†æ‰¾åˆ° Web åº”ç”¨');
                console.log('   5. å¤åˆ¶ firebaseConfig å¯¹è±¡');
                console.log('');
                console.log('========================================');
                console.log('');

                return { errors, warnings, oks, checks };
            }

            // è·å–ç”¨æˆ·ä¸“å±è·¯å¾„
            getUserPath(targetAccount) {
                const accountValue = targetAccount || (currentUser ? (currentUser.account || currentUser.email) : null);
                if (!accountValue) return 'users/guest';
                const userId = accountValue;
                return `users/${userId.replace(/[.@]/g, '_')}`;
            }

            async deleteUserAccount(account) {
                if (!this.isInitialized || !account) return;
                const userPath = this.getUserPath(account);
                try {
                    await this.db.ref(userPath).remove();
                    console.log(`âœ… å·²ä»äº‘ç«¯åˆ é™¤è´¦å· ${account}`);
                } catch (error) {
                    console.error(`äº‘ç«¯åˆ é™¤è´¦å· ${account} å¤±è´¥:`, error);
                    throw error;
                }
            }

            // ========== ç»Ÿä¸€æ•°æ®åŒæ­¥ç®¡ç†å™¨ ==========
            // åŒæ­¥çŠ¶æ€ç®¡ç†
            _syncState = {
                inProgress: false,
                queue: [],
                lastSyncTime: null,
                errorCount: 0
            };

            // ç»Ÿä¸€åŒæ­¥å…¥å£ï¼šè‡ªåŠ¨ç®¡ç†åŒæ­¥çŠ¶æ€ï¼Œé¿å…é‡å¤åŒæ­¥
            async syncAllData() {
                if (!this.isInitialized) {
                    console.warn('âš ï¸ äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–ï¼Œè·³è¿‡åŒæ­¥');
                    return;
                }

                // å¦‚æœæ­£åœ¨åŒæ­¥ï¼Œå°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—
                if (this._syncState.inProgress) {
                    console.log('â³ åŒæ­¥è¿›è¡Œä¸­ï¼Œè¯·æ±‚å·²åŠ å…¥é˜Ÿåˆ—');
                    return new Promise((resolve) => {
                        this._syncState.queue.push(resolve);
                    });
                }

                return this._executeSync();
            }

            // æ‰§è¡ŒåŒæ­¥ï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰
            async _executeSync() {
                this._syncState.inProgress = true;
                this._syncState.errorCount = 0;

                try {
                    console.log('ğŸ”„ å¼€å§‹äº‘ç«¯åŒæ­¥...');

                    // åŒæ­¥å…¨å±€å…±äº«æ•°æ®
                    if (isCurrentUserAdmin()) {
                        // ç®¡ç†å‘˜ï¼šä»¥ä¸Šä¼ æœ¬åœ°ä¸ºå‡†ï¼Œè¦†ç›–äº‘ç«¯
                        await this._safeSync('products', () => this.syncProducts());
                        await this._safeSync('users', () => this.syncAllUsers());
                    } else {
                        // æ™®é€šç”¨æˆ·ï¼šåªä»äº‘ç«¯æ‹‰å–æœ€æ–°æ•°æ®ï¼Œä¸ä¸Šä¼ è¦†ç›–
                        await this._safeSync('products', () => this.loadProducts());
                        await this._safeSync('users', () => this.loadAllUsers());
                        await this._safeSync('settings', () => this.loadHomepageSettings());
                    }

                    // åŒæ­¥ç”¨æˆ·è®¢å•å’Œåœ°å€
                    if (currentUser) {
                        await this._safeSync('profile', () => this.syncUserData());
                        await this._safeSync('orders', () => this.syncOrders());
                        await this._safeSync('addresses', () => this.syncAddresses());
                    }

                    this._syncState.lastSyncTime = new Date();
                    this._syncState.errorCount = 0;
                    console.log('âœ… äº‘ç«¯åŒæ­¥å®Œæˆ');

                } catch (error) {
                    this._syncState.errorCount++;
                    console.error('äº‘ç«¯åŒæ­¥å¤±è´¥:', error);
                    if (this._syncState.errorCount <= 3) {
                        showNotification('äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œå°†è‡ªåŠ¨é‡è¯•', 'warning');
                    } else {
                        showNotification('äº‘ç«¯åŒæ­¥å¤šæ¬¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                    }
                } finally {
                    this._syncState.inProgress = false;
                    // å¤„ç†é˜Ÿåˆ—ä¸­çš„ç­‰å¾…è¯·æ±‚
                    if (this._syncState.queue.length > 0) {
                        const nextResolve = this._syncState.queue.shift();
                        this._executeSync().then(() => nextResolve()).catch(() => nextResolve());
                    }
                }
            }

            // å®‰å…¨åŒæ­¥åŒ…è£…å™¨ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
            async _safeSync(type, syncFn) {
                const maxRetries = 2;
                let lastError = null;

                for (let attempt = 0; attempt <= maxRetries; attempt++) {
                    try {
                        await syncFn();
                        return;
                    } catch (error) {
                        lastError = error;
                        if (attempt < maxRetries) {
                            console.warn(`âš ï¸ ${type} åŒæ­¥å¤±è´¥ï¼Œ${1000 * (attempt + 1)}ms åé‡è¯•...`, error.message);
                            await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                        }
                    }
                }

                console.error(`âŒ ${type} åŒæ­¥æœ€ç»ˆå¤±è´¥:`, lastError);
                throw lastError;
            }

            // åŒæ­¥äº§å“æ•°æ®
            async syncProducts() {
                // åªæœ‰ç®¡ç†å‘˜æ‰å…è®¸æŠŠæœ¬åœ°äº§å“åˆ—è¡¨å†™å›äº‘ç«¯ï¼Œé˜²æ­¢æ™®é€šç”¨æˆ·è¦†ç›–ç®¡ç†å‘˜æ”¹åŠ¨
                if (!isCurrentUserAdmin()) {
                    console.log('â„¹ï¸ å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œè·³è¿‡äº§å“ä¸Šä¼ åŒæ­¥');
                    return;
                }
                
                const productsRef = this.db.ref('products');
                // ä¸Šä¼ æœ¬åœ°äº§å“åˆ°äº‘ç«¯
                await productsRef.set(products);
                console.log('âœ… äº§å“æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯ï¼Œæ•°é‡:', products.length);
            }

            // ä»äº‘ç«¯åŠ è½½äº§å“æ•°æ®
            async loadProducts() {
                if (!this.isInitialized) return;

                try {
                    const snapshot = await this.db.ref('products').once('value');
                    const cloudProducts = snapshot.val();

                    if (cloudProducts && Array.isArray(cloudProducts) && cloudProducts.length > 0) {
                        // è¿‡æ»¤æ‰æ— æ•ˆçš„äº§å“ï¼ˆnullã€undefined æˆ–ç¼ºå°‘å¿…è¦å±æ€§ï¼‰
                        products = cloudProducts.filter(p => p && typeof p === 'object' && p.id && p.name);
                        localStorage.setItem('products', JSON.stringify(products));
                        console.log('âœ… å·²ä»äº‘ç«¯åŠ è½½äº§å“æ•°æ®ï¼Œæœ‰æ•ˆäº§å“æ•°é‡:', products.length);
                        return true;
                    }
                } catch (error) {
                    console.error('åŠ è½½äº‘ç«¯äº§å“å¤±è´¥:', error);
                }
                return false;
            }

            // åŒæ­¥ç”¨æˆ·æ•°æ®
            async syncUserData() {
                if (!currentUser) return;

                // è®¿å®¢ç”¨æˆ·ä¸åŒæ­¥ä¸ªäººæ•°æ®
                if (currentUser.username === 'guest') {
                    console.log('â„¹ï¸ è®¿å®¢ç”¨æˆ·è·³è¿‡ä¸ªäººæ•°æ®åŒæ­¥');
                    return;
                }

                try {
                    const userPath = this.getUserPath();
                    const userRef = this.db.ref(`${userPath}/profile`);

                    await userRef.set({
                        email: currentUser.email || '',
                        username: currentUser.username,
                        phone: currentUser.phone || '',
                        avatar: currentUser.avatar || '',
                        updatedAt: Date.now()
                    });

                    console.log('âœ… ç”¨æˆ·æ•°æ®å·²åŒæ­¥');
                } catch (error) {
                    console.error('ç”¨æˆ·æ•°æ®åŒæ­¥å¤±è´¥:', error);
                    throw error;
                }
            }

            // åŒæ­¥è®¢å•æ•°æ®
            async syncOrders() {
                if (!currentUser) return;

                // è®¿å®¢ç”¨æˆ·ä¸åŒæ­¥è®¢å•æ•°æ®
                if (currentUser.username === 'guest') {
                    console.log('â„¹ï¸ è®¿å®¢ç”¨æˆ·è·³è¿‡è®¢å•æ•°æ®åŒæ­¥');
                    return;
                }

                const userPath = this.getUserPath();
                const ordersRef = this.db.ref(`${userPath}/orders`);

                // ä¸ºæ¯ä¸ªè®¢å•æ·»åŠ æ›´æ–°æ—¶é—´æˆ³
                const ordersToSync = userOrders.map(order => ({
                    ...order,
                    updatedAt: order.updatedAt || Date.now(),
                    account: order.account || currentUser.account
                }));

                await ordersRef.set(ordersToSync);
                console.log('âœ… è®¢å•æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯ï¼Œæ•°é‡:', ordersToSync.length);
            }

            // ä»äº‘ç«¯åŠ è½½è®¢å•æ•°æ®ï¼ˆæ›´å®‰å…¨ï¼šä¼˜å…ˆä¿æŠ¤æœ¬åœ°æ•°æ®ï¼Œä¸è½»æ˜“æ¸…ç©ºï¼‰
            async loadOrders() {
                if (!this.isInitialized || !currentUser) {
                    // æœªç™»å½•æ—¶æ¸…ç©ºè®¢å•ï¼ˆè¿™æ˜¯ç”¨æˆ·ä¸»åŠ¨é€€å‡º/æœªç™»å½•åœºæ™¯ï¼Œå±äºæ­£å¸¸æ¸…ç©ºï¼‰
                    userOrders = [];
                    localStorage.setItem('userOrders', JSON.stringify(userOrders));
                    return false;
                }

                // åœ¨å°è¯•åŠ è½½å‰ï¼Œå…ˆå¤‡ä»½ä¸€ä»½å½“å‰æœ¬åœ°è®¢å•æ•°æ®ï¼Œé˜²æ­¢æ„å¤–ä¸¢å¤±
                try {
                    const backupKey = `userOrders_backup_${currentUser.account || 'guest'}`;
                    localStorage.setItem(backupKey, JSON.stringify(userOrders || []));
                } catch (backupError) {
                    console.warn('å¤‡ä»½æœ¬åœ°è®¢å•å¤±è´¥ï¼ˆä¸å½±å“æ­£å¸¸æµç¨‹ï¼‰:', backupError);
                }

                try {
                    const userPath = this.getUserPath();
                    const snapshot = await this.db.ref(`${userPath}/orders`).once('value');
                    const cloudOrders = snapshot.val();

                    if (cloudOrders && Array.isArray(cloudOrders) && cloudOrders.length > 0) {
                        // âœ… äº‘ç«¯æœ‰è®¢å•ï¼šä¸æœ¬åœ°è®¢å•è¿›è¡Œåˆå¹¶ï¼Œé¿å…æœ¬åœ°æˆ–äº‘ç«¯å•æ–¹é¢è¦†ç›–
                        console.log('âœ… æ£€æµ‹åˆ°äº‘ç«¯è®¢å•æ•°æ®ï¼Œå¼€å§‹åˆå¹¶æœ¬åœ°ä¸äº‘ç«¯è®¢å•...');
                        try {
                            mergeOrdersData(cloudOrders, currentUser.account || 'guest');
                        } catch (mergeError) {
                            console.warn('åˆå¹¶è®¢å•æ•°æ®å¤±è´¥ï¼Œæ”¹ä¸ºç›´æ¥ä½¿ç”¨äº‘ç«¯è®¢å•:', mergeError);
                            userOrders = cloudOrders;
                        }

                        const userOrdersKey = `userOrders_${currentUser.account || 'guest'}`;
                        localStorage.setItem(userOrdersKey, JSON.stringify(userOrders));
                        localStorage.setItem('userOrders', JSON.stringify(userOrders));

                        console.log('âœ… å·²ä»äº‘ç«¯åŠ è½½å¹¶åˆå¹¶è®¢å•æ•°æ®:', userOrders.length, 'ä¸ªè®¢å•');
                        return true;
                    } else {
                        // â„¹ï¸ äº‘ç«¯æ²¡æœ‰è®¢å•
                        if (Array.isArray(userOrders) && userOrders.length > 0) {
                            // âœ… æœ¬åœ°æœ‰è®¢å•ï¼Œä½†äº‘ç«¯ä¸ºç©ºï¼šæ£€æŸ¥æ˜¯å¦æ˜¯æœ€è¿‘åˆ›å»ºçš„è®¢å•
                            // æ—¶é—´é˜ˆå€¼ï¼šåªä¿ç•™æœ€è¿‘30å¤©å†…åˆ›å»ºçš„è®¢å•
                            const RECENT_ORDER_THRESHOLD = 30 * 24 * 60 * 60 * 1000; // 30å¤©
                            const now = Date.now();
                            const recentOrders = userOrders.filter(order => {
                                if (!order || !order.id) return false;
                                const orderTime = order.date || order.updatedAt || 0;
                                return (now - orderTime) < RECENT_ORDER_THRESHOLD;
                            });
                            
                            if (recentOrders.length > 0) {
                                // åªä¿ç•™æœ€è¿‘åˆ›å»ºçš„è®¢å•ï¼Œé¿å…å†å²æ•°æ®é‡ç°
                                userOrders = recentOrders;
                                const userOrdersKey = `userOrders_${currentUser.account || 'guest'}`;
                                localStorage.setItem(userOrdersKey, JSON.stringify(userOrders));
                                localStorage.setItem('userOrders', JSON.stringify(userOrders));
                                
                                console.warn(`âš ï¸ äº‘ç«¯æš‚æ— è®¢å•æ•°æ®ï¼Œä½†æœ¬åœ°å­˜åœ¨ ${userOrders.length} ä¸ªæœ€è¿‘è®¢å•ï¼Œå°†ä¿ç•™å¹¶å°è¯•åŒæ­¥åˆ°äº‘ç«¯`);
                                if (typeof showNotification === 'function') {
                                    showNotification('æ£€æµ‹åˆ°æœ¬åœ°æœ‰æœªåŒæ­¥çš„è®¢å•ï¼Œæ­£åœ¨å°è¯•åŒæ­¥åˆ°äº‘ç«¯â€¦', 'warning');
                                }

                                // å°è¯•æŠŠæœ¬åœ°è®¢å•åŒæ­¥åˆ°äº‘ç«¯
                                try {
                                    if (typeof this.syncOrders === 'function') {
                                        await this.syncOrders();
                                    }
                                } catch (syncError) {
                                    console.error('å°è¯•å°†æœ¬åœ°è®¢å•åŒæ­¥åˆ°äº‘ç«¯å¤±è´¥:', syncError);
                                }

                                return true;
                            } else {
                                // æœ¬åœ°è®¢å•éƒ½æ˜¯æ—§çš„ï¼Œæ¸…ç©ºæœ¬åœ°æ•°æ®ï¼Œé¿å…å†å²æ•°æ®é‡ç°
                                console.log('â„¹ï¸ æœ¬åœ°è®¢å•éƒ½æ˜¯æ—§çš„ï¼ˆè¶…è¿‡30å¤©ï¼‰ï¼Œæ¸…ç©ºæœ¬åœ°æ•°æ®ï¼Œé¿å…å†å²æ•°æ®é‡ç°');
                                userOrders = [];
                                const userOrdersKey = `userOrders_${currentUser.account || 'guest'}`;
                                localStorage.setItem(userOrdersKey, JSON.stringify(userOrders));
                                localStorage.setItem('userOrders', JSON.stringify(userOrders));
                                return false;
                            }
                        } else {
                            // äº‘ç«¯å’Œæœ¬åœ°éƒ½æ²¡æœ‰è®¢å•ï¼Œç¡®ä¿æœ¬åœ°æ˜¯ç©ºæ•°ç»„å³å¯
                            userOrders = [];
                            const userOrdersKey = `userOrders_${currentUser.account || 'guest'}`;
                            localStorage.setItem(userOrdersKey, JSON.stringify(userOrders));
                            localStorage.setItem('userOrders', JSON.stringify(userOrders));
                            console.log('â„¹ï¸ äº‘ç«¯å’Œæœ¬åœ°å‡æ— è®¢å•æ•°æ®');
                            return false;
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½äº‘ç«¯è®¢å•å¤±è´¥ï¼ˆæœ¬åœ°æ•°æ®å°†è¢«ä¿ç•™ï¼‰:', error);
                    // â— åŠ è½½å¤±è´¥æ—¶ä¸å†æ¸…ç©ºæœ¬åœ°è®¢å•ï¼Œé¿å…æŠŠç”¨æˆ·è®¢å•â€œè¯¯åˆ â€
                    if (typeof showNotification === 'function') {
                        showNotification('åŠ è½½äº‘ç«¯è®¢å•å¤±è´¥ï¼Œå·²æš‚æ—¶ä¿ç•™æœ¬åœ°è®¢å•æ•°æ®', 'warning');
                    }
                    return false;
                }
            }
            
            // åŠ è½½æ‰€æœ‰ç”¨æˆ·çš„è®¢å•ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰
            async loadAllOrders() {
                if (!this.isInitialized || !currentUser || currentUser.role !== 'admin') {
                    return false;
                }

                try {
                    const usersRef = this.db.ref('users');
                    const snapshot = await usersRef.once('value');
                    const usersData = snapshot.val();
                    
                    if (!usersData) {
                        console.log('â„¹ï¸ äº‘ç«¯æš‚æ— ç”¨æˆ·æ•°æ®');
                        return false;
                    }
                    
                    // æ”¶é›†æ‰€æœ‰ç”¨æˆ·çš„è®¢å•
                    const collectedOrders = [];
                    for (const userId in usersData) {
                        const userData = usersData[userId];
                        if (userData.orders && Array.isArray(userData.orders)) {
                            userData.orders.forEach(order => {
                                if (!order.account) {
                                    order.account = userId;
                                }
                                collectedOrders.push(order);
                            });
                        }
                    }
                    
                    if (collectedOrders.length > 0) {
                        // åˆå¹¶å‰å…ˆæ¸…ç©ºæœ¬åœ°æ—§æ•°æ®ï¼Œé¿å…å†å²æ•°æ®é‡ç°
                        // ä»¥äº‘ç«¯æ•°æ®ä¸ºå‡†ï¼Œé¿å…æœ¬åœ°æ—§æ•°æ®å¹²æ‰°
                        mergeAllOrdersData(collectedOrders);
                        console.log('âœ… å·²ä»äº‘ç«¯åŠ è½½æ‰€æœ‰è®¢å•æ•°æ®:', allOrders.length, 'ä¸ªè®¢å•');
                        return true;
                    } else {
                        // äº‘ç«¯æ²¡æœ‰è®¢å•æ•°æ®ï¼Œæ¸…ç©ºæœ¬åœ°æ•°æ®ï¼Œé¿å…å†å²æ•°æ®é‡ç°
                        console.log('â„¹ï¸ äº‘ç«¯æš‚æ— è®¢å•æ•°æ®ï¼Œæ¸…ç©ºæœ¬åœ°æ•°æ®');
                        allOrders = [];
                        localStorage.setItem('allOrders', JSON.stringify(allOrders));
                        return false;
                    }
                } catch (error) {
                    console.error('åŠ è½½æ‰€æœ‰è®¢å•å¤±è´¥:', error);
                    return false;
                }
            }

            // åŒæ­¥åœ°å€æ•°æ®
            async syncAddresses() {
                if (!currentUser) return;

                // è®¿å®¢ç”¨æˆ·ä¸åŒæ­¥åœ°å€æ•°æ®
                if (currentUser.username === 'guest') {
                    console.log('â„¹ï¸ è®¿å®¢ç”¨æˆ·è·³è¿‡åœ°å€æ•°æ®åŒæ­¥');
                    return;
                }

                const userPath = this.getUserPath();
                const addressesRef = this.db.ref(`${userPath}/addresses`);
                await addressesRef.set(userAddresses);
                console.log('âœ… åœ°å€æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯ï¼Œæ•°é‡:', userAddresses.length);
            }

            // ä»äº‘ç«¯åŠ è½½åœ°å€æ•°æ®ï¼ˆæ›´å®‰å…¨ï¼šä¼˜å…ˆä¿æŠ¤æœ¬åœ°æ•°æ®ï¼Œä¸è½»æ˜“æ¸…ç©ºï¼‰
            async loadAddresses() {
                if (!this.isInitialized || !currentUser) {
                    // æœªç™»å½•æ—¶æ¸…ç©ºåœ°å€ï¼ˆè¿™æ˜¯ç”¨æˆ·ä¸»åŠ¨é€€å‡º/æœªç™»å½•åœºæ™¯ï¼Œå±äºæ­£å¸¸æ¸…ç©ºï¼‰
                    userAddresses = [];
                    localStorage.setItem('userAddresses', JSON.stringify(userAddresses));
                    return false;
                }

                // åœ¨å°è¯•åŠ è½½å‰ï¼Œå…ˆå¤‡ä»½ä¸€ä»½å½“å‰æœ¬åœ°åœ°å€æ•°æ®ï¼Œé˜²æ­¢æ„å¤–ä¸¢å¤±
                try {
                    const backupKey = `userAddresses_backup_${currentUser.account || 'guest'}`;
                    localStorage.setItem(backupKey, JSON.stringify(userAddresses || []));
                } catch (backupError) {
                    console.warn('å¤‡ä»½æœ¬åœ°åœ°å€å¤±è´¥ï¼ˆä¸å½±å“æ­£å¸¸æµç¨‹ï¼‰:', backupError);
                }

                try {
                    const userPath = this.getUserPath();
                    const snapshot = await this.db.ref(`${userPath}/addresses`).once('value');
                    const cloudAddresses = snapshot.val();

                    if (cloudAddresses && Array.isArray(cloudAddresses) && cloudAddresses.length > 0) {
                        // âœ… äº‘ç«¯æœ‰åœ°å€ï¼šç›´æ¥ä»¥äº‘ç«¯ä¸ºå‡†è¦†ç›–æœ¬åœ°ï¼ˆåœ°å€ä¸€èˆ¬ä¸éœ€è¦å¤æ‚åˆå¹¶ï¼‰
                        userAddresses = cloudAddresses;
                        const userAddressesKey = `userAddresses_${currentUser.account || 'guest'}`;
                        localStorage.setItem(userAddressesKey, JSON.stringify(userAddresses));
                        localStorage.setItem('userAddresses', JSON.stringify(userAddresses)); // å…¼å®¹æ—§ä»£ç 
                        console.log('âœ… å·²ä»äº‘ç«¯åŠ è½½åœ°å€æ•°æ®:', userAddresses.length, 'ä¸ªåœ°å€');
                        return true;
                    } else {
                        // â„¹ï¸ äº‘ç«¯æ²¡æœ‰åœ°å€
                        if (Array.isArray(userAddresses) && userAddresses.length > 0) {
                            // âœ… æœ¬åœ°æœ‰åœ°å€ä½†äº‘ç«¯ä¸ºç©ºï¼šä¿æŠ¤æœ¬åœ°æ•°æ®ï¼Œæç¤ºå¹¶å°è¯•åŒæ­¥åˆ°äº‘ç«¯
                            console.warn('âš ï¸ äº‘ç«¯æš‚æ— åœ°å€æ•°æ®ï¼Œä½†æœ¬åœ°å­˜åœ¨', userAddresses.length, 'ä¸ªåœ°å€ï¼Œå°†ä¿ç•™æœ¬åœ°æ•°æ®å¹¶å°è¯•åŒæ­¥åˆ°äº‘ç«¯');
                            if (typeof showNotification === 'function') {
                                showNotification('æ£€æµ‹åˆ°æœ¬åœ°æœ‰æœªåŒæ­¥çš„åœ°å€ï¼Œæ­£åœ¨å°è¯•åŒæ­¥åˆ°äº‘ç«¯â€¦', 'warning');
                            }

                            try {
                                if (typeof this.syncAddresses === 'function') {
                                    await this.syncAddresses();
                                }
                            } catch (syncError) {
                                console.error('å°è¯•å°†æœ¬åœ°åœ°å€åŒæ­¥åˆ°äº‘ç«¯å¤±è´¥:', syncError);
                            }

                            // ä¸æ¸…ç©ºæœ¬åœ°åœ°å€ï¼Œåªæ˜¯è®°å½•æ—¥å¿—
                            return true;
                        } else {
                            // äº‘ç«¯å’Œæœ¬åœ°éƒ½æ²¡æœ‰åœ°å€ï¼Œç¡®ä¿æœ¬åœ°æ˜¯ç©ºæ•°ç»„å³å¯
                            userAddresses = [];
                            const userAddressesKey = `userAddresses_${currentUser.account || 'guest'}`;
                            localStorage.setItem(userAddressesKey, JSON.stringify(userAddresses));
                            localStorage.setItem('userAddresses', JSON.stringify(userAddresses));
                            console.log('â„¹ï¸ äº‘ç«¯å’Œæœ¬åœ°å‡æ— åœ°å€æ•°æ®');
                            return false;
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½äº‘ç«¯åœ°å€å¤±è´¥ï¼ˆæœ¬åœ°æ•°æ®å°†è¢«ä¿ç•™ï¼‰:', error);
                    // â— åŠ è½½å¤±è´¥æ—¶ä¸å†æ¸…ç©ºæœ¬åœ°åœ°å€ï¼Œé¿å…æŠŠç”¨æˆ·åœ°å€â€œè¯¯åˆ â€
                    if (typeof showNotification === 'function') {
                        showNotification('åŠ è½½äº‘ç«¯åœ°å€å¤±è´¥ï¼Œå·²æš‚æ—¶ä¿ç•™æœ¬åœ°åœ°å€æ•°æ®', 'warning');
                    }
                    return false;
                }
            }

            // åŒæ­¥æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼ˆå…¨å±€å…±äº«ï¼‰
            async syncAllUsers() {
                const usersRef = this.db.ref('allUsers');

                if (isCurrentUserAdmin()) {
                    // ç®¡ç†å‘˜ï¼šä»äº‘ç«¯æ‹‰å–å¹¶ä¸æœ¬åœ°åˆå¹¶ï¼Œç„¶åå°†åˆå¹¶åçš„ç»“æœå†™å›äº‘ç«¯
                    console.log('ğŸ”„ ç®¡ç†å‘˜æ­£åœ¨åŒæ­¥æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼ˆæ‹‰å– + åˆå¹¶ + å†™å›äº‘ç«¯ï¼‰...');
                    const snapshot = await usersRef.once('value');
                    const cloudUsers = Array.isArray(snapshot.val()) ? snapshot.val() : [];

                    const mergedUsers = mergeUsersData(cloudUsers, allUsers, { allowUnban: true });
                    allUsers = mergedUsers;
                    localStorage.setItem('allUsers', JSON.stringify(allUsers));

                    await usersRef.set(allUsers);
                    console.log('âœ… æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼ˆå«ç¦ç”¨çŠ¶æ€ï¼‰å·²å†™å›äº‘ç«¯');
                } else {
                    // éç®¡ç†å‘˜ï¼šåªå°†è‡ªå·±æ·»åŠ åˆ°äº‘ç«¯çš„ allUsers æ•°ç»„
                    let targetAccount = null;
                    let targetUserData = null;
                    
                    if (currentUser && currentUser.account) {
                        targetAccount = currentUser.account;
                        targetUserData = allUsers.find(u => u.account === targetAccount);
                    } else if (allUsers.length > 0) {
                        const sortedUsers = [...allUsers].sort((a, b) => {
                            const aId = a.id || (a.registerTime ? new Date(a.registerTime).getTime() : 0);
                            const bId = b.id || (b.registerTime ? new Date(b.registerTime).getTime() : 0);
                            return bId - aId;
                        });
                        targetUserData = sortedUsers[0];
                        targetAccount = targetUserData.account;
                    }
                    
                    if (targetAccount && targetUserData) {
                        // ä½¿ç”¨äº‹åŠ¡åŸå­åœ°æ›´æ–° allUsersï¼Œé¿å…å¹¶å‘å†™å¯¼è‡´çš„ä¸¢å¤±
                        await usersRef.transaction((current) => {
                            let list = Array.isArray(current) ? current.slice() : [];
                            const idx = list.findIndex(u => u && u.account === targetAccount);
                            if (idx >= 0) {
                                const existing = list[idx];
                                // å®‰å…¨è§„åˆ™ï¼šå¦‚æœäº‘ç«¯è¯¥è´¦å·å·²è¢«ç¦ç”¨ï¼Œåˆ™æ™®é€šç”¨æˆ·ä¸èƒ½å†æŠŠå®ƒæ”¹å›æ­£å¸¸
                                if (existing && existing.status === 'banned' && targetUserData.status !== 'banned') {
                                    return list;
                                }
                                list[idx] = {
                                    ...existing,
                                    ...targetUserData,
                                    status: existing.status === 'banned' ? 'banned' : (targetUserData.status || existing.status),
                                };
                            } else {
                                list.push(targetUserData);
                            }
                            return list;
                        });
                        console.log('âœ… é€šè¿‡äº‹åŠ¡å·²å†™å…¥äº‘ç«¯ allUsers:', targetAccount);
                    }
                }
            }

            // æ¸…ç†äº‘ç«¯ users èŠ‚ç‚¹ï¼šä»…åˆ é™¤åœ¨ allUsers ä¸­ä¸å­˜åœ¨çš„è´¦å·
            async clearCloudUsers() {
                // åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ
                if (!isCurrentUserAdmin()) {
                    console.warn('â„¹ï¸ å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œç¦æ­¢æ¸…ç†äº‘ç«¯ users èŠ‚ç‚¹');
                    throw new Error('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ¸…ç†äº‘ç«¯ users èŠ‚ç‚¹');
                }

                if (!this.isInitialized || !this.db) {
                    throw new Error('äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ“ä½œäº‘ç«¯ç”¨æˆ·æ•°æ®');
                }

                try {
                    const allUsersSnap = await this.db.ref('allUsers').once('value');
                    const cloudAllUsers = Array.isArray(allUsersSnap.val()) ? allUsersSnap.val() : [];
                    // å®‰å…¨ä¿æŠ¤ï¼šå½“ allUsers ä¸ºç©ºæ—¶ï¼Œä¸æ‰§è¡Œæ¸…ç†æ“ä½œï¼Œé¿å…è¯¯åˆ 
                    if (cloudAllUsers.length === 0) {
                        console.warn('âš ï¸ äº‘ç«¯ allUsers ä¸ºç©ºï¼Œå‡ºäºå®‰å…¨è€ƒè™‘è·³è¿‡ users æ¸…ç†');
                        return { removed: 0, skipped: true, reason: 'empty_allUsers' };
                    }
                    const keepAccounts = new Set(cloudAllUsers.map(u => u && u.account).filter(Boolean));

                    const usersRef = this.db.ref('users');
                    const usersSnap = await usersRef.once('value');
                    const usersData = usersSnap.val() || {};

                    const updates = {};
                    let removeCount = 0;
                    Object.keys(usersData).forEach(accountKey => {
                        if (!keepAccounts.has(accountKey)) {
                            updates[accountKey] = null; // ç½®ä¸º null å³åˆ é™¤è¯¥å­èŠ‚ç‚¹
                            removeCount++;
                        }
                    });

                    if (removeCount === 0) {
                        console.log('â„¹ï¸ users èŠ‚ç‚¹æ— éœ€æ¸…ç†ï¼ˆæ‰€æœ‰è´¦å·å‡åœ¨ allUsers ä¸­å­˜åœ¨ï¼‰');
                        return { removed: 0 };
                    }

                    await usersRef.update(updates);
                    console.log(`âœ… å·²æ¸…ç† users èŠ‚ç‚¹ï¼šåˆ é™¤ ${removeCount} ä¸ªè´¦å·ï¼ˆä»…ä¿ç•™åœ¨ allUsers ä¸­å­˜åœ¨çš„è´¦å·ï¼‰`);
                    return { removed: removeCount };
                } catch (error) {
                    console.error('æ¸…ç†äº‘ç«¯ users èŠ‚ç‚¹å¤±è´¥:', error);
                    throw error;
                }
            }

            // ä»äº‘ç«¯åŠ è½½æ‰€æœ‰ç”¨æˆ·æ•°æ®
            async loadAllUsers() {
                if (!this.isInitialized) return;

                try {
                    const snapshot = await this.db.ref('allUsers').once('value');
                    const cloudUsers = snapshot.val();

                    if (cloudUsers && Array.isArray(cloudUsers) && cloudUsers.length > 0) {
                        // ä»¥äº‘ç«¯æ•°æ®ä¸ºå‡†ï¼Œç›´æ¥æ›¿æ¢æœ¬åœ°æ•°æ®ï¼Œé¿å…å†å²ç”¨æˆ·é‡ç°
                        allUsers = cloudUsers;
                        localStorage.setItem('allUsers', JSON.stringify(allUsers));
                        
                        console.log(`ğŸ”„ ç”¨æˆ·æ•°æ®å·²ä»äº‘ç«¯æ›´æ–°: ${cloudUsers.length} ä¸ªç”¨æˆ·ï¼ˆå·²æ›¿æ¢æœ¬åœ°æ•°æ®ï¼‰`);

                        // å¦‚æœå½“å‰ç”¨æˆ·å·²ç™»å½•ï¼Œåˆ·æ–°currentUserå¯¹è±¡
                        if (currentUser && currentUser.account) {
                            refreshCurrentUserSnapshot(currentUser.account);
                            console.log('âœ… å·²åˆ·æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯å¿«ç…§');
                        }

                        console.log('âœ… å·²ä»äº‘ç«¯åŠ è½½æ‰€æœ‰ç”¨æˆ·æ•°æ®');
                        return true;
                    }
                } catch (error) {
                    console.error('åŠ è½½äº‘ç«¯ç”¨æˆ·å¤±è´¥:', error);
                }
                return false;
            }

            // é€šç”¨ä¸‹è½½æ¥å£ï¼šæ ¹æ®ç±»å‹ä»äº‘ç«¯è¯»å–æ•°æ®ï¼Œç»™ç™»å½•æµç¨‹ & æµ‹è¯•å·¥å…·å¤ç”¨
            async downloadData(type) {
                if (!this.isInitialized) {
                    throw new Error('CloudSyncManager æœªåˆå§‹åŒ–ï¼Œæ— æ³•ä¸‹è½½æ•°æ®');
                }

                let path = null;
                switch (type) {
                    case 'products':
                        path = 'products';
                        break;
                    case 'users':
                        // ç”¨æˆ·åˆ—è¡¨ç»Ÿä¸€ä½¿ç”¨ allUsers èŠ‚ç‚¹
                        path = 'allUsers';
                        break;
                    case 'orders':
                        // è®¢å•åœ¨ users èŠ‚ç‚¹ä¸‹æŒ‰ç”¨æˆ·åˆ†æ•£å­˜å‚¨ï¼Œè¿™é‡Œå¤ç”¨ loadAllOrders çš„é€»è¾‘
                        // ä¸ºä¿æŒè¿”å›ç»“æ„ç®€å•ï¼Œç›´æ¥èšåˆæˆæ•°ç»„è¿”å›
                        const usersRef = this.db.ref('users');
                        const snapshot = await usersRef.once('value');
                        const usersData = snapshot.val();
                        if (!usersData) return [];

                        const collectedOrders = [];
                        for (const userId in usersData) {
                            const userData = usersData[userId];
                            if (userData && Array.isArray(userData.orders)) {
                                userData.orders.forEach(order => {
                                    if (!order.account) {
                                        order.account = userId;
                                    }
                                    collectedOrders.push(order);
                                });
                            }
                        }
                        return collectedOrders;
                    default:
                        throw new Error(`ä¸æ”¯æŒçš„ä¸‹è½½ç±»å‹: ${type}`);
                }

                const ref = this.db.ref(path);
                const snapshot = await ref.once('value');
                const data = snapshot.val();

                // products / allUsers éƒ½æ˜¯æ•°ç»„å½¢å¼ï¼Œä¿æŒä¸€è‡´
                if (Array.isArray(data)) {
                    return data;
                }
                // å…¶å®ƒæƒ…å†µç›´æ¥è¿”å›åŸå§‹å¯¹è±¡ï¼ˆè°ƒç”¨æ–¹è‡ªå·±å¤„ç†ï¼‰
                return data || [];
            }

            // åŒæ­¥ä¸»é¡µè®¾ç½®
            async syncHomepageSettings() {
                // ä¸»é¡µè®¾ç½®ä»…ç®¡ç†å‘˜å¯ä¸Šä¼ 
                if (!isCurrentUserAdmin()) {
                    console.log('â„¹ï¸ å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œè·³è¿‡ä¸»é¡µè®¾ç½®ä¸Šä¼ ');
                    return;
                }
                try {
                    const settingsRef = this.db.ref('homepageSettings');
                    const settings = JSON.parse(localStorage.getItem('homepageSettings') || '{}');
                    
                    // ä¸Šä¼ ä¸»é¡µè®¾ç½®åˆ°äº‘ç«¯
                    await settingsRef.set(settings);
                    
                    console.log('âœ… ä¸»é¡µè®¾ç½®å·²åŒæ­¥');
                } catch (error) {
                    console.error('ä¸»é¡µè®¾ç½®åŒæ­¥å¤±è´¥:', error);
                    throw error;
                }
            }

            // ä»äº‘ç«¯åŠ è½½ä¸»é¡µè®¾ç½®
            async loadHomepageSettings() {
                if (!this.isInitialized) return;

                try {
                    const snapshot = await this.db.ref('homepageSettings').once('value');
                    const cloudSettings = snapshot.val();

                    if (cloudSettings && typeof cloudSettings === 'object') {
                        // åˆå¹¶äº‘ç«¯è®¾ç½®å’Œæœ¬åœ°è®¾ç½®
                        const localSettings = JSON.parse(localStorage.getItem('homepageSettings') || '{}');
                        const mergedSettings = { ...localSettings, ...cloudSettings };
                        
                        localStorage.setItem('homepageSettings', JSON.stringify(mergedSettings));
                        
                        // å¦‚æœå®šä¹‰äº†å…¨å±€å˜é‡ï¼Œæ›´æ–°å®ƒ
                        if (typeof homepageSettings !== 'undefined') {
                            Object.assign(homepageSettings, mergedSettings);
                        }
                        
                        console.log('âœ… å·²ä»äº‘ç«¯åŠ è½½ä¸»é¡µè®¾ç½®');
                        return true;
                    }
                } catch (error) {
                    console.error('åŠ è½½äº‘ç«¯ä¸»é¡µè®¾ç½®å¤±è´¥:', error);
                }
                return false;
            }

            // è®¾ç½®å®æ—¶ç›‘å¬
            setupRealtimeListeners() {
                if (!this.isInitialized) return;

                // ç›‘å¬äº§å“æ•°æ®å˜åŒ–ï¼ˆå…¬å…±æ•°æ®ï¼šæ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°ï¼‰
                const productsRef = this.db.ref('products');
                productsRef.on('value', (snapshot) => {
                    const cloudProducts = snapshot.val();
                    if (cloudProducts && Array.isArray(cloudProducts) && !this._syncState.inProgress) {
                        // è¿‡æ»¤æ‰æ— æ•ˆçš„äº§å“ï¼ˆnullã€undefined æˆ–ç¼ºå°‘å¿…è¦å±æ€§ï¼‰
                        const validProducts = cloudProducts.filter(p => p && typeof p === 'object' && p.id && p.name);
                        
                        // æ£€æµ‹äº§å“æ•°é‡å˜åŒ–
                        const productCountChanged = products.length !== validProducts.length;
                        const productIdsChanged = products.length === validProducts.length && 
                            products.some((p, i) => p.id !== validProducts[i]?.id);
                        
                        products = validProducts;
                        localStorage.setItem('products', JSON.stringify(products));

                        // åˆ·æ–°äº§å“æ˜¾ç¤º
                        const homePage = document.getElementById('home-page');
                        const adminPanel = document.getElementById('admin-panel');

                        if (homePage && homePage.style.display !== 'none') {
                            renderProducts(products);
                            if (productCountChanged || productIdsChanged) {
                                showNotification('äº§å“åˆ—è¡¨å·²æ›´æ–°', 'info');
                            }
                        }
                        if (adminPanel && adminPanel.style.display !== 'none') {
                            renderAdminProducts();
                        }

                        console.log(`ğŸ”„ äº§å“æ•°æ®å·²ä»äº‘ç«¯æ›´æ–°: ${validProducts.length} ä¸ªäº§å“`);
                    } else if (cloudProducts === null) {
                        console.log('â„¹ï¸ äº‘ç«¯äº§å“æ•°æ®ä¸ºç©º');
                        products = [];
                        localStorage.setItem('products', JSON.stringify(products));
                        renderProducts(products);
                    }
                }, (error) => {
                    console.error('âŒ äº§å“ç›‘å¬å™¨é”™è¯¯:', error);
                });

                // ç›‘å¬æ‰€æœ‰ç”¨æˆ·æ•°æ®å˜åŒ–ï¼ˆå…¬å…±æ•°æ®ï¼šæ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°ï¼‰
                const allUsersRef = this.db.ref('allUsers');
                allUsersRef.on('value', (snapshot) => {
                    const cloudUsers = snapshot.val();
                    if (cloudUsers && Array.isArray(cloudUsers) && !this._syncState.inProgress) {
                        const previousAllUsers = JSON.parse(JSON.stringify(allUsers)); // ä¿å­˜ä¹‹å‰çš„æ•°æ®ç”¨äºå¯¹æ¯”
                        allUsers = cloudUsers;
                        localStorage.setItem('allUsers', JSON.stringify(allUsers));
                        
                        console.log(`ğŸ”„ ç”¨æˆ·æ•°æ®å·²ä»äº‘ç«¯æ›´æ–°: ${cloudUsers.length} ä¸ªç”¨æˆ·`);

                        // å¦‚æœå½“å‰ç”¨æˆ·å·²ç™»å½•ï¼Œåˆ·æ–°currentUserå¯¹è±¡
                        if (currentUser && currentUser.account) {
                            const previousUser = previousAllUsers.find(u => u.account === currentUser.account);
                            const currentUserData = allUsers.find(u => u.account === currentUser.account);
                            
                            // æ£€æŸ¥ç”¨æˆ·æ•°æ®æ˜¯å¦æœ‰å˜åŒ–
                            const hasChanges = !previousUser || 
                                previousUser.status !== currentUserData?.status ||
                                previousUser.points !== currentUserData?.points ||
                                previousUser.username !== currentUserData?.username ||
                                previousUser.password !== currentUserData?.password;
                            
                            if (hasChanges && currentUserData) {
                                refreshCurrentUserSnapshot(currentUser.account);
                                
                                // ç«‹å³æ›´æ–°ç”¨æˆ·ç•Œé¢æ˜¾ç¤º
                                updateUserInterface();
                                
                                // å¦‚æœç”¨æˆ·è¢«ç¦ç”¨ï¼ŒupdateUserInterface ä¼šå¤„ç†ç™»å‡ºé€»è¾‘
                                if (currentUserData.status === 'banned') {
                                    console.log('âš ï¸ ç”¨æˆ·å·²è¢«ç¦ç”¨ï¼Œå·²è‡ªåŠ¨é€€å‡ºç™»å½•');
                                    return; // updateUserInterface å·²å¤„ç†ç™»å‡ºï¼Œç›´æ¥è¿”å›
                                }
                                
                                // æ›´æ–°ç”¨æˆ·ä¸ªäººä¿¡æ¯æ˜¾ç¤ºï¼ˆå¦‚æœç”¨æˆ·ä¸­å¿ƒå·²æ‰“å¼€ï¼‰
                                if (document.getElementById('user-profile')?.classList.contains('active')) {
                                    if (typeof loadUserProfile === 'function') {
                                        loadUserProfile();
                                    }
                                }
                                
                                // å¦‚æœç§¯åˆ†å‘ç”Ÿå˜åŒ–ï¼Œæ˜¾ç¤ºæç¤º
                                if (previousUser && previousUser.points !== currentUserData.points) {
                                    showNotification(`æ‚¨çš„ç§¯åˆ†å·²æ›´æ–°ï¼š${currentUserData.points}`, 'info');
                                }
                                
                                console.log('âœ… ç”¨æˆ·æ•°æ®å·²ä»äº‘ç«¯æ›´æ–°å¹¶åˆ·æ–°ç•Œé¢');
                            }
                        }

                        // åˆ·æ–°ç”¨æˆ·ç®¡ç†æ˜¾ç¤ºï¼ˆç®¡ç†å‘˜ç•Œé¢ï¼‰
                        const adminPanel = document.getElementById('admin-panel');
                        if (adminPanel && adminPanel.style.display !== 'none') {
                            const activeTab = document.querySelector('.admin-tab.active')?.dataset.tab;
                            if (activeTab === 'users') {
                                if (typeof renderUserManagement === 'function') {
                                    renderUserManagement();
                                }
                            }
                        }

                        console.log('ğŸ”„ ç”¨æˆ·æ•°æ®å·²ä»äº‘ç«¯æ›´æ–°');
                    }
                });

                // ç›‘å¬å½“å‰ç”¨æˆ·è®¢å•å˜åŒ–ï¼ˆè‹¥å½“å‰å·²ç™»å½•ï¼‰
                this.attachUserOrdersListener();
                
                // ç›‘å¬æ‰€æœ‰ç”¨æˆ·è®¢å•å˜åŒ–ï¼ˆç”¨äºåå°ç®¡ç†ï¼‰
                if (currentUser && currentUser.role === 'admin') {
                    this.setupAllOrdersListener();
                    // åˆå§‹åŒ–æ—¶åŠ è½½æ‰€æœ‰è®¢å•
                    this.loadAllOrders().then(() => {
                        // å¦‚æœåå°ç®¡ç†é¡µé¢å·²æ‰“å¼€ï¼Œåˆ·æ–°æ˜¾ç¤º
                        const adminPanel = document.getElementById('admin-panel');
                        if (adminPanel && adminPanel.style.display !== 'none') {
                            const adminOrders = document.getElementById('admin-orders');
                            if (adminOrders && adminOrders.classList.contains('active')) {
                                renderOrdersTable();
                            }
                        }
                    });
                }

                console.log('âœ… å®æ—¶ç›‘å¬å·²è®¾ç½®');
            }

            // åˆ·æ–°è®¢å•è¯¦æƒ…æ¨¡æ€æ¡†å†…å®¹ï¼ˆå¦‚æœå·²æ‰“å¼€ï¼‰
            refreshOrderDetailModal() {
                const orderDetailModal = document.getElementById('order-details-modal');
                if (orderDetailModal) {
                    const orderIdAttr = orderDetailModal.querySelector('[data-order-id]');
                    if (orderIdAttr) {
                        // ä½¿ç”¨normalizeOrderIdç¡®ä¿å…¼å®¹æ–°æ—§è®¢å•IDæ ¼å¼ï¼ˆæ•°å­—æˆ–å­—ç¬¦ä¸²ï¼‰
                        const orderId = normalizeOrderId(orderIdAttr.getAttribute('data-order-id'));
                        const updatedOrder = userOrders.find(o => normalizeOrderId(o.id) === orderId);
                        if (updatedOrder) {
                            setTimeout(() => {
                                showOrderDetailsModal(orderId);
                            }, 100);
                        }
                    }
                }
            }

            // æ ¹æ®å®æ—¶æ•°æ®åˆ·æ–°ç”¨æˆ·è®¢å•UI
            refreshOrderUI(immediate = false) {
                if (immediate) {
                    renderUserOrders();
                    this.refreshOrderDetailModal();
                } else {
                    clearTimeout(window.orderUpdateTimer);
                    window.orderUpdateTimer = setTimeout(() => {
                        renderUserOrders();
                        this.refreshOrderDetailModal();
                    }, 300);
                }
            }

            // å¤„ç†äº‘ç«¯è®¢å•æ›´æ–°ï¼ˆä¼˜åŒ–ç‰ˆï¼šç¡®ä¿æ•°æ®åˆå¹¶æ­£ç¡®ä¸”ä¸äº’ç›¸è¦†ç›–ï¼‰
            processUserOrderUpdate(cloudOrders, immediate = false) {
                if (!currentUser || !Array.isArray(cloudOrders)) {
                    console.warn('âš ï¸ processUserOrderUpdate: å‚æ•°æ— æ•ˆ');
                    return;
                }

                // è®°å½•æ›´æ–°å‰çš„è®¢å•çŠ¶æ€ï¼Œç”¨äºæ£€æµ‹å˜åŒ–
                const orderStatusMap = new Map();
                userOrders.forEach(order => {
                    if (order && order.id) {
                        orderStatusMap.set(String(order.id), order.status);
                    }
                });

                // æ™ºèƒ½åˆå¹¶è®¢å•æ•°æ®ï¼ˆç¡®ä¿æ•°æ®éš”ç¦»ï¼šåªåˆå¹¶å±äºå½“å‰ç”¨æˆ·çš„è®¢å•ï¼‰
                const validCloudOrders = cloudOrders.filter(order => {
                    if (!order || !order.id) return false;
                    // ç¡®ä¿è®¢å•å±äºå½“å‰ç”¨æˆ·
                    const orderAccount = order.account || '';
                    const currentAccount = currentUser.account || '';
                    if (orderAccount !== currentAccount) {
                        console.warn(`âš ï¸ æ£€æµ‹åˆ°ä¸å±äºå½“å‰ç”¨æˆ·çš„è®¢å•ï¼Œå·²è¿‡æ»¤: ${order.id} (è®¢å•è´¦æˆ·: ${orderAccount}, å½“å‰è´¦æˆ·: ${currentAccount})`);
                        return false;
                    }
                    return true;
                });

                if (validCloudOrders.length === 0 && cloudOrders.length > 0) {
                    console.warn('âš ï¸ æ‰€æœ‰äº‘ç«¯è®¢å•éƒ½ä¸å±äºå½“å‰ç”¨æˆ·ï¼Œè·³è¿‡æ›´æ–°');
                    return;
                }

                // æ‰§è¡Œåˆå¹¶ï¼ˆmergeOrdersDataä¼šç¡®ä¿æ•°æ®æ­£ç¡®åˆå¹¶ï¼‰
                mergeOrdersData(validCloudOrders, currentUser.account);

                // æ£€æµ‹è®¢å•çŠ¶æ€å˜åŒ–
                let hasStatusChange = false;
                userOrders.forEach(order => {
                    if (order && order.id) {
                        const oldStatus = orderStatusMap.get(String(order.id));
                        if (oldStatus && oldStatus !== order.status) {
                            hasStatusChange = true;
                            console.log(`ğŸ”„ è®¢å• ${order.id} çŠ¶æ€å˜åŒ–: ${oldStatus} -> ${order.status}`);
                        }
                    }
                });

                if (hasStatusChange) {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°è®¢å•çŠ¶æ€å˜åŒ–ï¼Œåˆ·æ–°æ˜¾ç¤º');
                    // æ˜¾ç¤ºé€šçŸ¥ï¼ˆä»…åœ¨ç”¨æˆ·ä¸­å¿ƒé¡µé¢æ—¶ï¼‰
                    const userCenter = document.getElementById('user-center');
                    if (userCenter && userCenter.style.display !== 'none') {
                        showNotification('æ‚¨çš„è®¢å•çŠ¶æ€å·²æ›´æ–°', 'info');
                    }
                }

                // åˆ·æ–°UI
                this.refreshOrderUI(immediate);
            }

            // ç§»é™¤ç”¨æˆ·è®¢å•ç›‘å¬å™¨
            detachUserOrdersListener() {
                if (this.userOrdersRef) {
                    this.userOrdersRef.off();
                    this.userOrdersRef = null;
                }
                if (this.orderUpdateTimer) {
                    clearTimeout(this.orderUpdateTimer);
                    this.orderUpdateTimer = null;
                }
                this.pendingOrderUpdate = null;
            }

            // ç§»é™¤ç”¨æˆ·åœ°å€ç›‘å¬å™¨
            detachUserAddressesListener() {
                if (this.userAddressesRef) {
                    this.userAddressesRef.off();
                    this.userAddressesRef = null;
                }
                if (this.addressUpdateTimer) {
                    clearTimeout(this.addressUpdateTimer);
                    this.addressUpdateTimer = null;
                }
                this.pendingAddressUpdate = null;
            }

            // ç›‘å¬ç”¨æˆ·è®¢å•å˜åŒ–ï¼ˆä¼˜åŒ–ç‰ˆï¼šç¡®ä¿å®æ—¶åŒæ­¥ä¸”æ•°æ®éš”ç¦»ï¼‰
            attachUserOrdersListener() {
                if (!this.isInitialized || !currentUser) {
                    console.warn('âš ï¸ æ— æ³•è®¾ç½®è®¢å•ç›‘å¬å™¨ï¼šäº‘ç«¯æœªåˆå§‹åŒ–æˆ–ç”¨æˆ·æœªç™»å½•');
                    return;
                }

                // å…ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç›‘å¬
                this.detachUserOrdersListener();

                const userPath = this.getUserPath();
                if (!userPath || userPath === 'users/guest') {
                    console.warn('âš ï¸ æ— æ³•è®¾ç½®è®¢å•ç›‘å¬å™¨ï¼šç”¨æˆ·è·¯å¾„æ— æ•ˆ');
                    return;
                }

                const ordersRef = this.db.ref(`${userPath}/orders`);
                this.userOrdersRef = ordersRef;

                console.log(`ğŸ”” å¼€å§‹ç›‘å¬ç”¨æˆ·è®¢å•å˜åŒ–: ${userPath}/orders`);

                ordersRef.on('value', (snapshot) => {
                    const cloudOrders = snapshot.val();
                    
                    // å¤„ç†ç©ºæ•°æ®æƒ…å†µï¼ˆäº‘ç«¯è®¢å•è¢«æ¸…ç©ºï¼‰
                    if (cloudOrders === null) {
                        console.log('â„¹ï¸ äº‘ç«¯è®¢å•æ•°æ®ä¸ºç©ºï¼Œæ¸…ç©ºæœ¬åœ°è®¢å•');
                        if (currentUser && currentUser.account) {
                            userOrders = [];
                            const userOrdersKey = `userOrders_${currentUser.account}`;
                            localStorage.setItem(userOrdersKey, JSON.stringify(userOrders));
                            localStorage.setItem('userOrders', JSON.stringify(userOrders));
                            this.refreshOrderUI(true);
                        }
                        return;
                    }

                    if (cloudOrders && Array.isArray(cloudOrders)) {
                        // ç¡®ä¿è®¢å•æ•°æ®å±äºå½“å‰ç”¨æˆ·ï¼ˆæ•°æ®éš”ç¦»ä¿æŠ¤ï¼‰
                        const filteredOrders = cloudOrders.filter(order => {
                            if (!order) return false;
                            // ç¡®ä¿è®¢å•å±äºå½“å‰ç”¨æˆ·
                            const orderAccount = order.account || '';
                            const currentAccount = currentUser.account || '';
                            return orderAccount === currentAccount;
                        });

                        if (this._syncState.inProgress) {
                            console.log('â³ åŒæ­¥è¿›è¡Œä¸­ï¼Œå»¶è¿Ÿå¤„ç†äº‘ç«¯è®¢å•æ›´æ–°...');
                            this.pendingOrderUpdate = filteredOrders;
                            if (this.orderUpdateTimer) clearTimeout(this.orderUpdateTimer);
                            this.orderUpdateTimer = setTimeout(() => {
                                if (this.pendingOrderUpdate) {
                                    console.log('ğŸ”„ å»¶è¿Ÿå¤„ç†äº‘ç«¯è®¢å•æ›´æ–°');
                                    this.processUserOrderUpdate(this.pendingOrderUpdate, true);
                                    this.pendingOrderUpdate = null;
                                }
                            }, 1500);
                        } else {
                            console.log(`âœ… æ”¶åˆ°äº‘ç«¯è®¢å•æ›´æ–°: ${filteredOrders.length} ä¸ªè®¢å•`);
                            this.processUserOrderUpdate(filteredOrders, false);
                        }
                    } else {
                        console.warn('âš ï¸ äº‘ç«¯è®¢å•æ•°æ®æ ¼å¼å¼‚å¸¸:', typeof cloudOrders);
                    }
                }, (error) => {
                    console.error('âŒ è®¢å•ç›‘å¬å™¨é”™è¯¯:', error);
                });
            }

            // ç›‘å¬ç”¨æˆ·åœ°å€å˜åŒ–
            attachUserAddressesListener() {
                if (!this.isInitialized || !currentUser) return;

                this.detachUserAddressesListener();

                const userPath = this.getUserPath();
                const addressesRef = this.db.ref(`${userPath}/addresses`);
                this.userAddressesRef = addressesRef;

                addressesRef.on('value', (snapshot) => {
                    const cloudAddresses = snapshot.val();
                    if (cloudAddresses && Array.isArray(cloudAddresses)) {
                        if (this._syncState.inProgress) {
                            console.log('â³ åŒæ­¥è¿›è¡Œä¸­ï¼Œå»¶è¿Ÿå¤„ç†äº‘ç«¯åœ°å€æ›´æ–°...');
                            this.pendingAddressUpdate = cloudAddresses;
                            if (this.addressUpdateTimer) clearTimeout(this.addressUpdateTimer);
                            this.addressUpdateTimer = setTimeout(() => {
                                if (this.pendingAddressUpdate) {
                                    console.log('ğŸ”„ å»¶è¿Ÿå¤„ç†äº‘ç«¯åœ°å€æ›´æ–°');
                                    this.processUserAddressUpdate(this.pendingAddressUpdate, true);
                                    this.pendingAddressUpdate = null;
                                }
                            }, 1500);
                        } else {
                            this.processUserAddressUpdate(cloudAddresses, false);
                        }
                    } else if (cloudAddresses === null) {
                        // äº‘ç«¯åœ°å€è¢«æ¸…ç©º
                        userAddresses = [];
                        const userAddressesKey = `userAddresses_${currentUser.account || 'guest'}`;
                        localStorage.setItem(userAddressesKey, JSON.stringify(userAddresses));
                        localStorage.setItem('userAddresses', JSON.stringify(userAddresses));
                        if (typeof renderAddressList === 'function') {
                            renderAddressList();
                        }
                    }
                });
            }

            // å¤„ç†äº‘ç«¯åœ°å€æ›´æ–°
            processUserAddressUpdate(cloudAddresses, immediate = false) {
                if (!currentUser || !Array.isArray(cloudAddresses)) return;

                // æ›´æ–°å…¨å±€å˜é‡å’ŒlocalStorage
                userAddresses = cloudAddresses;
                const userAddressesKey = `userAddresses_${currentUser.account || 'guest'}`;
                localStorage.setItem(userAddressesKey, JSON.stringify(userAddresses));
                localStorage.setItem('userAddresses', JSON.stringify(userAddresses));
                
                console.log('âœ… åœ°å€æ•°æ®å·²ä»äº‘ç«¯æ›´æ–°:', userAddresses.length, 'ä¸ªåœ°å€');

                // åˆ·æ–°åœ°å€åˆ—è¡¨æ˜¾ç¤º
                if (immediate) {
                    if (typeof renderAddressList === 'function') {
                        renderAddressList();
                    }
                } else {
                    clearTimeout(window.addressUpdateTimer);
                    window.addressUpdateTimer = setTimeout(() => {
                        if (typeof renderAddressList === 'function') {
                            renderAddressList();
                        }
                    }, 300);
                }
            }

            // ç§»é™¤ç®¡ç†å‘˜è®¢å•ç›‘å¬å™¨
            detachAllOrdersListener() {
                if (this.allOrdersRef) {
                    this.allOrdersRef.off();
                    this.allOrdersRef = null;
                }
            }

            // ç§»é™¤ä¼šè¯ç›‘å¬å™¨
            detachSessionListener() {
                if (this.sessionRef) {
                    this.sessionRef.off();
                    this.sessionRef = null;
                }
            }

            // å¤„ç†ç”¨æˆ·ç™»å½•/é€€å‡ºåçš„æ•°æ®å’Œç›‘å¬å™¨
            async handleUserSessionChange() {
                if (!this.isInitialized) return;

                // æ¸…ç†æ—§ç›‘å¬å™¨
                this.detachUserOrdersListener();
                this.detachUserAddressesListener();
                this.detachAllOrdersListener();
                this.detachSessionListener();

                if (!currentUser) {
                    userOrders = [];
                    userAddresses = [];
                    localStorage.removeItem('userOrders');
                    localStorage.removeItem('userAddresses');
                    this.currentSessionId = null;
                    return;
                }

                // å…ˆåŠ è½½è¯¥ç”¨æˆ·çš„æ•°æ®
                await Promise.all([
                    this.loadOrders(),
                    this.loadAddresses()
                ]);

                refreshCurrentUserSnapshot();

                // ç¡®ä¿å…¨å±€å˜é‡å·²æ›´æ–°ï¼ˆä»localStorageé‡æ–°åŠ è½½ï¼‰
                if (currentUser && currentUser.account) {
                    const userOrdersKey = `userOrders_${currentUser.account}`;
                    const userAddressesKey = `userAddresses_${currentUser.account}`;
                    userOrders = JSON.parse(localStorage.getItem(userOrdersKey)) || JSON.parse(localStorage.getItem('userOrders')) || [];
                    userAddresses = JSON.parse(localStorage.getItem(userAddressesKey)) || JSON.parse(localStorage.getItem('userAddresses')) || [];
                    console.log('âœ… handleUserSessionChange - æ•°æ®å·²åŠ è½½ - è®¢å•æ•°:', userOrders.length, 'åœ°å€æ•°:', userAddresses.length);
                    
                    // ç«‹å³åˆ·æ–°ç•Œé¢æ˜¾ç¤ºï¼ˆåŒæ­¥æ‰§è¡Œï¼Œä¸ç­‰å¾…ï¼‰
                    if (typeof renderUserOrders === 'function') {
                        renderUserOrders();
                    }
                    if (typeof renderAddressList === 'function') {
                        renderAddressList();
                    }
                }

                // é‡æ–°ç›‘å¬è¯¥ç”¨æˆ·çš„è®¢å•å’Œåœ°å€ï¼ˆå®æ—¶åŒæ­¥ï¼‰
                this.attachUserOrdersListener();
                this.attachUserAddressesListener();

                // ç®¡ç†å‘˜éœ€è¦åŒæ­¥æ‰€æœ‰è®¢å•
                if (currentUser.role === 'admin') {
                    await this.loadAllOrders();
                    this.setupAllOrdersListener();
                }

                // è®¾ç½®å½“å‰è´¦å·çš„ä¼šè¯è·Ÿè¸ªï¼ˆå¤šè®¾å¤‡ç™»å½•æ§åˆ¶ï¼‰
                await this.setupSessionTracking();
            }

            // ä¸ºå½“å‰ç™»å½•è´¦å·ç”Ÿæˆä¼šè¯IDï¼Œå¹¶ç›‘å¬æ˜¯å¦è¢«å…¶ä»–è®¾å¤‡æŠ¢ç™»
            async setupSessionTracking() {
                if (!this.isInitialized || !currentUser || !currentUser.account) return;

                try {
                    // å…ˆç§»é™¤æ—§ç›‘å¬
                    this.detachSessionListener();

                    const userPath = this.getUserPath(currentUser.account);
                    this.sessionRef = this.db.ref(`${userPath}/activeSessionId`);

                    // ä¸ºæœ¬è®¾å¤‡ç”Ÿæˆæ–°çš„ä¼šè¯ID
                    this.currentSessionId = `${Date.now()}_${Math.random().toString(36).slice(2, 10)}`;

                    // å†™å…¥äº‘ç«¯ï¼Œå£°æ˜â€œå½“å‰ä¼šè¯â€
                    await this.sessionRef.set({
                        id: this.currentSessionId,
                        updatedAt: Date.now(),
                        ua: navigator.userAgent || ''
                    });

                    // ç›‘å¬ä¼šè¯å˜åŒ–ï¼šå¦‚æœ activeSessionId.id è¢«æ”¹æˆåˆ«çš„å€¼ï¼Œè¯´æ˜æœ‰å…¶ä»–è®¾å¤‡ç™»å½•
                    this.sessionRef.on('value', async (snapshot) => {
                        const data = snapshot.val();
                        if (!data || !data.id || !this.currentSessionId) return;

                        if (data.id !== this.currentSessionId) {
                            console.warn('æ£€æµ‹åˆ°åŒä¸€è´¦å·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œå‡†å¤‡åŒæ­¥å¹¶è‡ªåŠ¨ç™»å‡ºæœ¬è®¾å¤‡');

                            try {
                                // å°½é‡åœ¨é€€å‡ºå‰æŠŠæœ¬åœ°æœ€æ–°æ•°æ®åŒæ­¥åˆ°äº‘ç«¯
                                await this.syncAllData();
                            } catch (syncError) {
                                console.error('è¿œç¨‹ç™»å‡ºå‰åŒæ­¥æ•°æ®å¤±è´¥:', syncError);
                            }

                            // æ‰§è¡Œè¿œç¨‹ç™»å‡ºï¼ˆå¦‚æœå…¨å±€æœ‰ä¸“é—¨å‡½æ•°åˆ™è°ƒç”¨ï¼Œæ²¡æœ‰å°±ç”¨å…œåº•é€»è¾‘ï¼‰
                            if (typeof handleRemoteLogout === 'function') {
                                handleRemoteLogout();
                            } else {
                                try {
                                    currentUser = null;
                                    localStorage.removeItem('currentUser');

                                    if (typeof clearAllLocalDataOnLogout === 'function') {
                                        clearAllLocalDataOnLogout();
                                    } else {
                                        // å…œåº•æ¸…ç†å…³é”®ä¿¡æ¯
                                        localStorage.removeItem('userOrders');
                                        localStorage.removeItem('userAddresses');
                                    }

                                    if (typeof updateUserInterface === 'function') {
                                        updateUserInterface();
                                    }
                                    if (typeof showHomePage === 'function') {
                                        showHomePage();
                                    }
                                    if (typeof showNotification === 'function') {
                                        showNotification(t('loggedOutByOtherDevice'), 'warning');
                                    }
                                } catch (e) {
                                    console.error('å¤„ç†è¿œç¨‹ç™»å‡ºè¿‡ç¨‹ä¸­çš„é”™è¯¯:', e);
                                }
                            }

                            // é¿å…é‡å¤è§¦å‘
                            this.detachSessionListener();
                            this.currentSessionId = null;
                        }
                    });
                } catch (error) {
                    console.error('è®¾ç½®ä¼šè¯è·Ÿè¸ªå¤±è´¥:', error);
                }
            }

            // è®¾ç½®æ‰€æœ‰è®¢å•ç›‘å¬å™¨ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰
            setupAllOrdersListener() {
                if (!this.isInitialized || !currentUser || currentUser.role !== 'admin') return;

                this.detachAllOrdersListener();
                
                try {
                    // ç›‘å¬æ‰€æœ‰ç”¨æˆ·çš„è®¢å•
                    this.allOrdersRef = this.db.ref('users');
                    this.allOrdersRef.on('value', async (snapshot) => {
                        if (this._syncState.inProgress) {
                            console.log('â³ åŒæ­¥è¿›è¡Œä¸­ï¼Œè·³è¿‡ç®¡ç†å‘˜è®¢å•ç›‘å¬æ›´æ–°');
                            return;
                        }
                        
                        const usersData = snapshot.val();
                        if (!usersData) {
                            console.log('â„¹ï¸ äº‘ç«¯ç”¨æˆ·æ•°æ®ä¸ºç©º');
                            return;
                        }
                        
                        // æ”¶é›†æ‰€æœ‰ç”¨æˆ·çš„è®¢å•ï¼ˆç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼‰
                        const collectedOrders = [];
                        for (const userId in usersData) {
                            const userData = usersData[userId];
                            if (userData && userData.orders && Array.isArray(userData.orders)) {
                                userData.orders.forEach(order => {
                                    if (order && order.id) {
                                        // ç¡®ä¿è®¢å•æœ‰accountå­—æ®µï¼ˆç”¨äºæ•°æ®éš”ç¦»ï¼‰
                                        if (!order.account) {
                                            order.account = userId.replace(/_/g, '.'); // è¿˜åŸè´¦å·æ ¼å¼
                                        }
                                        // ç¡®ä¿è®¢å•æœ‰updatedAtå­—æ®µï¼ˆç”¨äºåˆå¹¶é€»è¾‘ï¼‰
                                        if (!order.updatedAt && order.date) {
                                            order.updatedAt = typeof order.date === 'number' ? order.date : Date.now();
                                        }
                                        collectedOrders.push(order);
                                    }
                                });
                            }
                        }
                        
                        if (collectedOrders.length > 0) {
                            // æ™ºèƒ½åˆå¹¶æ‰€æœ‰è®¢å•ï¼ˆç¡®ä¿æ•°æ®æ­£ç¡®ï¼‰
                            mergeAllOrdersData(collectedOrders);
                            
                            // åˆ·æ–°åå°ç®¡ç†è®¢å•è¡¨æ ¼
                            const adminPanel = document.getElementById('admin-panel');
                            if (adminPanel && adminPanel.style.display !== 'none') {
                                const adminOrders = document.getElementById('admin-orders');
                                if (adminOrders && adminOrders.classList.contains('active')) {
                                    renderOrdersTable();
                                }
                            }
                            
                            console.log(`ğŸ”„ æ‰€æœ‰è®¢å•æ•°æ®å·²ä»äº‘ç«¯æ›´æ–°ï¼ˆåå°ç®¡ç†ï¼‰: ${collectedOrders.length} ä¸ªè®¢å•`);
                        } else {
                            console.log('â„¹ï¸ äº‘ç«¯æš‚æ— è®¢å•æ•°æ®');
                        }
                    }, (error) => {
                        console.error('âŒ ç®¡ç†å‘˜è®¢å•ç›‘å¬å™¨é”™è¯¯:', error);
                    });
                } catch (error) {
                    console.error('è®¾ç½®æ‰€æœ‰è®¢å•ç›‘å¬å™¨å¤±è´¥:', error);
                }
            }

            // æ‰‹åŠ¨è§¦å‘åŒæ­¥
            async manualSync() {
                showNotification('æ­£åœ¨åŒæ­¥æ•°æ®...', 'info');
                await this.syncAllData();
            }

            // æ¸…ç†
            destroy() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }

                // ç§»é™¤æ‰€æœ‰ç›‘å¬å™¨
                this.detachUserOrdersListener();
                this.detachUserAddressesListener();
                this.detachAllOrdersListener();
                
                if (this.db) {
                    this.db.ref('products').off();
                    if (currentUser) {
                        const userPath = this.getUserPath();
                        this.db.ref(`${userPath}/orders`).off();
                        this.db.ref(`${userPath}/addresses`).off();
                    }
                }
            }
        }

        // åˆå§‹åŒ–äº‘ç«¯åŒæ­¥ï¼ˆå¼‚æ­¥ï¼‰
        async function initCloudSync() {
            try {
                console.log('ğŸ”„ åˆ›å»º CloudSyncManager å®ä¾‹...');
                cloudSync = new CloudSyncManager();

                console.log('ğŸ”„ è°ƒç”¨ init() æ–¹æ³•...');
                await cloudSync.init();

                console.log('âœ… CloudSync å®Œå…¨åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('âŒ äº‘ç«¯åŒæ­¥åˆå§‹åŒ–å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–äº‘ç«¯åŒæ­¥ï¼ˆå·²åœ¨DOMContentLoadedä¸­å¤„ç†ï¼Œè¿™é‡Œä¸å†é‡å¤åˆå§‹åŒ–ï¼‰
        // window.addEventListener('load', () => {
        //     console.log('ğŸš€ é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡åˆå§‹åŒ–äº‘åŒæ­¥...');
        //     // å·²åœ¨DOMContentLoadedä¸­åˆå§‹åŒ–ï¼Œé¿å…é‡å¤
        // });

        // ========== ç¦»çº¿ç¼“å­˜ç®¡ç†å™¨ ==========
        class OfflineCacheManager {
            constructor() {
                this.cacheName = 'ecommerce-cache-v1';
                this.offlineQueue = [];
                this.isOnline = navigator.onLine;

                this.init();
            }

            // åˆå§‹åŒ–ç¦»çº¿ç¼“å­˜
            init() {
                // ç›‘å¬ç½‘ç»œçŠ¶æ€
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    console.log('âœ… ç½‘ç»œå·²è¿æ¥');
                    showNotification('ç½‘ç»œå·²è¿æ¥', 'success');
                    this.syncOfflineQueue();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    console.log('âš ï¸ ç½‘ç»œå·²æ–­å¼€');
                    showNotification('æ‚¨å·²ç¦»çº¿ï¼Œæ•°æ®å°†è¢«ç¼“å­˜', 'warning');
                });

                // æ³¨å†Œ Service Worker
                if ('serviceWorker' in navigator) {
                    this.registerServiceWorker();
                }

                // ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç¦»çº¿é˜Ÿåˆ—
                this.loadOfflineQueue();

                console.log('âœ… ç¦»çº¿ç¼“å­˜ç®¡ç†å™¨å·²åˆå§‹åŒ–');
            }

            // æ³¨å†Œ Service Worker
            async registerServiceWorker() {
                try {
                    // åˆ›å»ºä¸€ä¸ªå†…è”çš„ Service Worker
                    const swCode = `
                        const CACHE_NAME = 'ecommerce-cache-v1';
                        const urlsToCache = [
                            '/',
                            '/main.html'
                        ];
                        
                        self.addEventListener('install', (event) => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then((cache) => cache.addAll(urlsToCache))
                            );
                        });
                        
                        self.addEventListener('fetch', (event) => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then((response) => {
                                        if (response) {
                                            return response;
                                        }
                                        return fetch(event.request).then((response) => {
                                            if (!response || response.status !== 200) {
                                                return response;
                                            }
                                            const responseToCache = response.clone();
                                            caches.open(CACHE_NAME)
                                                .then((cache) => {
                                                    cache.put(event.request, responseToCache);
                                                });
                                            return response;
                                        });
                                    })
                            );
                        });
                        
                        self.addEventListener('activate', (event) => {
                            event.waitUntil(
                                caches.keys().then((cacheNames) => {
                                    return Promise.all(
                                        cacheNames.map((cacheName) => {
                                            if (cacheName !== CACHE_NAME) {
                                                return caches.delete(cacheName);
                                            }
                                        })
                                    );
                                })
                            );
                        });
                    `;

                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);

                    const registration = await navigator.serviceWorker.register(swUrl);
                    console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration);
                } catch (error) {
                    console.warn('Service Worker æ³¨å†Œå¤±è´¥:', error);
                }
            }

            // æ·»åŠ åˆ°ç¦»çº¿é˜Ÿåˆ—
            addToOfflineQueue(action, data) {
                const queueItem = {
                    id: Date.now() + Math.random(),
                    action,
                    data,
                    timestamp: Date.now()
                };

                this.offlineQueue.push(queueItem);
                this.saveOfflineQueue();

                console.log('ğŸ“¦ å·²æ·»åŠ åˆ°ç¦»çº¿é˜Ÿåˆ—:', queueItem);
                return queueItem;
            }

            // ä¿å­˜ç¦»çº¿é˜Ÿåˆ—åˆ°æœ¬åœ°å­˜å‚¨
            saveOfflineQueue() {
                localStorage.setItem('offlineQueue', JSON.stringify(this.offlineQueue));
            }

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç¦»çº¿é˜Ÿåˆ—
            loadOfflineQueue() {
                const stored = localStorage.getItem('offlineQueue');
                if (stored) {
                    try {
                        this.offlineQueue = JSON.parse(stored);
                        console.log('ğŸ“¦ å·²åŠ è½½ç¦»çº¿é˜Ÿåˆ—:', this.offlineQueue.length, 'é¡¹');
                    } catch (error) {
                        console.error('åŠ è½½ç¦»çº¿é˜Ÿåˆ—å¤±è´¥:', error);
                        this.offlineQueue = [];
                    }
                }
            }

            // åŒæ­¥ç¦»çº¿é˜Ÿåˆ—
            async syncOfflineQueue() {
                if (this.offlineQueue.length === 0) {
                    return;
                }

                console.log('ğŸ”„ å¼€å§‹åŒæ­¥ç¦»çº¿é˜Ÿåˆ—...');
                showNotification('æ­£åœ¨åŒæ­¥ç¦»çº¿æ•°æ®...', 'info');

                const successItems = [];
                const failedItems = [];

                for (const item of this.offlineQueue) {
                    try {
                        await this.processQueueItem(item);
                        successItems.push(item);
                    } catch (error) {
                        console.error('å¤„ç†ç¦»çº¿é˜Ÿåˆ—é¡¹å¤±è´¥:', error);
                        failedItems.push(item);
                    }
                }

                // ç§»é™¤æˆåŠŸçš„é¡¹
                this.offlineQueue = this.offlineQueue.filter(item =>
                    !successItems.includes(item)
                );
                this.saveOfflineQueue();

                if (successItems.length > 0) {
                    showNotification(`æˆåŠŸåŒæ­¥ ${successItems.length} é¡¹æ•°æ®`, 'success');
                }

                if (failedItems.length > 0) {
                    showNotification(`${failedItems.length} é¡¹æ•°æ®åŒæ­¥å¤±è´¥`, 'error');
                }

                console.log('âœ… ç¦»çº¿é˜Ÿåˆ—åŒæ­¥å®Œæˆ');
            }

            // å¤„ç†å•ä¸ªé˜Ÿåˆ—é¡¹
            async processQueueItem(item) {
                switch (item.action) {
                    case 'addProduct':
                        // åªæœ‰ç®¡ç†å‘˜æ‰å…è®¸é€šè¿‡ç¦»çº¿é˜Ÿåˆ—ä¿®æ”¹äº§å“
                        if (!isCurrentUserAdmin()) {
                            console.log('â„¹ï¸ éç®¡ç†å‘˜ç¦»çº¿æ“ä½œ addProduct å·²å¿½ç•¥');
                            break;
                        }
                        products.push(item.data);
                        localStorage.setItem('products', JSON.stringify(products));
                        if (cloudSync && cloudSync.isInitialized) {
                            await cloudSync.syncProducts();
                        }
                        break;

                    case 'updateProduct':
                        if (!isCurrentUserAdmin()) {
                            console.log('â„¹ï¸ éç®¡ç†å‘˜ç¦»çº¿æ“ä½œ updateProduct å·²å¿½ç•¥');
                            break;
                        }
                        const productIndex = products.findIndex(p => p.id === item.data.id);
                        if (productIndex !== -1) {
                            products[productIndex] = item.data;
                            localStorage.setItem('products', JSON.stringify(products));
                            if (cloudSync && cloudSync.isInitialized) {
                                await cloudSync.syncProducts();
                            }
                        }
                        break;

                    case 'deleteProduct':
                        if (!isCurrentUserAdmin()) {
                            console.log('â„¹ï¸ éç®¡ç†å‘˜ç¦»çº¿æ“ä½œ deleteProduct å·²å¿½ç•¥');
                            break;
                        }
                        products = products.filter(p => p.id !== item.data.id);
                        localStorage.setItem('products', JSON.stringify(products));
                        if (cloudSync && cloudSync.isInitialized) {
                            await cloudSync.syncProducts();
                        }
                        break;

                    case 'addOrder':
                        userOrders.push(item.data);
                        localStorage.setItem('userOrders', JSON.stringify(userOrders));
                        if (cloudSync && cloudSync.isInitialized) {
                            await cloudSync.syncOrders();
                        }
                        break;

                    case 'updateOrder':
                        // ä½¿ç”¨è§„èŒƒåŒ–IDï¼Œé˜²æ­¢å­—ç¬¦ä¸²/æ•°å­—ä¸ä¸€è‡´å¯¼è‡´æ›´æ–°å¤±è´¥
                        {
                            const targetId = normalizeOrderId(item.data.id);
                            const orderIndex = userOrders.findIndex(o => normalizeOrderId(o.id) === targetId);
                            if (orderIndex !== -1) {
                                userOrders[orderIndex] = item.data;
                                localStorage.setItem('userOrders', JSON.stringify(userOrders));
                                if (cloudSync && cloudSync.isInitialized) {
                                    await cloudSync.syncOrders();
                                }
                            }
                        }
                        break;

                    default:
                        console.warn('æœªçŸ¥çš„ç¦»çº¿æ“ä½œ:', item.action);
                }
            }

            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            checkOnlineStatus() {
                return this.isOnline;
            }

            // ç¼“å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
            cacheData(key, data) {
                try {
                    localStorage.setItem(`cache_${key}`, JSON.stringify({
                        data,
                        timestamp: Date.now()
                    }));
                    console.log('âœ… æ•°æ®å·²ç¼“å­˜:', key);
                } catch (error) {
                    console.error('ç¼“å­˜æ•°æ®å¤±è´¥:', error);
                }
            }

            // ä»ç¼“å­˜è·å–æ•°æ®
            getCachedData(key, maxAge = 24 * 60 * 60 * 1000) {
                try {
                    const cached = localStorage.getItem(`cache_${key}`);
                    if (!cached) return null;

                    const { data, timestamp } = JSON.parse(cached);
                    const age = Date.now() - timestamp;

                    if (age > maxAge) {
                        // ç¼“å­˜å·²è¿‡æœŸ
                        localStorage.removeItem(`cache_${key}`);
                        return null;
                    }

                    console.log('âœ… ä»ç¼“å­˜åŠ è½½æ•°æ®:', key);
                    return data;
                } catch (error) {
                    console.error('è¯»å–ç¼“å­˜å¤±è´¥:', error);
                    return null;
                }
            }

            // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
            clearAllCache() {
                // æ¸…é™¤ localStorage ç¼“å­˜
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('cache_')) {
                        localStorage.removeItem(key);
                    }
                });

                // æ¸…é™¤ Service Worker ç¼“å­˜
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }

                console.log('âœ… å·²æ¸…é™¤æ‰€æœ‰ç¼“å­˜');
                showNotification('ç¼“å­˜å·²æ¸…é™¤', 'success');
            }

            // è·å–ç¼“å­˜å¤§å°ä¼°ç®—
            async getCacheSize() {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usage = estimate.usage || 0;
                    const quota = estimate.quota || 0;

                    return {
                        usage: (usage / 1024 / 1024).toFixed(2) + ' MB',
                        quota: (quota / 1024 / 1024).toFixed(2) + ' MB',
                        percentage: ((usage / quota) * 100).toFixed(2) + '%'
                    };
                }
                return null;
            }
        }

        // åˆ›å»ºç¦»çº¿ç¼“å­˜ç®¡ç†å™¨å®ä¾‹
        const offlineCache = new OfflineCacheManager();

        // å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
        window.offlineCache = offlineCache;

        // å°å·¥å…·ï¼šé˜²æŠ–
        function debounce(fn, delay) {
            let timerId = null;
            return function (...args) {
                clearTimeout(timerId);
                timerId = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // å°å·¥å…·ï¼šèŠ‚æµ
        function throttle(fn, delay) {
            let lastCall = 0;
            return function (...args) {
                const now = Date.now();
                if (now - lastCall >= delay) {
                    lastCall = now;
                    return fn.apply(this, args);
                }
            };
        }

        // å°å·¥å…·ï¼šæ·±æ‹·è´
        function deepClone(obj) {
            if (obj === null || typeof obj !== 'object') return obj;
            if (obj instanceof Date) return new Date(obj.getTime());
            if (obj instanceof Array) return obj.map(item => deepClone(item));
            if (typeof obj === 'object') {
                const clonedObj = {};
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        clonedObj[key] = deepClone(obj[key]);
                    }
                }
                return clonedObj;
            }
        }

        // å°å·¥å…·ï¼šæ ¼å¼åŒ–æ—¥æœŸï¼ˆåŒ…å«æ—¶åˆ†ç§’ï¼‰
        function formatDate(date) {
            if (!date) return '';
            
            // å¤„ç†æ—¶é—´æˆ³ï¼ˆæ•°å­—ï¼‰æˆ–æ—¥æœŸå­—ç¬¦ä¸²
            let dateObj;
            if (typeof date === 'number') {
                // ç›´æ¥ä½¿ç”¨æ—¶é—´æˆ³åˆ›å»ºæ—¥æœŸå¯¹è±¡ï¼Œç¡®ä¿ä½¿ç”¨å®é™…ä¸‹å•æ—¶é—´
                dateObj = new Date(date);
            } else if (typeof date === 'string') {
                // å¦‚æœæ˜¯æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆå¦‚ "2025-11-30"ï¼‰ï¼Œå°è¯•è§£æ
                if (date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    // çº¯æ—¥æœŸæ ¼å¼ï¼Œå¦‚æœæ²¡æœ‰æ—¶é—´ä¿¡æ¯ï¼Œä½¿ç”¨00:00:00è€Œä¸æ˜¯å½“å‰æ—¶é—´
                    dateObj = new Date(date + 'T00:00:00');
                } else {
                    dateObj = new Date(date);
                }
            } else {
                dateObj = new Date(date);
            }
            
            // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
            if (isNaN(dateObj.getTime())) {
                return '';
            }
            
            // æ ¹æ®å½“å‰è¯­è¨€é€‰æ‹©æ ¼å¼
            const locale = currentLanguage === 'en' ? 'en-US' : 'zh-CN';
            return dateObj.toLocaleString(locale, {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // å°å·¥å…·ï¼šæ˜¾ç¤ºé€šçŸ¥ï¼ˆå·²æ”¹ä¸ºä»…è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œä¸å†åœ¨å³ä¸Šè§’å¼¹å‡ºæç¤ºæ°”æ³¡ï¼‰
        function showNotification(message, type = 'info') {
            try {
                console.log('[Notification]', type, message);
            } catch (e) {
                // å¿½ç•¥æ§åˆ¶å°é”™è¯¯
            }
            // æŒ‰ä½ çš„è¦æ±‚ï¼Œæ‰€æœ‰å³ä¸Šè§’çš„è§†è§‰æç¤ºå·²å…³é—­ï¼Œè¿™é‡Œä¸å†åˆ›å»ºä»»ä½• DOMã€‚
        }

        // ========== åˆå§‹åŒ–æ•°æ® - å®Œå…¨ç§»é™¤æœ¬åœ°æ¼”ç¤ºæ•°æ® ==========
        // æ–°ç­–ç•¥:ä¸å†ä½¿ç”¨ä»»ä½•é¢„è®¾æ¼”ç¤ºæ•°æ®,æ‰€æœ‰æ•°æ®ä»äº‘ç«¯è·å–
        // è¿™ç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œå®æ—¶æ€§
        function initData() {
            // âœ… å·²ç§»é™¤æ‰€æœ‰æ¼”ç¤ºäº§å“çš„è‡ªåŠ¨åŠ è½½
            // âœ… æ•°æ®ä»…åœ¨ç™»å½•æˆåŠŸåä»äº‘ç«¯åŠ è½½
            // âœ… å¦‚éœ€æ·»åŠ äº§å“,è¯·ç®¡ç†å‘˜ç™»å½•åé€šè¿‡åå°ç®¡ç†æ·»åŠ 

            // ä»localStorageåŠ è½½æ‰€æœ‰è®¢å•ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰
            try {
                const savedAllOrders = localStorage.getItem('allOrders');
                if (savedAllOrders) {
                    allOrders = JSON.parse(savedAllOrders);
                    console.log('ğŸ“¦ å·²ä»æœ¬åœ°åŠ è½½æ‰€æœ‰è®¢å•:', allOrders.length, 'ä¸ª');
                }
            } catch (e) {
                // è§£ææœ¬åœ°æ‰€æœ‰è®¢å•å¤±è´¥æ—¶ï¼Œä¸å†å¼ºåˆ¶æ¸…ç©ºå†…å­˜ä¸­çš„ allOrdersï¼Œé¿å…è¦†ç›–å·²æœ‰æœ‰æ•ˆæ•°æ®
                console.error('åŠ è½½æœ¬åœ°æ‰€æœ‰è®¢å•å¤±è´¥ï¼ˆä¿ç•™å½“å‰å†…å­˜æ•°æ®ï¼‰:', e);
            }

            console.log('ğŸ“‹ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            console.log('â„¹ï¸ äº§å“æ•°æ®:', products.length, 'ä¸ª');
            console.log('â„¹ï¸ è®¢å•æ•°æ®:', userOrders.length, 'ä¸ª');
            console.log('â„¹ï¸ æ‰€æœ‰è®¢å•æ•°æ®:', allOrders.length, 'ä¸ªï¼ˆç®¡ç†å‘˜ï¼‰');
            console.log('â„¹ï¸ ç”¨æˆ·æ•°æ®:', allUsers.length, 'ä¸ª');

            updateUserInterface();
        }

        // åŠ è½½æ¼”ç¤ºäº§å“æ•°æ®ï¼ˆä»…åœ¨ç®¡ç†å‘˜æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨ï¼‰
        function loadDemoProducts() {
            customConfirm(t('confirmLoadDemo'), t('confirmLoadDemoData')).then(confirmed => {
                if (!confirmed) return;
                const demoProducts = [
                    {
                        id: Date.now() + 1,
                        name: 'æ— çº¿è“ç‰™è€³æœº',
                        price: 299,
                        image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                        category: 'electronics',
                        description: 'é«˜å“è´¨æ— çº¿è“ç‰™è€³æœºï¼Œé‡‡ç”¨æœ€æ–°è“ç‰™5.0æŠ€æœ¯ï¼Œæä¾›æ¸…æ™°éŸ³è´¨å’Œé•¿è¾¾20å°æ—¶çš„ç”µæ± ç»­èˆªã€‚è½»å·§è®¾è®¡ï¼Œèˆ’é€‚ä½©æˆ´ã€‚',
                        stock: 50
                    },
                    {
                        id: Date.now() + 2,
                        name: 'æ™ºèƒ½æ‰‹è¡¨',
                        price: 899,
                        image: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                        category: 'electronics',
                        description: 'å¤šåŠŸèƒ½æ™ºèƒ½æ‰‹è¡¨ï¼Œæ”¯æŒå¿ƒç‡ç›‘æµ‹ã€è¿åŠ¨è¿½è¸ªã€æ¶ˆæ¯é€šçŸ¥ç­‰åŠŸèƒ½ã€‚é˜²æ°´è®¾è®¡ï¼Œé€‚åˆå„ç§è¿åŠ¨åœºæ™¯ã€‚',
                        stock: 30
                    },
                    {
                        id: Date.now() + 3,
                        name: 'ä¾¿æºå¼éŸ³ç®±',
                        price: 459,
                        image: 'https://images.unsplash.com/photo-1546868871-7041f2a55e12?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                        category: 'electronics',
                        description: 'ä¾¿æºå¼è“ç‰™éŸ³ç®±ï¼Œ360åº¦ç¯ç»•éŸ³æ•ˆï¼ŒIP67é˜²æ°´ç­‰çº§ï¼Œé€‚åˆæˆ·å¤–ä½¿ç”¨ã€‚ç”µæ± ç»­èˆªè¾¾15å°æ—¶ã€‚',
                        stock: 25
                    },
                    {
                        id: Date.now() + 4,
                        name: 'è¿åŠ¨è·‘é‹',
                        price: 599,
                        image: 'https://images.unsplash.com/photo-1491553895911-0055eca6402d?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                        category: 'clothing',
                        description: 'ä¸“ä¸šè¿åŠ¨è·‘é‹ï¼Œé‡‡ç”¨é€æ°”ç½‘é¢æè´¨ï¼Œç¼“éœ‡ä¸­åº•è®¾è®¡ï¼Œæä¾›å‡ºè‰²çš„æ”¯æ’‘å’Œèˆ’é€‚æ€§ã€‚',
                        stock: 40
                    },
                    {
                        id: Date.now() + 5,
                        name: 'ç”·å£«é¦™æ°´',
                        price: 429,
                        image: 'https://images.unsplash.com/photo-1585386959984-a4155224a1ad?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                        category: 'beauty',
                        description: 'ä¼˜é›…ç”·å£«é¦™æ°´ï¼ŒæŒä¹…ç•™é¦™ï¼Œé€‚åˆå„ç§åœºåˆã€‚å‰è°ƒæ¸…æ–°ï¼Œä¸­è°ƒæ¸©æš–ï¼Œåè°ƒæ²‰ç¨³ã€‚',
                        stock: 60
                    },
                    {
                        id: Date.now() + 6,
                        name: 'æ™ºèƒ½å°ç¯',
                        price: 199,
                        image: 'https://images.unsplash.com/photo-1507473885765-e6ed057f782c?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                        category: 'home',
                        description: 'æ™ºèƒ½è°ƒå…‰å°ç¯ï¼Œæ”¯æŒæ‰‹æœºAPPæ§åˆ¶ï¼Œå¤šç§ç¯å…‰æ¨¡å¼ï¼ŒæŠ¤çœ¼è®¾è®¡ï¼Œé€‚åˆé˜…è¯»å’Œå·¥ä½œã€‚',
                        stock: 35
                    }
                ];

                products.push(...demoProducts);
                saveProducts();
                renderAdminProducts();
                showNotification('æ¼”ç¤ºäº§å“å·²åŠ è½½', 'success');
            });
        }


        function saveProducts() {
            try {
                console.log('ğŸ’¾ å¼€å§‹ä¿å­˜äº§å“æ•°æ®...');
                localStorage.setItem('products', JSON.stringify(products));
                console.log('ğŸ’¾ ä¿å­˜æˆåŠŸï¼Œäº§å“æ•°é‡:', products.length);
                console.log('ğŸ’¾ CLOUD_STORAGE.enabled =', CLOUD_STORAGE.enabled);
                if (CLOUD_STORAGE.enabled) {
                    console.log('ğŸŒ å‡†å¤‡è°ƒç”¨ syncToCloud...');
                    syncToCloud('products', products);
                }
                // åŒæ—¶åŒæ­¥åˆ°Firebaseäº‘ç«¯
                if (cloudSync && cloudSync.isInitialized) {
                    cloudSync.syncProducts().catch(err => {
                        console.warn('äº§å“æ•°æ®äº‘ç«¯åŒæ­¥å¤±è´¥:', err);
                    });
                }
                return true;
            } catch (error) {
                console.error('ğŸ’¾ ä¿å­˜å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                return false;
            }
        }

        // æ™ºèƒ½åˆå¹¶è®¢å•æ•°æ®ï¼ˆé¿å…æ•°æ®ä¸¢å¤±ï¼‰- ä¼˜åŒ–ç‰ˆæœ¬ï¼Œæå‡å‡†ç¡®åº¦
        // å…³é”®è§„åˆ™ï¼š
        //   - ä½¿ç”¨ updatedAt åˆ¤æ–­æ–°æ—§ï¼šè°çš„æ—¶é—´æˆ³å¤§ï¼Œè°ä¸ºå‡†
        //   - ç®¡ç†å‘˜é€šè¿‡åå°ä¿®æ”¹è®¢å•çŠ¶æ€æ—¶ï¼Œä¼šä¸º allOrders / userOrders å†™å…¥æ–°çš„ updatedAtï¼Œ
        //     å› æ­¤äº‘ç«¯æ”¶åˆ°çš„ä¹Ÿæ˜¯â€œæœ€æ–°ç‰ˆæœ¬â€ï¼Œå®¢æˆ·ç«¯æœ¬åœ°æ—§æ•°æ®ä¸ä¼šå†æŠŠç®¡ç†å‘˜æ”¹åŠ¨é¡¶å›å»
        function mergeOrdersData(cloudOrders, userAccount) {
            if (!cloudOrders || !Array.isArray(cloudOrders)) {
                console.warn('âš ï¸ äº‘ç«¯è®¢å•æ•°æ®æ— æ•ˆï¼Œä¿ç•™æœ¬åœ°æ•°æ®');
                return;
            }
            
            // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨Mapè¿›è¡ŒO(1)æŸ¥æ‰¾
            const cloudOrdersMap = new Map();
            const validCloudOrders = [];
            
            // é¢„å¤„ç†ï¼šè¿‡æ»¤æ— æ•ˆè®¢å•å¹¶å»ºç«‹æ˜ å°„ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
            cloudOrders.forEach(order => {
                if (order && order.id) {
                    // ç¡®ä¿è®¢å•æœ‰å¿…è¦çš„å­—æ®µ
                    if (!order.updatedAt && order.date) {
                        order.updatedAt = typeof order.date === 'number' ? order.date : Date.now();
                    }
                    if (!order.date && order.updatedAt) {
                        order.date = order.updatedAt;
                    }
                    // ç¡®ä¿accountå­—æ®µå­˜åœ¨
                    if (!order.account && userAccount) {
                        order.account = userAccount;
                    }
                    cloudOrdersMap.set(order.id, order);
                    validCloudOrders.push(order);
                }
            });
            
            // åˆå¹¶ç­–ç•¥ï¼šä¿ç•™æœ¬åœ°æœªåŒæ­¥çš„ä¿®æ”¹ï¼Œä½¿ç”¨äº‘ç«¯æœ€æ–°æ•°æ®
            const mergedOrders = [];
            const processedIds = new Set();
            const localOrdersMap = new Map();
            
            // é¢„å¤„ç†æœ¬åœ°è®¢å•
            userOrders.forEach(order => {
                if (order && order.id) {
                    // ç¡®ä¿æœ¬åœ°è®¢å•ä¹Ÿæœ‰å¿…è¦å­—æ®µ
                    if (!order.updatedAt && order.date) {
                        order.updatedAt = typeof order.date === 'number' ? order.date : Date.now();
                    }
                    if (!order.account && userAccount) {
                        order.account = userAccount;
                    }
                    localOrdersMap.set(order.id, order);
                }
            });
            
            // åˆå¹¶ï¼šä¼˜å…ˆä½¿ç”¨äº‘ç«¯æ•°æ®ï¼ˆæ›´å‡†ç¡®ï¼‰ï¼Œä½†ä¿ç•™æœ¬åœ°æœªåŒæ­¥çš„ä¿®æ”¹
            validCloudOrders.forEach(cloudOrder => {
                const localOrder = localOrdersMap.get(cloudOrder.id);
                if (localOrder) {
                    // æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œä¿ç•™æœ€æ–°çš„
                    const localTime = localOrder.updatedAt || localOrder.date || 0;
                    const cloudTime = cloudOrder.updatedAt || cloudOrder.date || 0;
                    
                    // å¯¹äºç®¡ç†å‘˜å·²ç»åœ¨äº‘ç«¯æ›´æ–°è¿‡çš„è®¢å•ï¼ˆupdatedAt æ˜æ˜¾æ›´å¤§ï¼‰ï¼Œå¿…é¡»ä»¥äº‘ç«¯ä¸ºå‡†ï¼Œå¼ºåˆ¶è¦†ç›–æœ¬åœ°
                    let mergedOrder;
                    if (cloudTime > localTime) {
                        mergedOrder = { ...cloudOrder };
                    } else {
                        mergedOrder = { ...localOrder };
                    }
                    
                    // ç¡®ä¿dateå­—æ®µå­˜åœ¨ï¼ˆè®¢å•åˆ›å»ºæ—¶é—´ï¼Œä¸èƒ½ä¸¢å¤±ï¼‰
                    if (!mergedOrder.date) {
                        mergedOrder.date = localOrder.date || cloudOrder.date || Date.now();
                    }
                    
                    // ç¡®ä¿updatedAtå­—æ®µå­˜åœ¨
                    if (!mergedOrder.updatedAt) {
                        mergedOrder.updatedAt = mergedOrder.date || Date.now();
                    }
                    
                    // ç¡®ä¿accountå­—æ®µå­˜åœ¨
                    if (!mergedOrder.account) {
                        mergedOrder.account = localOrder.account || cloudOrder.account || userAccount;
                    }
                    
                    // ç¡®ä¿customerInfoå­—æ®µå®Œæ•´
                    if (!mergedOrder.customerInfo) {
                        mergedOrder.customerInfo = localOrder.customerInfo || cloudOrder.customerInfo || {};
                    }
                    
                    // ç¡®ä¿productNameå­—æ®µå­˜åœ¨
                    if (!mergedOrder.productName) {
                        mergedOrder.productName = localOrder.productName || cloudOrder.productName || '';
                    }
                    
                    mergedOrders.push(mergedOrder);
                    processedIds.add(cloudOrder.id);
                } else {
                    // äº‘ç«¯æœ‰ä½†æœ¬åœ°æ²¡æœ‰ï¼Œç›´æ¥æ·»åŠ 
                    mergedOrders.push(cloudOrder);
                    processedIds.add(cloudOrder.id);
                }
            });
            
            // æ·»åŠ æœ¬åœ°æœ‰ä½†äº‘ç«¯æ²¡æœ‰çš„è®¢å•ï¼ˆåªä¿ç•™æœ€è¿‘åˆ›å»ºçš„è®¢å•ï¼Œé¿å…å†å²æ•°æ®é‡ç°ï¼‰
            // æ—¶é—´é˜ˆå€¼ï¼šåªä¿ç•™æœ€è¿‘30å¤©å†…åˆ›å»ºçš„è®¢å•ï¼Œé¿å…æ—§æ•°æ®é‡ç°
            const RECENT_ORDER_THRESHOLD = 30 * 24 * 60 * 60 * 1000; // 30å¤©
            const now = Date.now();
            
            localOrdersMap.forEach((localOrder, id) => {
                if (!processedIds.has(id)) {
                    // åªä¿ç•™å±äºå½“å‰ç”¨æˆ·çš„è®¢å•
                    if (localOrder.account === userAccount || !localOrder.account) {
                        // æ£€æŸ¥è®¢å•æ˜¯å¦æ˜¯æ–°åˆ›å»ºçš„ï¼ˆæœ€è¿‘30å¤©å†…ï¼‰
                        const orderTime = localOrder.date || localOrder.updatedAt || 0;
                        const isRecentOrder = (now - orderTime) < RECENT_ORDER_THRESHOLD;
                        
                        if (isRecentOrder) {
                            // åªæ·»åŠ æœ€è¿‘åˆ›å»ºçš„è®¢å•ï¼Œé¿å…å†å²æ•°æ®é‡ç°
                            mergedOrders.push(localOrder);
                            console.log(`âœ… ä¿ç•™æœ¬åœ°æ–°è®¢å•: ${id} (åˆ›å»ºæ—¶é—´: ${new Date(orderTime).toLocaleString()})`);
                        } else {
                            // å¿½ç•¥æ—§è®¢å•ï¼Œé¿å…å†å²æ•°æ®é‡ç°
                            console.log(`âš ï¸ å¿½ç•¥æœ¬åœ°æ—§è®¢å•: ${id} (åˆ›å»ºæ—¶é—´: ${new Date(orderTime).toLocaleString()}, å·²è¶…è¿‡30å¤©)`);
                        }
                    }
                }
            });
            
            // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            mergedOrders.sort((a, b) => {
                const timeA = a.updatedAt || a.date || 0;
                const timeB = b.updatedAt || b.date || 0;
                return timeB - timeA;
            });
            
            // æ›´æ–°æœ¬åœ°æ•°æ®
            const beforeCount = userOrders.length;
            userOrders = mergedOrders;
            
            // ä¿å­˜åˆ°localStorageï¼ˆåªä¿å­˜ä¸€æ¬¡ï¼Œé¿å…è¿‡å¤šå¤‡ä»½å½±å“æ€§èƒ½ï¼‰
            if (currentUser && currentUser.account) {
                const userOrdersKey = `userOrders_${currentUser.account}`;
                localStorage.setItem(userOrdersKey, JSON.stringify(userOrders));
            }
            localStorage.setItem('userOrders', JSON.stringify(userOrders));
        }
        
        // åˆå¹¶æ‰€æœ‰è®¢å•æ•°æ®ï¼ˆç”¨äºåå°ç®¡ç†ï¼‰- ä¼˜åŒ–ç‰ˆæœ¬
        function mergeAllOrdersData(cloudOrders) {
            if (!cloudOrders || !Array.isArray(cloudOrders)) return;
            
            // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨Mapè¿›è¡ŒO(1)æŸ¥æ‰¾
            const cloudOrdersMap = new Map();
            const validCloudOrders = [];
            
            // é¢„å¤„ç†ï¼šè¿‡æ»¤æ— æ•ˆè®¢å•å¹¶å»ºç«‹æ˜ å°„
            cloudOrders.forEach(order => {
                if (order && order.id) {
                    // ç¡®ä¿è®¢å•æœ‰å¿…è¦çš„å­—æ®µ
                    if (!order.updatedAt && order.date) {
                        order.updatedAt = typeof order.date === 'number' ? order.date : Date.now();
                    }
                    cloudOrdersMap.set(order.id, order);
                    validCloudOrders.push(order);
                }
            });
            
            // åˆå¹¶ç­–ç•¥ï¼šä¿ç•™æœ¬åœ°æœªåŒæ­¥çš„ä¿®æ”¹ï¼Œä½¿ç”¨äº‘ç«¯æœ€æ–°æ•°æ®
            const mergedOrders = [];
            const processedIds = new Set();
            const localOrdersMap = new Map();
            
            // é¢„å¤„ç†æœ¬åœ°è®¢å•
            allOrders.forEach(order => {
                if (order && order.id) {
                    localOrdersMap.set(order.id, order);
                }
            });
            
            // åˆå¹¶ï¼šä¼˜å…ˆä½¿ç”¨äº‘ç«¯æ•°æ®ï¼ˆæ›´å‡†ç¡®ï¼‰ï¼Œä½†ä¿ç•™æœ¬åœ°æœªåŒæ­¥çš„ä¿®æ”¹
            validCloudOrders.forEach(cloudOrder => {
                const localOrder = localOrdersMap.get(cloudOrder.id);
                if (localOrder) {
                    // æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œä¿ç•™æœ€æ–°çš„
                    const localTime = localOrder.updatedAt || localOrder.date || 0;
                    const cloudTime = cloudOrder.updatedAt || cloudOrder.date || 0;
                    
                    // å¯¹äºç®¡ç†å‘˜å·²ç»åœ¨äº‘ç«¯æ›´æ–°è¿‡çš„è®¢å•ï¼ˆupdatedAt æ˜æ˜¾æ›´å¤§ï¼‰ï¼Œå¿…é¡»ä»¥äº‘ç«¯ä¸ºå‡†ï¼Œå¼ºåˆ¶è¦†ç›–æœ¬åœ°
                    let mergedOrder;
                    if (cloudTime > localTime) {
                        mergedOrder = { ...cloudOrder };
                    } else {
                        mergedOrder = { ...localOrder };
                    }
                    
                    // ç¡®ä¿dateå­—æ®µå­˜åœ¨ï¼ˆè®¢å•åˆ›å»ºæ—¶é—´ï¼‰
                    if (!mergedOrder.date) {
                        mergedOrder.date = localOrder.date || cloudOrder.date || Date.now();
                    }
                    
                    // ç¡®ä¿updatedAtå­—æ®µå­˜åœ¨
                    if (!mergedOrder.updatedAt) {
                        mergedOrder.updatedAt = mergedOrder.date || Date.now();
                    }
                    
                    // ç¡®ä¿accountå­—æ®µå­˜åœ¨
                    if (!mergedOrder.account && localOrder.account) {
                        mergedOrder.account = localOrder.account;
                    }
                    if (!mergedOrder.account && cloudOrder.account) {
                        mergedOrder.account = cloudOrder.account;
                    }
                    
                    mergedOrders.push(mergedOrder);
                    processedIds.add(cloudOrder.id);
                } else {
                    // äº‘ç«¯æœ‰ä½†æœ¬åœ°æ²¡æœ‰ï¼Œç›´æ¥æ·»åŠ 
                    mergedOrders.push(cloudOrder);
                    processedIds.add(cloudOrder.id);
                }
            });
            
            // æ·»åŠ æœ¬åœ°æœ‰ä½†äº‘ç«¯æ²¡æœ‰çš„è®¢å•ï¼ˆåªä¿ç•™æœ€è¿‘åˆ›å»ºçš„è®¢å•ï¼Œé¿å…å†å²æ•°æ®é‡ç°ï¼‰
            // æ—¶é—´é˜ˆå€¼ï¼šåªä¿ç•™æœ€è¿‘30å¤©å†…åˆ›å»ºçš„è®¢å•ï¼Œé¿å…æ—§æ•°æ®é‡ç°
            const RECENT_ORDER_THRESHOLD = 30 * 24 * 60 * 60 * 1000; // 30å¤©
            const now = Date.now();
            
            localOrdersMap.forEach((localOrder, id) => {
                if (!processedIds.has(id)) {
                    // æ£€æŸ¥è®¢å•æ˜¯å¦æ˜¯æ–°åˆ›å»ºçš„ï¼ˆæœ€è¿‘30å¤©å†…ï¼‰
                    const orderTime = localOrder.date || localOrder.updatedAt || 0;
                    const isRecentOrder = (now - orderTime) < RECENT_ORDER_THRESHOLD;
                    
                    if (isRecentOrder) {
                        // åªæ·»åŠ æœ€è¿‘åˆ›å»ºçš„è®¢å•ï¼Œé¿å…å†å²æ•°æ®é‡ç°
                        mergedOrders.push(localOrder);
                        console.log(`âœ… ä¿ç•™æœ¬åœ°æ–°è®¢å•: ${id} (åˆ›å»ºæ—¶é—´: ${new Date(orderTime).toLocaleString()})`);
                    } else {
                        // å¿½ç•¥æ—§è®¢å•ï¼Œé¿å…å†å²æ•°æ®é‡ç°
                        console.log(`âš ï¸ å¿½ç•¥æœ¬åœ°æ—§è®¢å•: ${id} (åˆ›å»ºæ—¶é—´: ${new Date(orderTime).toLocaleString()}, å·²è¶…è¿‡30å¤©)`);
                    }
                }
            });
            
            // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            mergedOrders.sort((a, b) => {
                const timeA = a.updatedAt || a.date || 0;
                const timeB = b.updatedAt || b.date || 0;
                return timeB - timeA;
            });
            
            // æ›´æ–°å…¨å±€è®¢å•æ•°æ®
            allOrders = mergedOrders;
            localStorage.setItem('allOrders', JSON.stringify(allOrders));
            
            console.log(`âœ… æ‰€æœ‰è®¢å•æ•°æ®å·²æ™ºèƒ½åˆå¹¶: ${mergedOrders.length} ä¸ªè®¢å•`);
        }

        // ========== ç»Ÿä¸€çš„æ•°æ®ä¿å­˜å’ŒåŒæ­¥æ¥å£ ==========
        function saveUserOrders() {
            // ä¸ºæ¯ä¸ªè®¢å•æ·»åŠ æ›´æ–°æ—¶é—´æˆ³å’Œè´¦æˆ·ä¿¡æ¯
            const now = Date.now();
            userOrders.forEach(order => {
                if (!order.updatedAt) {
                    order.updatedAt = now;
                }
                // ç¡®ä¿è®¢å•æœ‰accountå­—æ®µ
                if (!order.account && currentUser && currentUser.account) {
                    order.account = currentUser.account;
                }
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            if (currentUser && currentUser.account) {
                const userOrdersKey = `userOrders_${currentUser.account}`;
                Storage.set(userOrdersKey, userOrders);
            }
            Storage.set('userOrders', userOrders); // å…¼å®¹æ—§ä»£ç 
            
            // æ›´æ–°å…¨å±€è®¢å•æ•°ç»„ï¼ˆå¦‚æœå½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼‰
            if (currentUser && currentUser.role === 'admin') {
                updateAllOrdersFromUserOrders();
            }
            
            // åŒæ­¥åˆ°äº‘ç«¯ï¼ˆä½¿ç”¨ç»Ÿä¸€åŒæ­¥æ¥å£ï¼‰
            if (cloudSync && cloudSync.isInitialized) {
                cloudSync.syncOrders().catch(err => {
                    console.error('è®¢å•äº‘ç«¯åŒæ­¥å¤±è´¥:', err);
                });
            }
        }
        
        // ä»ç”¨æˆ·è®¢å•æ›´æ–°å…¨å±€è®¢å•æ•°ç»„
        function updateAllOrdersFromUserOrders() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            // åˆ›å»ºè®¢å•IDæ˜ å°„
            const allOrdersMap = new Map();
            allOrders.forEach(order => {
                allOrdersMap.set(order.id, order);
            });
            
            // æ›´æ–°æˆ–æ·»åŠ å½“å‰ç”¨æˆ·çš„è®¢å•
            userOrders.forEach(userOrder => {
                // ç¡®ä¿è®¢å•æœ‰accountå­—æ®µ
                if (!userOrder.account && currentUser.account) {
                    userOrder.account = currentUser.account;
                }
                allOrdersMap.set(userOrder.id, userOrder);
            });
            
            // æ›´æ–°å…¨å±€æ•°ç»„
            allOrders = Array.from(allOrdersMap.values());
            localStorage.setItem('allOrders', JSON.stringify(allOrders));
            console.log('âœ… å…¨å±€è®¢å•æ•°ç»„å·²æ›´æ–°:', allOrders.length, 'ä¸ªè®¢å•');
        }

        // æ™ºèƒ½åˆå¹¶ç”¨æˆ·æ•°æ®åˆ—è¡¨ï¼šæŒ‰ account å»é‡ï¼Œå°½é‡ä»¥äº‘ç«¯ä¸ºå‡†ï¼ŒåŒæ—¶ä¿ç•™æœ¬åœ°æ–°å¢ç”¨æˆ·
        // ç‰¹åˆ«è§„åˆ™ï¼š
        //   - æ™®é€šåŒæ­¥ï¼šä¸€æ—¦è´¦å·åœ¨äº‘ç«¯è¢«æ ‡è®°ä¸º bannedï¼Œæœ¬åœ°ä¸èƒ½è‡ªåŠ¨â€œæ´—ç™½â€
        //   - ç®¡ç†å‘˜åŒæ­¥ï¼šå…è®¸æ˜¾å¼è§£ç¦ï¼ˆæœ¬åœ°ä» banned æ”¹ä¸º activeï¼‰ï¼Œä»¥ç®¡ç†å‘˜æ“ä½œä¸ºå‡†
        function mergeUsersData(cloudUsers, localUsers, options = {}) {
            const allowUnban = !!options.allowUnban;
            const resultMap = new Map();

            // å…ˆæŠŠäº‘ç«¯ç”¨æˆ·æ”¾è¿›å»ï¼ˆé»˜è®¤ä»¥äº‘ç«¯ä¸ºå‡†ï¼‰
            if (Array.isArray(cloudUsers)) {
                cloudUsers.forEach(user => {
                    if (user && user.account) {
                        resultMap.set(user.account, user);
                    }
                });
            }

            // å†åˆå¹¶æœ¬åœ°ç”¨æˆ·ï¼šäº‘ç«¯ä¸å­˜åœ¨çš„è´¦å·ç›´æ¥åŠ å…¥ï¼›äº‘ç«¯å­˜åœ¨çš„ï¼Œä»…åœ¨æœ¬åœ°æ˜æ˜¾æ›´æ–°æ—¶è¦†ç›–
            if (Array.isArray(localUsers)) {
                localUsers.forEach(user => {
                    if (!user || !user.account) return;
                    const account = user.account;
                    const cloudUser = resultMap.get(account);

                    if (!cloudUser) {
                        // äº‘ç«¯æ²¡æœ‰è¿™ä¸ªè´¦å·ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æœ€è¿‘æ³¨å†Œçš„ç”¨æˆ·ï¼ˆé¿å…å†å²ç”¨æˆ·é‡ç°ï¼‰
                        // æ—¶é—´é˜ˆå€¼ï¼šåªä¿ç•™æœ€è¿‘90å¤©å†…æ³¨å†Œçš„ç”¨æˆ·ï¼Œé¿å…æ—§æ•°æ®é‡ç°
                        const RECENT_USER_THRESHOLD = 90 * 24 * 60 * 60 * 1000; // 90å¤©
                        const now = Date.now();
                        const registerTime = user.registerTime 
                            ? (typeof user.registerTime === 'string' ? new Date(user.registerTime).getTime() : user.registerTime)
                            : (user.updatedAt || 0);
                        const isRecentUser = (now - registerTime) < RECENT_USER_THRESHOLD;
                        
                        if (isRecentUser) {
                            // åªæ·»åŠ æœ€è¿‘æ³¨å†Œçš„ç”¨æˆ·ï¼Œé¿å…å†å²ç”¨æˆ·é‡ç°
                            resultMap.set(account, user);
                            console.log(`âœ… ä¿ç•™æœ¬åœ°æ–°ç”¨æˆ·: ${account} (æ³¨å†Œæ—¶é—´: ${new Date(registerTime).toLocaleString()})`);
                        } else {
                            // å¿½ç•¥æ—§ç”¨æˆ·ï¼Œé¿å…å†å²ç”¨æˆ·é‡ç°
                            console.log(`âš ï¸ å¿½ç•¥æœ¬åœ°æ—§ç”¨æˆ·: ${account} (æ³¨å†Œæ—¶é—´: ${new Date(registerTime).toLocaleString()}, å·²è¶…è¿‡90å¤©)`);
                        }
                    } else {
                        // åŒä¸€è´¦å·åŒæ—¶å­˜åœ¨äºäº‘ç«¯å’Œæœ¬åœ°ï¼ŒæŒ‰æ—¶é—´æˆ³/æ³¨å†Œæ—¶é—´å†³å®šæ˜¯å¦è¦†ç›–
                        const cloudTime = cloudUser.updatedAt
                            || (cloudUser.registerTime ? new Date(cloudUser.registerTime).getTime() : 0);
                        const localTime = user.updatedAt
                            || (user.registerTime ? new Date(user.registerTime).getTime() : 0);

                        const cloudBanned = cloudUser.status === 'banned';
                        const localBanned = user.status === 'banned';

                        // 1ï¸âƒ£ äº‘ç«¯å·²ç¦ç”¨ï¼Œæœ¬åœ°æœªç¦ç”¨
                        if (cloudBanned && !localBanned) {
                            if (allowUnban) {
                                // ç®¡ç†å‘˜åŒæ­¥åœºæ™¯ï¼šå…è®¸æœ¬åœ°â€œè§£ç¦â€ï¼Œä½†ä»æŒ‰æ—¶é—´æˆ³åˆ¤æ–­è°æ›´æ–°å¾—æ›´æ™š
                                if (localTime > cloudTime) {
                                    resultMap.set(account, user);
                                } else {
                                    resultMap.set(account, cloudUser);
                                }
                            } else {
                                // æ™®é€šåŒæ­¥ï¼šä¿æŒäº‘ç«¯ç¦ç”¨çŠ¶æ€
                                resultMap.set(account, cloudUser);
                            }
                        }
                        // 2ï¸âƒ£ æœ¬åœ°æ˜¯ç¦ç”¨çŠ¶æ€ï¼Œè€Œäº‘ç«¯ä¸æ˜¯ï¼Œåˆ™ä»¥æœ¬åœ°ä¸ºå‡†ï¼ˆé€šå¸¸æ¥è‡ªç®¡ç†å‘˜ç¦ç”¨ï¼‰
                        else if (localBanned && !cloudBanned) {
                            resultMap.set(account, user);
                        }
                        // 3ï¸âƒ£ å…¶ä½™æƒ…å†µæŒ‰æ—¶é—´æˆ³å†³å®š
                        else if (localTime > cloudTime) {
                            // æœ¬åœ°çœ‹èµ·æ¥æ›´æ–°æ›´æ™šï¼Œç”¨æœ¬åœ°è¦†ç›–äº‘ç«¯ç‰ˆæœ¬
                            resultMap.set(account, user);
                        } else {
                            resultMap.set(account, cloudUser);
                        }
                    }
                });
            }

            return Array.from(resultMap.values());
        }

        function saveCurrentUser() {
            Storage.set('currentUser', currentUser);
        }

        function saveUserAddresses() {
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            if (currentUser && currentUser.account) {
                const userAddressesKey = `userAddresses_${currentUser.account}`;
                Storage.set(userAddressesKey, userAddresses);
            }
            Storage.set('userAddresses', userAddresses); // å…¼å®¹æ—§ä»£ç 
            
            // åŒæ­¥åˆ°äº‘ç«¯ï¼ˆä½¿ç”¨ç»Ÿä¸€åŒæ­¥æ¥å£ï¼‰
            if (cloudSync && cloudSync.isInitialized) {
                cloudSync.syncAddresses().catch(err => {
                    console.error('åœ°å€æ•°æ®äº‘ç«¯åŒæ­¥å¤±è´¥:', err);
                });
            }
        }

        function saveUserProfile() {
            Storage.set('userProfile', userProfile);
        }

        // ä¿å­˜è®¾å¤‡æ³¨å†Œé™åˆ¶
        function saveDeviceRegisterLimits() {
            Storage.set('deviceRegisterLimits', deviceRegisterLimits);
        }

        // è·å–è®¾å¤‡çš„æ³¨å†Œé™åˆ¶
        function getDeviceRegisterLimit(deviceId) {
            return deviceRegisterLimits[deviceId] !== undefined 
                ? deviceRegisterLimits[deviceId] 
                : DEFAULT_DEVICE_REGISTER_LIMIT;
        }

        // æ›´æ–°è®¾å¤‡é™åˆ¶åˆ—è¡¨æ˜¾ç¤º
        function updateDeviceLimitsList() {
            const contentDiv = DOMCache.get('#device-limits-content');
            if (!contentDiv) return;

            const devices = Object.keys(deviceRegisterLimits);
            if (devices.length === 0) {
                contentDiv.innerHTML = `<p style="color: #666; margin: 0;">æš‚æ— è‡ªå®šä¹‰é™åˆ¶ï¼Œæ‰€æœ‰è®¾å¤‡ä½¿ç”¨é»˜è®¤é™åˆ¶(${DEFAULT_DEVICE_REGISTER_LIMIT})</p>`;
                return;
            }

            // ç»Ÿè®¡æ¯ä¸ªè®¾å¤‡çš„å®é™…æ³¨å†Œæ•°é‡
            const deviceUserCountMap = {};
            allUsers.forEach(user => {
                if (user.role !== 'admin' && user.deviceId) {
                    deviceUserCountMap[user.deviceId] = (deviceUserCountMap[user.deviceId] || 0) + 1;
                }
            });

            // ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ä¼˜åŒ–æ€§èƒ½
            const rows = devices.map(deviceId => {
                const limit = deviceRegisterLimits[deviceId];
                const currentCount = deviceUserCountMap[deviceId] || 0;
                const statusColor = currentCount >= limit ? '#dc3545' : (currentCount >= limit * 0.8 ? '#ffc107' : '#28a745');
                const escapedDeviceId = escapeHtml(deviceId);
                return `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 8px; border: 1px solid #dee2e6;">${escapeHtml(formatDeviceLabel(deviceId))}<br><small style="color: #666;">${escapedDeviceId}</small></td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">${limit}</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6; color: ${statusColor}; font-weight: bold;">${currentCount}</td>
                        <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">
                            <button class="btn btn-sm btn-danger" onclick="removeDeviceLimit('${escapedDeviceId.replace(/'/g, "\\'")}')" style="padding: 4px 8px; font-size: 12px;">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');

            contentDiv.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #e9ecef;">
                            <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">è®¾å¤‡ID</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">é™åˆ¶æ•°é‡</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">å·²æ³¨å†Œ</th>
                            <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        // åˆ é™¤è®¾å¤‡é™åˆ¶
        function removeDeviceLimit(deviceId) {
            if (!deviceId) {
                console.error('removeDeviceLimit: deviceId ä¸èƒ½ä¸ºç©º');
                return;
            }
            const deviceLabel = formatDeviceLabel(deviceId);
            if (confirm(`ç¡®å®šè¦åˆ é™¤è®¾å¤‡ ${deviceLabel} çš„è‡ªå®šä¹‰æ³¨å†Œé™åˆ¶å—ï¼Ÿåˆ é™¤åå°†ä½¿ç”¨é»˜è®¤é™åˆ¶(${DEFAULT_DEVICE_REGISTER_LIMIT})ã€‚`)) {
                try {
                    delete deviceRegisterLimits[deviceId];
                    saveDeviceRegisterLimits();
                    updateDeviceLimitsList();
                    showMessageModal('æˆåŠŸ', 'è®¾å¤‡é™åˆ¶å·²åˆ é™¤', 'success');
                } catch (error) {
                    console.error('åˆ é™¤è®¾å¤‡é™åˆ¶å¤±è´¥:', error);
                    showMessageModal('é”™è¯¯', 'åˆ é™¤è®¾å¤‡é™åˆ¶å¤±è´¥', 'alert');
                }
            }
        }

        // é€šç”¨çš„ç®¡ç†å‘˜æ›´æ–°åŒ…è£…å™¨ï¼šä¼˜å…ˆåœ¨äº‘ç«¯æ‰§è¡Œå†™å…¥ + é‡æ–°åŠ è½½ï¼Œé¿å…æœ¬åœ°æ—§æ•°æ®è¦†ç›–äº‘ç«¯
        async function runAdminUpdate(writeFn, reloadFn) {
            const isAdminUser = currentUser && currentUser.role === 'admin';
            const canUseCloud = cloudSync && cloudSync.isInitialized;

            // å¦‚æœæ— æ³•ä½¿ç”¨äº‘ç«¯æˆ–å½“å‰ä¸æ˜¯ç®¡ç†å‘˜ï¼Œåˆ™ç›´æ¥æ‰§è¡Œæœ¬åœ°é€»è¾‘
            if (!isAdminUser || !canUseCloud) {
                try {
                    if (typeof writeFn === 'function') {
                        await writeFn();
                    }
                    if (typeof reloadFn === 'function') {
                        await reloadFn();
                    }
                } catch (e) {
                    console.error('runAdminUpdate æœ¬åœ°æ‰§è¡Œå‡ºé”™:', e);
                }
                return;
            }

            // ç®¡ç†å‘˜ + äº‘ç«¯å¯ç”¨ï¼šä½¿ç”¨å®‰å…¨æ¨¡å¼ï¼Œé˜²æ­¢ç›‘å¬å™¨ç”¨æ—§æ•°æ®è¦†ç›–
            try {
                cloudSync._syncState.inProgress = true;

                if (typeof writeFn === 'function') {
                    await writeFn();
                }
                if (typeof reloadFn === 'function') {
                    await reloadFn();
                }
            } catch (e) {
                console.error('runAdminUpdate äº‘ç«¯æ‰§è¡Œå‡ºé”™:', e);
            } finally {
                setTimeout(() => {
                    if (cloudSync) {
                        cloudSync._syncState.inProgress = false;
                    }
                }, 500);
            }
        }

        async function saveAllUsers() {
            // æœ¬åœ°æŒä¹…åŒ–ä¸€ä»½æœ€æ–°çš„ allUsers ä½œä¸ºç¼“å­˜
            try {
                Storage.set('allUsers', allUsers);
            } catch (e) {
                console.warn('ä¿å­˜æœ¬åœ° allUsers å¤±è´¥:', e);
            }
            
            // ä½¿ç”¨ç»Ÿä¸€çš„ç®¡ç†å‘˜æ›´æ–°æµç¨‹åŒæ­¥åˆ°äº‘ç«¯
            if (cloudSync && cloudSync.isInitialized && typeof cloudSync.syncAllUsers === 'function') {
                await runAdminUpdate(
                    () => cloudSync.syncAllUsers(),
                    null
                );
            } else if (CLOUD_STORAGE.enabled) {
                // å¦‚æœCloudSyncManageræœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æ—§çš„åŒæ­¥æ–¹å¼
                syncToCloud('users', allUsers);
            }
        }

        // ç®€åŒ–çš„æ•°æ®åŒæ­¥åŠŸèƒ½ - ä½¿ç”¨ localStorage è·¨è®¾å¤‡åŒæ­¥
        function syncToCloud(dataType, data) {
            console.log(`ğŸ”„ å¼€å§‹åŒæ­¥ ${dataType} æ•°æ®...`);
            console.log(`ğŸ“Š CROSS_DEVICE_SYNC.enabled = ${CROSS_DEVICE_SYNC.enabled}`);

            if (!CROSS_DEVICE_SYNC.enabled) {
                console.warn(`âš ï¸ ${dataType} åŒæ­¥å·²ç¦ç”¨`);
                return;
            }

            try {
                // åˆ›å»ºåŒæ­¥æ•°æ®åŒ…
                const syncData = {
                    type: dataType,
                    data: data,
                    timestamp: Date.now(),
                    deviceId: getDeviceId()
                };

                console.log(`ğŸ“¦ åŒæ­¥æ•°æ®åŒ…:`, syncData);

                // ä¿å­˜åˆ° localStorage
                const existingSync = JSON.parse(localStorage.getItem(CROSS_DEVICE_SYNC.syncKey) || '{}');
                existingSync[dataType] = syncData;
                localStorage.setItem(CROSS_DEVICE_SYNC.syncKey, JSON.stringify(existingSync));
                localStorage.setItem(CROSS_DEVICE_SYNC.lastSyncTime, Date.now().toString());

                console.log(`âœ… ${dataType} æ•°æ®å·²åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨`);

                // å°è¯•åŒæ­¥åˆ°å…¶ä»–è®¾å¤‡ï¼ˆé€šè¿‡ URL å‚æ•°ï¼‰
                syncViaURL(dataType, data);

            } catch (error) {
                console.error(`âŒ ${dataType} åŒæ­¥é”™è¯¯:`, error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
            }
        }

        function syncFromCloud(dataType) {
            if (!CROSS_DEVICE_SYNC.enabled) return null;

            try {
                const syncData = JSON.parse(localStorage.getItem(CROSS_DEVICE_SYNC.syncKey) || '{}');
                const data = syncData[dataType];

                if (data && data.data) {
                    console.log(`âœ… ${dataType} æ•°æ®å·²ä»æœ¬åœ°å­˜å‚¨åŒæ­¥`);
                    return data.data;
                }

                return null;
            } catch (error) {
                console.error(`âŒ ${dataType} åŒæ­¥é”™è¯¯:`, error);
                return null;
            }
        }

        // ç”Ÿæˆè®¾å¤‡ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('device_id');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('device_id', deviceId);
            }
            return deviceId;
        }

        // é€šè¿‡URLå‚æ•°åŒæ­¥æ•°æ®ï¼ˆç®€å•æ–¹æ¡ˆï¼‰
        function syncViaURL(dataType, data) {
            try {
                // ä½¿ç”¨ encodeURIComponent æ›¿ä»£ btoaï¼Œæ”¯æŒä¸­æ–‡å­—ç¬¦
                const jsonData = JSON.stringify({ type: dataType, data: data });
                const encodedData = encodeURIComponent(jsonData);
                const syncURL = `${window.location.origin}${window.location.pathname}?sync=${encodedData}`;

                // åœ¨æ§åˆ¶å°æ˜¾ç¤ºåŒæ­¥é“¾æ¥ï¼Œç”¨æˆ·å¯ä»¥å¤åˆ¶åˆ°å…¶ä»–è®¾å¤‡
                console.log(`ğŸ“‹ è·¨è®¾å¤‡åŒæ­¥é“¾æ¥ (${dataType}):`, syncURL);

                // å¯ä»¥æ˜¾ç¤ºç»™ç”¨æˆ·ï¼ˆå·²ç¦ç”¨ï¼Œé¿å…å¼¹çª—å¹²æ‰°ï¼‰
                // if (isAdmin()) {
                //     showNotification(`æ•°æ®åŒæ­¥é“¾æ¥å·²ç”Ÿæˆï¼Œè¯·å¤åˆ¶åˆ°å…¶ä»–è®¾å¤‡: ${syncURL}`, 'info');
                // }
            } catch (error) {
                console.error('URLåŒæ­¥å¤±è´¥:', error);
            }
        }

        // ä»URLå‚æ•°è¯»å–åŒæ­¥æ•°æ®
        function loadSyncFromURL() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const syncData = urlParams.get('sync');

                if (syncData) {
                    const decoded = JSON.parse(decodeURIComponent(syncData));
                    console.log('ğŸ“¥ ä»URLæ¥æ”¶åˆ°åŒæ­¥æ•°æ®:', decoded);

                    // æ ¹æ®æ•°æ®ç±»å‹æ›´æ–°æœ¬åœ°æ•°æ®
                    switch (decoded.type) {
                        case 'products':
                            products = decoded.data;
                            saveProducts();
                            renderProducts(products);
                            showNotification('äº§å“æ•°æ®å·²åŒæ­¥', 'success');
                            break;
                        case 'users':
                            allUsers = decoded.data;
                            saveAllUsers();
                            showNotification('ç”¨æˆ·æ•°æ®å·²åŒæ­¥', 'success');
                            break;
                        case 'orders':
                            userOrders = decoded.data;
                            saveUserOrders();
                            showNotification('è®¢å•æ•°æ®å·²åŒæ­¥', 'success');
                            break;
                    }

                    // æ¸…é™¤URLå‚æ•°
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch (error) {
                console.error('URLåŒæ­¥æ•°æ®è§£æå¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–æ—¶ä»äº‘ç«¯åŒæ­¥æ•°æ®
        // æ—§çš„initCloudSyncå‡½æ•°ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨Firebase CloudSyncManagerç‰ˆæœ¬ï¼‰
        // æ­¤å‡½æ•°å·²è¢«ä¸Šæ–¹çš„Firebaseç‰ˆæœ¬æ›¿ä»£ï¼Œä¿ç•™ä»…ä¸ºå…¼å®¹æ€§
        // async function initCloudSync() { ... }

        // æƒé™æ£€æŸ¥å‡½æ•°
        function isAdmin() {
            return currentUser && currentUser.role === 'admin';
        }

        function isLoggedIn() {
            return currentUser !== null;
        }

        // ç”¨æˆ·è®¤è¯
        function authenticateUser(account, password) {
            // æ£€æŸ¥ç®¡ç†å‘˜è´¦å·
            if (ADMIN_ACCOUNTS[account]) {
                if (ADMIN_ACCOUNTS[account].password === password) {
                    return {
                        account: account,
                        username: ADMIN_ACCOUNTS[account].username,
                        role: 'admin',
                        status: 'active'
                    };
                } else {
                    // ç®¡ç†å‘˜è´¦å·å­˜åœ¨ä½†å¯†ç é”™è¯¯
                    return {
                        success: false,
                        error: 'password',
                        message: 'å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥'
                    };
                }
            }

            // æ£€æŸ¥æ™®é€šç”¨æˆ·
            const user = allUsers.find(u => u.account === account);
            if (user) {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«ç¦ç”¨
                if (user.status === 'banned') {
                    return {
                        banned: true,
                        message: 'æ‚¨çš„è´¦å·å·²è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
                    };
                }
                
                // æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®
                if (user.password === password) {
                    return {
                        account: user.account,
                        username: user.username,
                        role: 'user',
                        status: user.status || 'active',
                        points: typeof user.points === 'number' ? user.points : 1
                    };
                } else {
                    // è´¦å·å­˜åœ¨ä½†å¯†ç é”™è¯¯
                    return {
                        success: false,
                        error: 'password',
                        message: t('passwordIncorrect')
                    };
                }
            }

            // è´¦å·ä¸å­˜åœ¨
            return {
                success: false,
                error: 'account',
                message: t('accountNotExists')
            };
        }

        // æ³¨å†Œç”¨æˆ·
        function registerUser(account, password, username) {
            // æ£€æŸ¥è´¦å·æ˜¯å¦å·²å­˜åœ¨
            if (ADMIN_ACCOUNTS[account] || allUsers.find(u => u.account === account)) {
                return { success: false, message: t('accountExists') };
            }

            // æ£€æŸ¥è®¾å¤‡æ³¨å†Œé™åˆ¶ï¼ˆå¯é…ç½®ï¼‰
            const deviceId = getDeviceId();
            const sameDeviceUsers = allUsers.filter(u => u.deviceId === deviceId);
            // è·å–è¯¥è®¾å¤‡çš„æ³¨å†Œé™åˆ¶ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åˆ™ä½¿ç”¨é»˜è®¤å€¼
            const deviceLimit = deviceRegisterLimits[deviceId] !== undefined 
                ? deviceRegisterLimits[deviceId] 
                : DEFAULT_DEVICE_REGISTER_LIMIT;
            if (sameDeviceUsers.length >= deviceLimit) {
                return {
                    success: false,
                    message: t('deviceRegisterLimitReached') || 'å·²ç»æœ‰è´¦æˆ·å•¦ï¼Œå¿«å»ç™»å½•è´¦æˆ·é¢†å–å¥½ç‰©å§ï¼'
                };
            }

            const now = Date.now();
            const newUser = {
                id: now,
                account: account,
                password: password,
                username: username,
                role: 'user',
                registerTime: new Date(now).toISOString(),
                status: 'active',
                // ğŸ¯ æ–°å¢ï¼šç”¨æˆ·ç§¯åˆ†ï¼ˆèœœç½ï¼‰ï¼Œé»˜è®¤ 1
                points: 1,
                // è®°å½•æ³¨å†Œè®¾å¤‡IDï¼Œç”¨äºæ£€æµ‹åŒè®¾å¤‡å¤šè´¦å·
                deviceId: deviceId,
                // è®°å½•æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹æ—¶é—´ï¼Œä¾¿äºäº‘ç«¯/æœ¬åœ°åˆå¹¶æ—¶ä»¥æœ€æ–°ä¸ºå‡†
                updatedAt: now
            };

            allUsers.push(newUser);
            saveAllUsers();

            return { success: true, message: 'æ³¨å†ŒæˆåŠŸ' };
        }

        // ç«‹å³åˆå§‹åŒ–Logoæ˜¾ç¤ºï¼ˆä¸ç­‰å¾…DOMContentLoadedï¼‰
        (function initLogo() {
            const logoImg = document.getElementById('site-logo-img');
            if (logoImg) {
                // ç¡®ä¿logoå›¾ç‰‡å¯è§
                logoImg.style.display = 'block';
                logoImg.style.visibility = 'visible';
                logoImg.style.opacity = '1';
                const logoContainer = document.getElementById('home-link');
                if (logoContainer) {
                    logoContainer.style.display = 'flex';
                    logoContainer.style.visibility = 'visible';
                }
                // å¦‚æœsrcä¸ºç©ºï¼Œè®¾ç½®é»˜è®¤logo
                if (!logoImg.src || logoImg.src === window.location.href) {
                    logoImg.src = 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_acd40833aec9706776e6e1e4432f7198_ProductImage_PT02';
                }
            }
        })();

        document.addEventListener('DOMContentLoaded', async function () {
            const loader = DOMCache.get('#page-loader');
            const loaderProgress = DOMCache.get('#loader-progress');
            
            try {
                // æ›´æ–°åŠ è½½è¿›åº¦
                loaderProgress.textContent = 'æ£€æŸ¥URLåŒæ­¥æ•°æ®...';
                
            // å…ˆæ£€æŸ¥URLåŒæ­¥æ•°æ®
            loadSyncFromURL();

                // æ›´æ–°åŠ è½½è¿›åº¦
                loaderProgress.textContent = currentLanguage === 'zh' ? 'åˆå§‹åŒ–äº‘ç«¯åŒæ­¥...' : 'Initializing cloud sync...';
                
                // ç­‰å¾…Firebase SDKåŠ è½½ï¼ˆæœ€å¤šç­‰å¾…3ç§’ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ï¼‰
                let firebaseReady = false;
                for (let i = 0; i < 6; i++) {
                    if (typeof firebase !== 'undefined') {
                        firebaseReady = true;
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                if (firebaseReady) {
                    // åˆå§‹åŒ–äº‘ç«¯åŒæ­¥ï¼ˆè¿™ä¼šåŠ è½½äº§å“ã€ç”¨æˆ·å’Œä¸»é¡µè®¾ç½®ï¼‰
                    loaderProgress.textContent = currentLanguage === 'zh' ? 'è¿æ¥äº‘ç«¯æ•°æ®åº“...' : 'Connecting to cloud database...';
            await initCloudSync();

                    // ç­‰å¾…äº‘ç«¯åŒæ­¥åˆå§‹åŒ–å®Œæˆï¼ˆæœ€å¤šç­‰å¾…5ç§’ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ï¼‰
                    let syncReady = false;
                    for (let i = 0; i < 10; i++) {
                        if (cloudSync && cloudSync.isInitialized) {
                            syncReady = true;
                            break;
                        }
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    if (syncReady) {
                        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®ï¼Œæé«˜é€Ÿåº¦
                        loaderProgress.textContent = currentLanguage === 'zh' ? 'åŠ è½½äº‘ç«¯æ•°æ®...' : 'Loading cloud data...';
                        
                        // å¹¶è¡ŒåŠ è½½äº§å“ã€ç”¨æˆ·è®¢å•å’Œåœ°å€ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
                        const loadPromises = [
                            cloudSync.loadProducts(),
                            cloudSync.loadHomepageSettings()
                        ];
                        
                        if (currentUser) {
                            loadPromises.push(cloudSync.loadOrders());
                            loadPromises.push(cloudSync.loadAddresses());
                        }
                        
                        await Promise.all(loadPromises);
                        
                        // ä»localStorageè¯»å–æ›´æ–°åçš„æ•°æ®ï¼ˆäº‘ç«¯å·²åŠ è½½ï¼‰
                        products = JSON.parse(localStorage.getItem('products')) || [];
                        homepageSettings = JSON.parse(localStorage.getItem('homepageSettings')) || homepageSettings;
                        if (currentUser) {
                            // ä½¿ç”¨ç”¨æˆ·ç‰¹å®šçš„localStorage key
                            const userOrdersKey = `userOrders_${currentUser.account}`;
                            const userAddressesKey = `userAddresses_${currentUser.account}`;
                            userOrders = JSON.parse(localStorage.getItem(userOrdersKey)) || JSON.parse(localStorage.getItem('userOrders')) || [];
                            userAddresses = JSON.parse(localStorage.getItem(userAddressesKey)) || JSON.parse(localStorage.getItem('userAddresses')) || [];
                            
                            // è¿‡æ»¤æ‰ä¸å±äºå½“å‰ç”¨æˆ·çš„è®¢å•å’Œåœ°å€ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
                            userOrders = userOrders.filter(order => !order.account || order.account === currentUser.account);
                            userAddresses = userAddresses.filter(addr => !addr.account || addr.account === currentUser.account);
                            
                            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼ŒåŠ è½½æ‰€æœ‰è®¢å•
                            if (currentUser.role === 'admin') {
                                cloudSync.loadAllOrders().catch(err => {
                                    console.error('åŠ è½½æ‰€æœ‰è®¢å•å¤±è´¥:', err);
                                });
                            }
                        } else {
                            userOrders = [];
                            userAddresses = [];
                        }
                        
                        // ä»localStorageåŠ è½½æ‰€æœ‰è®¢å•ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰
                        try {
                            const savedAllOrders = localStorage.getItem('allOrders');
                            if (savedAllOrders) {
                                allOrders = JSON.parse(savedAllOrders);
                                console.log('ğŸ“¦ å·²ä»æœ¬åœ°åŠ è½½æ‰€æœ‰è®¢å•:', allOrders.length, 'ä¸ª');
                            }
                        } catch (e) {
                            // è§£ææœ¬åœ°æ‰€æœ‰è®¢å•å¤±è´¥æ—¶ï¼Œä¸å†å¼ºåˆ¶æ¸…ç©ºå†…å­˜ä¸­çš„ allOrdersï¼Œé¿å…è¦†ç›–å·²æœ‰æœ‰æ•ˆæ•°æ®
                            console.error('åŠ è½½æœ¬åœ°æ‰€æœ‰è®¢å•å¤±è´¥ï¼ˆä¿ç•™å½“å‰å†…å­˜æ•°æ®ï¼‰:', e);
                        }
                    } else {
                        loaderProgress.textContent = currentLanguage === 'zh' ? 'äº‘ç«¯åŒæ­¥è¶…æ—¶...' : 'Cloud sync timeout...';
                        // è¶…æ—¶åä»å°è¯•ä»äº‘ç«¯åŠ è½½ä¸€æ¬¡
                        products = [];
                    }
                } else {
                    loaderProgress.textContent = 'FirebaseæœªåŠ è½½...';
                    products = [];
                }

                // æ›´æ–°åŠ è½½è¿›åº¦
                loaderProgress.textContent = 'æ¸²æŸ“é¡µé¢å†…å®¹...';
                
                // ç«‹å³æ¸²æŸ“é¡µé¢å†…å®¹ï¼ˆä¸ç­‰å¾…ï¼‰
            renderProducts(products);
            renderUserOrders();

                // å¦‚æœåå°ç®¡ç†é¡µé¢å·²æ‰“å¼€ï¼Œæ›´æ–°è¡¨å•
                if (cloudSync && cloudSync.isInitialized) {
                    const adminHomepage = document.getElementById('admin-homepage');
                    if (adminHomepage && adminHomepage.classList.contains('active')) {
                        loadHomepageSettings();
                    }
                }

            // åº”ç”¨ä¸»é¡µè®¾ç½®
            applyHomepageSettings();
                
                // åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨
                const languageSelect = document.getElementById('language-select');
                if (languageSelect) {
                    // è®¾ç½®å½“å‰è¯­è¨€
                    languageSelect.value = currentLanguage;
                    
                    // ç»‘å®šè¯­è¨€åˆ‡æ¢äº‹ä»¶
                    languageSelect.addEventListener('change', function() {
                        switchLanguage(this.value);
                    });
                }
                
                // åº”ç”¨è¯­è¨€è®¾ç½®ï¼ˆåœ¨é¡µé¢æ¸²æŸ“åï¼‰
                applyLanguage();
                
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                loaderProgress.textContent = 'åŠ è½½å¤±è´¥';
                // å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤ºç©ºé¡µé¢
                renderProducts(products || []);
                renderUserOrders();
                applyHomepageSettings();
                
                // åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨ï¼ˆå³ä½¿å¤±è´¥ä¹Ÿè¦åˆå§‹åŒ–ï¼‰
                const languageSelect = document.getElementById('language-select');
                if (languageSelect) {
                    languageSelect.value = currentLanguage;
                    languageSelect.addEventListener('change', function() {
                        switchLanguage(this.value);
                    });
                }
                
                // åº”ç”¨è¯­è¨€è®¾ç½®
                applyLanguage();
            } finally {
                // ç«‹å³éšè—åŠ è½½é®ç½©ï¼Œæ˜¾ç¤ºé¡µé¢å†…å®¹ï¼ˆä¸å»¶è¿Ÿï¼‰
                loader.classList.add('hidden');
                document.body.classList.remove('loading');
                loader.remove();
            }

            // è½®æ’­å›¾åŠŸèƒ½ - ä½¿ç”¨ç»Ÿä¸€çš„åˆå§‹åŒ–å‡½æ•°
            initCarousel();

            // æœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');

            searchBtn.addEventListener('click', performSearch);
            // è¾“å…¥å³æ—¶æœç´¢ï¼ˆé˜²æŠ–ï¼‰
            searchInput.addEventListener('input', debounce(performSearch, 300));

            function performSearch() {
                const keyword = searchInput.value.trim().toLowerCase();
                if (keyword) {
                    const filteredProducts = products.filter(product =>
                        product.name.toLowerCase().includes(keyword) ||
                        product.description.toLowerCase().includes(keyword)
                    );
                    renderProducts(filteredProducts);
                } else {
                    renderProducts(products);
                }
            }

            // åˆ†ç±»ç­›é€‰
            const categoryItems = document.querySelectorAll('.category-item');
            categoryItems.forEach(item => {
                item.addEventListener('click', () => {
                    categoryItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    const category = item.getAttribute('data-category');
                    if (category === 'all') {
                        renderProducts(products);
                    } else {
                        const filteredProducts = products.filter(product => product.category === category);
                        renderProducts(filteredProducts);
                    }
                });
            });

            // é¡µé¢å¯¼èˆª
            const homeLink = document.getElementById('home-link');
            const mainHomeLink = document.getElementById('main-home-link');
            const adminLink = document.getElementById('admin-link');
            const userCenterLink = document.getElementById('user-center-link');
            const searchBar = document.querySelector('.search-bar');
            const homePage = document.getElementById('home-page');
            const userCenter = document.getElementById('user-center');
            const adminPanel = document.getElementById('admin-panel');
            const topCarousel = document.querySelector('.carousel');

            function showHomePage() {
                homePage.style.display = 'block';
                userCenter.classList.remove('show');
                userCenter.style.display = 'none';
                adminPanel.style.display = 'none';
                if (topCarousel) topCarousel.style.display = 'block';
                // åªåœ¨é¦–é¡µæ˜¾ç¤ºæœç´¢æ 
                if (searchBar) searchBar.style.display = 'flex';
                renderProducts(products);
            }

            function showUserCenter() {
                // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
                updateUserInterface();

                if (!currentUser) {
                    // å¦‚æœç”¨æˆ·è¢«ç¦ç”¨ï¼ŒupdateUserInterfaceä¼šæ¸…é™¤currentUser
                    return;
                }

                homePage.style.display = 'none';
                adminPanel.style.display = 'none';
                if (topCarousel) topCarousel.style.display = 'none';
                
                // éé¦–é¡µéšè—æœç´¢æ 
                if (searchBar) searchBar.style.display = 'none';
                
                // æ˜¾ç¤ºç”¨æˆ·ä¸­å¿ƒ
                userCenter.classList.add('show');
                userCenter.style.display = '';
                
                // æ˜¾ç¤ºä¾§è¾¹æ ï¼ˆå¦‚æœè¢«éšè—ï¼‰
                const userSidebar = document.querySelector('.user-sidebar');
                if (userSidebar) {
                    userSidebar.style.display = 'block';
                }
                userCenter.classList.remove('sidebar-hidden');
                
                // é»˜è®¤æ˜¾ç¤ºä¸ªäººä¿¡æ¯é¡µé¢ï¼Œä¸æ˜¾ç¤ºè®¢å•
                showUserPage('profile');
            }

            function showAdminPanel() {
                homePage.style.display = 'none';
                userCenter.classList.remove('show');
                userCenter.style.display = 'none';
                adminPanel.style.display = 'block';
                if (topCarousel) topCarousel.style.display = 'none';
                // éé¦–é¡µéšè—æœç´¢æ 
                if (searchBar) searchBar.style.display = 'none';
                renderAdminProducts();
            }

            homeLink.addEventListener('click', (e) => {
                e.preventDefault();
                showHomePage();
            });

            mainHomeLink.addEventListener('click', (e) => {
                e.preventDefault();
                showHomePage();
            });

            adminLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (!isLoggedIn()) {
                    customAlert(t('pleaseLogin'), t('infoTitle')).then(() => {
                        document.getElementById('login-modal').style.display = 'flex';
                    });
                    return;
                }

                if (!isAdmin()) {
                    customAlert(t('insufficientPermissions'), t('insufficientPermissionsTitle'));
                    return;
                }

                showAdminPanel();
            });

            userCenterLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentUser) {
                    showUserCenter();
                } else {
                    customAlert(t('pleaseLogin'), t('infoTitle')).then(() => {
                        document.getElementById('login-modal').style.display = 'flex';
                    });
                }
            });

            // æˆ‘çš„æŠ¥åé“¾æ¥ç‚¹å‡»äº‹ä»¶
            const myOrdersLink = document.getElementById('my-orders-link');
            if (myOrdersLink) {
                myOrdersLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentUser) {
                        homePage.style.display = 'none';
                        adminPanel.style.display = 'none';
                        
                        const userCenter = document.getElementById('user-center');
                        // æ˜¾ç¤ºç”¨æˆ·ä¸­å¿ƒ
                        userCenter.classList.add('show');
                        userCenter.style.display = '';
                        
                        // éšè—ä¾§è¾¹æ ï¼Œåªæ˜¾ç¤ºè®¢å•
                        const userSidebar = document.querySelector('.user-sidebar');
                        if (userSidebar) {
                            userSidebar.style.display = 'none';
                        }
                        userCenter.classList.add('sidebar-hidden');
                        
                        // ç›´æ¥æ˜¾ç¤ºè®¢å•é¡µé¢
                        showUserPage('orders');
                    } else {
                        alert(t('pleaseLogin'));
                        document.getElementById('login-modal').style.display = 'flex';
                    }
                });
            }

            // æ¨¡æ€æ¡†åŠŸèƒ½
            const modals = document.querySelectorAll('.modal');
            const loginModal = document.getElementById('login-modal');
            const registerModal = document.getElementById('register-modal');
            const signupModal = document.getElementById('signup-modal');
            const loginLink = document.getElementById('login-link');
            const registerLink = document.getElementById('register-link');
            const logoutLink = document.getElementById('logout-link');
            const closeButtons = document.querySelectorAll('.close-modal');

            loginLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginModal.style.display = 'flex';
            });

            // å·²ç§»é™¤æ•°æ®æºé€‰æ‹©åŠŸèƒ½ï¼Œå¼ºåˆ¶ä½¿ç”¨äº‘ç«¯æ¨¡å¼

            registerLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerModal.style.display = 'flex';
            });

            // ç™»å½•/æ³¨å†Œé€‰æ‹©æ¨¡æ€æ¡†æŒ‰é’®äº‹ä»¶
            const authChoiceModal = document.getElementById('auth-choice-modal');
            const gotoLoginBtn = document.getElementById('goto-login-btn');
            const gotoRegisterBtn = document.getElementById('goto-register-btn');

            if (gotoLoginBtn) {
                gotoLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (authChoiceModal) authChoiceModal.style.display = 'none';
                    loginModal.style.display = 'flex';
                });
            }

            if (gotoRegisterBtn) {
                gotoRegisterBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (authChoiceModal) authChoiceModal.style.display = 'none';
                    registerModal.style.display = 'flex';
                });
            }

            closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    modals.forEach(modal => modal.style.display = 'none');
                    // åŒæ—¶å…³é—­ç™»å½•/æ³¨å†Œé€‰æ‹©æ¨¡æ€æ¡†
                    if (authChoiceModal) authChoiceModal.style.display = 'none';
                });
            });

            // ç»Ÿä¸€çš„ç‚¹å‡»å¤–éƒ¨å…³é—­é€»è¾‘åœ¨åº•éƒ¨æ³¨å†Œ

            // ç™»å½•è¡¨å• - ä¼˜åŒ–:ç™»å½•å‰å…ˆæ¸…ç†æœ¬åœ°ç¼“å­˜ï¼Œç™»å½•åä»äº‘ç«¯åŠ è½½æœ€æ–°æ•°æ®
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const account = document.getElementById('login-account').value;
                const password = document.getElementById('login-password').value;

                if (!account || !password) {
                    customAlert(t('pleaseFillCompleteInfo'), t('infoTitle'));
                    return;
                }

                // ========== é˜²æ­¢é‡å¤ç™»å½• ==========
                if (currentUser && currentUser.account === account) {
                    showNotification('è¯¥è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•', 'warning');
                    loginModal.style.display = 'none';
                    return;
                }

                // ========== ç™»å½•å‰æ¸…é™¤æœ¬åœ°ç¼“å­˜å’Œç™»å½•çŠ¶æ€ï¼Œé˜²æ­¢æ—§æ•°æ®/æ—§ä¼šè¯å¹²æ‰° ==========
                console.log('ğŸ§¹ ç™»å½•å‰æ¸…é™¤æœ¬åœ°ç¼“å­˜å’Œæ—§çš„ç™»å½•çŠ¶æ€...');
                try {
                    // 1. å…ˆæ¸…é™¤å½“å‰å†…å­˜ä¸­çš„ç™»å½•çŠ¶æ€
                    currentUser = null;

                    // 2. æ¸…é™¤æœ¬åœ°å­˜å‚¨ä¸­çš„ç™»å½•çŠ¶æ€ï¼ˆä½†ä¿ç•™è®¾å¤‡é™åˆ¶ç­‰é‡è¦ä¿¡æ¯ï¼‰
                    try {
                        // ä½¿ç”¨å°è£…çš„ Storage å·¥å…·ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                        if (typeof Storage !== 'undefined' && Storage.remove) {
                            Storage.remove('currentUser');
                        } else {
                            localStorage.removeItem('currentUser');
                        }
                    } catch (e1) {
                        console.warn('âš ï¸ æ¸…é™¤ currentUser æœ¬åœ°è®°å½•æ—¶å‡ºé”™:', e1);
                        // å…œåº•å†ç›´æ¥æ“ä½œ localStorage
                        try {
                            localStorage.removeItem('currentUser');
                        } catch (e2) {
                            console.warn('âš ï¸ ç›´æ¥æ“ä½œ localStorage æ¸…é™¤ currentUser å¤±è´¥:', e2);
                        }
                    }

                    // 3. æ¸…é™¤ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡ç¼“å­˜ï¼ˆè®¢å•ã€åœ°å€ç­‰ï¼‰
                    localStorage.removeItem('userOrders');
                    localStorage.removeItem('userAddresses');
                    
                    // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§è®¢å•ç¼“å­˜ï¼ˆé’ˆå¯¹ä¸åŒç”¨æˆ·çš„è®¢å•ï¼‰
                    // éå†localStorageï¼Œæ¸…é™¤æ‰€æœ‰ä»¥'userOrders_'å¼€å¤´çš„key
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith('userOrders_') || key.startsWith('userAddresses_'))) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                        console.log('ğŸ—‘ï¸ å·²æ¸…é™¤ç¼“å­˜:', key);
                    });
                    
                    // 4. æ¸…ç©ºå†…å­˜ä¸­çš„æ—§æ•°æ®
                    userOrders = [];
                    userAddresses = [];
                    userProfile = {};
                    
                    console.log('âœ… ç™»å½•ç›¸å…³æœ¬åœ°ç¼“å­˜å’Œæ—§ä¼šè¯å·²æ¸…é™¤');
                } catch (error) {
                    console.warn('âš ï¸ æ¸…é™¤ç™»å½•ç¼“å­˜/æ—§ä¼šè¯æ—¶å‡ºç°é”™è¯¯:', error);
                }

                const authResult = authenticateUser(account, password);
                
                // æ£€æŸ¥ç™»å½•ç»“æœ
                if (authResult && !authResult.banned && authResult.success !== false && authResult.account) {
                    // ç™»å½•æˆåŠŸ
                    // ========== æ¸…ç©ºæ—§ç”¨æˆ·æ•°æ®ï¼Œå‡†å¤‡åŠ è½½æ–°ç”¨æˆ·æ•°æ® ==========
                    console.log('ğŸ”„ ç™»å½•æˆåŠŸï¼Œå‡†å¤‡åŠ è½½æ–°ç”¨æˆ·æ•°æ®...');
                    
                    currentUser = authResult;
                    saveCurrentUser();
                    refreshCurrentUserSnapshot(authResult.account);

                    showNotification(`ç™»å½•æˆåŠŸï¼æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...`, 'success');
                    loginModal.style.display = 'none';

                    // ========== å¼ºåˆ¶ä½¿ç”¨äº‘ç«¯æ¨¡å¼åŠ è½½æ•°æ® ==========
                    console.log('ğŸ”„ ç™»å½•æˆåŠŸï¼Œå¼ºåˆ¶ä½¿ç”¨äº‘ç«¯æ¨¡å¼');

                    try {
                        // äº‘ç«¯æ¨¡å¼ï¼šä»äº‘ç«¯åŠ è½½æœ€æ–°æ•°æ®
                        if (cloudSync && cloudSync.isInitialized) {
                            console.log('â˜ï¸ äº‘ç«¯æ¨¡å¼ - ä»äº‘ç«¯æ•°æ®åº“åŠ è½½æ•°æ®...');

                            // åŠ è½½äº§å“æ•°æ®
                            const cloudProducts = await cloudSync.downloadData('products');
                            if (cloudProducts && cloudProducts.length > 0) {
                                products = cloudProducts;
                                localStorage.setItem('products', JSON.stringify(products));
                                console.log('âœ… äº§å“æ•°æ®å·²ä»äº‘ç«¯åŠ è½½:', products.length, 'ä¸ªäº§å“');
                            } else {
                                console.log('â„¹ï¸ äº‘ç«¯æš‚æ— äº§å“æ•°æ®');
                                products = [];
                            }

                            // åŠ è½½ç”¨æˆ·æ•°æ®(ä»…ç®¡ç†å‘˜)
                            if (authResult.role === 'admin') {
                                const cloudUsers = await cloudSync.downloadData('users');
                                if (cloudUsers && cloudUsers.length > 0) {
                                    allUsers = cloudUsers;
                                    localStorage.setItem('allUsers', JSON.stringify(allUsers));
                                    console.log('âœ… ç”¨æˆ·æ•°æ®å·²ä»äº‘ç«¯åŠ è½½:', allUsers.length, 'ä¸ªç”¨æˆ·');
                                }
                            }

                            // åŒæ­¥å½“å‰ç”¨æˆ·ç›¸å…³æ•°æ®å¹¶å»ºç«‹ç›‘å¬
                            await cloudSync.handleUserSessionChange();
                            
                            // ç¡®ä¿ä»localStorageé‡æ–°åŠ è½½æœ€æ–°çš„è®¢å•å’Œåœ°å€æ•°æ®ï¼ˆhandleUserSessionChangeå·²æ›´æ–°ï¼‰
                            const userOrdersKey = `userOrders_${authResult.account}`;
                            const userAddressesKey = `userAddresses_${authResult.account}`;
                            userOrders = JSON.parse(localStorage.getItem(userOrdersKey)) || JSON.parse(localStorage.getItem('userOrders')) || [];
                            userAddresses = JSON.parse(localStorage.getItem(userAddressesKey)) || JSON.parse(localStorage.getItem('userAddresses')) || [];
                            
                            console.log('âœ… ç™»å½•åæ•°æ®å·²åŒæ­¥ - è®¢å•æ•°:', userOrders.length, 'åœ°å€æ•°:', userAddresses.length);

                            // ç«‹å³æ›´æ–°ç•Œé¢æ˜¾ç¤ºï¼ˆåœ¨æ˜¾ç¤ºé€šçŸ¥ä¹‹å‰ï¼‰
                            updateUserInterface();
                            renderProducts(products);
                            renderUserOrders();
                            renderAddressList();

                            showNotification(`â˜ï¸ äº‘ç«¯æ•°æ®åŠ è½½å®Œæˆï¼æ¬¢è¿ ${authResult.username}`, 'success');
                        } else {
                            // äº‘ç«¯åŒæ­¥æœªå¯ç”¨,å›é€€åˆ°æœ¬åœ°ç¼“å­˜
                            console.log('âš ï¸ äº‘ç«¯åŒæ­¥æœªå¯ç”¨,ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®');
                            products = JSON.parse(localStorage.getItem('products')) || [];
                            // ä»ç”¨æˆ·ç‰¹å®šçš„localStorageåŠ è½½è®¢å•å’Œåœ°å€
                            const userOrdersKey = `userOrders_${authResult.account}`;
                            const userAddressesKey = `userAddresses_${authResult.account}`;
                            userOrders = JSON.parse(localStorage.getItem(userOrdersKey)) || [];
                            userAddresses = JSON.parse(localStorage.getItem(userAddressesKey)) || [];
                            allUsers = JSON.parse(localStorage.getItem('allUsers')) || [];
                            
                            // ç«‹å³æ›´æ–°ç•Œé¢æ˜¾ç¤º
                            updateUserInterface();
                            renderProducts(products);
                            renderUserOrders();
                            renderAddressList();
                            
                            showNotification(`ğŸ’¾ äº‘ç«¯æœªè¿æ¥ï¼Œå·²åŠ è½½æœ¬åœ°æ•°æ®ï¼æ¬¢è¿ ${authResult.username}`, 'warning');
                        }
                    } catch (error) {
                        console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', error);
                        showNotification('æ•°æ®åŠ è½½å¤±è´¥,ä½¿ç”¨æœ¬åœ°ç¼“å­˜', 'warning');
                        // å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°ç¼“å­˜
                        products = JSON.parse(localStorage.getItem('products')) || [];
                        const userOrdersKey = `userOrders_${authResult.account}`;
                        const userAddressesKey = `userAddresses_${authResult.account}`;
                        userOrders = JSON.parse(localStorage.getItem(userOrdersKey)) || [];
                        userAddresses = JSON.parse(localStorage.getItem(userAddressesKey)) || [];
                        allUsers = JSON.parse(localStorage.getItem('allUsers')) || [];
                        
                        // ç«‹å³æ›´æ–°ç•Œé¢æ˜¾ç¤º
                        updateUserInterface();
                        renderProducts(products);
                        renderUserOrders();
                        renderAddressList();
                    }

                    // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºæ§åˆ¶é¢æ¿
                    if (authResult.role === 'admin') {
                        const controlPanel = document.getElementById('admin-control-panel');
                        if (controlPanel) {
                            controlPanel.style.display = 'block';
                        }
                    }

                    // å¦‚æœä¹‹å‰ç‚¹å‡»äº†é¢†å–äº§å“ï¼Œç™»å½•æˆåŠŸåè‡ªåŠ¨æ‰“å¼€æŠ¥åæ¨¡æ€æ¡†
                    if (pendingSignupProduct) {
                        setTimeout(() => {
                            openSignupModal(pendingSignupProduct);
                            pendingSignupProduct = null; // æ¸…é™¤å¾…é¢†å–äº§å“
                        }, 500);
                    }

                } else if (authResult && authResult.banned) {
                    // è´¦å·è¢«ç¦ç”¨
                    customAlert(authResult.message, t('accountDisabled'));
                } else if (authResult && authResult.success === false) {
                    // ç™»å½•å¤±è´¥ï¼Œæ˜¾ç¤ºå…·ä½“é”™è¯¯åŸå› 
                    customAlert(authResult.message, t('loginFailed'));
                } else {
                    // æœªçŸ¥é”™è¯¯
                    customAlert(t('loginFailedRetry'), t('errorTitle'));
                }
            });

            // æ³¨å†Œè¡¨å•
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const account = document.getElementById('register-account').value.trim();
                const password = document.getElementById('register-password').value;
                const confirm = document.getElementById('register-confirm').value;

                // éªŒè¯è´¦å·æ˜¯å¦ä¸ºç©º
                if (!account) {
                    customAlert(t('pleaseEnterAccount'), t('registerFailed'));
                    return;
                }

                // éªŒè¯è´¦å·æ ¼å¼ï¼ˆå»ºè®®ä½¿ç”¨é‚®ç®±æ ¼å¼ï¼‰
                if (account.length < 3) {
                    customAlert(t('accountMinLength'), t('registerFailed'));
                    return;
                }

                // éªŒè¯å¯†ç æ˜¯å¦ä¸ºç©º
                if (!password) {
                    customAlert(t('enterPassword'), t('registerFailed'));
                    return;
                }

                // éªŒè¯ç¡®è®¤å¯†ç æ˜¯å¦ä¸ºç©º
                if (!confirm) {
                    customAlert(t('pleaseConfirmPassword'), t('registerFailed'));
                    return;
                }

                // éªŒè¯å¯†ç é•¿åº¦
                if (password.length < 6) {
                    customAlert(t('passwordMinLength'), t('registerFailed'));
                    return;
                }

                // éªŒè¯å¯†ç æ˜¯å¦åŒ¹é…
                if (password !== confirm) {
                    customAlert(t('passwordMismatchRetry'), t('registerFailed'));
                    return;
                }

                // éªŒè¯å¯†ç å¼ºåº¦ï¼ˆå»ºè®®ï¼šè‡³å°‘åŒ…å«å­—æ¯æˆ–æ•°å­—ï¼Œä½†å…è®¸çº¯å­—æ¯æˆ–çº¯æ•°å­—ï¼‰
                // åªæ£€æŸ¥æ˜¯å¦åŒ…å«æœ‰æ•ˆå­—ç¬¦ï¼Œä¸å¼ºåˆ¶è¦æ±‚åŒæ—¶åŒ…å«å­—æ¯å’Œæ•°å­—
                const passwordRegex = /^[A-Za-z\d@$!%*#?&]{6,}$/;
                if (!passwordRegex.test(password)) {
                    customAlert(t('passwordFormatError'), t('registerFailed'));
                    return;
                }

                const username = account.split('@')[0];
                const result = registerUser(account, password, username);

                if (result.success) {
                    // ========== æ¸…ç©ºæ—§ç”¨æˆ·æ•°æ®ï¼Œå‡†å¤‡æ–°ç”¨æˆ·æ•°æ® ==========
                    console.log('ğŸ”„ æ³¨å†ŒæˆåŠŸï¼Œæ¸…ç©ºæ—§ç”¨æˆ·æ•°æ®...');
                    userOrders = [];
                    userAddresses = [];
                    userProfile = {};
                    
                    // ä» allUsers ä¸­è·å–åˆšæ³¨å†Œçš„å®Œæ•´ç”¨æˆ·æ•°æ®
                    const newUserData = allUsers.find(u => u.account === account);
                    if (newUserData) {
                        currentUser = {
                            account: newUserData.account,
                            username: newUserData.username,
                            role: newUserData.role,
                            status: newUserData.status,
                            points: newUserData.points
                        };
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œä½¿ç”¨åŸºæœ¬ä¿¡æ¯
                        currentUser = { account, username, role: 'user' };
                    }
                    saveCurrentUser();

                    // åŒæ­¥åˆ°äº‘ç«¯ï¼ˆç¡®ä¿æ–°ç”¨æˆ·è¢«æ·»åŠ åˆ°äº‘ç«¯çš„ allUsersï¼‰
                    if (cloudSync && cloudSync.isInitialized) {
                        try {
                            console.log('ğŸ”„ å¼€å§‹åŒæ­¥æ–°æ³¨å†Œç”¨æˆ·åˆ°äº‘ç«¯ allUsers...');
                            await cloudSync.syncAllUsers();
                            await cloudSync.handleUserSessionChange();
                            console.log('âœ… æ–°ç”¨æˆ·å·²åŒæ­¥åˆ°äº‘ç«¯ allUsers');
                        } catch (syncError) {
                            console.error('åŒæ­¥åˆ°äº‘ç«¯å¤±è´¥:', syncError);
                            // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œæœ¬åœ°æ³¨å†Œå·²æˆåŠŸï¼Œç»§ç»­æ‰§è¡Œ
                        }
                    } else {
                        console.warn('âš ï¸ äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–ï¼Œæ–°ç”¨æˆ·ä»…ä¿å­˜åœ¨æœ¬åœ°');
                    }

                    // æ³¨å†ŒæˆåŠŸåï¼šç›´æ¥æç¤º + è‡ªåŠ¨ç™»å½•å¹¶å…³é—­æ³¨å†Œçª—å£
                    showNotification(t('registrationSuccess') || 'æ³¨å†ŒæˆåŠŸï¼', 'success');
                    registerModal.style.display = 'none';
                    updateUserInterface();
                    renderUserOrders();
                    renderAddressList();

                    // å¦‚æœä¹‹å‰ç‚¹å‡»äº†é¢†å–äº§å“ï¼Œæ³¨å†ŒæˆåŠŸåè‡ªåŠ¨æ‰“å¼€æŠ¥åæ¨¡æ€æ¡†
                    if (pendingSignupProduct) {
                        setTimeout(() => {
                            openSignupModal(pendingSignupProduct);
                            pendingSignupProduct = null; // æ¸…é™¤å¾…é¢†å–äº§å“
                        }, 500);
                    }
                } else {
                    // æ³¨å†Œå¤±è´¥ï¼Œæ˜¾ç¤ºå…·ä½“é”™è¯¯åŸå› 
                    customAlert(result.message || t('registerFailedRetry'), t('registerFailed'));
                }
            });

            // ç”¨æˆ·ä¸»åŠ¨é€€å‡ºæ—¶ï¼Œæ¸…é™¤æœ¬åœ°æ‰€æœ‰æ•°æ®
            function clearAllLocalDataOnLogout() {
                try {
                    console.log('ğŸ§¹ ç”¨æˆ·ä¸»åŠ¨é€€å‡ºï¼Œå¼€å§‹æ¸…é™¤æœ¬åœ°æ‰€æœ‰æ•°æ®...');

                    // æ¸…é™¤ localStorage å…¨éƒ¨æ•°æ®
                    localStorage.clear();

                    // æ¸…é™¤ sessionStorage å…¨éƒ¨æ•°æ®
                    try {
                        sessionStorage.clear();
                    } catch (e) {
                        console.warn('æ¸…é™¤ sessionStorage æ—¶å‡ºé”™:', e);
                    }

                    // å¯é€‰ï¼šæ¸…é™¤ IndexedDBï¼ˆå¦‚æœæœ‰ä½¿ç”¨ï¼‰
                    try {
                        if ('indexedDB' in window && indexedDB.databases) {
                            indexedDB.databases().then(databases => {
                                databases.forEach(db => {
                                    if (db.name) {
                                        indexedDB.deleteDatabase(db.name);
                                        console.log(`âœ… å·²æ¸…é™¤ IndexedDB: ${db.name}`);
                                    }
                                });
                            }).catch(e => {
                                console.warn('æ¸…é™¤ IndexedDB æ—¶å‡ºé”™:', e);
                            });
                        }
                    } catch (e) {
                        console.warn('è®¿é—® IndexedDB æ—¶å‡ºé”™:', e);
                    }

                    // å¯é€‰ï¼šæ¸…é™¤ Service Worker ç¼“å­˜
                    try {
                        if ('caches' in window) {
                            caches.keys().then(names => {
                                names.forEach(name => {
                                    caches.delete(name);
                                    console.log(`âœ… å·²æ¸…é™¤ Service Worker ç¼“å­˜: ${name}`);
                                });
                            }).catch(e => {
                                console.warn('æ¸…é™¤ Service Worker ç¼“å­˜æ—¶å‡ºé”™:', e);
                            });
                        }
                    } catch (e) {
                        console.warn('è®¿é—® Service Worker ç¼“å­˜æ—¶å‡ºé”™:', e);
                    }

                    console.log('âœ… ç”¨æˆ·é€€å‡ºåï¼Œæœ¬åœ°æ•°æ®å·²å…¨éƒ¨æ¸…é™¤');
                } catch (error) {
                    console.error('âŒ é€€å‡ºæ—¶æ¸…é™¤æœ¬åœ°æ•°æ®å‡ºé”™:', error);
                }
            }

            // é€€å‡ºç™»å½•
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();

                // å…ˆå¤„ç†å½“å‰ä¼šè¯å’Œäº‘ç«¯çŠ¶æ€
                currentUser = null;
                localStorage.removeItem('currentUser');
                if (cloudSync && cloudSync.isInitialized) {
                    await cloudSync.handleUserSessionChange();
                } else {
                    userOrders = [];
                    userAddresses = [];
                }

                // æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ˆåªåœ¨ç”¨æˆ·ä¸»åŠ¨é€€å‡ºæ—¶æ‰§è¡Œï¼‰
                clearAllLocalDataOnLogout();

                // æ›´æ–°ç•Œé¢å¹¶è¿”å›ä¸»é¡µ
                updateUserInterface();
                showHomePage();
            });

            // è¿œç¨‹ç™»å½•å¼ºåˆ¶å½“å‰è®¾å¤‡é€€å‡ºï¼ˆå¤šè®¾å¤‡ç™»å½•æ§åˆ¶ç”¨ï¼‰
            window.handleRemoteLogout = async function () {
                try {
                    currentUser = null;
                    localStorage.removeItem('currentUser');

                    if (cloudSync && cloudSync.isInitialized) {
                        await cloudSync.handleUserSessionChange();
                    } else {
                        userOrders = [];
                        userAddresses = [];
                    }

                    if (typeof clearAllLocalDataOnLogout === 'function') {
                        clearAllLocalDataOnLogout();
                    }

                    if (typeof updateUserInterface === 'function') {
                        updateUserInterface();
                    }
                    if (typeof showHomePage === 'function') {
                        showHomePage();
                    }
                    if (typeof showNotification === 'function') {
                        showNotification(t('loggedOutByOtherDevice'), 'warning');
                    }
                } catch (e) {
                    console.error('handleRemoteLogout æ‰§è¡Œå¤±è´¥:', e);
                }
            };

            const deleteAccountBtn = document.getElementById('delete-account-btn');
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', handleSelfAccountDeletion);
            }

            // åŒæ­¥çŠ¶æ€ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºåŒæ­¥è¯¦æƒ…å¯¹è¯æ¡†
            const syncStatus = document.getElementById('sync-status');
            if (syncStatus) {
                syncStatus.addEventListener('click', () => {
                    showSyncStatusDialog();
                });
            }

            // ========== ç®¡ç†å‘˜æ§åˆ¶é¢æ¿äº‹ä»¶ ==========
            const controlPanelBtn = document.getElementById('control-panel-btn');
            const controlPanelDropdown = document.getElementById('control-panel-dropdown');

            // ç‚¹å‡»æŒ‰é’®åˆ‡æ¢ä¸‹æ‹‰èœå•
            if (controlPanelBtn) {
                controlPanelBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isVisible = controlPanelDropdown.style.display === 'block';
                    controlPanelDropdown.style.display = isVisible ? 'none' : 'block';
                });
            }

            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', (e) => {
                if (controlPanelDropdown && !controlPanelDropdown.contains(e.target) && e.target !== controlPanelBtn) {
                    controlPanelDropdown.style.display = 'none';
                }
            });

            // å¼ºåˆ¶ä½¿ç”¨äº‘ç«¯æ¨¡å¼ - æ‰€æœ‰æ•°æ®ä»äº‘ç«¯è·å–
            window.currentDataSourceMode = 'cloud';
            localStorage.setItem('dataSourceMode', 'cloud');
            console.log('ğŸ”’ å·²å¯ç”¨äº‘ç«¯æ¨¡å¼ï¼Œæ‰€æœ‰æ•°æ®å®æ—¶åŒæ­¥');

            // åˆå§‹åŒ–æ—¶ä»äº‘ç«¯åŠ è½½æ•°æ®
            if (cloudSync && cloudSync.isInitialized) {
                console.log('ğŸ“¥ ä»äº‘ç«¯åŠ è½½æœ€æ–°æ•°æ®...');
            }

            // æµ‹è¯•äº‘ç«¯è¿æ¥
            const testCloudBtn = document.getElementById('test-cloud-connection');
            if (testCloudBtn) {
                testCloudBtn.addEventListener('click', async function () {
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';

                    try {
                        if (cloudSync && cloudSync.isInitialized) {
                            await cloudSync.testConnection();
                            showNotification('âœ… äº‘ç«¯è¿æ¥æ­£å¸¸ï¼', 'success');
                            document.getElementById('sync-status-text').textContent = 'çŠ¶æ€ï¼šè¿æ¥æ­£å¸¸';
                        } else {
                            showNotification('äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–', 'warning');
                            document.getElementById('sync-status-text').textContent = 'çŠ¶æ€ï¼šæœªè¿æ¥';
                        }
                    } catch (error) {
                        console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                        showNotification('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
                        document.getElementById('sync-status-text').textContent = 'çŠ¶æ€ï¼šè¿æ¥å¤±è´¥';
                    }

                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-cloud"></i> æµ‹è¯•äº‘ç«¯è¿æ¥';
                });
            }

            // å¼ºåˆ¶åŒæ­¥æ•°æ®
            const forceSyncBtn = document.getElementById('force-sync');
            if (forceSyncBtn) {
                forceSyncBtn.addEventListener('click', async function () {
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŒæ­¥ä¸­...';

                    try {
                        if (cloudSync && cloudSync.isInitialized) {
                            await cloudSync.syncAllData();
                            showNotification('âœ… æ•°æ®åŒæ­¥å®Œæˆï¼', 'success');

                            // é‡æ–°åŠ è½½æ•°æ®
                            products = JSON.parse(localStorage.getItem('products')) || [];
                            renderProducts(products);
                            if (document.getElementById('admin-panel').style.display !== 'none') {
                                renderAdminProducts();
                            }
                        } else {
                            showNotification('äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–', 'warning');
                        }
                    } catch (error) {
                        console.error('åŒæ­¥å¤±è´¥:', error);
                        showNotification('âŒ åŒæ­¥å¤±è´¥: ' + error.message, 'error');
                    }

                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-sync-alt"></i> å¼ºåˆ¶åŒæ­¥æ•°æ®';
                });
            }

            // æ¸…é™¤æœ¬åœ°ç¼“å­˜
            const clearCacheBtn = document.getElementById('clear-cache');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', function () {
                    customConfirm(t('confirmClearCache'), t('confirmClearCache')).then(confirmed => {
                        if (!confirmed) return;
                        localStorage.removeItem('products');
                        localStorage.removeItem('userOrders');
                        localStorage.removeItem('allUsers');
                        products = [];
                        userOrders = [];
                        allUsers = [];
                        renderProducts(products);
                        if (document.getElementById('admin-panel').style.display !== 'none') {
                            renderAdminProducts();
                        }
                        showNotification('âœ… æœ¬åœ°ç¼“å­˜å·²æ¸…é™¤ï¼', 'success');
                    });
                });
            }

            // WhatsAppæŒ‰é’®å·²é€šè¿‡HTMLç›´æ¥é“¾æ¥ï¼Œæ— éœ€JavaScriptå¤„ç†

            // ========== æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤åŠŸèƒ½ ==========
            // ä¸‹è½½æ•°æ®åº“å¤‡ä»½
            const downloadDatabaseBtn = document.getElementById('download-database-btn');
            if (downloadDatabaseBtn) {
                downloadDatabaseBtn.addEventListener('click', function() {
                    try {
                        // æ”¶é›†æ‰€æœ‰éœ€è¦å¤‡ä»½çš„æ•°æ®
                        const backupData = {
                            version: '1.0',
                            timestamp: new Date().toISOString(),
                            data: {
                                products: JSON.parse(localStorage.getItem('products') || '[]'),
                                userOrders: JSON.parse(localStorage.getItem('userOrders') || '[]'),
                                allOrders: JSON.parse(localStorage.getItem('allOrders') || '[]'),
                                allUsers: JSON.parse(localStorage.getItem('allUsers') || '[]'),
                                homepageSettings: JSON.parse(localStorage.getItem('homepageSettings') || '{}'),
                                currentUser: JSON.parse(localStorage.getItem('currentUser') || 'null'),
                                language: localStorage.getItem('language') || 'en'
                            }
                        };

                        // ç»Ÿè®¡ä¿¡æ¯
                        const stats = {
                            productsCount: backupData.data.products.length,
                            ordersCount: backupData.data.userOrders.length,
                            allOrdersCount: backupData.data.allOrders.length,
                            usersCount: backupData.data.allUsers.length
                        };

                        // åˆ›å»ºJSONå­—ç¬¦ä¸²
                        const jsonString = JSON.stringify(backupData, null, 2);
                        
                        // åˆ›å»ºBlobå¯¹è±¡
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        
                        // åˆ›å»ºä¸‹è½½é“¾æ¥
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `database-backup-${new Date().toISOString().split('T')[0]}-${Date.now()}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        // æ˜¾ç¤ºå¤‡ä»½ä¿¡æ¯
                        const infoDiv = document.getElementById('database-backup-info');
                        const detailsDiv = document.getElementById('database-backup-details');
                        if (infoDiv && detailsDiv) {
                            detailsDiv.innerHTML = `
                                <div><strong>å¤‡ä»½æ—¶é—´ï¼š</strong>${new Date(backupData.timestamp).toLocaleString()}</div>
                                <div><strong>äº§å“æ•°é‡ï¼š</strong>${stats.productsCount}</div>
                                <div><strong>ç”¨æˆ·è®¢å•æ•°é‡ï¼š</strong>${stats.ordersCount}</div>
                                <div><strong>å…¨éƒ¨è®¢å•æ•°é‡ï¼š</strong>${stats.allOrdersCount}</div>
                                <div><strong>ç”¨æˆ·æ•°é‡ï¼š</strong>${stats.usersCount}</div>
                            `;
                            infoDiv.style.display = 'block';
                        }

                        showNotification('âœ… æ•°æ®åº“å¤‡ä»½å·²ä¸‹è½½', 'success');
                    } catch (error) {
                        console.error('å¤‡ä»½å¤±è´¥:', error);
                        showMessageModal(t('errorTitle'), t('databaseBackupFailed').replace('{error}', error.message), 'alert');
                    }
                });
            }

            // ä¸Šä¼ æ•°æ®åº“å¤‡ä»½å¹¶æ¢å¤
            window.handleDatabaseUpload = function(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                // éªŒè¯æ–‡ä»¶ç±»å‹
                if (!file.name.endsWith('.json')) {
                    showMessageModal(t('errorTitle'), t('pleaseUploadJSONFile'), 'alert');
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);

                        // éªŒè¯å¤‡ä»½æ–‡ä»¶æ ¼å¼
                        if (!backupData || !backupData.data) {
                            throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
                        }

                        // éªŒè¯æ•°æ®ç»“æ„ï¼ˆallOrdersæ˜¯å¯é€‰çš„ï¼Œå…¼å®¹æ—§ç‰ˆæœ¬å¤‡ä»½ï¼‰
                        const requiredKeys = ['products', 'userOrders', 'allUsers', 'homepageSettings'];
                        const missingKeys = requiredKeys.filter(key => !(key in backupData.data));
                        if (missingKeys.length > 0) {
                            throw new Error('å¤‡ä»½æ–‡ä»¶ç¼ºå°‘å¿…è¦çš„æ•°æ®ï¼š' + missingKeys.join(', '));
                        }

                        // éªŒè¯æ•°æ®ç±»å‹
                        if (!Array.isArray(backupData.data.products)) {
                            throw new Error('äº§å“æ•°æ®æ ¼å¼é”™è¯¯');
                        }
                        if (!Array.isArray(backupData.data.userOrders)) {
                            throw new Error('ç”¨æˆ·è®¢å•æ•°æ®æ ¼å¼é”™è¯¯');
                        }
                        if (!Array.isArray(backupData.data.allUsers)) {
                            throw new Error('ç”¨æˆ·æ•°æ®æ ¼å¼é”™è¯¯');
                        }
                        if (typeof backupData.data.homepageSettings !== 'object') {
                            throw new Error('è®¾ç½®æ•°æ®æ ¼å¼é”™è¯¯');
                        }
                        // allOrdersæ˜¯å¯é€‰çš„ï¼Œå¦‚æœæ²¡æœ‰åˆ™è®¾ä¸ºç©ºæ•°ç»„
                        if (backupData.data.allOrders && !Array.isArray(backupData.data.allOrders)) {
                            throw new Error('å…¨éƒ¨è®¢å•æ•°æ®æ ¼å¼é”™è¯¯');
                        }

                        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                        const stats = {
                            productsCount: backupData.data.products.length,
                            ordersCount: backupData.data.userOrders.length,
                            allOrdersCount: (backupData.data.allOrders || []).length,
                            usersCount: backupData.data.allUsers.length,
                            backupTime: backupData.timestamp ? new Date(backupData.timestamp).toLocaleString() : 'æœªçŸ¥'
                        };

                        customConfirm(
                            `ç¡®å®šè¦æ¢å¤æ•°æ®åº“å—ï¼Ÿ\n\n` +
                            `å¤‡ä»½ä¿¡æ¯ï¼š\n` +
                            `- å¤‡ä»½æ—¶é—´ï¼š${stats.backupTime}\n` +
                            `- äº§å“æ•°é‡ï¼š${stats.productsCount}\n` +
                            `- ç”¨æˆ·è®¢å•æ•°é‡ï¼š${stats.ordersCount}\n` +
                            `- å…¨éƒ¨è®¢å•æ•°é‡ï¼š${stats.allOrdersCount}\n` +
                            `- ç”¨æˆ·æ•°é‡ï¼š${stats.usersCount}\n\n` +
                            `è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºå½“å‰æ‰€æœ‰æ•°æ®å¹¶æ›¿æ¢ä¸ºå¤‡ä»½æ•°æ®ï¼`,
                            'ç¡®è®¤æ¢å¤æ•°æ®åº“'
                        ).then(confirmed => {
                            if (!confirmed) {
                                event.target.value = '';
                                return;
                            }

                            try {
                                // æ¸…ç©ºå½“å‰æ•°æ®
                                localStorage.removeItem('products');
                                localStorage.removeItem('userOrders');
                                localStorage.removeItem('allOrders');
                                localStorage.removeItem('allUsers');
                                localStorage.removeItem('userAddresses');
                                
                                // æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç›¸å…³çš„ç¼“å­˜
                                const keysToRemove = [];
                                for (let i = 0; i < localStorage.length; i++) {
                                    const key = localStorage.key(i);
                                    if (key && (key.startsWith('userOrders_') || key.startsWith('userAddresses_'))) {
                                        keysToRemove.push(key);
                                    }
                                }
                                keysToRemove.forEach(key => localStorage.removeItem(key));
                                
                                // æ¢å¤æ•°æ®
                                localStorage.setItem('products', JSON.stringify(backupData.data.products));
                                localStorage.setItem('userOrders', JSON.stringify(backupData.data.userOrders));
                                if (backupData.data.allOrders && Array.isArray(backupData.data.allOrders)) {
                                    localStorage.setItem('allOrders', JSON.stringify(backupData.data.allOrders));
                                } else {
                                    localStorage.setItem('allOrders', JSON.stringify([]));
                                }
                                localStorage.setItem('allUsers', JSON.stringify(backupData.data.allUsers));
                                
                                if (backupData.data.currentUser && backupData.data.currentUser !== 'null') {
                                    localStorage.setItem('currentUser', JSON.stringify(backupData.data.currentUser));
                                } else {
                                    localStorage.removeItem('currentUser');
                                }
                                
                                if (backupData.data.language) {
                                    localStorage.setItem('language', backupData.data.language);
                                }

                                // é‡æ–°åŠ è½½å…¨å±€å˜é‡
                                products = backupData.data.products || [];
                                userOrders = backupData.data.userOrders || [];
                                allOrders = backupData.data.allOrders || [];
                                allUsers = backupData.data.allUsers || [];
                                currentUser = backupData.data.currentUser || null;

                                // é‡æ–°æ¸²æŸ“é¡µé¢
                                if (typeof renderProducts === 'function') {
                                    renderProducts(products);
                                }
                                
                                // å¦‚æœç®¡ç†å‘˜é¢æ¿æ‰“å¼€ï¼Œåˆ·æ–°æ‰€æœ‰ç›¸å…³é¡µé¢
                                const adminPanel = document.getElementById('admin-panel');
                                if (adminPanel && adminPanel.style.display !== 'none') {
                                    if (typeof renderAdminProducts === 'function') {
                                        renderAdminProducts();
                                    }
                                    if (typeof updateStatistics === 'function') {
                                        updateStatistics();
                                    }
                                    if (typeof renderOrdersTable === 'function') {
                                        renderOrdersTable();
                                    }
                                    if (typeof renderUsersTable === 'function') {
                                        renderUsersTable();
                                    }
                                }

                                // æ›´æ–°ç”¨æˆ·ç•Œé¢
                                if (typeof updateUserInterface === 'function') {
                                    updateUserInterface();
                                }
                                
                                // å¦‚æœç”¨æˆ·ä¸­å¿ƒæ‰“å¼€ï¼Œåˆ·æ–°è®¢å•åˆ—è¡¨
                                const userCenter = document.getElementById('user-center');
                                if (userCenter && userCenter.style.display !== 'none') {
                                    if (typeof renderUserOrders === 'function') {
                                        renderUserOrders();
                                    }
                                }
                                
                                // åº”ç”¨ä¸»é¡µè®¾ç½®
                                if (typeof applyHomepageSettings === 'function') {
                                    applyHomepageSettings();
                                }

                                // æ˜¾ç¤ºå¤‡ä»½ä¿¡æ¯
                                const infoDiv = document.getElementById('database-backup-info');
                                const detailsDiv = document.getElementById('database-backup-details');
                                if (infoDiv && detailsDiv) {
                                    detailsDiv.innerHTML = `
                                        <div><strong>æ¢å¤æ—¶é—´ï¼š</strong>${new Date().toLocaleString()}</div>
                                        <div><strong>å¤‡ä»½æ—¶é—´ï¼š</strong>${stats.backupTime}</div>
                                        <div><strong>äº§å“æ•°é‡ï¼š</strong>${stats.productsCount}</div>
                                        <div><strong>ç”¨æˆ·è®¢å•æ•°é‡ï¼š</strong>${stats.ordersCount}</div>
                                        <div><strong>å…¨éƒ¨è®¢å•æ•°é‡ï¼š</strong>${stats.allOrdersCount}</div>
                                        <div><strong>ç”¨æˆ·æ•°é‡ï¼š</strong>${stats.usersCount}</div>
                                    `;
                                    infoDiv.style.display = 'block';
                                }

                                showMessageModal(t('successTitle'), t('databaseRestoredSuccess'), 'alert');
                                showNotification('âœ… æ•°æ®åº“æ¢å¤æˆåŠŸ', 'success');

                                // åŒæ­¥åˆ°äº‘ç«¯ï¼ˆå¦‚æœå·²åˆå§‹åŒ–ï¼‰
                                if (cloudSync && cloudSync.isInitialized) {
                                    cloudSync.syncAllData().catch(err => {
                                        console.warn('äº‘ç«¯åŒæ­¥å¤±è´¥:', err);
                                        showNotification('âš ï¸ æ•°æ®å·²æ¢å¤ï¼Œä½†äº‘ç«¯åŒæ­¥å¤±è´¥', 'warning');
                                    });
                                }

                            } catch (error) {
                                console.error('æ¢å¤å¤±è´¥:', error);
                                showMessageModal(t('errorTitle'), t('databaseRestoreFailed').replace('{error}', error.message), 'alert');
                                
                                // å¦‚æœæ¢å¤å¤±è´¥ï¼Œå°è¯•é‡æ–°åŠ è½½é¡µé¢æ•°æ®
                                try {
                                    products = JSON.parse(localStorage.getItem('products') || '[]');
                                    userOrders = JSON.parse(localStorage.getItem('userOrders') || '[]');
                                    allOrders = JSON.parse(localStorage.getItem('allOrders') || '[]');
                                    allUsers = JSON.parse(localStorage.getItem('allUsers') || '[]');
                                    homepageSettings = JSON.parse(localStorage.getItem('homepageSettings') || '{}');
                                    if (typeof renderProducts === 'function') {
                                        renderProducts(products);
                                    }
                                } catch (reloadError) {
                                    console.error('é‡æ–°åŠ è½½æ•°æ®å¤±è´¥:', reloadError);
                                    showMessageModal(t('errorTitle'), t('dataRestoreFailed'), 'alert');
                                }
                            }

                            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                            event.target.value = '';
                        });

                    } catch (error) {
                        console.error('è¯»å–å¤‡ä»½æ–‡ä»¶å¤±è´¥:', error);
                        showMessageModal(t('errorTitle'), t('readBackupFileFailed').replace('{error}', error.message), 'alert');
                        event.target.value = '';
                    }
                };

                reader.onerror = function() {
                    showMessageModal(t('errorTitle'), t('readFileFailed'), 'alert');
                    event.target.value = '';
                };

                reader.readAsText(file);
            };

            // æŠ¥åè¡¨å• - ä¿®æ”¹è¿™éƒ¨åˆ†ä»£ç 
            const signupForm = document.getElementById('signup-form');
            if (!signupForm) {
                console.error('âŒ æ‰¾ä¸åˆ°signup-formå…ƒç´ ');
            } else {
                signupForm.addEventListener('submit', function (e) {
                    e.preventDefault(); // å…ˆé˜»æ­¢é»˜è®¤æäº¤ï¼Œæ£€æŸ¥åœ°å€åå†å†³å®šæ˜¯å¦æäº¤
                    console.log('ğŸ“ æŠ¥åè¡¨å•æäº¤äº‹ä»¶è§¦å‘');
                    
                    if (!currentUser) {
                        console.warn('âš ï¸ ç”¨æˆ·æœªç™»å½•');
                        customAlert(t('pleaseLogin'), t('infoTitle')).then(() => {
                            document.getElementById('login-modal').style.display = 'flex';
                        });
                        return;
                    }
                    
                    console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', currentUser.account);

                // è·å–è¡¨å•æ•°æ®
                const productName = document.getElementById('signup-product-name').value;
                const email = document.getElementById('signup-email').value;
                // ä»éšè—å­—æ®µè·å–åœ°å€ï¼ˆç”±åœ°å€é€‰æ‹©å™¨å¡«å……ï¼‰
                const addressInput = document.getElementById('signup-address-hidden');
                const address = addressInput ? addressInput.value.trim() : '';
                const notes = document.getElementById('signup-notes').value;

                // æ£€æŸ¥åœ°å€ï¼šå…ˆæ£€æŸ¥è¡¨å•ä¸­çš„åœ°å€å­—æ®µï¼Œå†æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰ä¿å­˜çš„åœ°å€
                const hasFormAddress = address && address.length > 0;
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰ä¿å­˜çš„åœ°å€ï¼ˆè¿‡æ»¤å½“å‰ç”¨æˆ·çš„åœ°å€ï¼‰
                const userSavedAddresses = userAddresses.filter(addr => {
                    // å¦‚æœåœ°å€æœ‰accountå­—æ®µï¼ŒåªåŒ¹é…å½“å‰ç”¨æˆ·çš„åœ°å€
                    if (addr.account !== undefined) {
                        return addr.account === currentUser.account;
                    }
                    // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰accountå­—æ®µï¼Œè®¤ä¸ºæ˜¯å½“å‰ç”¨æˆ·çš„åœ°å€
                    return true;
                });
                const hasSavedAddress = userSavedAddresses && userSavedAddresses.length > 0;

                // å¦‚æœè¡¨å•ä¸­æ²¡æœ‰å¡«å†™åœ°å€ï¼Œä¸”ç”¨æˆ·ä¹Ÿæ²¡æœ‰ä¿å­˜çš„åœ°å€ï¼Œè·³è½¬åˆ°åœ°å€é¡µé¢
                if (!hasFormAddress && !hasSavedAddress) {
                    prepareReturnToSignup();
                    // å…³é—­æŠ¥åæ¨¡æ€æ¡†
                    closeModal('signup-modal');
                    
                    // æ˜¾ç¤ºç”¨æˆ·ä¸­å¿ƒå¹¶åˆ‡æ¢åˆ°åœ°å€é¡µé¢
                    showUserCenter();
                    showUserPage('address');
                    
                    // æ‰“å¼€åœ°å€æ·»åŠ æ¨¡æ€æ¡†
                    setTimeout(() => {
                        const addressModal = document.getElementById('address-modal');
                        if (addressModal) {
                            addressModal.style.display = 'flex';
                        }
                    }, 300);
                    
                    // æç¤ºç”¨æˆ·éœ€è¦å¡«å†™åœ°å€
                    showNotification(currentLanguage === 'zh' ? 'è¯·å…ˆå¡«å†™æ”¶è´§åœ°å€' : 'Please fill in your shipping address first', 'info');
                    return;
                }

                // å¦‚æœæœ‰åœ°å€ï¼ˆè¡¨å•ä¸­æœ‰æˆ–å·²ä¿å­˜ï¼‰ï¼Œç»§ç»­æäº¤æµç¨‹
                // æ£€æŸ¥currentProductæ˜¯å¦å­˜åœ¨
                if (!currentProduct) {
                    console.error('âŒ æäº¤å¤±è´¥ï¼šcurrentProductä¸ºç©º');
                    customAlert(t('systemError'), t('errorTitle'));
                    return;
                }

                // è®¾ç½®å›å¤é‚®ç®±
                document.getElementById('signup-email-input').value = email;

                // ç¡®å®šä½¿ç”¨çš„åœ°å€ï¼šä¼˜å…ˆä½¿ç”¨è¡¨å•ä¸­çš„åœ°å€ï¼Œå¦åˆ™ä½¿ç”¨ä¿å­˜çš„é»˜è®¤åœ°å€ï¼Œå†å¦åˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªä¿å­˜çš„åœ°å€
                let finalAddress = '';
                let finalAddressDetail = null; // ä¿å­˜è¯¦ç»†åœ°å€ä¿¡æ¯ï¼ˆåŒ…å«è”ç³»äººï¼‰
                
                if (hasFormAddress) {
                    // å°è¯•è§£æåœ°å€JSONå¯¹è±¡
                    try {
                        const addressObj = JSON.parse(address);
                        if (addressObj && typeof addressObj === 'object' && addressObj.address) {
                            finalAddress = addressObj.address;
                            finalAddressDetail = addressObj; // ä¿å­˜è¯¦ç»†åœ°å€å¯¹è±¡ï¼ˆåŒ…å«å§“åã€ç”µè¯ï¼‰
                        } else {
                            finalAddress = address;
                        }
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯JSONï¼Œç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²
                        finalAddress = address;
                    }
                } else if (hasSavedAddress) {
                    // ä¼˜å…ˆä½¿ç”¨é»˜è®¤åœ°å€
                    const defaultAddress = userSavedAddresses.find(addr => addr.isDefault === true);
                    const selectedAddr = defaultAddress || userSavedAddresses[0];
                    
                    if (selectedAddr) {
                        // æ ¼å¼åŒ–åœ°å€å­—ç¬¦ä¸²
                        if (selectedAddr.state) {
                            finalAddress = [
                                selectedAddr.detail || selectedAddr.street,
                                selectedAddr.unit,
                                selectedAddr.city,
                                selectedAddr.state,
                                selectedAddr.postal || selectedAddr.zip
                            ].filter(Boolean).join(', ');
                        } else {
                            finalAddress = [
                                selectedAddr.province || '',
                                selectedAddr.city || '',
                                selectedAddr.district || '',
                                selectedAddr.detail || selectedAddr.street || ''
                            ].filter(Boolean).join(' ');
                        }
                        
                        // ä¿å­˜è¯¦ç»†åœ°å€ä¿¡æ¯
                        finalAddressDetail = {
                            name: selectedAddr.name || '',
                            phone: selectedAddr.phone || '',
                            detail: selectedAddr.detail || selectedAddr.street || '',
                            unit: selectedAddr.unit || '',
                            city: selectedAddr.city || '',
                            state: selectedAddr.state || '',
                            postal: selectedAddr.postal || selectedAddr.zip || '',
                            country: selectedAddr.country || 'US'
                        };
                    }
                }

                // âœ… æ™®é€šç”¨æˆ·é™åˆ¶ï¼šé˜²æ­¢åŒä¸€è´¦æˆ·é‡å¤é¢†å–åŒä¸€å•†å“ + èœœç½æ¶ˆè€—
                if (!isCurrentUserAdmin()) {
                    // é˜²æ­¢åŒä¸€è´¦æˆ·é‡å¤é¢†å–åŒä¸€å•†å“
                    if (currentUser && currentUser.account && Array.isArray(userOrders)) {
                        const hasExisting = userOrders.some(o =>
                            o &&
                            o.productId === currentProduct.id &&
                            o.account === currentUser.account &&
                            o.status !== 'cancelled'
                        );
                        if (hasExisting) {
                            showNotification(t('duplicateClaimNotAllowed') || 'æ‚¨å·²ç»é¢†å–è¿‡è¯¥å•†å“ï¼Œä¸èƒ½é‡å¤é¢†å–ã€‚', 'warning');
                            return;
                        }
                    }

                    // èœœç½æ¶ˆè€—ï¼šæ¯æ¬¡æˆåŠŸé¢†å–å‰å†æ¬¡ç¡®è®¤å¹¶æ‰£é™¤ 1 ä¸ªèœœç½
                    try {
                        const user = allUsers.find(u => u.account === currentUser.account);
                        const currentPoints = (user && user.points != null && !isNaN(user.points))
                            ? Number(user.points)
                            : 1;

                        if (currentPoints <= 0) {
                            showNotification(t('pointsNotEnoughForSubmit') || 'æ‚¨çš„èœœç½ä¸è¶³ï¼Œæ— æ³•å®Œæˆæœ¬æ¬¡é¢†å–ã€‚è¯·å®Œæˆè¯„ä»·ä»¥è·å–æ›´å¤šèœœç½ã€‚', 'warning');
                            return;
                        }

                        const newPoints = currentPoints - 1;
                        if (user) {
                            user.points = newPoints;
                        }
                        currentUser.points = newPoints;
                        saveAllUsers();
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));

                        const badge = document.getElementById('user-points-badge');
                        const valueEl = document.getElementById('user-points-value');
                        if (badge && valueEl) {
                            badge.style.display = 'inline-flex';
                            valueEl.textContent = newPoints;
                        }

                        showNotification(t('pointsClaimUsed') || 'âœ… æœ¬æ¬¡é¢†å–å·²æ¶ˆè€— 1 ä¸ªèœœç½', 'info');
                    } catch (err) {
                        console.warn('æ‰£å‡é¢†å–ç§¯åˆ†æ—¶å‡ºé”™:', err);
                    }
                }

                // è”ç³»äººä¿¡æ¯ä¼˜å…ˆæ¥è‡ªåœ°å€ï¼Œå…¶æ¬¡æ¥è‡ªç”¨æˆ·èµ„æ–™
                const latestUserData = allUsers.find(u => u.account === currentUser.account);
                let customerName = finalAddressDetail?.name || latestUserData?.username || currentUser.username || '';
                let customerPhone = finalAddressDetail?.phone || '';
                if (!customerPhone && currentUser.account && !currentUser.account.includes('@')) {
                    customerPhone = currentUser.account;
                }

                // åˆ›å»ºæ–°è®¢å•ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
                // ä½¿ç”¨çŸ­æ ¼å¼æ—¶é—´æˆ³+éšæœºæ•°å­—ç¡®ä¿è®¢å•å·å”¯ä¸€æ€§ï¼ˆçº¯æ•°å­—æ ¼å¼ï¼Œçº¦12-14ä½ï¼‰ï¼Œé¿å…å¹¶å‘ä¸‹å•æ—¶è®¢å•å·é‡å¤
                // æ ¼å¼ï¼šæ—¶é—´æˆ³å10ä½ + 4ä½éšæœºæ•° = 14ä½æ•°å­—
                const timestamp = Date.now().toString();
                const shortTimestamp = timestamp.slice(-10); // å–æ—¶é—´æˆ³å10ä½
                const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0'); // 4ä½éšæœºæ•°ï¼Œä¸è¶³è¡¥0
                const orderId = parseInt(shortTimestamp + randomNum);
                const newOrder = {
                    id: orderId,
                    productId: currentProduct.id,
                    productName: productName,
                    price: currentProduct.price || 0,
                    originalPrice: currentProduct.price || 0,
                    promoPrice: currentProduct.newPrice !== undefined ? currentProduct.newPrice : 0,
                    image: currentProduct.image || '',
                    status: 'review',
                    date: Date.now(), // ä¿å­˜å®Œæ•´æ—¶é—´æˆ³ï¼Œç¡®ä¿æ—¶é—´å‡†ç¡®
                    customerInfo: { 
                        name: customerName, 
                        phone: customerPhone, 
                        email, 
                        address: finalAddress, // å®Œæ•´åœ°å€å­—ç¬¦ä¸²ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
                        // è¯¦ç»†åœ°å€å­—æ®µ
                        addressDetail: finalAddressDetail?.detail || '',
                        addressUnit: finalAddressDetail?.unit || '',
                        addressCity: finalAddressDetail?.city || '',
                        addressState: finalAddressDetail?.state || '',
                        addressPostal: finalAddressDetail?.postal || '',
                        addressCountry: finalAddressDetail?.country || 'US',
                        // å…¼å®¹æ—§å­—æ®µå
                        detail: finalAddressDetail?.detail || '',
                        unit: finalAddressDetail?.unit || '',
                        city: finalAddressDetail?.city || '',
                        state: finalAddressDetail?.state || '',
                        postal: finalAddressDetail?.postal || '',
                        notes 
                    },
                    account: currentUser ? currentUser.account : null // æ·»åŠ ç”¨æˆ·æ ‡è¯†
                };

                userOrders.push(newOrder);
                saveUserOrders();

                // å‘é€ç»™å®¢æœï¼ˆå¦‚æœaddMessageå‡½æ•°å­˜åœ¨ï¼‰
                try {
                    const customerMessage = `æ–°çš„äº§å“æŠ¥åï¼š\näº§å“ï¼š${productName}\nå§“åï¼š${customerName}\nç”µè¯ï¼š${customerPhone}\né‚®ç®±ï¼š${email}\nåœ°å€ï¼š${newOrder.customerInfo.address}\nå¤‡æ³¨ï¼š${notes}`;
                    if (typeof addMessage === 'function') {
                        addMessage(customerMessage, 'service');
                    }
                } catch (err) {
                    console.warn('å‘é€å®¢æœæ¶ˆæ¯å¤±è´¥ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰:', err);
                }

                // æäº¤åˆ°Formspreeï¼ˆå¦‚æœéœ€è¦ï¼‰
                // æ³¨æ„ï¼šç”±äºæˆ‘ä»¬é˜»æ­¢äº†é»˜è®¤æäº¤ï¼Œè¿™é‡Œéœ€è¦æ‰‹åŠ¨æäº¤æˆ–ä½¿ç”¨fetch
                // å¦‚æœä¸éœ€è¦Formspreeæäº¤ï¼Œå¯ä»¥æ³¨é‡Šæ‰ä¸‹é¢çš„ä»£ç 
                const form = document.getElementById('signup-form');
                const formData = new FormData(form);
                
                // ä½¿ç”¨fetchæäº¤åˆ°Formspreeï¼ˆå¯é€‰ï¼‰
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                }).catch(err => {
                    console.log('Formspreeæäº¤å¤±è´¥ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰:', err);
                });

                // æ¸…ç©ºè¡¨å•
                console.log('âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼Œå‡†å¤‡å…³é—­æ¨¡æ€æ¡†');
                setTimeout(() => {
                    try {
                        document.getElementById('signup-form').reset();
                        closeModal('signup-modal');
                        
                        // æ˜¾ç¤ºWhatsAppæç¤ºæ¨¡æ€æ¡†ï¼Œä¼ é€’è®¢å•å·
                        if (typeof showWhatsAppModal === 'function') {
                            showWhatsAppModal(newOrder.id);
                        } else {
                            console.warn('âš ï¸ showWhatsAppModalå‡½æ•°ä¸å­˜åœ¨');
                        }

                        // æ›´æ–°ç”¨æˆ·ä¸­å¿ƒè®¢å•
                        const userCenter = document.getElementById('user-center');
                        if (userCenter && userCenter.style.display === 'block') {
                            renderUserOrders();
                        }
                        console.log('âœ… æŠ¥åæµç¨‹å®Œæˆ');
                    } catch (err) {
                        console.error('âŒ å…³é—­æ¨¡æ€æ¡†æ—¶å‡ºé”™:', err);
                    }
                }, 100);
                });
            }

            // ç”¨æˆ·ä¸­å¿ƒèœå•åˆ‡æ¢
            const userMenuItems = document.querySelectorAll('.user-menu a');
            userMenuItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // ç¡®ä¿ä¾§è¾¹æ æ˜¾ç¤ºï¼ˆä»"æˆ‘çš„æŠ¥å"è¿”å›æ—¶ï¼‰
                    const userSidebar = document.querySelector('.user-sidebar');
                    const userCenter = document.getElementById('user-center');
                    if (userSidebar) {
                        userSidebar.style.display = 'block';
                    }
                    if (userCenter) {
                        userCenter.classList.remove('sidebar-hidden');
                    }

                    // æ›´æ–°èœå•çŠ¶æ€
                    userMenuItems.forEach(menu => menu.classList.remove('active'));
                    item.classList.add('active');

                    // åˆ‡æ¢é¡µé¢
                    const tab = item.getAttribute('data-tab');
                    showUserPage(tab);
                });
            });

            // ç”¨æˆ·ä¸­å¿ƒè®¢å•æ ‡ç­¾åˆ‡æ¢
            const orderTabs = document.querySelectorAll('.order-tab');
            orderTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    orderTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    const status = tab.getAttribute('data-status');
                    document.querySelectorAll('.order-list').forEach(list => {
                        list.classList.remove('active');
                    });
                    document.getElementById(`order-${status}`).classList.add('active');
                });
            });

            // ç”¨æˆ·ç®¡ç†ç­›é€‰æ§ä»¶
            const userRoleFilterEl = document.getElementById('user-role-filter');
            if (userRoleFilterEl) {
                userRoleFilterEl.addEventListener('change', (e) => {
                    userFilterRole = e.target.value;
                    resetPagination('users');
                    renderUsersTable();
                });
            }

            const userStatusFilterEl = document.getElementById('user-status-filter');
            if (userStatusFilterEl) {
                userStatusFilterEl.addEventListener('change', (e) => {
                    userFilterStatus = e.target.value;
                    resetPagination('users');
                    renderUsersTable();
                });
            }

            const userDeviceFilterEl = document.getElementById('user-device-filter');
            if (userDeviceFilterEl) {
                userDeviceFilterEl.addEventListener('input', (e) => {
                    userDeviceFilter = e.target.value.trim();
                    resetPagination('users');
                    renderUsersTable();
                });
            }

            const userSearchInputEl = document.getElementById('user-search-input');
            if (userSearchInputEl) {
                userSearchInputEl.addEventListener('input', (e) => {
                    userSearchTerm = e.target.value.trim();
                    resetPagination('users');
                    renderUsersTable();
                });
            }

            const adminProductSearchInput = document.getElementById('admin-product-search');
            if (adminProductSearchInput) {
                const handleProductSearch = debounce((value) => {
                    adminProductSearchTerm = value.trim().toLowerCase();
                    resetPagination('products');
                    renderAdminProducts();
                }, 300);

                adminProductSearchInput.addEventListener('input', (e) => {
                    handleProductSearch(e.target.value);
                });
            }

            // è¯„ä»·æœç´¢ä¸åˆ†ç±»ç­›é€‰
            const reviewsSearchInput = document.getElementById('reviews-search-input');
            const reviewsFilterCategory = document.getElementById('reviews-filter-category');
            if (reviewsSearchInput) {
                const handleReviewSearch = debounce((value) => {
                    reviewSearchTerm = value;
                    resetPagination('reviews');
                    renderReviewsTable();
                }, 300);

                reviewsSearchInput.addEventListener('input', (e) => {
                    handleReviewSearch(e.target.value);
                });
            }
            if (reviewsFilterCategory) {
                reviewsFilterCategory.addEventListener('change', (e) => {
                    reviewSearchCategory = e.target.value || 'all';
                    resetPagination('reviews');
                    renderReviewsTable();
                });
            }

            // Excelä¸Šä¼ åŠŸèƒ½
            const excelUploadArea = document.getElementById('excel-upload-area');
            const excelFileInput = document.getElementById('excel-file');

            excelUploadArea.addEventListener('click', () => {
                excelFileInput.click();
            });

            excelUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                excelUploadArea.style.borderColor = 'var(--primary)';
                excelUploadArea.style.background = '#f8f9fa';
            });

            excelUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                excelUploadArea.style.borderColor = '#ddd';
                excelUploadArea.style.background = 'white';
            });

            excelUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                excelUploadArea.style.borderColor = '#ddd';
                excelUploadArea.style.background = 'white';

                const files = e.dataTransfer.files;
                if (files.length > 0 && (files[0].name.endsWith('.xlsx') || files[0].name.endsWith('.xls'))) {
                    // FileList ä¸ºåªè¯»ï¼Œä¸å†å¼ºè¡Œèµ‹å€¼ç»™ input
                    handleExcelFile(files[0]);
                }
            });

            excelFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleExcelFile(e.target.files[0]);
                }
            });

            // æ·»åŠ äº§å“æŒ‰é’®
            document.getElementById('add-product-btn').addEventListener('click', () => {
                console.log('ğŸ”· ç‚¹å‡»æ·»åŠ äº§å“æŒ‰é’®ï¼Œå½“å‰äº§å“æ•°é‡:', products.length);
                openProductEditModal(null);
            });

            // æ‰¹é‡æ“ä½œæŒ‰é’®
            const selectAllProductsCheckbox = document.getElementById('select-all-products');
            if (selectAllProductsCheckbox) {
                selectAllProductsCheckbox.addEventListener('change', toggleSelectAllProducts);
            }

            const batchEditBtn = document.getElementById('batch-edit-btn');
            if (batchEditBtn) {
                batchEditBtn.addEventListener('click', openBatchEditModal);
            }

            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            if (batchDeleteBtn) {
                batchDeleteBtn.addEventListener('click', batchDeleteProducts);
            }

            // æ‰¹é‡ç¼–è¾‘è¡¨å•
            const batchEditForm = document.getElementById('batch-edit-form');
            if (batchEditForm) {
                batchEditForm.addEventListener('submit', applyBatchEdit);

                // ä»·æ ¼æ“ä½œä¸‹æ‹‰æ¡†å˜åŒ–
                document.getElementById('batch-edit-price-action').addEventListener('change', function () {
                    const valueGroup = document.getElementById('batch-price-value-group');
                    valueGroup.style.display = this.value ? 'block' : 'none';
                });

                // åº“å­˜æ“ä½œä¸‹æ‹‰æ¡†å˜åŒ–
                document.getElementById('batch-edit-stock-action').addEventListener('change', function () {
                    const valueGroup = document.getElementById('batch-stock-value-group');
                    valueGroup.style.display = this.value ? 'block' : 'none';
                });
            }

            // åå°ç®¡ç†å¯¼èˆªåˆ‡æ¢
            const adminNavBtns = document.querySelectorAll('.admin-nav-btn');
            adminNavBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    adminNavBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const tab = btn.getAttribute('data-tab');
                    showAdminPage(tab);
                });
            });

            // åå°ç®¡ç†æŒ‰é’®äº‹ä»¶
            document.getElementById('refresh-users-btn').addEventListener('click', () => {
                showButtonFeedback('refresh-users-btn', () => {
                    renderUsersTable();
                });
            });

            document.getElementById('export-users-btn').addEventListener('click', () => {
                showButtonFeedback('export-users-btn', () => {
                    exportUsersData();
                });
            });

            const deleteSelectedUsersBtn = document.getElementById('delete-selected-users-btn');
            if (deleteSelectedUsersBtn) {
                deleteSelectedUsersBtn.addEventListener('click', deleteSelectedUsers);
            }

            // è®¾å¤‡æ³¨å†Œé™åˆ¶ç®¡ç†äº‹ä»¶
            const setDeviceLimitBtn = document.getElementById('set-device-limit-btn');
            if (setDeviceLimitBtn) {
                setDeviceLimitBtn.addEventListener('click', () => {
                    const deviceId = document.getElementById('device-limit-device-input').value.trim();
                    const limitValue = parseInt(document.getElementById('device-limit-value-input').value);
                    
                    if (!deviceId) {
                        showMessageModal('é”™è¯¯', 'è¯·è¾“å…¥è®¾å¤‡ID', 'alert');
                        return;
                    }
                    
                    if (isNaN(limitValue) || limitValue < 0 || limitValue > 100) {
                        showMessageModal('é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é™åˆ¶æ•°é‡ï¼ˆ0-100ï¼‰', 'alert');
                        return;
                    }
                    
                    deviceRegisterLimits[deviceId] = limitValue;
                    saveDeviceRegisterLimits();
                    showMessageModal('æˆåŠŸ', `è®¾å¤‡ ${deviceId} çš„æ³¨å†Œé™åˆ¶å·²è®¾ç½®ä¸º ${limitValue}`, 'success');
                    document.getElementById('device-limit-device-input').value = '';
                    updateDeviceLimitsList();
                });
            }

            const viewDeviceLimitsBtn = document.getElementById('view-device-limits-btn');
            if (viewDeviceLimitsBtn) {
                viewDeviceLimitsBtn.addEventListener('click', () => {
                    const listDiv = document.getElementById('device-limits-list');
                    if (listDiv.style.display === 'none') {
                        updateDeviceLimitsList();
                        listDiv.style.display = 'block';
                    } else {
                        listDiv.style.display = 'none';
                    }
                });
            }

            const resetDeviceLimitBtn = document.getElementById('reset-device-limit-btn');
            if (resetDeviceLimitBtn) {
                resetDeviceLimitBtn.addEventListener('click', () => {
                    const deviceId = document.getElementById('device-limit-device-input').value.trim();
                    if (!deviceId) {
                        showMessageModal('é”™è¯¯', 'è¯·è¾“å…¥è¦é‡ç½®çš„è®¾å¤‡ID', 'alert');
                        return;
                    }
                    
                    if (deviceRegisterLimits[deviceId] !== undefined) {
                        delete deviceRegisterLimits[deviceId];
                        saveDeviceRegisterLimits();
                        showMessageModal('æˆåŠŸ', `è®¾å¤‡ ${deviceId} çš„æ³¨å†Œé™åˆ¶å·²é‡ç½®ä¸ºé»˜è®¤å€¼(${DEFAULT_DEVICE_REGISTER_LIMIT})`, 'success');
                        document.getElementById('device-limit-device-input').value = '';
                        updateDeviceLimitsList();
                    } else {
                        showMessageModal('æç¤º', `è®¾å¤‡ ${deviceId} æœªè®¾ç½®è‡ªå®šä¹‰é™åˆ¶ï¼Œå·²ä½¿ç”¨é»˜è®¤å€¼`, 'info');
                    }
                });
            }

            const clearCloudUsersBtn = document.getElementById('clear-cloud-users-btn');
            if (clearCloudUsersBtn) {
                clearCloudUsersBtn.addEventListener('click', async () => {
                    try {
                        if (!cloudSync || !cloudSync.isInitialized) {
                            showMessageModal(t('errorTitle'), t('cloudSyncNotEnabledError'), 'alert');
                            return;
                        }

                        if (!isCurrentUserAdmin()) {
                            showMessageModal(t('errorTitle'), t('onlyAdminCanOperate'), 'alert');
                            return;
                        }

                        const confirmed = await customConfirm(
                            'æ­¤æ“ä½œå°†æ¸…ç†äº‘ç«¯ users èŠ‚ç‚¹ï¼šä»…åˆ é™¤é‚£äº›ä¸åœ¨ allUsers åˆ—è¡¨ä¸­çš„è´¦å·æ•°æ®ã€‚\n\nâ€¢ allUsers ä¸ä¼šè¢«ä¿®æ”¹\nâ€¢ æœ¬åœ°ç”¨æˆ·åˆ—è¡¨ä¸å˜\n\næ˜¯å¦ç»§ç»­ï¼Ÿ',
                            'å±é™©æ“ä½œç¡®è®¤'
                        );
                        if (!confirmed) {
                            return;
                        }

                        // æŒ‰é’®ç¦ç”¨ä¸çŠ¶æ€åé¦ˆ
                        clearCloudUsersBtn.disabled = true;
                        const originalText = clearCloudUsersBtn.textContent;
                        clearCloudUsersBtn.textContent = 'æ­£åœ¨æ¸…ç†äº‘ç«¯ users...';

                        try {
                            const result = await cloudSync.clearCloudUsers();
                            if (result && result.skipped) {
                                showMessageModal(t('infoTitle'), t('cloudAllUsersEmpty'), 'alert');
                            } else {
                                const removed = result?.removed || 0;
                                showNotification(`å·²æ¸…ç† usersï¼šåˆ é™¤ ${removed} ä¸ªè´¦å·ï¼ˆä»…åˆ é™¤ä¸åœ¨ allUsers çš„è´¦å·ï¼‰`, 'success');
                            }
                        } catch (err) {
                            console.error('æ¸…ç†äº‘ç«¯ users å¤±è´¥:', err);
                            showMessageModal(t('errorTitle'), t('clearCloudUsersFailed').replace('{error}', err.message || err), 'alert');
                        } finally {
                            clearCloudUsersBtn.disabled = false;
                            clearCloudUsersBtn.textContent = originalText;
                        }
                    } catch (e) {
                        console.error('å¤„ç†æ¸…ç©ºäº‘ç«¯ç”¨æˆ·æŒ‰é’®ç‚¹å‡»æ—¶å‡ºé”™:', e);
                    }
                });
            }

            const selectAllUsersCheckbox = document.getElementById('select-all-users');
            if (selectAllUsersCheckbox) {
                selectAllUsersCheckbox.addEventListener('change', () => {
                    const shouldCheck = selectAllUsersCheckbox.checked;
                    document.querySelectorAll('.user-select-checkbox').forEach(cb => {
                        cb.checked = shouldCheck;
                        const account = cb.getAttribute('data-account');
                        if (shouldCheck) {
                            selectedUserAccounts.add(account);
                        } else {
                            selectedUserAccounts.delete(account);
                        }
                    });
                    refreshUserSelectionUI();
                });
            }

            document.getElementById('refresh-orders-btn').addEventListener('click', () => {
                showButtonFeedback('refresh-orders-btn', () => {
                    renderOrdersTable();
                });
            });

            document.getElementById('export-orders-btn').addEventListener('click', () => {
                showButtonFeedback('export-orders-btn', () => {
                    exportOrdersData();
                });
            });

            const deleteSelectedOrdersBtn = document.getElementById('delete-selected-orders-btn');
            if (deleteSelectedOrdersBtn) {
                deleteSelectedOrdersBtn.addEventListener('click', deleteSelectedOrders);
            }

            const selectAllOrdersCheckbox = document.getElementById('select-all-orders');
            if (selectAllOrdersCheckbox) {
                selectAllOrdersCheckbox.addEventListener('change', () => {
                    const shouldCheck = selectAllOrdersCheckbox.checked;
                    document.querySelectorAll('.order-select-checkbox').forEach(cb => {
                        cb.checked = shouldCheck;
                        const id = cb.getAttribute('data-order-id');
                        if (shouldCheck) {
                            selectedOrderIds.add(id);
                        } else {
                            selectedOrderIds.delete(id);
                        }
                    });
                    refreshOrderSelectionUI();
                });
            }

            // ä¸»é¡µç®¡ç†æŒ‰é’®äº‹ä»¶
            document.getElementById('preview-homepage-btn').addEventListener('click', () => {
                showHomePage();
                showNotification('å·²åˆ‡æ¢åˆ°ä¸»é¡µé¢„è§ˆ', 'info');
            });

            document.getElementById('reset-homepage-btn').addEventListener('click', () => {
                resetHomepageSettings();
            });

            document.getElementById('save-homepage-btn').addEventListener('click', () => {
                saveHomepageSettings();
            });

            const addDesktopCarouselBtn = document.getElementById('add-carousel-btn-desktop');
            if (addDesktopCarouselBtn) {
                addDesktopCarouselBtn.addEventListener('click', () => addCarouselItem('desktop'));
            }

            const addMobileCarouselBtn = document.getElementById('add-carousel-btn-mobile');
            if (addMobileCarouselBtn) {
                addMobileCarouselBtn.addEventListener('click', () => addCarouselItem('mobile'));
            }

            const carouselTabs = document.querySelectorAll('.carousel-tab');
            const carouselPanels = document.querySelectorAll('.carousel-panel');
            carouselTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-carousel-tab');
                    carouselTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    carouselPanels.forEach(panel => {
                        if (panel.getAttribute('data-carousel-panel') === target) {
                            panel.classList.add('active');
                        } else {
                            panel.classList.remove('active');
                        }
                    });
                    renderCarouselList(target);
                });
            });

            // è®¢å•ç­›é€‰
            document.getElementById('order-status-filter').addEventListener('change', () => {
                resetPagination('orders');
                renderOrdersTable();
            });

            document.getElementById('order-search').addEventListener('input', debounce(() => {
                resetPagination('orders');
                renderOrdersTable();
            }, 300));

            const orderSearchField = document.getElementById('order-search-field');
            if (orderSearchField) {
                orderSearchField.addEventListener('change', () => {
                    resetPagination('orders');
                    renderOrdersTable();
                });
            }

            // åœ°å€ç®¡ç†åŠŸèƒ½
            const addAddressBtn = document.getElementById('add-address-btn');
            const addressModal = document.getElementById('address-modal');
            const addressForm = document.getElementById('address-form');
            const cancelAddressBtn = document.getElementById('cancel-address');

            if (addAddressBtn) {
                addAddressBtn.addEventListener('click', () => {
                    openAddressModal();
                });
            }

            if (cancelAddressBtn) {
                cancelAddressBtn.addEventListener('click', () => {
                    closeModal('address-modal');
                });
            }

            if (addressForm && !addressForm._submitHandler) {
                addressForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    // é˜²æ­¢é‡å¤æäº¤
                    if (addressForm._submitting) {
                        console.warn('è¡¨å•æ­£åœ¨æäº¤ä¸­ï¼Œå¿½ç•¥é‡å¤æäº¤');
                        return;
                    }
                    addressForm._submitting = true;
                    saveAddress();
                    // æäº¤å®Œæˆåé‡ç½®æ ‡å¿—
                    setTimeout(() => {
                        addressForm._submitting = false;
                    }, 1000);
                });
                addressForm._submitHandler = true;
            }

            // ä¸ªäººä¿¡æ¯è¡¨å•
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveProfile();
                });
            }

            // ä¿®æ”¹å¯†ç è¡¨å•
            const changePasswordForm = document.getElementById('change-password-form');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    changePassword();
                });
            }

            // ç¡®ä¿ç¼–è¾‘æ¨¡æ€æ¡†ä¹Ÿèƒ½å…³é—­
            const editModal = document.getElementById('edit-product-modal');
            if (editModal) {
                const closeBtn = editModal.querySelector('.close-modal');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        editModal.style.display = 'none';
                    });
                }
            }

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­ï¼ˆåºŸå¼ƒçš„é‡å¤ç»‘å®šå·²ç§»é™¤ï¼Œç»Ÿä¸€åœ¨åº•éƒ¨ï¼‰
            // ç¼–è¾‘æ¨¡æ€æ¡†å–æ¶ˆæŒ‰é’®
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function () {
                    closeModal('edit-product-modal');
                });
            }

            // ç¼–è¾‘æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
            const editModalClose = document.querySelector('#edit-product-modal .close-modal');
            if (editModalClose) {
                editModalClose.addEventListener('click', function () {
                    closeModal('edit-product-modal');
                });
            }

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­ï¼ˆå¢å¼ºç‰ˆï¼Œç»Ÿä¸€å”¯ä¸€å¤„ç†ï¼‰
            window.addEventListener('click', (e) => {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // ç»‘å®šä¸€æ¬¡æ€§ç¼–è¾‘è¡¨å•æäº¤äº‹ä»¶ï¼Œé¿å…é‡å¤ç»‘å®š
            const editForm = document.getElementById('edit-product-form');
            if (editForm) {
                editForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    const productId = parseInt(document.getElementById('edit-product-id').value);
                    const targetProduct = products.find(p => p.id === productId);
                    if (!targetProduct) {
                        customAlert(t('productNotFound'), t('errorTitle'));
                        return;
                    }

                    const editImageInputs = Array.from(document.querySelectorAll('.edit-product-image-url'));
                    const editImageUrls = editImageInputs
                        .map(input => input.value.trim())
                        .filter(url => !!url)
                        .slice(0, 6);

                    if (editImageUrls.length === 0) {
                        customAlert(t('pleaseEnterAtLeastOneImage'), t('errorTitle'));
                        return;
                    }

                    const updatedProduct = {
                        id: productId,
                        name: document.getElementById('edit-product-name').value.trim(),
                        price: parseFloat(document.getElementById('edit-product-price').value),
                        newPrice: parseFloat(document.getElementById('edit-product-new-price').value) || 0,
                        stock: parseInt(document.getElementById('edit-product-stock').value),
                        category: document.getElementById('edit-product-category').value,
                        image: editImageUrls[0],
                        imageUrls: editImageUrls,
                        description: document.getElementById('edit-product-description').value.trim()
                    };

                    for (let i = 1; i <= 6; i++) {
                        updatedProduct[`imageUrl${i}`] = editImageUrls[i - 1] || '';
                    }

                    if (!updatedProduct.name) { customAlert(t('productNameRequired'), t('errorTitle')); return; }
                    if (!(updatedProduct.price > 0)) { customAlert(t('productPriceRequired'), t('errorTitle')); return; }
                    if (updatedProduct.stock < 0) { customAlert(t('stock') + ' ' + t('cannotBeNegative'), t('errorTitle')); return; }
                    if (!updatedProduct.image) { customAlert(t('productImageRequired'), t('errorTitle')); return; }

                    const productIndex = products.findIndex(p => p.id === productId);
                    if (productIndex !== -1) {
                        products[productIndex] = { ...products[productIndex], ...updatedProduct };
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å¹¶åŒæ­¥åˆ°äº‘ç«¯ï¼ˆç­‰å¾…å®Œæˆï¼‰
                        saveProducts().then(() => {
                            console.log('âœ… äº§å“æ•°æ®ï¼ˆåŒ…æ‹¬newPriceï¼‰å·²ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯');
                            customAlert(t('productUpdateSuccess'), 'æˆåŠŸ');
                            closeModal('edit-product-modal');
                            if (document.getElementById('admin-panel').style.display !== 'none') {
                                renderAdminProducts();
                            }
                            if (document.getElementById('home-page').style.display !== 'none') {
                                renderProducts(products);
                            }
                        }).catch(err => {
                            console.warn('âš ï¸ äº§å“æ•°æ®ä¿å­˜æˆ–åŒæ­¥å¤±è´¥:', err);
                            customAlert(t('productUpdateSuccess'), 'æˆåŠŸ'); // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œæœ¬åœ°å·²ä¿å­˜ï¼Œä»æ˜¾ç¤ºæˆåŠŸ
                            closeModal('edit-product-modal');
                            if (document.getElementById('admin-panel').style.display !== 'none') {
                                renderAdminProducts();
                            }
                            if (document.getElementById('home-page').style.display !== 'none') {
                                renderProducts(products);
                            }
                        });
                    } else {
                        customAlert(t('productUpdateFailed'), 'é”™è¯¯');
                    }
                });
            }
        });

        // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€å¯¹è¯æ¡†
        function showSyncStatusDialog() {
            // æ£€æŸ¥ Firebase SDK å’Œ CloudSync çŠ¶æ€
            const sdkLoaded = typeof firebase !== 'undefined';
            const syncInitialized = cloudSync && cloudSync.isInitialized;

            let dialogHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="sync-dialog">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 20px 0; color: #333; font-size: 22px;">
                            <i class="fas fa-cloud"></i> äº‘ç«¯åŒæ­¥çŠ¶æ€
                        </h3>
            `;

            if (!sdkLoaded) {
                dialogHTML += `
                    <div style="padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">
                            <i class="fas fa-exclamation-triangle"></i> Firebase SDK æœªåŠ è½½
                        </h4>
                        <p style="margin: 0; color: #856404; line-height: 1.6;">
                            Firebase SDK æ— æ³•ä»CDNåŠ è½½ã€‚è¿™å¯èƒ½æ˜¯ç”±äºç½‘ç»œé—®é¢˜æˆ–é˜²ç«å¢™é™åˆ¶ã€‚
                            <br><br>
                            <strong>å½“å‰æ¨¡å¼ï¼š</strong> æœ¬åœ°å­˜å‚¨æ¨¡å¼<br>
                            <strong>å½±å“ï¼š</strong> æ•°æ®ä»…ä¿å­˜åœ¨å½“å‰è®¾å¤‡ï¼Œæ— æ³•è·¨è®¾å¤‡åŒæ­¥
                        </p>
                    </div>
                    <div style="padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #0d47a1;">
                            <i class="fas fa-lightbulb"></i> è§£å†³æ–¹æ³•
                        </h4>
                        <ol style="margin: 0; padding-left: 20px; color: #0d47a1; line-height: 1.8;">
                            <li>æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                            <li>å°è¯•å…³é—­å¹¿å‘Šæ‹¦æˆªå™¨æˆ–é˜²ç«å¢™</li>
                            <li>è¿è¡Œè¯Šæ–­å·¥å…·ï¼š<code>firebase-diagnostic.html</code></li>
                            <li>åˆ·æ–°é¡µé¢é‡è¯•</li>
                        </ol>
                    </div>
                `;
            } else if (!syncInitialized) {
                dialogHTML += `
                    <div style="padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">
                            <i class="fas fa-exclamation-triangle"></i> äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–
                        </h4>
                        <p style="margin: 0; color: #856404; line-height: 1.6;">
                            Firebase SDK å·²åŠ è½½ï¼Œä½†äº‘ç«¯åŒæ­¥æœåŠ¡åˆå§‹åŒ–å¤±è´¥ã€‚
                            <br><br>
                            <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                            â€¢ Firebase é…ç½®ä¸æ­£ç¡®<br>
                            â€¢ Firebase æ•°æ®åº“æœªåˆ›å»º<br>
                            â€¢ æ•°æ®åº“æƒé™è®¾ç½®æœ‰è¯¯<br>
                            <br>
                            <strong>å½“å‰æ¨¡å¼ï¼š</strong> æœ¬åœ°å­˜å‚¨æ¨¡å¼
                        </p>
                    </div>
                    <div style="padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #0d47a1;">
                            <i class="fas fa-cog"></i> é…ç½®æ­¥éª¤
                        </h4>
                        <p style="margin: 0; color: #0d47a1; line-height: 1.8;">
                            1. è®¿é—® <a href="https://console.firebase.google.com/" target="_blank" style="color: #2196F3;">Firebase æ§åˆ¶å°</a><br>
                            2. åˆ›å»ºé¡¹ç›®å¹¶å¯ç”¨ Realtime Database<br>
                            3. è®¾ç½®æ•°æ®åº“è§„åˆ™ä¸ºæµ‹è¯•æ¨¡å¼ï¼ˆå…è®¸è¯»å†™ï¼‰<br>
                            4. æ›´æ–° main.html ä¸­çš„ Firebase é…ç½®<br>
                            <br>
                            è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ <code>FIREBASE_SETUP.md</code>
                        </p>
                    </div>
                `;
            } else {
                dialogHTML += `
                    <div style="padding: 20px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #155724;">
                            <i class="fas fa-check-circle"></i> äº‘ç«¯åŒæ­¥å·²å¯ç”¨
                        </h4>
                        <p style="margin: 0; color: #155724; line-height: 1.6;">
                            <strong>çŠ¶æ€ï¼š</strong> æ­£å¸¸è¿è¡Œ<br>
                            <strong>Firebase ç‰ˆæœ¬ï¼š</strong> ${firebase.SDK_VERSION || 'æœªçŸ¥'}<br>
                            <strong>ä¸Šæ¬¡åŒæ­¥ï¼š</strong> ${cloudSync.lastSyncTime || 'ä»æœªåŒæ­¥'}<br>
                            <strong>æ•°æ®åº“ï¼š</strong> ${cloudSync.firebaseConfig.databaseURL}
                        </p>
                    </div>
                    <div style="padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #0d47a1;">
                            <i class="fas fa-info-circle"></i> åŠŸèƒ½è¯´æ˜
                        </h4>
                        <p style="margin: 0; color: #0d47a1; line-height: 1.8;">
                            âœ… æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯<br>
                            âœ… æ”¯æŒå¤šè®¾å¤‡å®æ—¶åŒæ­¥<br>
                            âœ… ç¦»çº¿æ•°æ®è‡ªåŠ¨ç¼“å­˜<br>
                            âœ… ç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥
                        </p>
                    </div>
                `;
            }

            dialogHTML += `
                        <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
            `;

            // å§‹ç»ˆæä¾›æ‰“å¼€æ§åˆ¶å°æŒ‰é’®
            dialogHTML += `
                            <button onclick="openConsoleAndCheckErrors()" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-terminal"></i> æŸ¥çœ‹æ§åˆ¶å°
                            </button>
            `;

            // å¦‚æœSDKå·²åŠ è½½ä½†æœªåˆå§‹åŒ–ï¼Œæä¾›é‡è¯•æŒ‰é’®
            if (sdkLoaded && !syncInitialized) {
                dialogHTML += `
                            <button onclick="retryCloudSyncInit()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-sync-alt"></i> é‡è¯•åˆå§‹åŒ–
                            </button>
                `;
            }

            // å¦‚æœå·²åˆå§‹åŒ–ï¼Œæä¾›æ‰‹åŠ¨åŒæ­¥æŒ‰é’®
            if (syncInitialized) {
                dialogHTML += `
                            <button onclick="openSyncTestPanel()" style="padding: 10px 20px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-flask"></i> æµ‹è¯•åŠŸèƒ½
                            </button>
                            <button onclick="manualSyncNow()" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-cloud-upload-alt"></i> ç«‹å³åŒæ­¥
                            </button>
                `;
            }

            dialogHTML += `
                            <button onclick="closeSyncDialog()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // ç§»é™¤æ—§å¯¹è¯æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldDialog = document.getElementById('sync-dialog');
            if (oldDialog) {
                oldDialog.remove();
            }

            // æ·»åŠ æ–°å¯¹è¯æ¡†
            document.body.insertAdjacentHTML('beforeend', dialogHTML);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            document.getElementById('sync-dialog').addEventListener('click', (e) => {
                if (e.target.id === 'sync-dialog') {
                    closeSyncDialog();
                }
            });
        }

        // å…³é—­åŒæ­¥çŠ¶æ€å¯¹è¯æ¡†
        function closeSyncDialog() {
            const dialog = document.getElementById('sync-dialog');
            if (dialog) {
                dialog.remove();
            }
        }

        // é‡è¯•äº‘ç«¯åŒæ­¥åˆå§‹åŒ–
        async function retryCloudSyncInit() {
            closeSyncDialog();
            showNotification('æ­£åœ¨é‡è¯•åˆå§‹åŒ–äº‘ç«¯åŒæ­¥...', 'info');

            try {
                if (!cloudSync) {
                    cloudSync = new CloudSyncManager();
                }
                await cloudSync.init();
                showNotification('âœ… äº‘ç«¯åŒæ­¥åˆå§‹åŒ–æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('é‡è¯•åˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('âŒ åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®', 'error');
            }
        }

        // æ‰‹åŠ¨æ‰§è¡Œç«‹å³åŒæ­¥
        async function manualSyncNow() {
            if (!cloudSync || !cloudSync.isInitialized) {
                showNotification('äº‘ç«¯åŒæ­¥æœªå¯ç”¨', 'warning');
                return;
            }

            closeSyncDialog();
            showNotification('æ­£åœ¨åŒæ­¥æ•°æ®åˆ°äº‘ç«¯...', 'info');

            try {
                await cloudSync.syncAllData();
                showNotification('âœ… æ•°æ®åŒæ­¥æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                showNotification('âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // æ‰“å¼€æ§åˆ¶å°å¹¶æ˜¾ç¤ºæç¤º
        async function openConsoleAndCheckErrors() {
            closeSyncDialog();

            console.log('');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“Š äº‘ç«¯åŒæ­¥ç½‘ç»œè¯Šæ–­');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('');

            // Firebase SDK çŠ¶æ€
            console.log('1ï¸âƒ£ Firebase SDK çŠ¶æ€:');
            if (typeof firebase !== 'undefined') {
                console.log('   âœ… Firebase SDK å·²åŠ è½½');
                console.log('   ğŸ“¦ ç‰ˆæœ¬:', firebase.SDK_VERSION || 'æœªçŸ¥');
            } else {
                console.log('   âŒ Firebase SDK æœªåŠ è½½');
                console.log('   ğŸ’¡ å¯èƒ½åŸå› ï¼šCDN æ— æ³•è®¿é—®');
            }
            console.log('');

            // CloudSync çŠ¶æ€
            console.log('2ï¸âƒ£ CloudSync çŠ¶æ€:');
            if (cloudSync) {
                console.log('   âœ… CloudSync å®ä¾‹å·²åˆ›å»º');
                console.log('   åˆå§‹åŒ–çŠ¶æ€:', cloudSync.isInitialized ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–');
                if (cloudSync.isInitialized) {
                    console.log('   æ•°æ®åº“ URL:', cloudSync.firebaseConfig.databaseURL);
                }
            } else {
                console.log('   âŒ CloudSync å®ä¾‹æœªåˆ›å»º');
            }
            console.log('');

            // ç½‘ç»œçŠ¶æ€
            console.log('3ï¸âƒ£ ç½‘ç»œçŠ¶æ€:');
            console.log('   åœ¨çº¿çŠ¶æ€:', navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿');
            console.log('');

            // æœ¬åœ°å­˜å‚¨çŠ¶æ€
            console.log('4ï¸âƒ£ æœ¬åœ°å­˜å‚¨çŠ¶æ€:');
            try {
                const testKey = '__storage_test__';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                console.log('   âœ… LocalStorage å¯ç”¨');

                const products = JSON.parse(localStorage.getItem('products') || '[]');
                const users = JSON.parse(localStorage.getItem('allUsers') || '[]');
                const orders = JSON.parse(localStorage.getItem('userOrders') || '[]');

                console.log('   ğŸ“¦ äº§å“æ•°é‡:', products.length);
                console.log('   ğŸ‘¥ ç”¨æˆ·æ•°é‡:', users.length);
                console.log('   ğŸ“‹ è®¢å•æ•°é‡:', orders.length);
            } catch (error) {
                console.log('   âŒ LocalStorage ä¸å¯ç”¨:', error.message);
            }
            console.log('');

            // å¼€å§‹ç½‘ç»œè¿æ¥æµ‹è¯•
            console.log('5ï¸âƒ£ ç½‘ç»œè¿æ¥æµ‹è¯•:');
            console.log('   ğŸ”„ æ­£åœ¨æµ‹è¯• Firebase æœåŠ¡è¿æ¥...');
            console.log('');

            await runNetworkDiagnostics();

            console.log('');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ’¡ æç¤ºï¼šå³ä½¿äº‘ç«¯åŒæ­¥ä¸å¯ç”¨ï¼Œåº”ç”¨ä»å¯æ­£å¸¸ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('');

            showNotification('ç½‘ç»œè¯Šæ–­å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¯¦ç»†ä¿¡æ¯', 'info');
        }

        // ç½‘ç»œè¯Šæ–­å‡½æ•°
        async function runNetworkDiagnostics() {
            const endpoints = [
                {
                    name: 'Firebase CDN (SDK)',
                    url: 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js',
                    type: 'script',
                    description: 'Firebase æ ¸å¿ƒ SDK æ–‡ä»¶'
                },
                {
                    name: 'Firebase Database CDN',
                    url: 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js',
                    type: 'script',
                    description: 'Firebase æ•°æ®åº“ SDK æ–‡ä»¶'
                },
                {
                    name: 'Google APIs (é€šç”¨)',
                    url: 'https://www.googleapis.com/robot.txt',
                    type: 'api',
                    description: 'Google API æœåŠ¡'
                },
                {
                    name: 'Firebase ä¸»ç«™',
                    url: 'https://firebase.google.com/robots.txt',
                    type: 'api',
                    description: 'Firebase å®˜æ–¹ç½‘ç«™'
                },
                {
                    name: 'æ‚¨çš„ Firebase æ•°æ®åº“',
                    url: 'https://grok-f3406-default-rtdb.firebaseio.com/.json?shallow=true',
                    type: 'database',
                    description: 'å®æ—¶æ•°æ®åº“è¿æ¥'
                }
            ];

            const results = [];

            // æ˜¾ç¤ºè¯Šæ–­é¢æ¿
            showDiagnosticPanel(endpoints);

            for (let i = 0; i < endpoints.length; i++) {
                const endpoint = endpoints[i];
                updateDiagnosticItem(i, 'testing');

                const result = await testEndpoint(endpoint);
                results.push(result);

                updateDiagnosticItem(i, result.success ? 'success' : 'failed', result);

                const status = result.success ? 'âœ…' : 'âŒ';
                const timing = result.time ? ` (${result.time}ms)` : '';
                console.log(`   ${status} ${endpoint.name}${timing}`);

                if (!result.success) {
                    console.log(`      é”™è¯¯: ${result.error}`);
                    if (result.suggestion) {
                        console.log(`      å»ºè®®: ${result.suggestion}`);
                    }
                }
            }

            console.log('');
            console.log('ğŸ“ˆ è¯Šæ–­æ€»ç»“:');
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;
            console.log(`   æˆåŠŸ: ${successCount}/${totalCount}`);

            // æ›´æ–°è¯Šæ–­é¢æ¿æ€»ç»“
            updateDiagnosticSummary(successCount, totalCount);

            if (successCount === 0) {
                console.log('');
                console.log('âš ï¸ æ‰€æœ‰è¿æ¥éƒ½å¤±è´¥äº†ï¼å¯èƒ½çš„åŸå› ï¼š');
                console.log('   1. æ‚¨çš„ç½‘ç»œç¯å¢ƒæ— æ³•è®¿é—® Google æœåŠ¡');
                console.log('   2. é˜²ç«å¢™æˆ–ä»£ç†é˜»æ­¢äº†è¿æ¥');
                console.log('   3. DNS è§£æé—®é¢˜');
                console.log('');
                console.log('ğŸ’¡ å»ºè®®çš„è§£å†³æ–¹æ¡ˆï¼š');
                console.log('   â†’ ä½¿ç”¨ VPN è¿æ¥');
                console.log('   â†’ æ›´æ¢ç½‘ç»œç¯å¢ƒï¼ˆå¦‚ä½¿ç”¨æ‰‹æœºçƒ­ç‚¹ï¼‰');
                console.log('   â†’ æ£€æŸ¥é˜²ç«å¢™è®¾ç½®');
                console.log('   â†’ æˆ–è€…ç»§ç»­ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼');
            } else if (successCount < totalCount) {
                console.log('');
                console.log('âš ï¸ éƒ¨åˆ†è¿æ¥å¤±è´¥');
                console.log('   Firebase æœåŠ¡å¯èƒ½ä¸ç¨³å®šæˆ–éƒ¨åˆ†åŠŸèƒ½å—é™');
            } else {
                console.log('');
                console.log('âœ… æ‰€æœ‰è¿æ¥æ­£å¸¸ï¼');
                console.log('   å¦‚æœä»ç„¶æ— æ³•åˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ Firebase é…ç½®');
            }
        }

        // æ˜¾ç¤ºè¯Šæ–­é¢æ¿
        function showDiagnosticPanel(endpoints) {
            const existingPanel = document.getElementById('diagnostic-panel');
            if (existingPanel) {
                existingPanel.remove();
            }

            let panelHTML = `
                <div id="diagnostic-panel" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
                     z-index: 10001; max-width: 700px; width: 90%; max-height: 80vh; overflow: auto;">
                    <div style="padding: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #333; font-size: 22px;">
                                <i class="fas fa-network-wired"></i> ç½‘ç»œè¿æ¥è¯Šæ–­
                            </h2>
                            <button onclick="closeDiagnosticPanel()" style="background: none; border: none; font-size: 24px; 
                                    cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px;">Ã—</button>
                        </div>
                        
                        <div id="diagnostic-items" style="margin-bottom: 20px;">
            `;

            endpoints.forEach((endpoint, index) => {
                panelHTML += `
                    <div id="diagnostic-item-${index}" style="padding: 15px; margin-bottom: 10px; background: #f8f9fa; 
                         border-radius: 8px; border-left: 4px solid #ccc;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                    <i class="fas fa-circle" id="status-icon-${index}" style="font-size: 8px; color: #ccc;"></i>
                                    ${endpoint.name}
                                </div>
                                <div style="font-size: 12px; color: #666;">${endpoint.description}</div>
                                <div id="result-${index}" style="font-size: 12px; color: #999; margin-top: 5px;">
                                    ç­‰å¾…æµ‹è¯•...
                                </div>
                            </div>
                            <div id="spinner-${index}" style="display: none;">
                                <i class="fas fa-spinner fa-spin" style="color: #2196F3; font-size: 20px;"></i>
                            </div>
                        </div>
                    </div>
                `;
            });

            panelHTML += `
                        </div>
                        
                        <div id="diagnostic-summary" style="padding: 15px; background: #f0f0f0; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“Š è¯Šæ–­è¿›åº¦</div>
                            <div style="font-size: 14px; color: #666;">æ­£åœ¨å‡†å¤‡æµ‹è¯•...</div>
                        </div>
                        
                        <div style="text-align: right;">
                            <button onclick="closeDiagnosticPanel()" style="padding: 10px 20px; background: #6c757d; 
                                    color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', panelHTML);
        }

        // æ›´æ–°è¯Šæ–­é¡¹çŠ¶æ€
        function updateDiagnosticItem(index, status, result = null) {
            const item = document.getElementById(`diagnostic-item-${index}`);
            const statusIcon = document.getElementById(`status-icon-${index}`);
            const resultDiv = document.getElementById(`result-${index}`);
            const spinner = document.getElementById(`spinner-${index}`);

            if (!item) return;

            if (status === 'testing') {
                item.style.borderLeftColor = '#2196F3';
                statusIcon.style.color = '#2196F3';
                statusIcon.className = 'fas fa-spinner fa-spin';
                resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•...';
                resultDiv.style.color = '#2196F3';
                spinner.style.display = 'block';
            } else if (status === 'success') {
                item.style.borderLeftColor = '#28a745';
                statusIcon.style.color = '#28a745';
                statusIcon.className = 'fas fa-check-circle';
                resultDiv.innerHTML = `<i class="fas fa-check"></i> è¿æ¥æˆåŠŸ (${result.time}ms)`;
                resultDiv.style.color = '#28a745';
                spinner.style.display = 'none';
            } else if (status === 'failed') {
                item.style.borderLeftColor = '#dc3545';
                statusIcon.style.color = '#dc3545';
                statusIcon.className = 'fas fa-times-circle';
                resultDiv.innerHTML = `<i class="fas fa-times"></i> ${result.error}`;
                if (result.suggestion) {
                    resultDiv.innerHTML += `<br><small style="color: #ff9800;">ğŸ’¡ ${result.suggestion}</small>`;
                }
                resultDiv.style.color = '#dc3545';
                spinner.style.display = 'none';
            }
        }

        // æ›´æ–°è¯Šæ–­æ€»ç»“
        function updateDiagnosticSummary(successCount, totalCount) {
            const summaryDiv = document.getElementById('diagnostic-summary');
            if (!summaryDiv) return;

            const percentage = Math.round((successCount / totalCount) * 100);
            let statusColor = '#28a745';
            let statusIcon = 'fa-check-circle';
            let statusText = 'æ‰€æœ‰è¿æ¥æ­£å¸¸ï¼';
            let recommendation = 'Firebase äº‘ç«¯åŒæ­¥å·²å°±ç»ªï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚';

            if (successCount === 0) {
                statusColor = '#dc3545';
                statusIcon = 'fa-times-circle';
                statusText = 'æ‰€æœ‰è¿æ¥å¤±è´¥';
                recommendation = 'æ‚¨çš„ç½‘ç»œæ— æ³•è®¿é—® Firebase æœåŠ¡ã€‚å»ºè®®ä½¿ç”¨ VPN æˆ–æ›´æ¢ç½‘ç»œç¯å¢ƒï¼Œæˆ–ç»§ç»­ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼ã€‚';
            } else if (successCount < totalCount) {
                statusColor = '#ff9800';
                statusIcon = 'fa-exclamation-triangle';
                statusText = 'éƒ¨åˆ†è¿æ¥å¤±è´¥';
                recommendation = 'Firebase æœåŠ¡å¯èƒ½ä¸ç¨³å®šã€‚æŸäº›åŠŸèƒ½å¯èƒ½å—é™ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚';
            }

            summaryDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <i class="fas ${statusIcon}" style="color: ${statusColor}; font-size: 24px; margin-right: 10px;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 16px; color: ${statusColor};">${statusText}</div>
                        <div style="font-size: 14px; color: #666; margin-top: 5px;">æˆåŠŸ: ${successCount}/${totalCount} (${percentage}%)</div>
                    </div>
                </div>
                <div style="font-size: 13px; color: #555; padding: 10px; background: white; border-radius: 5px;">
                    ${recommendation}
                </div>
            `;
        }

        // å…³é—­è¯Šæ–­é¢æ¿
        function closeDiagnosticPanel() {
            const panel = document.getElementById('diagnostic-panel');
            if (panel) {
                panel.remove();
            }
        }

        // æ‰“å¼€äº‘ç«¯åŒæ­¥æµ‹è¯•é¢æ¿
        function openSyncTestPanel() {
            closeSyncDialog();

            // æ£€æŸ¥ CloudSync æ˜¯å¦å¯ç”¨
            if (!cloudSync || !cloudSync.isInitialized) {
                showNotification('âš ï¸ äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆåˆå§‹åŒ–', 'warning');
                setTimeout(() => {
                    retryCloudSyncInit();
                }, 1000);
                return;
            }

            const panelHTML = `
                <div id="sync-test-panel" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
                     z-index: 10001; max-width: 800px; width: 90%; max-height: 85vh; overflow: auto;">
                    <div style="padding: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #333; font-size: 22px;">
                                <i class="fas fa-cloud-upload-alt"></i> äº‘ç«¯åŒæ­¥åŠŸèƒ½æµ‹è¯•
                            </h2>
                            <button onclick="closeSyncTestPanel()" style="background: none; border: none; font-size: 24px; 
                                    cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px;">Ã—</button>
                        </div>
                        
                        <!-- å½“å‰çŠ¶æ€ -->
                        <div style="background: #e3f2fd; border-left: 4px solid #2196F3; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1976d2; margin-bottom: 10px;">
                                <i class="fas fa-info-circle"></i> å½“å‰æ•°æ®çŠ¶æ€
                            </div>
                            <div id="sync-test-status" style="font-size: 14px; color: #555;">
                                æ­£åœ¨åŠ è½½...
                            </div>
                        </div>
                        
                        <!-- æµ‹è¯•åŠŸèƒ½åŒº -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <!-- ä¸Šä¼ åŠŸèƒ½ -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 40px; color: #4CAF50; margin-bottom: 10px;">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">ä¸Šä¼ åˆ°äº‘ç«¯</h3>
                                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                                    å°†æœ¬åœ°æ•°æ®ä¸Šä¼ åˆ° Firebase
                                </p>
                                <button onclick="testUploadToCloud()" style="padding: 8px 16px; background: #4CAF50; 
                                        color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                                    <i class="fas fa-upload"></i> æµ‹è¯•ä¸Šä¼ 
                                </button>
                            </div>
                            
                            <!-- ä¸‹è½½åŠŸèƒ½ -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 40px; color: #2196F3; margin-bottom: 10px;">
                                    <i class="fas fa-cloud-download-alt"></i>
                                </div>
                                <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">ä»äº‘ç«¯ä¸‹è½½</h3>
                                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                                    ä» Firebase ä¸‹è½½æ•°æ®åˆ°æœ¬åœ°
                                </p>
                                <button onclick="testDownloadFromCloud()" style="padding: 8px 16px; background: #2196F3; 
                                        color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                                    <i class="fas fa-download"></i> æµ‹è¯•ä¸‹è½½
                                </button>
                            </div>
                            
                            <!-- åŒæ­¥åŠŸèƒ½ -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 40px; color: #FF9800; margin-bottom: 10px;">
                                    <i class="fas fa-sync-alt"></i>
                                </div>
                                <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">åŒå‘åŒæ­¥</h3>
                                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                                    æœ¬åœ°ä¸äº‘ç«¯æ•°æ®åŒæ­¥
                                </p>
                                <button onclick="testSyncWithCloud()" style="padding: 8px 16px; background: #FF9800; 
                                        color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                                    <i class="fas fa-sync"></i> æµ‹è¯•åŒæ­¥
                                </button>
                            </div>
                        </div>
                        
                        <!-- é«˜çº§æµ‹è¯• -->
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">
                                <i class="fas fa-flask"></i> é«˜çº§æµ‹è¯•
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="testCreateTestData()" style="padding: 8px 12px; background: white; 
                                        border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 13px;">
                                    <i class="fas fa-plus"></i> åˆ›å»ºæµ‹è¯•æ•°æ®
                                </button>
                                <button onclick="testClearCloudData()" style="padding: 8px 12px; background: white; 
                                        border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 13px;">
                                    <i class="fas fa-trash"></i> æ¸…ç©ºäº‘ç«¯æ•°æ®
                                </button>
                                <button onclick="testViewCloudData()" style="padding: 8px 12px; background: white; 
                                        border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 13px;">
                                    <i class="fas fa-eye"></i> æŸ¥çœ‹äº‘ç«¯æ•°æ®
                                </button>
                                <button onclick="testAutoSync()" style="padding: 8px 12px; background: white; 
                                        border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 13px;">
                                    <i class="fas fa-magic"></i> æµ‹è¯•è‡ªåŠ¨åŒæ­¥
                                </button>
                            </div>
                        </div>
                        
                        <!-- æµ‹è¯•æ—¥å¿— -->
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-weight: bold; color: #333;">
                                    <i class="fas fa-terminal"></i> æµ‹è¯•æ—¥å¿—
                                </div>
                                <button onclick="clearSyncTestLog()" style="padding: 5px 10px; background: #6c757d; 
                                        color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                    æ¸…ç©ºæ—¥å¿—
                                </button>
                            </div>
                            <div id="sync-test-log" style="background: #1e1e1e; color: #d4d4d4; padding: 12px; 
                                 border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px; 
                                 max-height: 250px; overflow-y: auto; line-height: 1.6;">
                                <div style="color: #4ec9b0;">ç­‰å¾…æµ‹è¯•...</div>
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <button onclick="closeSyncTestPanel()" style="padding: 10px 20px; background: #6c757d; 
                                    color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', panelHTML);

            // æ›´æ–°å½“å‰çŠ¶æ€
            updateSyncTestStatus();
        }

        // å…³é—­åŒæ­¥æµ‹è¯•é¢æ¿
        function closeSyncTestPanel() {
            const panel = document.getElementById('sync-test-panel');
            if (panel) {
                panel.remove();
            }
        }

        // æ›´æ–°åŒæ­¥æµ‹è¯•çŠ¶æ€
        function updateSyncTestStatus() {
            const statusDiv = document.getElementById('sync-test-status');
            if (!statusDiv) return;

            try {
                const products = JSON.parse(localStorage.getItem('products') || '[]');
                const users = JSON.parse(localStorage.getItem('allUsers') || '[]');
                const orders = JSON.parse(localStorage.getItem('userOrders') || '[]');

                statusDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${products.length}</div>
                            <div style="font-size: 12px; color: #666;">äº§å“</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${users.length}</div>
                            <div style="font-size: 12px; color: #666;">ç”¨æˆ·</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${orders.length}</div>
                            <div style="font-size: 12px; color: #666;">è®¢å•</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #dc3545;">æ— æ³•è¯»å–æœ¬åœ°æ•°æ®</div>`;
            }
        }

        // æ·»åŠ æµ‹è¯•æ—¥å¿—
        function addSyncTestLog(message, type = 'info') {
            const logDiv = document.getElementById('sync-test-log');
            if (!logDiv) return;

            const timestamp = new Date().toLocaleTimeString();
            let color = '#d4d4d4';
            let icon = 'â—';

            switch (type) {
                case 'success':
                    color = '#4ec9b0';
                    icon = 'âœ“';
                    break;
                case 'error':
                    color = '#f48771';
                    icon = 'âœ—';
                    break;
                case 'warning':
                    color = '#dcdcaa';
                    icon = 'âš ';
                    break;
                case 'info':
                    color = '#569cd6';
                    icon = 'â„¹';
                    break;
            }

            const logEntry = document.createElement('div');
            logEntry.style.color = color;
            logEntry.innerHTML = `<span style="color: #858585;">[${timestamp}]</span> ${icon} ${message}`;

            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ¸…ç©ºæµ‹è¯•æ—¥å¿—
        function clearSyncTestLog() {
            const logDiv = document.getElementById('sync-test-log');
            if (logDiv) {
                logDiv.innerHTML = '<div style="color: #4ec9b0;">æ—¥å¿—å·²æ¸…ç©º</div>';
            }
        }

        // æµ‹è¯•ä¸Šä¼ åˆ°äº‘ç«¯
        async function testUploadToCloud() {
            addSyncTestLog('å¼€å§‹æµ‹è¯•ä¸Šä¼ åŠŸèƒ½...', 'info');

            try {
                if (!cloudSync || !cloudSync.isInitialized) {
                    throw new Error('äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–');
                }

                addSyncTestLog('è¯»å–æœ¬åœ°æ•°æ®...', 'info');
                const products = JSON.parse(localStorage.getItem('products') || '[]');
                const users = JSON.parse(localStorage.getItem('allUsers') || '[]');
                const orders = JSON.parse(localStorage.getItem('userOrders') || '[]');

                addSyncTestLog(`æœ¬åœ°æ•°æ®: ${products.length} äº§å“, ${users.length} ç”¨æˆ·, ${orders.length} è®¢å•`, 'info');

                addSyncTestLog('ä¸Šä¼ äº§å“æ•°æ®...', 'info');
                await cloudSync.uploadData('products', products);

                addSyncTestLog('ä¸Šä¼ ç”¨æˆ·æ•°æ®...', 'info');
                await cloudSync.uploadData('users', users);

                addSyncTestLog('ä¸Šä¼ è®¢å•æ•°æ®...', 'info');
                await cloudSync.uploadData('orders', orders);

                addSyncTestLog('âœ“ æ‰€æœ‰æ•°æ®ä¸Šä¼ æˆåŠŸï¼', 'success');
                showNotification('âœ… æ•°æ®å·²æˆåŠŸä¸Šä¼ åˆ°äº‘ç«¯', 'success');

            } catch (error) {
                addSyncTestLog(`âœ— ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                showNotification('âŒ ä¸Šä¼ å¤±è´¥', 'error');
                console.error('ä¸Šä¼ å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•ä»äº‘ç«¯ä¸‹è½½
        async function testDownloadFromCloud() {
            addSyncTestLog('å¼€å§‹æµ‹è¯•ä¸‹è½½åŠŸèƒ½...', 'info');

            try {
                if (!cloudSync || !cloudSync.isInitialized) {
                    throw new Error('äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–');
                }

                addSyncTestLog('ä»äº‘ç«¯ä¸‹è½½äº§å“æ•°æ®...', 'info');
                const cloudProducts = await cloudSync.downloadData('products');

                addSyncTestLog('ä»äº‘ç«¯ä¸‹è½½ç”¨æˆ·æ•°æ®...', 'info');
                const cloudUsers = await cloudSync.downloadData('users');

                addSyncTestLog('ä»äº‘ç«¯ä¸‹è½½è®¢å•æ•°æ®...', 'info');
                const cloudOrders = await cloudSync.downloadData('orders');

                const productsCount = cloudProducts ? cloudProducts.length : 0;
                const usersCount = cloudUsers ? cloudUsers.length : 0;
                const ordersCount = cloudOrders ? cloudOrders.length : 0;

                addSyncTestLog(`äº‘ç«¯æ•°æ®: ${productsCount} äº§å“, ${usersCount} ç”¨æˆ·, ${ordersCount} è®¢å•`, 'info');

                if (cloudProducts) {
                    localStorage.setItem('products', JSON.stringify(cloudProducts));
                    addSyncTestLog('âœ“ äº§å“æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°', 'success');
                }

                if (cloudUsers) {
                    localStorage.setItem('allUsers', JSON.stringify(cloudUsers));
                    addSyncTestLog('âœ“ ç”¨æˆ·æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°', 'success');
                }

                if (cloudOrders) {
                    localStorage.setItem('userOrders', JSON.stringify(cloudOrders));
                    addSyncTestLog('âœ“ è®¢å•æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°', 'success');
                }

                addSyncTestLog('âœ“ æ‰€æœ‰æ•°æ®ä¸‹è½½æˆåŠŸï¼', 'success');
                showNotification('âœ… æ•°æ®å·²æˆåŠŸä»äº‘ç«¯ä¸‹è½½', 'success');
                updateSyncTestStatus();

                // åˆ·æ–°å½“å‰é¡µé¢æ˜¾ç¤º
                if (typeof loadProducts === 'function') {
                    loadProducts();
                }

            } catch (error) {
                addSyncTestLog(`âœ— ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
                showNotification('âŒ ä¸‹è½½å¤±è´¥', 'error');
                console.error('ä¸‹è½½å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•åŒå‘åŒæ­¥
        async function testSyncWithCloud() {
            addSyncTestLog('å¼€å§‹æµ‹è¯•åŒå‘åŒæ­¥åŠŸèƒ½...', 'info');

            try {
                if (!cloudSync || !cloudSync.isInitialized) {
                    throw new Error('äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–');
                }

                addSyncTestLog('æ‰§è¡ŒåŒå‘åŒæ­¥...', 'info');
                await cloudSync.syncAllData();

                addSyncTestLog('âœ“ åŒå‘åŒæ­¥å®Œæˆï¼', 'success');
                showNotification('âœ… æ•°æ®åŒæ­¥æˆåŠŸ', 'success');
                updateSyncTestStatus();

            } catch (error) {
                addSyncTestLog(`âœ— åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
                showNotification('âŒ åŒæ­¥å¤±è´¥', 'error');
                console.error('åŒæ­¥å¤±è´¥:', error);
            }
        }

        // åˆ›å»ºæµ‹è¯•æ•°æ®
        function testCreateTestData() {
            addSyncTestLog('åˆ›å»ºæµ‹è¯•æ•°æ®...', 'info');

            const testProduct = {
                id: 'test_' + Date.now(),
                name: 'æµ‹è¯•äº§å“ ' + new Date().toLocaleTimeString(),
                price: 99.99,
                stock: 100,
                category: 'æµ‹è¯•åˆ†ç±»',
                description: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•äº‘ç«¯åŒæ­¥çš„äº§å“',
                images: [],
                createdAt: new Date().toISOString()
            };

            const products = JSON.parse(localStorage.getItem('products') || '[]');
            products.push(testProduct);
            localStorage.setItem('products', JSON.stringify(products));

            addSyncTestLog(`âœ“ å·²åˆ›å»ºæµ‹è¯•äº§å“: ${testProduct.name}`, 'success');
            showNotification('âœ… æµ‹è¯•æ•°æ®å·²åˆ›å»º', 'success');
            updateSyncTestStatus();

            if (typeof loadProducts === 'function') {
                loadProducts();
            }
        }

        // æ¸…ç©ºäº‘ç«¯æ•°æ®
        async function testClearCloudData() {
            if (!confirm(t('confirmClearCloud'))) {
                return;
            }

            addSyncTestLog('æ¸…ç©ºäº‘ç«¯æ•°æ®...', 'warning');

            try {
                if (!cloudSync || !cloudSync.isInitialized) {
                    throw new Error('äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–');
                }

                await cloudSync.uploadData('products', []);
                await cloudSync.uploadData('users', []);
                await cloudSync.uploadData('orders', []);

                addSyncTestLog('âœ“ äº‘ç«¯æ•°æ®å·²æ¸…ç©º', 'success');
                showNotification('âœ… äº‘ç«¯æ•°æ®å·²æ¸…ç©º', 'success');

            } catch (error) {
                addSyncTestLog(`âœ— æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error');
                showNotification('âŒ æ¸…ç©ºå¤±è´¥', 'error');
            }
        }

        // æŸ¥çœ‹äº‘ç«¯æ•°æ®
        async function testViewCloudData() {
            addSyncTestLog('è·å–äº‘ç«¯æ•°æ®...', 'info');

            try {
                if (!cloudSync || !cloudSync.isInitialized) {
                    throw new Error('äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–');
                }

                const cloudProducts = await cloudSync.downloadData('products');
                const cloudUsers = await cloudSync.downloadData('users');
                const cloudOrders = await cloudSync.downloadData('orders');

                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ“¦ äº‘ç«¯æ•°æ®è¯¦æƒ…');
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('äº§å“æ•°æ®:', cloudProducts);
                console.log('ç”¨æˆ·æ•°æ®:', cloudUsers);
                console.log('è®¢å•æ•°æ®:', cloudOrders);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                const productsCount = cloudProducts ? cloudProducts.length : 0;
                const usersCount = cloudUsers ? cloudUsers.length : 0;
                const ordersCount = cloudOrders ? cloudOrders.length : 0;

                addSyncTestLog(`äº‘ç«¯æ•°æ®: ${productsCount} äº§å“, ${usersCount} ç”¨æˆ·, ${ordersCount} è®¢å•`, 'info');
                addSyncTestLog('è¯¦ç»†æ•°æ®å·²è¾“å‡ºåˆ°æ§åˆ¶å°', 'success');
                showNotification('è¯¦ç»†æ•°æ®å·²è¾“å‡ºåˆ°æ§åˆ¶å° (F12)', 'info');

            } catch (error) {
                addSyncTestLog(`âœ— è·å–å¤±è´¥: ${error.message}`, 'error');
                showNotification('âŒ è·å–å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•è‡ªåŠ¨åŒæ­¥
        async function testAutoSync() {
            addSyncTestLog('æµ‹è¯•è‡ªåŠ¨åŒæ­¥æœºåˆ¶...', 'info');

            if (!cloudSync || !cloudSync.isInitialized) {
                addSyncTestLog('âœ— äº‘ç«¯åŒæ­¥æœªåˆå§‹åŒ–', 'error');
                return;
            }

            addSyncTestLog('è‡ªåŠ¨åŒæ­¥åŠŸèƒ½æ­£å¸¸è¿è¡Œä¸­', 'success');
            addSyncTestLog('æ¯ 5 åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡', 'info');
            addSyncTestLog('æ•°æ®ä¿®æ”¹æ—¶ä¹Ÿä¼šè‡ªåŠ¨è§¦å‘åŒæ­¥', 'info');
            showNotification('è‡ªåŠ¨åŒæ­¥åŠŸèƒ½æ­£å¸¸', 'success');
        }

        // æµ‹è¯•å•ä¸ªç«¯ç‚¹
        async function testEndpoint(endpoint) {
            const startTime = Date.now();

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶

                const response = await fetch(endpoint.url, {
                    method: 'HEAD',
                    mode: 'no-cors', // é¿å… CORS é—®é¢˜
                    cache: 'no-cache',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const endTime = Date.now();

                return {
                    success: true,
                    time: endTime - startTime,
                    endpoint: endpoint.name
                };
            } catch (error) {
                const endTime = Date.now();
                let errorMsg = error.message;
                let suggestion = '';

                if (error.name === 'AbortError') {
                    errorMsg = 'è¿æ¥è¶…æ—¶ï¼ˆ>10ç§’ï¼‰';
                    suggestion = 'ç½‘ç»œé€Ÿåº¦è¿‡æ…¢æˆ–æœåŠ¡å™¨æ— å“åº”';
                } else if (errorMsg.includes('Failed to fetch')) {
                    errorMsg = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨';
                    suggestion = 'å¯èƒ½è¢«é˜²ç«å¢™é˜»æ­¢æˆ– DNS è§£æå¤±è´¥';
                } else if (errorMsg.includes('NetworkError')) {
                    errorMsg = 'ç½‘ç»œé”™è¯¯';
                    suggestion = 'æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä»£ç†è®¾ç½®';
                }

                return {
                    success: false,
                    time: endTime - startTime,
                    endpoint: endpoint.name,
                    error: errorMsg,
                    suggestion: suggestion
                };
            }
        }

        // æ›´æ–°ç”¨æˆ·ç•Œé¢çŠ¶æ€
        function updateUserInterface() {
            const loginLink = document.getElementById('login-link');
            const registerLink = document.getElementById('register-link');
            const logoutLink = document.getElementById('logout-link');
            const userCenterLink = document.getElementById('user-center-link');
            const myOrdersLink = document.getElementById('my-orders-link');
            const adminLink = document.getElementById('admin-link');
            const adminBottomNavBtn = document.getElementById('bottom-admin-btn');
            const usernameDisplay = document.getElementById('username-display');
            const userPointsBadge = document.getElementById('user-points-badge');
            const userPointsValue = document.getElementById('user-points-value');

            if (currentUser) {
                // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦è¢«ç¦ç”¨ï¼Œå¹¶è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
                const user = allUsers.find(u => u.account === currentUser.account);
                if (user && user.status === 'banned') {
                    // ç”¨æˆ·å·²è¢«ç¦ç”¨ï¼šå…ˆå°†æœ¬åœ°æ•°æ®å®‰å…¨åŒæ­¥åˆ°äº‘ç«¯ï¼Œç„¶åæ¸…ç©ºæœ¬åœ°æ•°æ®å¹¶å¼ºåˆ¶ç™»å‡º
                    (async () => {
                        try {
                            if (cloudSync && cloudSync.isInitialized) {
                                console.log('âš ï¸ æ£€æµ‹åˆ°è´¦å·è¢«ç¦ç”¨ï¼Œå¼€å§‹åœ¨é€€å‡ºå‰åŒæ­¥æ•°æ®åˆ°äº‘ç«¯...');
                                try {
                                    await cloudSync.syncOrders();
                                } catch (orderSyncError) {
                                    console.error('ç¦ç”¨ç™»å‡ºå‰åŒæ­¥è®¢å•åˆ°äº‘ç«¯å¤±è´¥:', orderSyncError);
                                }
                                try {
                                    await cloudSync.syncAddresses();
                                } catch (addressSyncError) {
                                    console.error('ç¦ç”¨ç™»å‡ºå‰åŒæ­¥åœ°å€åˆ°äº‘ç«¯å¤±è´¥:', addressSyncError);
                                }
                            } else {
                                console.warn('cloudSync æœªåˆå§‹åŒ–ï¼Œæ— æ³•åœ¨ç¦ç”¨ç™»å‡ºå‰æ‰§è¡Œäº‘ç«¯åŒæ­¥');
                            }
                        } catch (syncError) {
                            console.error('å¤„ç†ç¦ç”¨ç™»å‡ºå‰äº‘ç«¯åŒæ­¥æ—¶å‡ºé”™:', syncError);
                        }

                        // åœ¨æ•°æ®ä¸Šä¼ å°è¯•å®Œæˆåï¼Œæ¸…ç©ºæœ¬åœ°æ‰€æœ‰æ•°æ®
                        try {
                            if (typeof clearAllLocalDataOnLogout === 'function') {
                                clearAllLocalDataOnLogout();
                            } else {
                                console.warn('clearAllLocalDataOnLogout æœªå®šä¹‰ï¼Œè·³è¿‡æœ¬åœ°æ•°æ®æ¸…ç†');
                            }
                        } catch (clearError) {
                            console.error('ç¦ç”¨ç™»å‡ºæ—¶æ¸…ç©ºæœ¬åœ°æ•°æ®å‡ºé”™:', clearError);
                        }

                        // æœ€åæ›´æ–°å½“å‰ç”¨æˆ·çŠ¶æ€å¹¶åˆ·æ–°ç•Œé¢ä¸ºâ€œæœªç™»å½•â€
                        currentUser = null;
                        try {
                            localStorage.removeItem('currentUser');
                        } catch (e) {
                            console.warn('ç§»é™¤ localStorage[currentUser] æ—¶å‡ºé”™:', e);
                        }

                        loginLink.style.display = 'inline';
                        registerLink.style.display = 'inline';
                        logoutLink.style.display = 'none';
                        userCenterLink.style.display = 'none';
                        if (myOrdersLink) myOrdersLink.style.display = 'none';
                        adminLink.style.display = 'none';
                        usernameDisplay.textContent = 'ç”¨æˆ·å';
                        if (userPointsBadge) userPointsBadge.style.display = 'none';
                        if (adminBottomNavBtn) adminBottomNavBtn.style.display = 'none';

                        // è¿”å›é¦–é¡µ
                        document.getElementById('home-page').style.display = 'block';
                        document.getElementById('user-center').style.display = 'none';
                        document.getElementById('admin-panel').style.display = 'none';

                        showNotification('æ‚¨çš„è´¦å·å·²è¢«ç¦ç”¨ï¼Œæ­£åœ¨å®Œæˆæ•°æ®åŒæ­¥å¹¶å·²è‡ªåŠ¨é€€å‡ºç™»å½•', 'error');
                    })();

                    // ç«‹å³è¿”å›ï¼Œé¿å…ç»§ç»­æŒ‰ç…§â€œå·²ç™»å½•çŠ¶æ€â€æ›´æ–°ç•Œé¢
                    return;
                }

                // å¦‚æœåœ¨allUsersä¸­æ‰¾åˆ°ç”¨æˆ·ï¼Œæ›´æ–°currentUserçš„username
                if (user && user.username) {
                    currentUser.username = user.username;
                }

                loginLink.style.display = 'none';
                registerLink.style.display = 'none';
                logoutLink.style.display = 'inline';
                userCenterLink.style.display = 'inline';
                if (myOrdersLink) myOrdersLink.style.display = 'inline';
                usernameDisplay.textContent = currentUser.username;

                // æ˜¾ç¤ºå¹¶æ›´æ–°ç§¯åˆ†
                let safePoints = currentUser.points;
                if ((safePoints == null || isNaN(safePoints)) && currentUser.account) {
                    const latest = allUsers.find(u => u.account === currentUser.account);
                    if (latest && latest.points != null) {
                        safePoints = Number(latest.points);
                    }
                }
                if (safePoints == null || isNaN(safePoints)) {
                    safePoints = 1;
                } else {
                    safePoints = Number(safePoints);
                }
                currentUser.points = safePoints;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                if (userPointsBadge && userPointsValue) {
                    userPointsBadge.style.display = 'inline-flex';
                    userPointsValue.textContent = safePoints;
                }

                // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºåå°ç®¡ç†é“¾æ¥
                if (isAdmin()) {
                    adminLink.style.display = 'inline';
                    if (adminBottomNavBtn) adminBottomNavBtn.style.display = 'inline-block';
                } else {
                    adminLink.style.display = 'none';
                    if (adminBottomNavBtn) adminBottomNavBtn.style.display = 'none';
                }
            } else {
                loginLink.style.display = 'inline';
                registerLink.style.display = 'inline';
                logoutLink.style.display = 'none';
                userCenterLink.style.display = 'none';
                if (myOrdersLink) myOrdersLink.style.display = 'none';
                adminLink.style.display = 'none';
                usernameDisplay.textContent = 'ç”¨æˆ·å';
                if (userPointsBadge) userPointsBadge.style.display = 'none';
                if (adminBottomNavBtn) adminBottomNavBtn.style.display = 'none';
            }
        }

        // æ¸²æŸ“é¦–é¡µäº§å“åˆ—è¡¨
        function renderProducts(productsToRender) {
            const productsGrid = document.getElementById('products-grid');
            const productDetail = document.getElementById('product-detail');
            const topCarousel = document.querySelector('.carousel');

            if (!productsGrid || !productDetail) {
                console.info('é¦–é¡µå·²éšè—å•†å“å±•ç¤ºï¼ŒrenderProducts è·³è¿‡æ¸²æŸ“ã€‚');
                return;
            }

            productDetail.style.display = 'none';
            productsGrid.style.display = 'grid';

            if (!productsToRender || productsToRender.length === 0) {
                productsGrid.innerHTML = `<div class="no-products">${t('noProducts')}</div>`;
                return;
            }

            // è¿‡æ»¤æ‰æ— æ•ˆçš„äº§å“ï¼ˆundefinedã€null æˆ–ç¼ºå°‘å¿…è¦å±æ€§ï¼‰
            const validProducts = productsToRender.filter(product => 
                product && typeof product === 'object' && product.id && product.name
            );

            if (validProducts.length === 0) {
                productsGrid.innerHTML = `<div class="no-products">${t('noProducts')}</div>`;
                return;
            }

            productsGrid.innerHTML = validProducts.map(product => {
                if (!product) return ''; // é¢å¤–å®‰å…¨æ£€æŸ¥
                const categoryLabel = getCategoryLabel(product.category);
                const oldPrice = formatCurrency(product.price);
                const newPrice = formatCurrency(product.newPrice !== undefined ? product.newPrice : 0);
                const stock = (product && typeof product.stock !== 'undefined') ? product.stock : 0;
                return `
                    <article class="home-feature-card" data-product-id="${product.id}">
                        <div class="home-feature-image">
                            <img src="${getPrimaryProductImage(product)}" alt="${product.name || ''}">
                            <span class="home-feature-tag">${categoryLabel}</span>
                        </div>
                        <div class="home-feature-body">
                            <div>
                                <h3>${product.name || ''}</h3>
                                <div class="home-feature-price">
                                    <span style="text-decoration: line-through; color: #999; margin-right: 10px;">${oldPrice}</span>
                                    <span style="color: #e74c3c; font-weight: bold; font-size: 1.2em;">${newPrice}</span>
                                </div>
                                <div class="home-feature-stock">${t('stock')} ${stock} ${t('pieces')}</div>
                            </div>
                            <div class="home-feature-actions">
                                <button class="btn btn-primary view-detail">${t('viewDetail')}</button>
                                <button class="btn btn-secondary signup-btn" data-product-id="${product.id}">${t('claimNow')}</button>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');

            // é‡æ–°ç»‘å®šäº‹ä»¶
            document.querySelectorAll('.signup-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const productId = parseInt(this.getAttribute('data-product-id'), 10);
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        openSignupModal(product);
                    } else {
                        alert(t('systemError'));
                    }
                });
            });

            document.querySelectorAll('.view-detail').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productId = this.closest('.home-feature-card').getAttribute('data-product-id');
                    showProductDetail(parseInt(productId, 10));
                });
            });

            document.querySelectorAll('.home-feature-card').forEach(card => {
                card.addEventListener('click', function () {
                    const productId = this.getAttribute('data-product-id');
                    showProductDetail(parseInt(productId, 10));
                });
            });
        }

        // æ˜¾ç¤ºäº§å“è¯¦æƒ…
        function showProductDetail(productId) {
            // ä½¿ç”¨è§„èŒƒåŒ– IDï¼Œé¿å…å­—ç¬¦ä¸²/æ•°å­—æ··ç”¨å¯¼è‡´æ‰¾ä¸åˆ°äº§å“
            const product = products.find(p => normalizeOrderId(p.id) === normalizeOrderId(productId));
            if (!product) return;

            currentProduct = product;

            const productsGrid = document.getElementById('products-grid');
            const productDetail = document.getElementById('product-detail');
            const topCarousel = document.querySelector('.carousel');
            if (!productsGrid || !productDetail) {
                return;
            }

            const oldPrice = formatCurrency(product.price || 0);
            const newPrice = formatCurrency(product.newPrice !== undefined ? product.newPrice : 0);
            const imageUrls = getProductImageUrls(product);
            const hasMultipleImages = imageUrls.length > 1;
            
            // è·å–è¯¥äº§å“çš„è¯„ä»·åˆ—è¡¨
            const productReviews = (product.reviews || []).sort((a, b) => b.createdAt - a.createdAt);
            
            productDetail.innerHTML = `
                <div class="product-detail-content">
                    <div class="product-detail-image">
                        <div class="product-gallery">
                            <div class="product-gallery-main">
                                ${hasMultipleImages ? `
                                    <button type="button" class="product-gallery-arrow" data-action="prev"><i class="fas fa-chevron-left"></i></button>
                                ` : ''}
                                <div class="product-gallery-slides">
                                    ${imageUrls.map((url, index) => `
                                        <div class="product-gallery-slide ${index === 0 ? 'active' : ''}" data-index="${index}">
                                            <img src="${url}" alt="${product.name} ${index + 1}">
                                        </div>
                                    `).join('')}
                                </div>
                                ${hasMultipleImages ? `
                                    <button type="button" class="product-gallery-arrow" data-action="next"><i class="fas fa-chevron-right"></i></button>
                                ` : ''}
                            </div>
                            ${imageUrls.length ? `
                                <div class="product-gallery-thumbs">
                                    ${imageUrls.map((url, index) => `
                                        <button type="button" class="product-gallery-thumb ${index === 0 ? 'active' : ''}" data-index="${index}" aria-label="Preview image ${index + 1}">
                                            <img src="${url}" alt="${product.name} thumbnail ${index + 1}">
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="product-detail-info">
                        <h1 class="product-detail-title">${product.name}</h1>
                        <div class="product-detail-price">
                            <span style="text-decoration: line-through; color: #999; margin-right: 15px; font-size: 0.9em;">${oldPrice}</span>
                            <span style="color: #e74c3c; font-weight: bold; font-size: 1.3em;">${newPrice}</span>
                        </div>
                        <div class="product-detail-description">
                            <p>${product.description || ''}</p>
                            <p>${t('stock')}: ${(product && typeof product.stock !== 'undefined') ? product.stock : 0} ${t('pieces')}</p>
                        </div>
                        <div class="product-detail-actions">
                            <button class="btn btn-primary signup-now">${t('registerNow')}</button>
                            <button class="btn btn-secondary back-to-list">${t('returnToList')}</button>
                        </div>
                    </div>
                </div>
                
                <!-- è¯„ä»·åŒºåŸŸ -->
                <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #eee;">
                    <h2 style="margin-bottom: 20px; color: var(--primary); font-size: 24px;">
                        <i class="fas fa-star" style="margin-right: 8px; color: #ffc107;"></i>${t('reviews')} (${productReviews.length})
                    </h2>
                    
                    ${productReviews.length === 0 ? `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-comment-slash" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p style="font-size: 16px;">${t('noReviews')}</p>
                        </div>
                    ` : `
                        <div class="reviews-list" style="display: flex; flex-direction: column; gap: 20px;">
                            ${productReviews.map(review => `
                                <div class="review-item" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary);">
                                    ${isCurrentUserAdmin() ? `
                                        <div class="review-admin-actions">
                                            <button class="btn-icon" title="${t('deleteReview') || 'åˆ é™¤è¯„ä»·'}" onclick="deleteReview('${normalizeOrderId(review.orderId)}')">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    ` : ''}
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                        <div>
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                <strong style="font-size: 16px; color: var(--primary);">${review.userName || t('customerName')}</strong>
                                                ${review.userPhone ? `<span style="color: #999; font-size: 14px;">${review.userPhone}</span>` : ''}
                                            </div>
                                            <div class="review-rating" style="display: flex; gap: 3px; margin-bottom: 8px;">
                                                ${Array.from({length: 5}, (_, i) => `
                                                    <i class="fas fa-star" style="color: ${i < review.rating ? '#ffc107' : '#ddd'}; font-size: 14px;"></i>
                                                `).join('')}
                                                <span style="margin-left: 8px; color: #666; font-size: 14px;">${review.rating} ${t('stars')}</span>
                                            </div>
                                            <p style="color: #666; font-size: 13px; margin: 0;">
                                                <i class="fas fa-shopping-bag" style="margin-right: 5px;"></i>${t('purchasedProduct')}: ${review.productName || product.name}
                                            </p>
                                        </div>
                                        <div style="text-align: right; color: #999; font-size: 13px;">
                                            <i class="fas fa-clock" style="margin-right: 5px;"></i>${formatDate(review.createdAt)}
                                        </div>
                                    </div>
                                    <div class="review-comment" style="color: #333; line-height: 1.6; font-size: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                        ${review.comment}
                                        ${review.adminReply ? `
                                            <div class="admin-reply" style="margin-top: 15px; padding: 12px 15px; border-radius: 6px; background: #fff; border-left: 3px solid #3498db; font-size: 14px; color: #34495e;">
                                                <strong style="color:#3498db; margin-right:6px;">${t('adminReply') || 'ç®¡ç†å‘˜å›å¤'}ï¼š</strong>
                                                <span>${review.adminReply}</span>
                                            </div>
                                        ` : ''}
                                        ${Array.isArray(review.replies) && review.replies.length ? `
                                            <div class="customer-replies" style="margin-top: 15px; padding: 12px 15px; border-radius: 6px; background: #fff; border-left: 3px solid #2ecc71;">
                                                <strong style="color:#2ecc71; display:block; margin-bottom:8px;">${t('customerReplies') || 'ç”¨æˆ·å›å¤'}</strong>
                                                ${review.replies.map(reply => `
                                                    <div class="customer-reply-item" style="margin-bottom: 10px;">
                                                        <div style="display:flex; justify-content: space-between; font-size: 13px; color:#666; margin-bottom:4px;">
                                                            <span><i class="fas fa-user-circle" style="margin-right:6px;"></i>${reply.userName || t('customerName')}</span>
                                                            <span><i class="fas fa-clock" style="margin-right:6px;"></i>${formatDate(reply.createdAt)}</span>
                                                        </div>
                                                        <p style="margin:0; color:#34495e;">
                                                            ${reply.replyToUserName ? `<span style="color:#999;">@${reply.replyToUserName}</span> ` : ''}
                                                            ${reply.message}
                                                        </p>
                                                        <div style="margin-top:4px; display:flex; justify-content:flex-end; gap:8px; font-size:12px;">
                                                            ${currentUser ? `
                                                                <button class="btn btn-xs btn-link review-reply-btn"
                                                                    data-review-id="${review.reviewId}"
                                                                    data-product-id="${product.id}"
                                                                    data-target-type="reply"
                                                                    data-target-user="${reply.userName || t('customerName')}"
                                                                    data-target-reply-id="${reply.replyId}">
                                                                    <i class="fas fa-reply" style="margin-right:4px;"></i>${t('reply') || 'å›å¤'}
                                                                </button>
                                                            ` : ''}
                                                        </div>
                                                        ${isCurrentUserAdmin() ? `
                                                            <div class="customer-reply-admin-actions">
                                                                <button class="btn-icon" title="${t('deleteReview') || 'åˆ é™¤è¯„ä»·å›å¤'}"
                                                                    onclick="deleteReviewReply('${normalizeOrderId(product.id)}', '${review.reviewId}', '${reply.replyId}')">
                                                                    <i class="fas fa-trash-alt"></i>
                                                                </button>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${currentUser ? `
                                        <div class="review-actions" style="margin-top: 15px; text-align: right;">
                                            <button class="btn btn-sm btn-outline-primary review-reply-btn"
                                                data-review-id="${review.reviewId}"
                                                data-product-id="${product.id}"
                                                data-target-type="review"
                                                data-target-user="${review.userName || t('customerName')}">
                                                <i class="fas fa-reply" style="margin-right:6px;"></i>${t('reply') || 'å›å¤'}
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;

            productsGrid.style.display = 'none';
            productDetail.style.display = 'block';
            if (topCarousel) topCarousel.style.display = 'none';
            if (topCarousel) topCarousel.style.display = 'none';

            // ç»‘å®šæŒ‰é’®äº‹ä»¶ï¼Œç§»é™¤å†…è” onclick
            const signupNowBtn = document.querySelector('#product-detail .signup-now');
            const backBtn = document.querySelector('#product-detail .back-to-list');
            if (signupNowBtn) {
                signupNowBtn.addEventListener('click', function () {
                    openSignupModal(currentProduct);
                });
            }
            if (backBtn) {
                backBtn.addEventListener('click', function () {
                    showProductList();
                });
            }

            document.querySelectorAll('#product-detail .review-reply-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const pid = this.getAttribute('data-product-id');
                    const rid = this.getAttribute('data-review-id');
                    const targetType = this.getAttribute('data-target-type') || 'review';
                    const targetUser = this.getAttribute('data-target-user') || '';
                    const targetReplyId = this.getAttribute('data-target-reply-id') || null;
                    handleReviewReply(pid, rid, targetType, targetReplyId, targetUser);
                });
            });

            initProductGalleryControls();
        }

        // æ˜¾ç¤ºäº§å“åˆ—è¡¨
        function showProductList() {
            const productsGrid = document.getElementById('products-grid');
            const productDetail = document.getElementById('product-detail');
            const topCarousel = document.querySelector('.carousel');

            if (!productsGrid || !productDetail) {
                return;
            }

            productDetail.style.display = 'none';
            productsGrid.style.display = 'grid';
            if (topCarousel) topCarousel.style.display = 'block';
        }

        function initProductGalleryControls() {
            const gallery = document.querySelector('#product-detail .product-gallery');
            if (!gallery) return;

            const slides = Array.from(gallery.querySelectorAll('.product-gallery-slide'));
            const thumbs = Array.from(gallery.querySelectorAll('.product-gallery-thumb'));
            if (!slides.length) return;

            let currentIndex = slides.findIndex(slide => slide.classList.contains('active'));
            if (currentIndex < 0) currentIndex = 0;

            const showSlide = (index) => {
                if (!slides.length) return;
                const previousIndex = currentIndex;
                currentIndex = (index + slides.length) % slides.length;

                const directionClass = currentIndex > previousIndex ? 'slide-from-right' : 'slide-from-left';

                slides.forEach((slide, idx) => {
                    const isActive = idx === currentIndex;
                    slide.classList.toggle('active', isActive);
                    slide.classList.remove('slide-from-left', 'slide-from-right');
                    if (isActive) {
                        // è§¦å‘åŠ¨ç”»
                        slide.classList.add(directionClass);
                        slide.addEventListener('animationend', () => {
                            slide.classList.remove('slide-from-left', 'slide-from-right');
                        }, { once: true });
                    }
                });

                thumbs.forEach((thumb, idx) => thumb.classList.toggle('active', idx === currentIndex));
            };

            const prevBtn = gallery.querySelector('[data-action="prev"]');
            const nextBtn = gallery.querySelector('[data-action="next"]');

            if (prevBtn) {
                prevBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showSlide(currentIndex - 1);
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showSlide(currentIndex + 1);
                });
            }

            thumbs.forEach(thumb => {
                thumb.addEventListener('click', (e) => {
                    e.preventDefault();
                    const index = parseInt(thumb.getAttribute('data-index'), 10);
                    if (!isNaN(index)) {
                        showSlide(index);
                    }
                });
            });

            // ç§»åŠ¨ç«¯æ»‘åŠ¨åˆ‡æ¢
            let touchStartX = null;
            let touchStartY = null;

            gallery.addEventListener('touchstart', (e) => {
                if (!e.touches || !e.touches.length) return;
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
            }, { passive: true });

            gallery.addEventListener('touchend', (e) => {
                if (touchStartX === null || !e.changedTouches || !e.changedTouches.length) return;
                const touch = e.changedTouches[0];
                const deltaX = touch.clientX - touchStartX;
                const deltaY = touch.clientY - touchStartY;

                // åªæœ‰å·¦å³æ»‘åŠ¨æ˜æ˜¾æ—¶æ‰è§¦å‘ï¼Œé¿å…ä¸é¡µé¢ä¸Šä¸‹æ»šåŠ¨å†²çª
                if (Math.abs(deltaX) > 40 && Math.abs(deltaX) > Math.abs(deltaY)) {
                    if (deltaX < 0) {
                        // å‘å·¦æ»‘ï¼Œçœ‹ä¸‹ä¸€å¼ 
                        showSlide(currentIndex + 1);
                    } else {
                        // å‘å³æ»‘ï¼Œçœ‹ä¸Šä¸€å¼ 
                        showSlide(currentIndex - 1);
                    }
                }

                touchStartX = null;
                touchStartY = null;
            }, { passive: true });
        }

        function captureSignupFormData() {
            const form = document.getElementById('signup-form');
            if (!form) return null;

            return {
                email: document.getElementById('signup-email')?.value || '',
                notes: document.getElementById('signup-notes')?.value || '',
                address: document.getElementById('signup-address-hidden')?.value || ''
            };
        }

        function restoreSignupFormData() {
            if (!pendingSignupFormData) return;

            const { email, notes } = pendingSignupFormData;
            const emailInput = document.getElementById('signup-email');
            const notesInput = document.getElementById('signup-notes');

            if (emailInput) emailInput.value = email || '';
            if (notesInput) notesInput.value = notes || '';

            // åœ°å€éœ€è¦ç”¨æˆ·é‡æ–°é€‰æ‹©ï¼Œé¿å…æ—§å€¼å¤±æ•ˆ
            const addressHidden = document.getElementById('signup-address-hidden');
            if (addressHidden) {
                addressHidden.value = '';
            }

            pendingSignupFormData = null;
        }

        function prepareReturnToSignup() {
            pendingSignupFormData = captureSignupFormData();
            shouldReturnToSignup = true;
            if (currentProduct) {
                pendingSignupProduct = currentProduct;
            }
        }

        // æ‰“å¼€æŠ¥åæ¨¡æ€æ¡†
        function openSignupModal(product) {
            console.log('ğŸ“ æŠ¥åè°ƒè¯• - ç‚¹å‡»çš„äº§å“:', product);

            if (!currentUser) {
                // æœªç™»å½•æ—¶ï¼Œè®°å½•å¾…é¢†å–çš„äº§å“ï¼Œç„¶åæ‰“å¼€ç™»å½•/æ³¨å†Œé€‰æ‹©æ¨¡æ€æ¡†
                pendingSignupProduct = product;
                const authChoiceModal = document.getElementById('auth-choice-modal');
                if (authChoiceModal) {
                    authChoiceModal.style.display = 'flex';
                }
                return;
            }

            // âœ… æ£€æŸ¥æ˜¯å¦å·²ç»é¢†å–è¿‡è¯¥äº§å“
            if (currentUser && currentUser.account && Array.isArray(userOrders)) {
                const hasExisting = userOrders.some(o =>
                    o &&
                    o.productId === product.id &&
                    o.account === currentUser.account &&
                    o.status !== 'cancelled'
                );
                if (hasExisting) {
                    // ä½¿ç”¨å¼¹çª—æç¤ºï¼Œè€Œä¸æ˜¯é€šçŸ¥
                    customAlert(
                        t('productAlreadyClaimed') || 'è¿™ä¸ªäº§å“å·²ç»é¢†å–è¿‡å•¦ï¼Œå¿«å»çœ‹çœ‹å…¶å®ƒå¥½ç‰©å§ï¼',
                        t('infoTitle') || 'æç¤º'
                    );
                    return;
                }
            }

            // ğŸ’ é¢†å–å‰æ£€æŸ¥èœœç½
            try {
                const user = allUsers.find(u => u.account === currentUser.account);
                const currentPoints = (user && user.points != null && !isNaN(user.points))
                    ? Number(user.points)
                    : 1;

                if (currentPoints <= 0) {
                    // ä¹‹å‰ç”¨å³ä¸Šè§’æ°”æ³¡æç¤ºï¼Œç°åœ¨æ”¹ä¸ºå¼¹çª—æç¤ºï¼Œé¿å…"æ²¡ååº”"çš„æ„Ÿè§‰
                    const isEnglish = (typeof t === 'function' && t('pointsBalance') === 'Honey Balance') || 
                                      (typeof window !== 'undefined' && window.currentLanguage === 'en');
                    const alertMessage = isEnglish 
                        ? 'Balance: 0<br><br>â€¢ Write a review to earn <span class="honey-highlight">Honey</span>.<br><br>â€¢ Contact support for help.'
                        : 'ä½™é¢: 0<br><br>â€¢ å®Œæˆè¯„ä»·å¯è·å¾—<span class="honey-highlight">èœœç½</span>ã€‚<br><br>â€¢ å¦‚éœ€å¸®åŠ©ï¼Œè¯·è”ç³»å®¢æœã€‚';
                    const alertTitle = isEnglish ? 'Out of Honey' : 'èœœç½ä¸è¶³';
                    customAlert(alertMessage, alertTitle);
                    return;
                }
            } catch (err) {
                console.warn('æ£€æŸ¥é¢†å–èœœç½æ—¶å‡ºé”™ï¼Œå…è®¸ç»§ç»­é¢†å–ä»¥é¿å…é˜»å¡:', err);
            }

            if (!product) {
                console.error('âŒ æŠ¥åå¤±è´¥ï¼šäº§å“æ•°æ®ä¸ºç©º');
                customAlert(t('systemError'), t('errorTitle'));
                return;
            }

            currentProduct = product;
            const signupModal = document.getElementById('signup-modal');

            // å¡«å……äº§å“ä¿¡æ¯
            document.getElementById('signup-product-name').value = product.name;

            // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œé¢„å¡«ç”¨æˆ·ä¿¡æ¯
            if (currentUser) {
                const emailInput = document.getElementById('signup-email');
                if (emailInput) {
                    emailInput.value = currentUser.account.includes('@') ? currentUser.account : '';
                }
            }

            // æ›´æ–°åœ°å€é€‰æ‹©å™¨
            updateSignupAddressSelector();

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            signupModal.style.display = 'flex';
            console.log('âœ… æŠ¥åæ¨¡æ€æ¡†å·²æ‰“å¼€');

            if (pendingSignupFormData) {
                restoreSignupFormData();
            }
        }

        // æ›´æ–°æŠ¥åè¡¨å•ä¸­çš„åœ°å€é€‰æ‹©å™¨
        function updateSignupAddressSelector() {
            const addressSelect = document.getElementById('signup-address-select');
            const addressBtn = document.getElementById('signup-address-btn');
            const addressHidden = document.getElementById('signup-address-hidden');
            
            if (!addressSelect || !addressBtn || !addressHidden) return;

            // è·å–å½“å‰ç”¨æˆ·çš„åœ°å€åˆ—è¡¨ï¼ˆä¼˜å…ˆä½¿ç”¨å…¨å±€å˜é‡ï¼Œç¡®ä¿æ•°æ®åŒæ­¥ï¼‰
            let addresses = [];
            if (currentUser && currentUser.account) {
                // ä¼˜å…ˆä½¿ç”¨å…¨å±€å˜é‡ userAddresses
                if (Array.isArray(userAddresses) && userAddresses.length > 0) {
                    addresses = userAddresses.filter(addr => !addr.account || addr.account === currentUser.account);
                } else {
                    // å¦‚æœå…¨å±€å˜é‡ä¸ºç©ºï¼Œä» localStorage è¯»å–
                    const userAddressesKey = `userAddresses_${currentUser.account}`;
                    addresses = JSON.parse(localStorage.getItem(userAddressesKey)) || JSON.parse(localStorage.getItem('userAddresses')) || [];
                    // è¿‡æ»¤æ‰ä¸å±äºå½“å‰ç”¨æˆ·çš„åœ°å€
                    addresses = addresses.filter(addr => !addr.account || addr.account === currentUser.account);
                }
            } else {
                // æœªç™»å½•ç”¨æˆ·ï¼Œä½¿ç”¨å…¨å±€å˜é‡æˆ– localStorage
                addresses = Array.isArray(userAddresses) && userAddresses.length > 0 
                    ? userAddresses 
                    : JSON.parse(localStorage.getItem('userAddresses')) || [];
            }

            // æ¸…ç©ºé€‰æ‹©å™¨
            addressSelect.innerHTML = '<option value="">è¯·é€‰æ‹©åœ°å€</option>';
            addressHidden.value = '';

            if (addresses.length > 0) {
                // æœ‰åœ°å€ï¼Œæ˜¾ç¤ºä¸‹æ‹‰é€‰æ‹©æ¡†
                addressSelect.style.display = 'block';
                addressBtn.style.display = 'none';

                // å¡«å……åœ°å€é€‰é¡¹
                addresses.forEach((address) => {
                    // æ„å»ºå®Œæ•´åœ°å€å­—ç¬¦ä¸²
                    const fullAddress = address.state 
                        ? [
                            address.detail,
                            address.unit,
                            address.city,
                            address.state,
                            address.postal
                          ].filter(Boolean).join(', ')
                        : [
                            address.province || '',
                            address.city || '',
                            address.district || '',
                            address.detail || ''
                          ].filter(Boolean).join(' ');

                    const addressText = `${address.name} - ${address.phone} - ${fullAddress}${address.isDefault ? ' (é»˜è®¤)' : ''}`;
                    const option = document.createElement('option');
                    const payload = JSON.stringify({
                        name: address.name,
                        phone: address.phone,
                        address: fullAddress,
                        detail: address.detail || address.street || '',
                        unit: address.unit || '',
                        city: address.city || '',
                        state: address.state || '',
                        postal: address.postal || address.zip || '',
                        country: address.country || 'US',
                        full: addressText
                    });
                    option.value = payload;
                    option.textContent = addressText;
                    if (address.isDefault) {
                        option.selected = true;
                        addressHidden.value = payload;
                    }
                    addressSelect.appendChild(option);
                });

                // å¦‚æœæ²¡æœ‰é»˜è®¤åœ°å€ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæœ‰æ•ˆåœ°å€
                if (!addressHidden.value && addressSelect.options.length > 1) {
                    addressSelect.options[1].selected = true;
                    addressHidden.value = addressSelect.options[1].value;
                }

                // ç›‘å¬åœ°å€é€‰æ‹©å˜åŒ–
                addressSelect.onchange = function() {
                    if (this.value) {
                        addressHidden.value = this.value;
                    } else {
                        addressHidden.value = '';
                    }
                };
            } else {
                // æ²¡æœ‰åœ°å€ï¼Œæ˜¾ç¤ºè·³è½¬æŒ‰é’®
                addressSelect.style.display = 'none';
                addressBtn.style.display = 'block';
                
                // æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼šè·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒåœ°å€é¡µé¢
                // å…ˆç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
                const newAddressBtn = addressBtn.cloneNode(true);
                addressBtn.parentNode.replaceChild(newAddressBtn, addressBtn);
                
                // é‡æ–°è·å–æŒ‰é’®å¼•ç”¨
                const updatedAddressBtn = document.getElementById('signup-address-btn');
                if (updatedAddressBtn) {
                    // æ›´æ–°æŒ‰é’®æ–‡æœ¬ï¼ˆå›½é™…åŒ–ï¼‰
                    const btnText = document.getElementById('signup-address-btn-text');
                    if (btnText && typeof t === 'function') {
                        btnText.textContent = t('goToAddressPage');
                    }
                    
                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    updatedAddressBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        prepareReturnToSignup();
                        
                        console.log('ğŸ“ ç‚¹å‡»äº†"å‰å¾€ç”¨æˆ·ä¸­å¿ƒæ·»åŠ åœ°å€"æŒ‰é’®');
                        
                        // å…³é—­æŠ¥åæ¨¡æ€æ¡†
                        if (typeof closeModal === 'function') {
                            closeModal('signup-modal');
                        }
                        
                        // æ˜¾ç¤ºç”¨æˆ·ä¸­å¿ƒå¹¶åˆ‡æ¢åˆ°åœ°å€é¡µé¢
                        if (typeof showUserCenter === 'function') {
                            showUserCenter();
                        }
                        
                        if (typeof showUserPage === 'function') {
                            showUserPage('address');
                        }
                        
                        // æ‰“å¼€åœ°å€æ·»åŠ æ¨¡æ€æ¡†
                        setTimeout(() => {
                            const addressModal = document.getElementById('address-modal');
                            if (addressModal) {
                                addressModal.style.display = 'flex';
                                console.log('âœ… åœ°å€æ·»åŠ æ¨¡æ€æ¡†å·²æ‰“å¼€');
                            } else {
                                console.warn('âš ï¸ æœªæ‰¾åˆ°åœ°å€æ·»åŠ æ¨¡æ€æ¡†');
                            }
                        }, 300);
                        
                        // æç¤ºç”¨æˆ·éœ€è¦å¡«å†™åœ°å€
                        const currentLang = localStorage.getItem('language') || 'zh';
                        if (typeof showNotification === 'function') {
                            showNotification(currentLang === 'zh' ? 'è¯·å…ˆå¡«å†™æ”¶è´§åœ°å€' : 'Please fill in your shipping address first', 'info');
                        }
                    });
                    
                    console.log('âœ… åœ°å€æŒ‰é’®ç‚¹å‡»äº‹ä»¶å·²ç»‘å®š');
                } else {
                    console.error('âŒ æ— æ³•æ‰¾åˆ°åœ°å€æŒ‰é’®å…ƒç´ ');
                }
            }
        }

        // æ¸²æŸ“ç”¨æˆ·è®¢å•
        function renderUserOrders() {
            const orderContainers = {
                'all': document.getElementById('order-all'),
                'pending': document.getElementById('order-pending'),
                'review': document.getElementById('order-review'),
                'shipping': document.getElementById('order-shipping'),
                'completed': document.getElementById('order-completed'),
                'rejected': document.getElementById('order-rejected'),
                'cancelled': document.getElementById('order-cancelled')
            };

            // æ¸…ç©ºæ‰€æœ‰è®¢å•å®¹å™¨
            Object.values(orderContainers).forEach(container => {
                if (container) container.innerHTML = '';
            });

            // ç¡®ä¿userOrdersæ˜¯æ•°ç»„ä¸”åªåŒ…å«å½“å‰ç”¨æˆ·çš„è®¢å•
            if (!Array.isArray(userOrders)) {
                userOrders = [];
            }

            // è¿‡æ»¤æ‰ä¸å±äºå½“å‰ç”¨æˆ·çš„è®¢å•ï¼ˆå¦‚æœæœ‰accountå­—æ®µï¼‰
            if (currentUser && currentUser.account) {
                userOrders = userOrders.filter(order => {
                    // å¦‚æœè®¢å•æœ‰accountå­—æ®µï¼Œåªæ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„è®¢å•
                    if (order.account) {
                        return order.account === currentUser.account;
                    }
                    // æ—§æ•°æ®æ²¡æœ‰accountå­—æ®µï¼Œä¿ç•™ï¼ˆå…¼å®¹æ€§ï¼‰
                    return true;
                });
            }

            if (userOrders.length === 0) {
                if (orderContainers.all) orderContainers.all.innerHTML = `<p style="text-align: center; color: #999; padding: 40px;">${t('noOrders')}</p>`;
                if (orderContainers.review) orderContainers.review.innerHTML = `<p style="text-align: center; color: #999; padding: 40px;">${t('noReviewOrders')}</p>`;
                if (orderContainers.shipping) orderContainers.shipping.innerHTML = `<p style="text-align: center; color: #999; padding: 40px;">${t('noShippingOrders')}</p>`;
                if (orderContainers.completed) orderContainers.completed.innerHTML = `<p style="text-align: center; color: #999; padding: 40px;">${t('noCompletedOrders')}</p>`;
                if (orderContainers.rejected) orderContainers.rejected.innerHTML = `<p style="text-align: center; color: #999; padding: 40px;">${t('noRejectedOrders')}</p>`;
                if (orderContainers.cancelled) orderContainers.cancelled.innerHTML = `<p style="text-align: center; color: #999; padding: 40px;">${t('noCancelledOrders')}</p>`;
                return;
            }

            userOrders.forEach(order => {
                // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºå–æ¶ˆè®¢å•æŒ‰é’®ï¼ˆè¿è¾“ä¸­ä¹‹å‰çš„çŠ¶æ€ï¼špendingæˆ–reviewï¼‰
                // ä¸åŒºåˆ†ç®¡ç†å‘˜ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥å–æ¶ˆè®¢å•
                const isPendingOrReview = order.status === 'pending' || order.status === 'review';
                const canCancel = isPendingOrReview && currentUser;
                
                // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºè¯„ä»·æŒ‰é’®ï¼ˆå·²å®Œæˆä¸”æœªè¯„ä»·ï¼‰
                // ä¸åŒºåˆ†ç®¡ç†å‘˜ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è¯„ä»·
                const isCompleted = order.status === 'completed';
                const hasNotReviewed = !order.hasReview || order.hasReview === false || order.hasReview === 'false';
                const showReviewBtn = isCompleted && currentUser && hasNotReviewed;
                
                const relatedProduct = products.find(p => p.id === order.productId);
                const originalPrice = relatedProduct && relatedProduct.price !== undefined
                    ? relatedProduct.price
                    : (order.originalPrice !== undefined ? order.originalPrice : order.price || 0);
                const promoPriceRaw = relatedProduct && relatedProduct.newPrice !== undefined
                    ? relatedProduct.newPrice
                    : (order.promoPrice !== undefined ? order.promoPrice : 0);
                const formattedOldPrice = formatCurrency(originalPrice);
                const formattedNewPrice = formatCurrency(promoPriceRaw);
                const formattedDate = formatDate(order.date);

                const orderHtml = `
                    <div class="order-item" data-order-id="${order.id}" style="cursor: pointer; position: relative;">
                        <div class="order-image" style="background-image: url('${order.image}')"></div>
                        <div class="order-details" style="flex: 1;">
                            <div class="order-title">${order.productName}</div>
                            <div class="order-price">
                                <span class="order-price-old">${formattedOldPrice}</span>
                                <span class="order-price-new">${formattedNewPrice}</span>
                            </div>
                            ${formattedDate ? `<div class="order-date">${formattedDate}</div>` : ''}
                            <div style="display: flex; align-items: center; gap: 8px; margin: 8px 0;">
                                <span style="font-weight: 500; color: #666;">${t('orderId')}:</span>
                                <span style="font-family: monospace; color: var(--primary); font-weight: 500;">${order.id}</span>
                                <button type="button" class="btn order-copy-btn" onclick="event.stopPropagation(); copyOrderId('${order.id}');" title="${t('copyOrderId') || 'å¤åˆ¶è®¢å•å·'}">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="order-status status-${order.status}" style="margin: 8px 0;">${getStatusText(order.status)}</div>
                            ${(canCancel || showReviewBtn) ? `
                            <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                                ${canCancel ? `
                                    <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); cancelOrder(${order.id});" 
                                            style="padding: 8px 16px; font-size: 13px; border-radius: 6px; font-weight: 500; box-shadow: 0 2px 4px rgba(231,76,60,0.2); transition: all 0.3s;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(231,76,60,0.3)';"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(231,76,60,0.2)';">
                                        <i class="fas fa-times-circle" style="margin-right: 6px;"></i>${t('cancelOrder')}
                                    </button>
                                ` : ''}
                                ${showReviewBtn ? `
                                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openReviewModal(${order.id});" 
                                            style="padding: 8px 16px; font-size: 13px; border-radius: 6px; font-weight: 500; box-shadow: 0 2px 4px rgba(52,152,219,0.2); transition: all 0.3s;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(52,152,219,0.3)';"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(52,152,219,0.2)';">
                                        <i class="fas fa-star" style="margin-right: 6px;"></i>${t('writeReview')}
                                    </button>
                                ` : ''}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                // æ·»åŠ åˆ°å…¨éƒ¨è®¢å•
                orderContainers.all.innerHTML += orderHtml;

                // æ·»åŠ åˆ°å¯¹åº”çŠ¶æ€è®¢å•
                // pendingçŠ¶æ€ä¹Ÿæ˜¾ç¤ºåœ¨reviewå®¹å™¨ä¸­
                if (order.status === 'pending' && orderContainers.review) {
                    orderContainers.review.innerHTML += orderHtml;
                } else if (orderContainers[order.status]) {
                    orderContainers[order.status].innerHTML += orderHtml;
                }
            });

            // ä¸ºæ‰€æœ‰è®¢å•é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.order-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    const orderId = this.getAttribute('data-order-id');
                    if (orderId) {
                        // ä½¿ç”¨normalizeOrderIdç¡®ä¿å…¼å®¹æ–°æ—§è®¢å•IDæ ¼å¼ï¼ˆæ•°å­—æˆ–å­—ç¬¦ä¸²ï¼‰
                        showOrderDetailsModal(normalizeOrderId(orderId));
                    }
                });
            });

            // å¤„ç†ç©ºçŠ¶æ€
            Object.entries(orderContainers).forEach(([status, container]) => {
                if (status !== 'all' && container && container.innerHTML === '') {
                    let emptyText = '';
                    if (status === 'review') emptyText = t('noReviewOrders');
                    else if (status === 'shipping') emptyText = t('noShippingOrders');
                    else if (status === 'completed') emptyText = t('noCompletedOrders');
                    else if (status === 'rejected') emptyText = t('noRejectedOrders');
                    else if (status === 'cancelled') emptyText = t('noCancelledOrders');
                    else emptyText = t('noOrders');
                    container.innerHTML = `<p style="text-align: center; color: #999; padding: 40px;">${emptyText}</p>`;
                }
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': t('orderReview'), // pendingçŠ¶æ€ä¹Ÿæ˜¾ç¤ºä¸º"å¾…ä¸Šä¼ "
                'review': t('orderReview'),
                'shipping': t('orderShipping'),
                'rejected': t('orderRejected'),
                'cancelled': t('orderCancelled'),
                'completed': t('orderCompleted')
            };
            return statusMap[status] || status;
        }

        function formatDeviceLabel(deviceId) {
            if (!deviceId) return '';
            const cleanId = String(deviceId).trim();
            if (!cleanId) return '';
            const suffix = cleanId.slice(-4).toUpperCase();
            return `è®¾å¤‡${suffix}`;
        }

        function getCategoryLabel(category) {
            if (currentLanguage === 'en') {
                const map = {
                    'electronics': 'Electronics',
                    'home': 'Home & Living',
                    'clothing': 'Clothing & Shoes',
                    'beauty': 'Beauty & Skincare'
                };
                return map[category] || 'Featured';
            } else {
            const map = {
                'electronics': 'ç”µå­äº§å“',
                'home': 'å®¶å±…ç”¨å“',
                'clothing': 'æœé¥°é‹åŒ…',
                'beauty': 'ç¾å¦†æŠ¤ç†'
            };
            return map[category] || 'ç²¾é€‰å¥½ç‰©';
            }
        }

        // åå°ç®¡ç†é¡µé¢åˆ‡æ¢
        function showAdminPage(tab) {
            const pages = document.querySelectorAll('.admin-page');
            pages.forEach(page => page.classList.remove('active'));

            switch (tab) {
                case 'products':
                    document.getElementById('admin-products').classList.add('active');
                    renderAdminProducts();
                    break;
                case 'users':
                    document.getElementById('admin-users').classList.add('active');
                    renderUsersTable();
                    // å¦‚æœè®¾å¤‡é™åˆ¶åˆ—è¡¨å·²å±•å¼€ï¼Œæ›´æ–°æ˜¾ç¤º
                    const deviceLimitsList = document.getElementById('device-limits-list');
                    if (deviceLimitsList && deviceLimitsList.style.display !== 'none') {
                        updateDeviceLimitsList();
                    }
                    break;
                case 'orders':
                    document.getElementById('admin-orders').classList.add('active');
                    // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œç¡®ä¿åŠ è½½æ‰€æœ‰è®¢å•
                    if (currentUser && currentUser.role === 'admin' && cloudSync && cloudSync.isInitialized) {
                        // å¦‚æœå…¨å±€è®¢å•æ•°ç»„ä¸ºç©ºæˆ–å¾ˆå°‘ï¼Œå°è¯•ä»äº‘ç«¯åŠ è½½
                        if (allOrders.length === 0 || allOrders.length < userOrders.length) {
                            cloudSync.loadAllOrders().then(() => {
                                renderOrdersTable();
                            }).catch(err => {
                                console.error('åŠ è½½æ‰€æœ‰è®¢å•å¤±è´¥:', err);
                                renderOrdersTable(); // å³ä½¿å¤±è´¥ä¹Ÿæ¸²æŸ“å½“å‰æ•°æ®
                            });
                        } else {
                            renderOrdersTable();
                        }
                    } else {
                        renderOrdersTable();
                    }
                    break;
                case 'reviews':
                    document.getElementById('admin-reviews').classList.add('active');
                    renderReviewsTable();
                    break;
                case 'homepage':
                    document.getElementById('admin-homepage').classList.add('active');
                    loadHomepageSettings();
                    break;
                case 'statistics':
                    document.getElementById('admin-statistics').classList.add('active');
                    renderStatistics();
                    break;
            }
        }

        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');

            // åªå±•ç¤ºæ™®é€šç”¨æˆ·ï¼ˆå†…ç½®ç®¡ç†å‘˜è´¦å·ä¸åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºï¼‰
            const allUsersList = [...allUsers];

            // ç»Ÿè®¡æ¯ä¸ªè®¾å¤‡IDæ³¨å†Œçš„è´¦å·æ•°é‡ï¼ˆä»…æ™®é€šç”¨æˆ·ï¼‰
            const deviceUserCountMap = {};
            allUsersList.forEach(user => {
                if (user.role !== 'admin' && user.deviceId) {
                    deviceUserCountMap[user.deviceId] = (deviceUserCountMap[user.deviceId] || 0) + 1;
                }
            });

            if (allUsersList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
                return;
            }

            // ç§»é™¤å·²ä¸å­˜åœ¨çš„é€‰ä¸­è´¦å·
            selectedUserAccounts.forEach(account => {
                if (!allUsersList.some(u => u.account === account && u.role !== 'admin')) {
                    selectedUserAccounts.delete(account);
                }
            });

            let filteredUsers = allUsersList.filter(user => {
                const userStatus = user.status || 'active';

                if (userFilterRole && user.role !== userFilterRole) {
                    return false;
                }

                if (userFilterStatus && userStatus !== userFilterStatus) {
                    return false;
                }

                if (userDeviceFilter) {
                    const filterValue = userDeviceFilter.toLowerCase();
                    const rawDevice = (user.deviceId || '').toLowerCase();
                    const label = formatDeviceLabel(user.deviceId).toLowerCase();
                    if (!rawDevice.includes(filterValue) && !label.includes(filterValue)) {
                        return false;
                    }
                }

                if (userSearchTerm) {
                    const term = userSearchTerm.toLowerCase();
                    const fields = [
                        user.username || '',
                        user.account || '',
                        user.email || '',
                        user.phone || ''
                    ];
                    const matched = fields.some(field => field.toLowerCase().includes(term));
                    if (!matched) {
                        return false;
                    }
                }

                return true;
            });

            if (filteredUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·</td></tr>';
                updatePaginationControls('users', 0);
                return;
            }

            const { items: paginatedUsers } = getPaginatedItems(filteredUsers, 'users');

            tbody.innerHTML = paginatedUsers.map(user => {
                // è·å–ç”¨æˆ·å¯†ç 
                let userPassword = '******';
                if (user.role === 'admin') {
                    const adminInfo = ADMIN_ACCOUNTS[user.account];
                    userPassword = adminInfo ? adminInfo.password : 'ç³»ç»Ÿé¢„è®¾';
                } else {
                    userPassword = user.password || 'æœªè®¾ç½®';
                }

                // è·å–ç”¨æˆ·çŠ¶æ€
                const userStatus = user.status || 'active';
                const userPoints = (user.points == null || isNaN(user.points)) ? 1 : Number(user.points);
                const statusBadge = userStatus === 'banned'
                    ? '<span class="status-badge status-banned">å·²ç¦ç”¨</span>'
                    : '<span class="status-badge status-active">æ­£å¸¸</span>';

                // æ˜¯å¦ä¸ºåŒè®¾å¤‡æ³¨å†Œçš„å¤šä¸ªè´¦å·ï¼ˆæ™®é€šç”¨æˆ·ï¼‰
                const isSuspiciousDevice =
                    user.role !== 'admin' &&
                    user.deviceId &&
                    deviceUserCountMap[user.deviceId] > 1;

                const deviceLabel = formatDeviceLabel(user.deviceId);
                // è·å–è®¾å¤‡æ³¨å†Œé™åˆ¶ä¿¡æ¯
                const deviceLimit = user.deviceId ? getDeviceRegisterLimit(user.deviceId) : null;
                const deviceCurrentCount = user.deviceId ? (deviceUserCountMap[user.deviceId] || 0) : 0;
                const deviceLimitInfo = user.deviceId && deviceLimit !== null
                    ? ` (${deviceCurrentCount}/${deviceLimit})`
                    : '';
                const suspiciousBadge = isSuspiciousDevice && deviceLabel
                    ? `<span class="status-badge status-pending" style="margin-left:6px;" title="åŒä¸€è®¾å¤‡æ³¨å†Œäº†å¤šä¸ªè´¦å·${deviceLimitInfo ? 'ï¼Œé™åˆ¶ï¼š' + deviceLimit + 'ï¼Œå½“å‰ï¼š' + deviceCurrentCount : ''}">${deviceLabel}${deviceLimitInfo}</span>`
                    : (deviceLabel ? `<span class="status-badge" style="margin-left:6px; background-color: #6c757d; color: white;" title="è®¾å¤‡æ³¨å†Œé™åˆ¶ï¼š${deviceLimit}ï¼Œå½“å‰ï¼š${deviceCurrentCount}">${deviceLabel}${deviceLimitInfo}</span>` : '');

                let rowStyle = '';
                if (userStatus === 'banned') {
                    rowStyle = 'style="opacity: 0.6; background-color: #fff3f3;"';
                } else if (isSuspiciousDevice) {
                    rowStyle = 'style="background-color: #fffdf3;"';
                }

                const selectable = user.role !== 'admin';
                const isChecked = selectable && selectedUserAccounts.has(user.account);

                return `
                    <tr ${rowStyle}>
                        <td class="select-col">
                            ${selectable ? `<input type="checkbox" class="user-select-checkbox" data-account="${user.account}" ${isChecked ? 'checked' : ''}>` : ''}
                        </td>
                        <td>${user.id}</td>
                        <td>${user.username || ''}${suspiciousBadge}</td>
                        <td>${user.account}</td>
                        <td>${userPassword}</td>
                        <td><span class="status-badge ${user.role === 'admin' ? 'status-active' : 'status-inactive'}">${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</span></td>
                        <td>${user.registerTime}</td>
                        <td>${userPoints}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewUserDetails('${user.account}')">æŸ¥çœ‹</button>
                            ${user.role !== 'admin' ? (
                        userStatus === 'banned'
                            ? `<button class="btn btn-sm btn-success" onclick="unbanUser('${user.account}')">è§£ç¦</button>`
                            : `<button class="btn btn-sm btn-danger" onclick="banUser('${user.account}')">ç¦ç”¨</button>`
                    ) : ''}
                            ${user.role !== 'admin' ? `<button class="btn btn-sm btn-danger" onclick="deleteUserAccount('${user.account}')" style="background-color: #c0392b;">åˆ é™¤è´¦å·</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');

            // ç»‘å®šå¤šé€‰äº‹ä»¶
            const userCheckboxes = tbody.querySelectorAll('.user-select-checkbox');
            userCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const account = checkbox.getAttribute('data-account');
                    if (checkbox.checked) {
                        selectedUserAccounts.add(account);
                    } else {
                        selectedUserAccounts.delete(account);
                    }
                    refreshUserSelectionUI();
                });
            });

            refreshUserSelectionUI();
            updatePaginationControls('users', filteredUsers.length, renderUsersTable);
        }

        function refreshUserSelectionUI() {
            const batchDeleteBtn = document.getElementById('delete-selected-users-btn');
            const selectAllCheckbox = document.getElementById('select-all-users');
            const checkboxes = document.querySelectorAll('.user-select-checkbox');
            const selectedCount = selectedUserAccounts.size;

            if (batchDeleteBtn) {
                batchDeleteBtn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
                batchDeleteBtn.textContent = selectedCount > 0
                    ? `æ‰¹é‡åˆ é™¤è´¦å· (${selectedCount})`
                    : 'æ‰¹é‡åˆ é™¤è´¦å·';
            }

            if (selectAllCheckbox) {
                const total = checkboxes.length;
                const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
                if (total === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = checked === total;
                    selectAllCheckbox.indeterminate = checked > 0 && checked < total;
                }
            }
        }

        // æ¸²æŸ“è®¢å•è¡¨æ ¼
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            const statusFilter = document.getElementById('order-status-filter').value;
            const searchTerm = document.getElementById('order-search').value.toLowerCase();
            const searchFieldSelect = document.getElementById('order-search-field');
            const searchField = searchFieldSelect ? searchFieldSelect.value : 'all';

            // åå°ç®¡ç†æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„è®¢å•ï¼Œæ™®é€šç”¨æˆ·åªæ˜¾ç¤ºè‡ªå·±çš„è®¢å•
            let ordersToDisplay = [];
            if (currentUser && currentUser.role === 'admin') {
                // ç®¡ç†å‘˜ï¼šæ˜¾ç¤ºæ‰€æœ‰è®¢å•
                if (allOrders.length === 0) {
                    // å¦‚æœå…¨å±€è®¢å•æ•°ç»„ä¸ºç©ºï¼Œå°è¯•ä»localStorageåŠ è½½
                    const savedAllOrders = localStorage.getItem('allOrders');
                    if (savedAllOrders) {
                        try {
                            allOrders = JSON.parse(savedAllOrders);
                            ordersToDisplay = allOrders;
                        } catch (e) {
                            console.error('è§£æä¿å­˜çš„æ‰€æœ‰è®¢å•å¤±è´¥:', e);
                            ordersToDisplay = userOrders; // ä¸´æ—¶ä½¿ç”¨å½“å‰ç”¨æˆ·è®¢å•
                        }
                    } else {
                        // å¦‚æœlocalStorageä¹Ÿæ²¡æœ‰ï¼Œå¼‚æ­¥åŠ è½½æ‰€æœ‰è®¢å•
                        if (cloudSync && cloudSync.isInitialized) {
                            cloudSync.loadAllOrders().then(() => {
                                renderOrdersTable(); // åŠ è½½å®Œæˆåé‡æ–°æ¸²æŸ“
                            });
                        }
                        ordersToDisplay = userOrders; // ä¸´æ—¶ä½¿ç”¨å½“å‰ç”¨æˆ·è®¢å•
                    }
                } else {
                    ordersToDisplay = allOrders;
                }
            } else {
                // æ™®é€šç”¨æˆ·ï¼šåªæ˜¾ç¤ºè‡ªå·±çš„è®¢å•
                ordersToDisplay = userOrders.filter(order => 
                    !order.account || order.account === currentUser?.account
                );
            }

            let filteredOrders = ordersToDisplay;

            // çŠ¶æ€ç­›é€‰
            if (statusFilter) {
                filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
            }

            // æœç´¢ç­›é€‰
            if (searchTerm) {
                filteredOrders = filteredOrders.filter(order => {
                    const idStr = String(order.id || '').toLowerCase();
                    const productName = (order.productName || '').toLowerCase();
                    const usernameValue = (order.account || order.customerInfo?.account || order.customerInfo?.name || order.customerInfo?.email || '').toLowerCase();

                    switch (searchField) {
                        case 'id':
                            return idStr.includes(searchTerm);
                        case 'productName':
                            return productName.includes(searchTerm);
                        case 'username':
                            return usernameValue.includes(searchTerm);
                        case 'all':
                        default:
                            return (
                                idStr.includes(searchTerm) ||
                                productName.includes(searchTerm) ||
                                usernameValue.includes(searchTerm)
                            );
                    }
                });
            }

            // æ¸…ç†ä¸å­˜åœ¨çš„é€‰ä¸­è®¢å•
            selectedOrderIds.forEach(id => {
                if (!filteredOrders.some(o => normalizeOrderId(o.id) === id)) {
                    selectedOrderIds.delete(id);
                }
            });

            if (filteredOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">æš‚æ— è®¢å•æ•°æ®</td></tr>';
                refreshOrderSelectionUI();
                updatePaginationControls('orders', 0);
                return;
            }

            const { items: paginatedOrders } = getPaginatedItems(filteredOrders, 'orders');

            tbody.innerHTML = paginatedOrders.map(order => {
                const customerInfo = order.customerInfo || {};
                const usernameValue = order.account || customerInfo.account || customerInfo.name || customerInfo.email || '';
                const customerName = customerInfo.name || '';
                const customerPhone = customerInfo.phone || '';
                const customerEmail = customerInfo.email || '';
                const productName = order.productName || '';
                const orderIdStr = normalizeOrderId(order.id);
                
                const isChecked = currentUser && currentUser.role === 'admin' && selectedOrderIds.has(orderIdStr);

                return `
                <tr>
                    <td>
                        ${currentUser && currentUser.role === 'admin'
                            ? `<input type="checkbox" class="order-select-checkbox" data-order-id="${orderIdStr}" ${isChecked ? 'checked' : ''}>`
                            : ''}
                    </td>
                    <td>${orderIdStr}</td>
                    <td>${productName}</td>
                    <td><a href="#" class="order-username-link" data-username="${usernameValue}" data-customer-name="${customerName}" data-customer-phone="${customerPhone}" data-customer-email="${customerEmail}" style="color: var(--primary); text-decoration: underline; cursor: pointer;">${usernameValue || '-'}</a></td>
                    <td><span class="status-badge status-${order.status || 'pending'}">${getStatusText(order.status || 'pending')}</span></td>
                    <td>
                        <span class="tracking-number-display" data-order-id="${orderIdStr}">${order.trackingNumber || t('notFilled')}</span>
                        <button class="btn btn-sm btn-primary" onclick="editTrackingNumber('${orderIdStr}')" style="margin-left: 5px;">${t('edit')}</button>
                    </td>
                    <td>${formatDate(order.date || order.updatedAt || Date.now())}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewOrderDetails('${orderIdStr}')">æŸ¥çœ‹</button>
                        <button class="btn btn-sm btn-secondary" onclick="openOrderStatusModal('${orderIdStr}')">æ›´æ–°çŠ¶æ€</button>
                        ${currentUser && currentUser.role === 'admin'
                            ? `<button class="btn btn-sm btn-danger" onclick="deleteSingleOrder('${orderIdStr}')">${t('deleteOrder') || 'åˆ é™¤è®¢å•'}</button>`
                            : ''}
                    </td>
                </tr>
            `;
            }).join('');

            // ä¸ºå®¢æˆ·å§“åé“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.order-username-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const customerName = link.getAttribute('data-customer-name');
                    const customerPhone = link.getAttribute('data-customer-phone');
                    const customerEmail = link.getAttribute('data-customer-email');
                    showCustomerHistory(customerName, customerPhone, customerEmail);
                });
            });

            // ç»‘å®šè®¢å•é€‰æ‹©å¤é€‰æ¡†äº‹ä»¶
            if (currentUser && currentUser.role === 'admin') {
                tbody.querySelectorAll('.order-select-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const id = checkbox.getAttribute('data-order-id');
                        if (checkbox.checked) {
                            selectedOrderIds.add(id);
                        } else {
                            selectedOrderIds.delete(id);
                        }
                        refreshOrderSelectionUI();
                    });
                });
            }

            refreshOrderSelectionUI();
            updatePaginationControls('orders', filteredOrders.length, renderOrdersTable);
        }

        function collectAllReviews() {
            const reviews = [];
            products.forEach(product => {
                if (product && Array.isArray(product.reviews)) {
                    product.reviews.forEach(review => {
                        reviews.push({
                            ...review,
                            productId: product.id,
                            productName: product.name || review.productName || t('product') || 'äº§å“',
                        });
                    });
                }
            });
            return reviews.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        }

        function refreshOrderSelectionUI() {
            const batchDeleteBtn = document.getElementById('delete-selected-orders-btn');
            const selectAllCheckbox = document.getElementById('select-all-orders');
            const checkboxes = document.querySelectorAll('.order-select-checkbox');
            const selectedCount = selectedOrderIds.size;

            if (batchDeleteBtn) {
                const hasAdmin = currentUser && currentUser.role === 'admin';
                batchDeleteBtn.style.display = hasAdmin && selectedCount > 0 ? 'inline-flex' : 'none';
                batchDeleteBtn.textContent = selectedCount > 0
                    ? `æ‰¹é‡åˆ é™¤è®¢å• (${selectedCount})`
                    : 'æ‰¹é‡åˆ é™¤è®¢å•';
            }

            if (selectAllCheckbox) {
                const total = checkboxes.length;
                const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
                if (total === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = checked === total;
                    selectAllCheckbox.indeterminate = checked > 0 && checked < total;
                }
            }
        }

        function renderReviewsTable() {
            const tbody = document.getElementById('reviews-table-body');
            if (!tbody) return;

            const allReviews = collectAllReviews();
            if (!Array.isArray(allReviews) || allReviews.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px;">æš‚æ— è¯„ä»·æ•°æ®</td></tr>';
                updatePaginationControls('reviews', 0);
                return;
            }

            const keyword = (reviewSearchTerm || '').trim().toLowerCase();
            const category = (reviewSearchCategory || 'all');

            const filteredReviews = keyword
                ? allReviews.filter(review => {
                    if (!review) return false;
                    const k = keyword;

                    const fields = {
                        product: [review.productName],
                        user: [review.userName, review.userAccount],
                        comment: [review.comment],
                        rating: [String(review.rating)],
                        reply: [review.adminReply],
                        all: [
                            review.productName,
                            review.userName,
                            review.userAccount,
                            review.comment,
                            String(review.rating),
                            review.adminReply
                        ]
                    };

                    const targets = fields[category] || fields.all;

                    return targets.some(field => {
                        if (field === undefined || field === null) return false;
                        return field.toString().toLowerCase().includes(k);
                    });
                })
                : allReviews;

            const reviews = filteredReviews;
            if (reviews.length === 0) {
                const emptyMessage = keyword
                    ? 'æœªæ‰¾åˆ°åŒ¹é…çš„è¯„ä»·ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯æˆ–åˆ‡æ¢ç­›é€‰åˆ†ç±»'
                    : 'æš‚æ— è¯„ä»·æ•°æ®';
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:40px;">${emptyMessage}</td></tr>`;
                updatePaginationControls('reviews', 0);
                return;
            }

            const { items: paginatedReviews } = getPaginatedItems(reviews, 'reviews');

            tbody.innerHTML = paginatedReviews.map(review => {
                const createdAt = review.createdAt ? formatDate(review.createdAt) : '-';
                const ratingStars = Array.from({ length: 5 }, (_, i) =>
                    `<i class="fas fa-star" style="color:${i < (review.rating || 0) ? '#ffc107' : '#ddd'};"></i>`
                ).join('');
                const hasOrderLink = !!review.orderId;

                return `
                    <tr>
                        <td>${review.reviewId || '-'}</td>
                        <td>${review.productName}</td>
                        <td>${review.userName || '-'}</td>
                        <td>${ratingStars}</td>
                        <td style="max-width: 280px;">${review.comment || '-'}</td>
                        <td>${review.adminReply ? `<span style="color:#2c3e50;">${review.adminReply}</span>` : '<span style="color:#bbb;">æœªå›å¤</span>'}</td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" ${hasOrderLink ? `onclick="replyToReview('${review.orderId}')"` : 'disabled'}>${t('replyReview') || 'å›å¤è¯„ä»·'}</button>
                            <button class="btn btn-sm btn-danger" ${hasOrderLink ? `onclick="deleteReview('${review.orderId}')"` : 'disabled'} style="margin-left:6px;">${t('deleteReview') || 'åˆ é™¤è¯„ä»·'}</button>
                        </td>
                    </tr>
                `;
            }).join('');

            updatePaginationControls('reviews', reviews.length, renderReviewsTable);
        }

        // æ¸²æŸ“ç»Ÿè®¡æ•°æ®
        function renderStatistics() {
            const totalUsers = allUsers.length + Object.keys(ADMIN_ACCOUNTS).length;
            const totalProducts = products.length;
            const totalOrders = userOrders.length;
            const pendingOrders = userOrders.filter(order => order.status === 'review').length;

            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('pending-orders').textContent = pendingOrders;
        }

        // æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
        function viewUserDetails(account) {
            const user = allUsers.find(u => u.account === account) ||
                Object.entries(ADMIN_ACCOUNTS).find(([acc]) => acc === account);

            if (user) {
                const userInfo = user[1] || user;
                const password = userInfo.password || 'ç³»ç»Ÿé¢„è®¾å¯†ç ';
                const points = (userInfo.points == null || isNaN(userInfo.points)) ? 1 : Number(userInfo.points);

                // åˆ›å»ºè¯¦æƒ…æ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>ç”¨æˆ·è¯¦æƒ…</h3>
                            <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="user-detail-grid">
                                <div class="detail-item">
                                    <label>ç”¨æˆ·åï¼š</label>
                                    <span>${userInfo.username}</span>
                                </div>
                                <div class="detail-item">
                                    <label>è´¦å·ï¼š</label>
                                    <span>${account}</span>
                                </div>
                                <div class="detail-item">
                                    <label>å¯†ç ï¼š</label>
                                    <span class="password-field">
                                        <span id="password-display">${'*'.repeat(password.length)}</span>
                                        <button class="btn btn-sm btn-secondary" onclick="togglePassword('${account}')">æ˜¾ç¤ºå¯†ç </button>
                                    </span>
                                </div>
                                <div class="detail-item">
                                    <label>è§’è‰²ï¼š</label>
                                    <span class="role-badge ${userInfo.role}">${userInfo.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>æ³¨å†Œæ—¶é—´ï¼š</label>
                                    <span>${user.registerTime || 'ç³»ç»Ÿé¢„è®¾'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>çŠ¶æ€ï¼š</label>
                                    <span class="status-badge ${userInfo.status === 'banned' ? 'status-banned' : 'status-active'}">
                                        ${userInfo.status === 'banned' ? 'å·²ç¦ç”¨' : 'æ­£å¸¸'}
                                    </span>
                                </div>
                                <div class="detail-item">
                                    <label>èœœç½ï¼š</label>
                                    <span>
                                        <input id="user-points-input" type="number" min="0" step="1" value="${points}" style="width: 120px; padding: 4px 8px; border-radius: 4px; border: 1px solid #d1d5db;">
                                    </span>
                                </div>
                                ${userInfo.bannedTime ? `
                                <div class="detail-item">
                                    <label>ç¦ç”¨æ—¶é—´ï¼š</label>
                                    <span>${new Date(userInfo.bannedTime).toLocaleString()}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="user-actions" style="margin-top: 20px;">
                                <button class="btn btn-primary" onclick="editUserPassword('${account}')">ä¿®æ”¹å¯†ç </button>
                                <button class="btn btn-secondary" onclick="updateUserPoints('${account}')">ä¿å­˜ç§¯åˆ†</button>
                                <button class="btn btn-secondary" onclick="resetUserData('${account}')">é‡ç½®ç”¨æˆ·æ•°æ®</button>
                                ${userInfo.role !== 'admin' ? (
                        userInfo.status === 'banned'
                            ? `<button class="btn btn-success" onclick="unbanUser('${account}')">è§£ç¦ç”¨æˆ·</button>`
                            : `<button class="btn btn-danger" onclick="banUser('${account}')">ç¦ç”¨ç”¨æˆ·</button>`
                    ) : ''}
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            }
        }

        // åˆ‡æ¢å¯†ç æ˜¾ç¤º
        function togglePassword(account) {
            const user = allUsers.find(u => u.account === account) ||
                Object.entries(ADMIN_ACCOUNTS).find(([acc]) => acc === account);

            if (user) {
                const userInfo = user[1] || user;
                const passwordDisplay = document.getElementById('password-display');
                const button = event.target;

                if (passwordDisplay.textContent.includes('*')) {
                    passwordDisplay.textContent = userInfo.password || 'ç³»ç»Ÿé¢„è®¾å¯†ç ';
                    button.textContent = 'éšè—å¯†ç ';
                } else {
                    passwordDisplay.textContent = '*'.repeat((userInfo.password || 'ç³»ç»Ÿé¢„è®¾å¯†ç ').length);
                    button.textContent = 'æ˜¾ç¤ºå¯†ç ';
                }
            }
        }

        // ä¿®æ”¹ç”¨æˆ·å¯†ç 
        async function editUserPassword(account) {
            const newPassword = prompt(t('enterNewPassword'));
            if (!newPassword || newPassword.length < 6) {
                showNotification(t('passwordTooShortError'), 'error');
                return;
            }

            const user = allUsers.find(u => u.account === account);
            if (!user) {
                showNotification('åªèƒ½ä¿®æ”¹æ™®é€šç”¨æˆ·å¯†ç ', 'error');
                return;
            }

            user.password = newPassword;
            user.updatedAt = Date.now();
            await saveAllUsers();
            showNotification('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
        }

        // æ›´æ–°ç”¨æˆ·ç§¯åˆ†ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰
        async function updateUserPoints(account) {
            const input = document.getElementById('user-points-input');
            if (!input) {
                showNotification('æœªæ‰¾åˆ°èœœç½è¾“å…¥æ¡†', 'error');
                return;
            }

            const value = Number(input.value);
            if (isNaN(value) || value < 0) {
                showNotification('èœœç½å¿…é¡»æ˜¯å¤§äºæˆ–ç­‰äº 0 çš„æ•°å­—', 'error');
                return;
            }

            const user = allUsers.find(u => u.account === account);
            if (!user) {
                showNotification('åªèƒ½ä¿®æ”¹æ™®é€šç”¨æˆ·èœœç½', 'error');
                return;
            }

            user.points = value;
            user.updatedAt = Date.now();

            // å¦‚æœå½“å‰ç™»å½•ç”¨æˆ·å°±æ˜¯è¢«ä¿®æ”¹çš„è´¦å·ï¼ŒåŠæ—¶åˆ·æ–° currentUser ä¸ UI
            if (currentUser && currentUser.account === account) {
                currentUser.points = value;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateUserInterface();
            }

            // ä½¿ç”¨ç»Ÿä¸€çš„ç®¡ç†å‘˜æ›´æ–°æµç¨‹ï¼ŒåŒæ­¥åˆ°äº‘ç«¯
            await saveAllUsers();

            showNotification('ç”¨æˆ·èœœç½å·²æ›´æ–°', 'success');
            // åŒæ­¥åˆ·æ–°ç”¨æˆ·åˆ—è¡¨ä¸­çš„ç§¯åˆ†æ˜¾ç¤º
            renderUsersTable();
        }

        // é‡ç½®ç”¨æˆ·æ•°æ®
        function resetUserData(account) {
            if (!confirm(t('confirmResetUserData'))) {
                return;
            }

            // åˆ é™¤ç”¨æˆ·ç›¸å…³æ•°æ®
            userOrders = userOrders.filter(order => order.customerInfo.email !== account);
            userAddresses = userAddresses.filter(addr => addr.account !== account);

            saveUserOrders();
            saveUserAddresses();

            showNotification(t('userDataReset'), 'success');
        }

        // ç¦ç”¨ç”¨æˆ·ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰
        async function banUser(account) {
            if (confirm(t('confirmBanUser'))) {
                const user = allUsers.find(u => u.account === account);
                if (user) {
                    user.status = 'banned';
                    user.bannedTime = new Date().toISOString();
                    user.updatedAt = Date.now();
                    await saveAllUsers();
                    renderUsersTable();
                    showNotification(t('userBanned'), 'success');

                    // å…³é—­ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => modal.remove());

                    // å¦‚æœè¢«ç¦ç”¨çš„ç”¨æˆ·æ­£åœ¨ç™»å½•ï¼Œå¼ºåˆ¶å…¶é€€å‡º
                    if (currentUser && currentUser.account === account) {
                        currentUser = null;
                        localStorage.removeItem('currentUser');
                        updateUserInterface();
                        showNotification('è¯¥è´¦å·å·²è¢«ç¦ç”¨å¹¶å·²é€€å‡ºç™»å½•', 'warning');
                    }
                }
            }
        }

        // è§£ç¦ç”¨æˆ·ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰
        async function unbanUser(account) {
            if (confirm(t('confirmUnbanUser'))) {
                const user = allUsers.find(u => u.account === account);
                if (user) {
                    user.status = 'active';
                    delete user.bannedTime;
                    user.updatedAt = Date.now();
                    await saveAllUsers();
                    renderUsersTable();
                    showNotification(t('userUnbanned'), 'success');

                    // å…³é—­ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => modal.remove());
                }
            }
        }

        function safeParseArray(raw) {
            if (!raw) return [];
            try {
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                console.warn('è§£ææœ¬åœ°æ•°æ®å¤±è´¥:', error);
                return [];
            }
        }

        // åˆ é™¤æœ¬åœ°å’Œäº‘ç«¯ä¸­çš„æŒ‡å®šè´¦å·åŠå…¶å…³è”æ•°æ®
        async function removeAccountData(account) {
            if (!account) throw new Error('è´¦å·æ— æ•ˆ');

            const isCurrent = currentUser && currentUser.account === account;
            const result = { orders: 0, addresses: 0 };

            // ç§»é™¤ç”¨æˆ·åˆ—è¡¨
            const userIndex = allUsers.findIndex(u => u.account === account);
            if (userIndex !== -1) {
                allUsers.splice(userIndex, 1);
            }

            // ç§»é™¤ç”¨æˆ·èµ„æ–™
            let profileChanged = false;
            if (userProfile[account]) {
                delete userProfile[account];
                profileChanged = true;
            }

            // æ¸…é™¤æœ¬åœ°è®¢å•ç¼“å­˜
            const ordersKey = `userOrders_${account}`;
            const storedOrders = safeParseArray(localStorage.getItem(ordersKey));
            result.orders = storedOrders.length;
            localStorage.removeItem(ordersKey);

            // æ¸…é™¤å…¨å±€è®¢å•æ•°ç»„ä¸­çš„è®°å½•
            if (allOrders.length > 0) {
                const before = allOrders.length;
                allOrders = allOrders.filter(order => order.account !== account);
                if (before !== allOrders.length) {
                    localStorage.setItem('allOrders', JSON.stringify(allOrders));
                }
            }

            // æ¸…é™¤å½“å‰ç”¨æˆ·è®¢å•/åœ°å€
            if (isCurrent) {
                userOrders = [];
                saveUserOrders();
                userAddresses = [];
                saveUserAddresses();
            } else {
                userOrders = userOrders.filter(order => order.account !== account);
                localStorage.setItem('userOrders', JSON.stringify(userOrders));
            }

            // æ¸…é™¤åœ°å€ç¼“å­˜
            const addressesKey = `userAddresses_${account}`;
            const storedAddresses = safeParseArray(localStorage.getItem(addressesKey));
            result.addresses = storedAddresses.length;
            localStorage.removeItem(addressesKey);

            // æ›´æ–°æœ¬åœ°å­˜å‚¨
            saveAllUsers();
            if (profileChanged) {
                saveUserProfile();
            }

            // æ›´æ–°å¤šé€‰çŠ¶æ€
            selectedUserAccounts.delete(account);

            // ========= åŒæ­¥äº‘ç«¯ç”¨æˆ·æ•°æ®ï¼ˆallUsers + users/<id>ï¼‰ç¡®ä¿åˆ é™¤æŒä¹…åŒ– =========
            if (cloudSync && cloudSync.isInitialized) {
                try {
                    // 1) ä» allUsers åˆ—è¡¨ä¸­åˆ é™¤è¯¥è´¦å·å¹¶å†™å›äº‘ç«¯
                    const usersRef = cloudSync.db.ref('allUsers');
                    const snapshot = await usersRef.once('value');
                    const cloudUsers = Array.isArray(snapshot.val()) ? snapshot.val() : [];
                    const updatedUsers = cloudUsers.filter(u => u && u.account !== account);
                    await usersRef.set(updatedUsers);
                    console.log(`âœ… å·²ä» allUsers åˆ—è¡¨ä¸­åˆ é™¤è´¦å· ${account}`);

                    // 2) åˆ é™¤ users/<id> èŠ‚ç‚¹ä¸‹çš„ç”¨æˆ·ç§æœ‰æ•°æ®
                    await cloudSync.deleteUserAccount(account);
                } catch (error) {
                    console.error('åˆ é™¤äº‘ç«¯ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                }
            }

            return result;
        }

        // ========== åˆ é™¤ç”¨æˆ·è´¦å·åŠŸèƒ½ ==========
        // å½»åº•åˆ é™¤ç”¨æˆ·è´¦å·åŠå…¶æ‰€æœ‰ç›¸å…³æ•°æ®
        async function deleteUserAccount(account) {
            const user = allUsers.find(u => u.account === account);
            if (!user) {
                showNotification(t('userNotExists'), 'error');
                return;
            }

            // äºŒæ¬¡ç¡®è®¤åˆ é™¤æ“ä½œ
            const confirmDelete = confirm(
                t('confirmDeleteUser')
                    .replace('{account}', account)
                    .replace('{username}', user.username)
                    .replace('{registerTime}', user.registerTime)
            );

            if (!confirmDelete) {
                return;
            }

            // å†æ¬¡ç¡®è®¤
            const finalConfirm = prompt(
                t('finalConfirmDelete').replace('{account}', account),
                ''
            );

            if (finalConfirm !== account) {
                showNotification(t('accountInputMismatch'), 'warning');
                return;
            }

            try {
                console.log('ğŸ—‘ï¸ å¼€å§‹åˆ é™¤ç”¨æˆ·è´¦å·:', account);

                const { orders, addresses } = await removeAccountData(account);

                // æ›´æ–°ç•Œé¢
                renderUsersTable();

                // å…³é—­ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => modal.remove());

                showNotification(
                    t('userDeletedSuccess')
                        .replace('{account}', account)
                        .replace('{orders}', orders)
                        .replace('{addresses}', addresses),
                    'success'
                );

                console.log('ğŸ‰ ç”¨æˆ·è´¦å·åˆ é™¤å®Œæˆ');

                // 10. å¦‚æœè¢«åˆ é™¤çš„ç”¨æˆ·æ­£åœ¨ç™»å½•ï¼Œå¼ºåˆ¶å…¶é€€å‡º
                if (currentUser && currentUser.account === account) {
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                    if (cloudSync && cloudSync.isInitialized) {
                        await cloudSync.handleUserSessionChange();
                    }
                    updateUserInterface();
                    showNotification(t('accountDeletedByAdmin'), 'error');
                    // è·³è½¬åˆ°é¦–é¡µ
                    document.getElementById('home-page').style.display = 'block';
                    document.getElementById('user-center').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'none';
                }

            } catch (error) {
                console.error('âŒ åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                showNotification(t('deleteUserFailed') + ': ' + error.message, 'error');
            }
        }

        async function deleteSelectedUsers() {
            if (selectedUserAccounts.size === 0) {
                showNotification(t('pleaseSelectAccountsToDelete'), 'warning');
                return;
            }

            const accounts = Array.from(selectedUserAccounts);
            if (!confirm(t('confirmDeleteSelectedAccounts').replace('{count}', accounts.length))) {
                return;
            }

            showNotification(t('deletingAccounts'), 'info');

            for (const account of accounts) {
                try {
                    await removeAccountData(account);
                } catch (error) {
                    console.error(`åˆ é™¤è´¦å· ${account} å¤±è´¥:`, error);
                    showNotification(`åˆ é™¤è´¦å· ${account} å¤±è´¥: ${error.message}`, 'error');
                }
            }

            renderUsersTable();
            showNotification(t('batchDeleteComplete'), 'success');
        }

        async function handleSelfAccountDeletion() {
            if (!currentUser) {
                showNotification(t('pleaseLoginBeforeDeletion'), 'warning');
                return;
            }

            const account = currentUser.account;
            const firstConfirm = confirm(t('confirmDeleteSelfAccount'));
            if (!firstConfirm) {
                return;
            }

            const finalInput = prompt(t('finalConfirmDeleteSelf').replace('{account}', account), '');
            if (finalInput !== account) {
                showNotification(t('accountInputMismatchCancel'), 'warning');
                return;
            }

            try {
                await removeAccountData(account);
                currentUser = null;
                localStorage.removeItem('currentUser');

                if (cloudSync && cloudSync.isInitialized) {
                    await cloudSync.handleUserSessionChange();
                }

                updateUserInterface();
                showHomePage();
                showNotification(t('accountDeletedSuccess'), 'success');
            } catch (error) {
                console.error('æ³¨é”€è´¦å·å¤±è´¥:', error);
                showNotification(t('deleteAccountFailed') + 'ï¼š' + error.message, 'error');
            }
        }

        async function deleteOrdersByIds(orderIds, showSuccessMessage = true) {
            const ids = (orderIds || []).map(normalizeOrderId).filter(Boolean);
            if (ids.length === 0) {
                showNotification(t('noOrdersToDelete'), 'warning');
                return false;
            }

            const uniqueIds = Array.from(new Set(ids));
            const ordersToDelete = uniqueIds
                .map(id => findOrderById(id))
                .filter(order => !!order);

            if (ordersToDelete.length === 0) {
                showNotification('æœªæ‰¾åˆ°è¦åˆ é™¤çš„è®¢å•', 'warning');
                return false;
            }

            const idSet = new Set(uniqueIds);

            if (allOrders && allOrders.length > 0) {
                allOrders = allOrders.filter(order => !idSet.has(normalizeOrderId(order.id)));
                localStorage.setItem('allOrders', JSON.stringify(allOrders));
            }

            if (userOrders && userOrders.length > 0) {
                userOrders = userOrders.filter(order => !idSet.has(normalizeOrderId(order.id)));
                saveUserOrders();
            }

            if (cloudSync && cloudSync.isInitialized) {
                const userOrderMap = new Map();
                ordersToDelete.forEach(order => {
                    if (!order.account) return;
                    if (!userOrderMap.has(order.account)) {
                        userOrderMap.set(order.account, []);
                    }
                    userOrderMap.get(order.account).push(normalizeOrderId(order.id));
                });

                for (const [account, idsForUser] of userOrderMap.entries()) {
                    try {
                        const ref = getCloudOrdersRefForAccount(account);
                        if (!ref) continue;
                        const snapshot = await ref.once('value');
                        const cloudUserOrders = snapshot.val() || [];
                        const filtered = cloudUserOrders.filter(o => !idsForUser.includes(normalizeOrderId(o.id)));
                        await ref.set(filtered);
                    } catch (error) {
                        console.error(`åŒæ­¥åˆ é™¤ç”¨æˆ· ${account} è®¢å•å¤±è´¥:`, error);
                    }
                }
            }

            renderOrdersTable();
            renderUserOrders();

            if (showSuccessMessage) {
                showNotification('è®¢å•å·²åˆ é™¤', 'success');
            }

            if (cloudSync && cloudSync.isInitialized && currentUser && currentUser.role === 'admin') {
                cloudSync.loadAllOrders().catch(err => console.warn('åˆ·æ–°æ‰€æœ‰è®¢å•å¤±è´¥', err));
            }

            return true;
        }

        async function deleteSelectedOrders() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤è®¢å•', 'warning');
                return;
            }

            if (selectedOrderIds.size === 0) {
                showNotification('è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„è®¢å•', 'warning');
                return;
            }

            const ids = Array.from(selectedOrderIds);
            if (!confirm(t('confirmDeleteSelectedOrders').replace('{count}', ids.length))) {
                return;
            }

            const result = await deleteOrdersByIds(ids, false);
            if (result) {
                selectedOrderIds.clear();
                refreshOrderSelectionUI();
                showNotification(t('batchDeleteComplete'), 'success');
            }
        }

        async function deleteSingleOrder(orderId) {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤è®¢å•', 'warning');
                return;
            }

            const order = findOrderById(orderId);
            if (!order) {
                showNotification(t('orderNotFound') || 'æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯', 'error');
                return;
            }

            const orderLabel = normalizeOrderId(orderId);
            if (!confirm(t('confirmDeleteOrder').replace('{orderLabel}', orderLabel))) {
                return;
            }

            await deleteOrdersByIds([orderId]);
            selectedOrderIds.delete(orderLabel);
            refreshOrderSelectionUI();
        }

        // æ˜¾ç¤ºå®¢æˆ·å†å²è®¢å•ä¿¡æ¯
        function showCustomerHistory(customerName, customerPhone, customerEmail) {
            // æŸ¥æ‰¾è¯¥å®¢æˆ·çš„æ‰€æœ‰è®¢å•
            const customerOrders = userOrders.filter(order =>
                order.customerInfo.name === customerName ||
                order.customerInfo.phone === customerPhone ||
                order.customerInfo.email === customerEmail
            );

            // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºå®¢æˆ·å†å²
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>å®¢æˆ·å†å²è®¢å• - ${customerName}</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="customer-info-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; color: var(--dark);">å®¢æˆ·ä¿¡æ¯</h4>
                            <p style="margin: 5px 0;"><strong>å§“åï¼š</strong>${customerName}</p>
                            <p style="margin: 5px 0;"><strong>ç”µè¯ï¼š</strong>${customerPhone}</p>
                            <p style="margin: 5px 0;"><strong>é‚®ç®±ï¼š</strong>${customerEmail}</p>
                            <p style="margin: 5px 0;"><strong>è®¢å•æ€»æ•°ï¼š</strong>${customerOrders.length} å•</p>
                        </div>
                        
                        <h4 style="margin-bottom: 15px; color: var(--dark);">å†å²è®¢å•åˆ—è¡¨</h4>
                        ${customerOrders.length === 0 ?
                    '<p style="text-align: center; color: #999; padding: 20px;">è¯¥å®¢æˆ·æš‚æ— å†å²è®¢å•</p>' :
                    `<div class="customer-orders-list" style="max-height: 400px; overflow-y: auto;">
                                ${customerOrders.map((order, index) => `
                                    <div class="order-history-item" style="padding: 15px; background: white; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 10px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                            <div>
                                                <h5 style="margin: 0 0 5px 0; color: var(--dark);">è®¢å• #${order.id}</h5>
                                                <p style="margin: 0; color: var(--gray); font-size: 14px;">${formatDate(order.date)}</p>
                                            </div>
                                            <span class="status-badge status-${order.status}">${getStatusText(order.status)}</span>
                                        </div>
                                        <div style="font-size: 14px;">
                                            <p style="margin: 5px 0;"><strong>äº§å“ï¼š</strong>${order.productName}</p>
                                            <p style="margin: 5px 0;">
                                                <strong>ä»·æ ¼ï¼š</strong>
                                                <span class="order-price-old">${formatCurrency(order.originalPrice ?? order.price)}</span>
                                                <span class="order-price-new">${formatCurrency(order.promoPrice ?? 0)}</span>
                                            </p>
                                            <p style="margin: 5px 0;"><strong>åœ°å€ï¼š</strong>${order.customerInfo.address}</p>
                                            ${order.customerInfo.notes ? `<p style="margin: 5px 0;"><strong>å¤‡æ³¨ï¼š</strong>${order.customerInfo.notes}</p>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                }
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // æŸ¥çœ‹è®¢å•è¯¦æƒ…
        function viewOrderDetails(orderId) {
            showOrderDetailsModal(orderId);
        }

        // ===== è®¢å•è¾…åŠ©å‡½æ•° =====
        function normalizeOrderId(orderId) {
            if (orderId === null || orderId === undefined) return '';
            return String(orderId);
        }

        function findOrderById(orderId) {
            const targetId = normalizeOrderId(orderId);
            let order = userOrders.find(o => normalizeOrderId(o.id) === targetId);
            if (!order && allOrders.length > 0) {
                order = allOrders.find(o => normalizeOrderId(o.id) === targetId);
            }
            return order || null;
        }

        function getCloudOrdersRefForAccount(account) {
            if (!cloudSync || !cloudSync.isInitialized || !account) return null;
            const userPath = cloudSync.getUserPath(account);
            return cloudSync.db.ref(`${userPath}/orders`);
        }

        function getCloudOrdersRefForOrder(order) {
            if (!order || !order.account) return null;
            return getCloudOrdersRefForAccount(order.account);
        }

        // ç®¡ç†å‘˜ä¸“ç”¨ï¼šç›´æ¥åœ¨äº‘ç«¯æ›´æ–°æŒ‡å®šè®¢å•çš„çŠ¶æ€ï¼ˆä»¥äº‘ç«¯ä¸ºå”¯ä¸€çœŸæºï¼‰
        // è¿”å› true è¡¨ç¤ºå·²åœ¨äº‘ç«¯æˆåŠŸæ›´æ–°å¹¶åˆ·æ–°åˆ°æœ¬åœ°ï¼›false è¡¨ç¤ºéœ€è¦å›é€€åˆ°æœ¬åœ°æ—§é€»è¾‘
        async function adminUpdateOrderStatusOnCloud(order, newStatus, statusText) {
            try {
                if (!cloudSync || !cloudSync.isInitialized) {
                    console.warn('adminUpdateOrderStatusOnCloud: cloudSync æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æœ¬åœ°æ›´æ–°é€»è¾‘');
                    return false;
                }
                if (!currentUser || currentUser.role !== 'admin') {
                    console.warn('adminUpdateOrderStatusOnCloud: å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼Œä½¿ç”¨æœ¬åœ°æ›´æ–°é€»è¾‘');
                    return false;
                }
                if (!order || !order.id) {
                    console.error('adminUpdateOrderStatusOnCloud: è®¢å•æ— æ•ˆ');
                    return false;
                }

                const userOrdersRef = getCloudOrdersRefForOrder(order);
                if (!userOrdersRef) {
                    console.warn('adminUpdateOrderStatusOnCloud: æ— æ³•å®šä½è®¢å•æ‰€å±ç”¨æˆ·è·¯å¾„ï¼Œä½¿ç”¨æœ¬åœ°æ›´æ–°é€»è¾‘');
                    return false;
                }

                console.log('ğŸ”„ ç®¡ç†å‘˜æ­£åœ¨äº‘ç«¯æ›´æ–°è®¢å•çŠ¶æ€:', {
                    orderId: order.id,
                    account: order.account,
                    newStatus,
                    statusText
                });

                // åœ¨æ›´æ–°æœŸé—´æš‚æ—¶é˜»æ­¢å®æ—¶ç›‘å¬è¦†ç›–æœ¬åœ°æ•°æ®
                cloudSync._syncState.inProgress = true;

                const snapshot = await userOrdersRef.once('value');
                let cloudUserOrders = snapshot.val() || [];
                if (!Array.isArray(cloudUserOrders)) {
                    console.warn('adminUpdateOrderStatusOnCloud: äº‘ç«¯è®¢å•æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨æœ¬åœ°æ›´æ–°é€»è¾‘');
                    return false;
                }

                // ä½¿ç”¨ä¸æœ¬åœ°ä¸€è‡´çš„IDè§„èŒƒåŒ–è§„åˆ™ï¼Œé¿å…å­—ç¬¦ä¸²/æ•°å­—ä¸ä¸€è‡´å¯¼è‡´åŒ¹é…å¤±è´¥
                const targetId = normalizeOrderId(order.id);
                const orderIndex = cloudUserOrders.findIndex(o => o && normalizeOrderId(o.id) === targetId);
                if (orderIndex === -1) {
                    console.warn('adminUpdateOrderStatusOnCloud: äº‘ç«¯æœªæ‰¾åˆ°è¯¥è®¢å•ï¼Œä½¿ç”¨æœ¬åœ°æ›´æ–°é€»è¾‘');
                    return false;
                }

                const updateTimestamp = Date.now();
                const original = cloudUserOrders[orderIndex] || {};

                // æé«˜ç®¡ç†å‘˜æ›´æ–°çš„"æƒé‡"ï¼šä½¿ç”¨ç•¥å¾®é åçš„æ—¶é—´æˆ³ï¼Œç¡®ä¿åœ¨ä»»ä½•åˆå¹¶é€»è¾‘é‡Œéƒ½ä»¥äº‘ç«¯ä¸ºå‡†
                const strongUpdateTimestamp = Date.now() + 30 * 1000; // æ¯”å½“å‰æ—¶é—´æ™š30ç§’
                
                // ä¿ç•™è®¢å•çš„æ‰€æœ‰é‡è¦å­—æ®µï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
                cloudUserOrders[orderIndex] = {
                    ...original,
                    status: newStatus,
                    updatedAt: strongUpdateTimestamp,
                    // ç¡®ä¿ä¿ç•™æ‰€æœ‰å¿…è¦å­—æ®µ
                    account: original.account || order.account,
                    productId: original.productId || order.productId,
                    productName: original.productName || order.productName,
                    price: original.price !== undefined ? original.price : order.price,
                    image: original.image || order.image,
                    customerInfo: original.customerInfo || order.customerInfo,
                    date: original.date || order.date || Date.now(),
                    trackingNumber: original.trackingNumber || order.trackingNumber
                };

                // ä½¿ç”¨ set æ–¹æ³•æ›´æ–°ï¼Œè¿™ä¼šè§¦å‘æ‰€æœ‰å®¢æˆ·ç«¯çš„å®æ—¶ç›‘å¬å™¨
                await userOrdersRef.set(cloudUserOrders);
                
                console.log('ğŸ“¤ è®¢å•æ›´æ–°å·²å†™å…¥äº‘ç«¯ï¼Œå®æ—¶ç›‘å¬å™¨å°†è‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰å®¢æˆ·ç«¯');

                console.log('âœ… ç®¡ç†å‘˜å·²åœ¨äº‘ç«¯æ›´æ–°è®¢å•çŠ¶æ€:', {
                    orderId: order.id,
                    newStatus,
                    updatedAt: updateTimestamp
                });

                // ä»äº‘ç«¯é‡æ–°åŠ è½½æ‰€æœ‰è®¢å•ï¼Œåˆ·æ–°åå°åˆ—è¡¨ï¼ˆä»¥äº‘ç«¯ä¸ºå‡†ï¼‰
                if (typeof cloudSync.loadAllOrders === 'function') {
                    try {
                        await cloudSync.loadAllOrders();
                        console.log('âœ… å·²ä»äº‘ç«¯é‡æ–°åŠ è½½æ‰€æœ‰è®¢å•ï¼ˆç®¡ç†å‘˜è§†å›¾ï¼‰');
                    } catch (reloadErr) {
                        console.warn('adminUpdateOrderStatusOnCloud: é‡æ–°åŠ è½½æ‰€æœ‰è®¢å•å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', reloadErr);
                    }
                }

                return true;
            } catch (e) {
                console.error('adminUpdateOrderStatusOnCloud æ‰§è¡Œå¤±è´¥:', e);
                return false;
            } finally {
                // ç¨å¾®å»¶è¿Ÿæ¸…ç†æ ‡è®°ï¼Œé¿å…ç›‘å¬å™¨ç«‹åˆ»è¦†ç›–
                if (cloudSync) {
                    setTimeout(() => {
                        cloudSync._syncState.inProgress = false;
                    }, 500);
                }
            }
        }

        function findReviewContextByOrderId(orderId) {
            const targetId = normalizeOrderId(orderId);
            for (const product of products) {
                if (!product || !Array.isArray(product.reviews)) continue;
                const index = product.reviews.findIndex(review => normalizeOrderId(review.orderId) === targetId);
                if (index > -1) {
                    return { product, index };
                }
            }
            return null;
        }

        // æ ¼å¼åŒ–è®¢å•åœ°å€æ˜¾ç¤º
        function renderOrderContactInfo(order) {
            const info = order.customerInfo || {};
            const name = info.name || info.fullName || order.account || t('notFilled');
            const account = info.account || info.username || order.account || t('notFilled');
            const email = info.email || t('notFilled');
            const phone = info.phone || t('notFilled');
            let street = info.addressDetail || info.detail || info.street || '';
            let unit = info.addressUnit || info.unit || '';
            let city = info.addressCity || info.city || '';
            let state = info.addressState || info.state || '';
            let postal = info.addressPostal || info.postal || info.zip || '';

            // å¦‚æœè¯¦ç»†å­—æ®µç¼ºå¤±ï¼Œä½†æœ‰æ•´æ®µåœ°å€å­—ç¬¦ä¸²ï¼Œå°è¯•æ™ºèƒ½è§£æ
            if (info.address && (!street || !city || !state || !postal)) {
                const parsed = parseAddressString(info.address);
                street = street || parsed.street;
                unit = unit || parsed.unit;
                city = city || parsed.city;
                state = state || parsed.state;
                postal = postal || parsed.postal;
            }

            const safeText = (value) => (value ? value : (t('notFilled') || 'N/A'));

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                    <div>
                        <div style="font-size: 12px; color: #777;">${t('name') || 'Full Name'}</div>
                        <div style="font-size: 15px; font-weight: 600;">${safeText(name)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #777;">${t('account') || 'Account'}</div>
                        <div style="font-size: 15px; font-weight: 600;">${safeText(account)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #777;">${t('email') || 'Email'}</div>
                        <div style="font-size: 15px; font-weight: 600; word-break: break-all;">${safeText(email)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #777;">${t('phone') || 'Phone'}</div>
                        <div style="font-size: 15px; font-weight: 600;">${safeText(phone)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #777;">${t('street') || 'Street'}</div>
                        <div style="font-size: 15px; font-weight: 600;">${safeText(street)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #777;">${t('unit') || 'Unit / Suite'}</div>
                        <div style="font-size: 15px; font-weight: 600;">${safeText(unit)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #777;">${t('city') || 'City'}</div>
                        <div style="font-size: 15px; font-weight: 600;">${safeText(city)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #777;">${t('state') || 'State'}</div>
                        <div style="font-size: 15px; font-weight: 600;">${safeText(state)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #777;">${t('postal') || 'ZIP Code'}</div>
                        <div style="font-size: 15px; font-weight: 600;">${safeText(postal)}</div>
                    </div>
                </div>
                ${info.notes ? `<div style="margin-top: 12px;"><strong>${t('notes')}ï¼š</strong>${info.notes}</div>` : ''}
            `;
        }

        function parseAddressString(addressStr) {
            const result = { street: '', unit: '', city: '', state: '', postal: '' };
            if (!addressStr || typeof addressStr !== 'string') {
                return result;
            }

            const parts = addressStr.split(',').map(p => p.trim()).filter(Boolean);
            if (parts.length === 0) return result;

            result.street = parts[0] || '';

            if (parts.length >= 5) {
                result.unit = parts[1] || '';
                result.city = parts[2] || '';
                result.state = parts[parts.length - 2] || '';
                result.postal = parts[parts.length - 1] || '';
            } else if (parts.length === 4) {
                result.unit = parts[1] || '';
                result.city = parts[2] || '';
                result.state = parts[3] || '';
            } else if (parts.length === 3) {
                result.city = parts[1] || '';
                if (/^\d{5}(-\d{4})?$/.test(parts[2])) {
                    result.postal = parts[2];
                } else if (/^[A-Za-z]{2,3}$/.test(parts[2])) {
                    result.state = parts[2];
                } else {
                    result.city = `${result.city ? result.city + ', ' : ''}${parts[2]}`;
                }
            } else if (parts.length === 2) {
                result.city = parts[1] || '';
            }

            // å¦‚æœä»æœªè¯†åˆ«å‡ºå·/é‚®ç¼–ï¼Œå°è¯•ä»æœ€åä¸¤ä¸ªå­—æ®µæ¨æ–­
            if (!result.postal && parts.length >= 2 && /^\d{5}(-\d{4})?$/.test(parts[parts.length - 1])) {
                result.postal = parts[parts.length - 1];
            }
            if (!result.state && parts.length >= 2 && /^[A-Za-z]{2,3}$/.test(parts[parts.length - 2])) {
                result.state = parts[parts.length - 2];
            }

            return result;
        }

        function formatOrderAddress(customerInfo) {
            if (!customerInfo) return t('notFilled') || 'æœªå¡«å†™';
            
            // å¦‚æœåœ°å€æœ‰è¯¦ç»†å­—æ®µï¼Œæ ¼å¼åŒ–æ˜¾ç¤º
            if (customerInfo.addressDetail || customerInfo.detail || customerInfo.street) {
                const addressParts = [];
                
                // è¡—é“åœ°å€
                const street = customerInfo.addressDetail || customerInfo.detail || customerInfo.street || '';
                if (street) addressParts.push(street);
                
                // å•å…ƒ/å¥—æˆ¿å·
                const unit = customerInfo.addressUnit || customerInfo.unit || '';
                if (unit) addressParts.push(unit);
                
                // åŸå¸‚
                const city = customerInfo.addressCity || customerInfo.city || '';
                if (city) addressParts.push(city);
                
                // å·/çœ
                const state = customerInfo.addressState || customerInfo.state || '';
                
                // é‚®ç¼–
                const postal = customerInfo.addressPostal || customerInfo.postal || customerInfo.zip || '';
                
                // æ„å»ºæ ¼å¼åŒ–åœ°å€
                let formattedAddress = '';
                if (addressParts.length > 0) {
                    formattedAddress = addressParts.join(', ');
                }
                
                if (state && postal) {
                    formattedAddress += (formattedAddress ? ', ' : '') + `${state} ${postal}`;
                } else if (state) {
                    formattedAddress += (formattedAddress ? ', ' : '') + state;
                } else if (postal) {
                    formattedAddress += (formattedAddress ? ', ' : '') + postal;
                }
                
                if (formattedAddress) {
                    return `<div style="margin-top: 5px; line-height: 1.6;">
                        ${street ? `<div><strong>${currentLanguage === 'zh' ? 'è¡—é“åœ°å€' : 'Street'}:</strong> ${street}</div>` : ''}
                        ${unit ? `<div><strong>${currentLanguage === 'zh' ? 'å•å…ƒ/å¥—æˆ¿' : 'Unit/Suite'}:</strong> ${unit}</div>` : ''}
                        ${city ? `<div><strong>${currentLanguage === 'zh' ? 'åŸå¸‚' : 'City'}:</strong> ${city}</div>` : ''}
                        ${state ? `<div><strong>${currentLanguage === 'zh' ? 'å·/çœ' : 'State'}:</strong> ${state}</div>` : ''}
                        ${postal ? `<div><strong>${currentLanguage === 'zh' ? 'é‚®ç¼–' : 'ZIP Code'}:</strong> ${postal}</div>` : ''}
                    </div>`;
                }
            }
            
            // å¦‚æœåªæœ‰å­—ç¬¦ä¸²åœ°å€ï¼Œå°è¯•è§£æå¹¶æ ¼å¼åŒ–
            if (customerInfo.address) {
                const addressStr = customerInfo.address;
                
                // å°è¯•è§£ææ ¼å¼ï¼šdetail, unit, city, state, postal
                const parts = addressStr.split(',').map(p => p.trim()).filter(p => p);
                
                if (parts.length >= 3) {
                    // æ™ºèƒ½è¯†åˆ«ï¼šæœ€åä¸€ä¸ªå¯èƒ½æ˜¯é‚®ç¼–ï¼ˆçº¯æ•°å­—ï¼‰ï¼Œå€’æ•°ç¬¬äºŒä¸ªå¯èƒ½æ˜¯å·ï¼ˆ2-3ä¸ªå­—æ¯ï¼‰
                    let street = parts[0] || '';
                    let unit = '';
                    let city = '';
                    let state = '';
                    let postal = '';
                    
                    // æ£€æŸ¥æœ€åä¸€ä¸ªæ˜¯å¦æ˜¯é‚®ç¼–ï¼ˆ5ä½æ•°å­—ï¼‰
                    const lastPart = parts[parts.length - 1];
                    if (/^\d{5}(-\d{4})?$/.test(lastPart)) {
                        postal = lastPart;
                        // å€’æ•°ç¬¬äºŒä¸ªå¯èƒ½æ˜¯å·ï¼ˆ2-3ä¸ªå¤§å†™å­—æ¯ï¼‰
                        if (parts.length >= 2 && /^[A-Z]{2,3}$/.test(parts[parts.length - 2])) {
                            state = parts[parts.length - 2];
                            city = parts.length >= 3 ? parts[parts.length - 3] : '';
                            unit = parts.length >= 4 ? parts[1] : '';
                        } else {
                            // æ²¡æœ‰æ˜ç¡®çš„å·ï¼Œæœ€åä¸€ä¸ªå¯èƒ½æ˜¯åŸå¸‚
                            city = parts.length >= 2 ? parts[parts.length - 2] : '';
                            unit = parts.length >= 3 ? parts[1] : '';
                        }
                    } else if (parts.length === 3) {
                        // 3ä¸ªéƒ¨åˆ†ï¼šè¡—é“, åŸå¸‚, å·/é‚®ç¼–
                        city = parts[1] || '';
                        // æ£€æŸ¥ç¬¬ä¸‰ä¸ªæ˜¯å¦æ˜¯é‚®ç¼–æˆ–å·
                        if (/^\d{5}(-\d{4})?$/.test(parts[2])) {
                            postal = parts[2];
                        } else if (/^[A-Z]{2,3}$/.test(parts[2])) {
                            state = parts[2];
                        }
                    } else if (parts.length >= 4) {
                        // 4ä¸ªæˆ–æ›´å¤šéƒ¨åˆ†ï¼šè¡—é“, å•å…ƒ, åŸå¸‚, å·, é‚®ç¼–
                        unit = parts[1] || '';
                        city = parts[2] || '';
                        if (parts.length >= 4) {
                            // æ£€æŸ¥å€’æ•°ç¬¬äºŒä¸ªæ˜¯å¦æ˜¯å·
                            if (/^[A-Z]{2,3}$/.test(parts[parts.length - 2])) {
                                state = parts[parts.length - 2];
                                postal = parts[parts.length - 1] || '';
                            } else {
                                state = parts[3] || '';
                                postal = parts.length >= 5 ? parts[4] : '';
                            }
                        }
                    }
                    
                    return `<div style="margin-top: 5px; line-height: 1.6;">
                        ${street ? `<div><strong>${currentLanguage === 'zh' ? 'è¡—é“åœ°å€' : 'Street'}:</strong> ${street}</div>` : ''}
                        ${unit ? `<div><strong>${currentLanguage === 'zh' ? 'å•å…ƒ/å¥—æˆ¿' : 'Unit/Suite'}:</strong> ${unit}</div>` : ''}
                        ${city ? `<div><strong>${currentLanguage === 'zh' ? 'åŸå¸‚' : 'City'}:</strong> ${city}</div>` : ''}
                        ${state ? `<div><strong>${currentLanguage === 'zh' ? 'å·/çœ' : 'State'}:</strong> ${state}</div>` : ''}
                        ${postal ? `<div><strong>${currentLanguage === 'zh' ? 'é‚®ç¼–' : 'ZIP Code'}:</strong> ${postal}</div>` : ''}
                    </div>`;
                } else {
                    // å¦‚æœæ— æ³•è§£æï¼Œç›´æ¥æ˜¾ç¤ºåŸåœ°å€
                    return `<div style="margin-top: 5px; white-space: pre-wrap; line-height: 1.6;">${addressStr}</div>`;
                }
            }
            
            return t('notFilled') || 'æœªå¡«å†™';
        }

        function normalizeUSPhone(value) {
            if (!value) return '';
            const digits = value.replace(/\D/g, '');
            let core = digits;
            if (core.length === 11 && core.startsWith('1')) {
                core = core.slice(1);
            }
            if (core.length !== 10) return null;
            return '+1' + core;
        }

        function extractUSPhoneDigits(value) {
            if (!value) return '';
            const digits = value.replace(/\D/g, '');
            if (digits.length === 11 && digits.startsWith('1')) {
                return digits.slice(1, 11);
            }
            if (digits.length >= 10) {
                return digits.slice(-10);
            }
            return digits;
        }

        function attachUSPhoneInputBehavior(inputId) {
            const input = document.getElementById(inputId);
            if (!input || input.dataset.usPhoneBound === 'true') return;
            input.dataset.usPhoneBound = 'true';

            const wrapper = input.closest('.phone-input-wrapper');

            input.addEventListener('input', function () {
                const digitsOnly = this.value.replace(/\D/g, '').slice(0, 10);
                this.value = digitsOnly;
                this.setCustomValidity('');
                if (wrapper) wrapper.classList.remove('error');
            });

            input.addEventListener('blur', function () {
                if (!this.value) {
                    this.setCustomValidity('');
                    if (wrapper) wrapper.classList.remove('error');
                    return;
                }
                const normalized = normalizeUSPhone(this.value);
                if (!normalized) {
                    const message = t('invalidPhoneFormat') || 'Invalid phone number format';
                    this.setCustomValidity(message);
                    if (wrapper) wrapper.classList.add('error');
                    if (typeof this.reportValidity === 'function') {
                        this.reportValidity();
                    } else {
                        customAlert(message, t('infoTitle') || 'æç¤º');
                    }
                } else {
                    this.setCustomValidity('');
                    if (wrapper) wrapper.classList.remove('error');
                }
            });
        }

        // æ˜¾ç¤ºè®¢å•è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆåŒ…å«äº§å“ä¿¡æ¯å’Œå¿«é€’å•å·ï¼‰
        function showOrderDetailsModal(orderId) {
            const order = findOrderById(orderId);
            
            if (!order) {
                console.error('æœªæ‰¾åˆ°è®¢å•ï¼Œè®¢å•ID:', orderId);
                console.log('userOrdersæ•°é‡:', userOrders.length);
                console.log('allOrdersæ•°é‡:', allOrders.length);
                showNotification(t('orderNotFound') || 'æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯', 'error');
                return;
            }

            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'order-details-modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>${t('orderDetails')}</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <div style="flex: 0 0 160px;">
                                <div class="order-image" style="background-image: url('${order.image || ''}'); width: 160px; height: 160px; background-size: cover; background-position: center; border-radius: 8px; border: 1px solid #ddd;"></div>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <h3 style="margin-top: 0; color: var(--primary); font-size: 18px; line-height: 1.4; max-height: 3.2em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; word-break: break-word;">
                                    ${order.productName}
                                </h3>
                                <div style="margin: 15px 0;">
                                    <p style="margin: 8px 0;"><strong>${t('orderId')}ï¼š</strong>${order.id}</p>
                                    <p style="margin: 8px 0;">
                                        <strong>${t('price') || 'ä»·æ ¼'}ï¼š</strong>
                                        <span class="order-price-old">${formatCurrency(order.originalPrice ?? order.price)}</span>
                                        <span class="order-price-new" style="font-size: 18px;">${formatCurrency(order.promoPrice ?? 0)}</span>
                                    </p>
                                    <p style="margin: 8px 0;"><strong>${t('orderStatus')}ï¼š</strong><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></p>
                                    <p style="margin: 8px 0;"><strong>${t('orderTime')}ï¼š</strong>${formatDate(order.date)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0; margin-bottom: 15px; color: var(--primary);">
                                <i class="fas fa-truck" style="margin-right: 8px;"></i>${t('expressInfo')}
                            </h4>
                            ${currentUser && currentUser.role === 'admin' ? `
                                <!-- ç®¡ç†å‘˜ï¼šå¯ä»¥ç¼–è¾‘å¿«é€’å•å· -->
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">${t('trackingNumber')}ï¼š</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" id="tracking-number-input" value="${order.trackingNumber || ''}" 
                                               placeholder="${t('trackingNumberPlaceholder')}" 
                                               style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                        <button class="btn btn-primary" onclick="saveTrackingNumber('${normalizeOrderId(order.id)}')" style="padding: 10px 20px;">
                                            <i class="fas fa-save"></i> ${t('save')}
                                        </button>
                                    </div>
                                    ${order.trackingNumber ? `
                                        <a href="https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${order.trackingNumber}" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           style="display: inline-block; background: #ffc107; color: #8b4513; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 15px; transition: all 0.3s; box-shadow: 0 2px 6px rgba(255,193,7,0.3); border: none; cursor: pointer; margin-top: 10px;"
                                           onmouseover="this.style.background='#ffb300'; this.style.boxShadow='0 4px 8px rgba(255,193,7,0.4)'; this.style.transform='translateY(-2px)';"
                                           onmouseout="this.style.background='#ffc107'; this.style.boxShadow='0 2px 6px rgba(255,193,7,0.3)'; this.style.transform='translateY(0)';">
                                            <i class="fas fa-truck" style="margin-right: 6px;"></i>${t('trackPackage')}
                                        </a>
                                        <p style="margin-top: 10px; color: #666; font-size: 12px;">
                                            <i class="fas fa-info-circle"></i> ${t('trackingNumberInfo')}
                                        </p>
                                    ` : ''}
                                </div>
                            ` : `
                                <!-- æ™®é€šç”¨æˆ·ï¼šåªæ˜¾ç¤ºå¿«é€’ä¿¡æ¯ï¼Œä¸èƒ½ç¼–è¾‘ -->
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">${t('trackingNumber')}ï¼š</label>
                                    ${order.trackingNumber ? `
                                        <div style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-bottom: 10px;">
                                            <span style="font-weight: 500; color: var(--primary);">${order.trackingNumber}</span>
                                        </div>
                                        <a href="https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${order.trackingNumber}" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           style="display: inline-block; background: #ffc107; color: #8b4513; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 15px; transition: all 0.3s; box-shadow: 0 2px 6px rgba(255,193,7,0.3); border: none; cursor: pointer;"
                                           onmouseover="this.style.background='#ffb300'; this.style.boxShadow='0 4px 8px rgba(255,193,7,0.4)'; this.style.transform='translateY(-2px)';"
                                           onmouseout="this.style.background='#ffc107'; this.style.boxShadow='0 2px 6px rgba(255,193,7,0.3)'; this.style.transform='translateY(0)';">
                                            <i class="fas fa-truck" style="margin-right: 6px;"></i>${t('trackPackage')}
                                        </a>
                                        <p style="margin-top: 10px; color: #666; font-size: 12px;">
                                            <i class="fas fa-info-circle"></i> ${t('trackingNumberInfo')}
                                        </p>
                                    ` : `
                                        <div style="padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; text-align: center; color: #856404;">
                                            <i class="fas fa-info-circle" style="margin-right: 5px;"></i>${t('noTrackingInfo')}
                                        </div>
                                    `}
                                </div>
                            `}
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="margin-top: 0; margin-bottom: 15px; color: var(--primary);">
                                <i class="fas fa-user" style="margin-right: 8px;"></i>${t('customerInfo')}
                            </h4>
                            ${renderOrderContactInfo(order)}
                        </div>
                        
                        ${order.status === 'completed' && currentUser && !currentUser.role && !(order.hasReview === true) ? `
                            <div style="margin-top: 20px; text-align: center;">
                                <button class="btn btn-primary" onclick="openReviewModal(${order.id})" style="padding: 12px 30px; font-size: 16px;">
                                    <i class="fas fa-star" style="margin-right: 8px;"></i>${t('writeReview')}
                                </button>
                            </div>
                        ` : ''}

                        ${(currentUser && currentUser.role === 'admin' && order.hasReview) ? `
                            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="replyToReview('${normalizeOrderId(order.id)}')">${t('replyReview') || 'å›å¤è¯„ä»·'}</button>
                                <button class="btn btn-danger" onclick="deleteReview('${normalizeOrderId(order.id)}')">${t('deleteReview') || 'åˆ é™¤è¯„ä»·'}</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ä¿å­˜å¿«é€’å•å·ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
        async function saveTrackingNumber(orderId) {
            const input = document.getElementById('tracking-number-input');
            if (!input) return;

            const trackingNumber = input.value.trim();
            const order = findOrderById(orderId);
            
            if (!order) {
                console.error('æœªæ‰¾åˆ°è®¢å•ï¼Œè®¢å•ID:', orderId);
                showNotification('æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯', 'error');
                return;
            }
            
            const normalizedId = normalizeOrderId(orderId);
            const isInAllOrders = allOrders.some(o => normalizeOrderId(o.id) === normalizedId);
            const isInUserOrders = userOrders.some(o => normalizeOrderId(o.id) === normalizedId);

            // æ›´æ–°è®¢å•çš„å¿«é€’å•å·
            order.trackingNumber = trackingNumber;
            order.updatedAt = Date.now();
            
            // å¦‚æœè®¢å•åœ¨allOrdersä¸­ï¼Œä¹Ÿéœ€è¦æ›´æ–°
            if (isInAllOrders) {
                const allOrder = allOrders.find(o => o.id === orderId);
                if (allOrder) {
                    allOrder.trackingNumber = trackingNumber;
                    allOrder.updatedAt = Date.now();
                    localStorage.setItem('allOrders', JSON.stringify(allOrders));
                }
            }
            
            // å¦‚æœè®¢å•åœ¨userOrdersä¸­ï¼Œä¿å­˜å¹¶åŒæ­¥
            if (isInUserOrders) {
                saveUserOrders(); // è¿™ä¼šè§¦å‘äº‘ç«¯åŒæ­¥
            } else if (isInAllOrders && currentUser && currentUser.role === 'admin' && order.account) {
                if (cloudSync && cloudSync.isInitialized) {
                    try {
                        const userOrdersRef = getCloudOrdersRefForOrder(order);
                        if (userOrdersRef) {
                            const snapshot = await userOrdersRef.once('value');
                            const userOrders = snapshot.val() || [];
                            const orderIndex = userOrders.findIndex(o => normalizeOrderId(o.id) === normalizedId);
                            if (orderIndex !== -1) {
                                userOrders[orderIndex].trackingNumber = trackingNumber;
                                userOrders[orderIndex].updatedAt = Date.now();
                                await userOrdersRef.set(userOrders);
                                console.log('âœ… å·²æ›´æ–°å…¶ä»–ç”¨æˆ·çš„è®¢å•å¿«é€’å•å·');
                            }
                        }
                    } catch (err) {
                        console.error('æ›´æ–°å…¶ä»–ç”¨æˆ·è®¢å•å¤±è´¥:', err);
                    }
                }
            }
            
            // æ›´æ–°æ˜¾ç¤º
            const displayElement = document.querySelector(`.tracking-number-display[data-order-id="${orderId}"]`);
            if (displayElement) {
                displayElement.textContent = trackingNumber || t('notFilled');
            }

            showNotification(t('trackingNumberSaved'), 'success');
            
            // å¦‚æœæ˜¯åœ¨è¯¦æƒ…æ¨¡æ€æ¡†ä¸­ï¼Œæ›´æ–°æ˜¾ç¤º
            const modalInput = document.getElementById('tracking-number-input');
            if (modalInput) {
                modalInput.value = trackingNumber;
            }
            
            // åˆ·æ–°è®¢å•è¡¨æ ¼ï¼ˆå¦‚æœæ˜¯åå°ç®¡ç†ï¼‰
            const adminOrders = document.getElementById('admin-orders');
            if (adminOrders && adminOrders.classList.contains('active')) {
                renderOrdersTable();
            }

            if (cloudSync && cloudSync.isInitialized && currentUser && currentUser.role === 'admin') {
                cloudSync.loadAllOrders().catch(err => console.warn('åˆ·æ–°æ‰€æœ‰è®¢å•å¤±è´¥', err));
            }
        }

        // ç¼–è¾‘å¿«é€’å•å·ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
        async function editTrackingNumber(orderId) {
            const order = findOrderById(orderId);
            
            if (!order) {
                console.error('æœªæ‰¾åˆ°è®¢å•ï¼Œè®¢å•ID:', orderId);
                showNotification('æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯', 'error');
                return;
            }

            const newTrackingNumber = prompt(t('enterTrackingNumber'), order.trackingNumber || '');
            if (newTrackingNumber === null) return;

            const trackingNumber = newTrackingNumber.trim();
            order.trackingNumber = trackingNumber;
            order.updatedAt = Date.now();
            
            const normalizedId = normalizeOrderId(orderId);
            const isInAllOrders = allOrders.some(o => normalizeOrderId(o.id) === normalizedId);
            const isInUserOrders = userOrders.some(o => normalizeOrderId(o.id) === normalizedId);
            
            if (isInAllOrders) {
                const allOrder = allOrders.find(o => o.id === orderId);
                if (allOrder) {
                    allOrder.trackingNumber = trackingNumber;
                    allOrder.updatedAt = Date.now();
                    localStorage.setItem('allOrders', JSON.stringify(allOrders));
                }
            }
            
            // å¦‚æœè®¢å•åœ¨userOrdersä¸­ï¼Œä¿å­˜å¹¶åŒæ­¥
            if (isInUserOrders) {
                saveUserOrders(); // è¿™ä¼šè§¦å‘äº‘ç«¯åŒæ­¥
            } else if (isInAllOrders && currentUser && currentUser.role === 'admin' && order.account) {
                if (cloudSync && cloudSync.isInitialized) {
                    try {
                        const userOrdersRef = getCloudOrdersRefForOrder(order);
                        if (userOrdersRef) {
                            const snapshot = await userOrdersRef.once('value');
                            const userOrders = snapshot.val() || [];
                            const orderIndex = userOrders.findIndex(o => normalizeOrderId(o.id) === normalizedId);
                            if (orderIndex !== -1) {
                                userOrders[orderIndex].trackingNumber = trackingNumber;
                                userOrders[orderIndex].updatedAt = Date.now();
                                await userOrdersRef.set(userOrders);
                                console.log('âœ… å·²æ›´æ–°å…¶ä»–ç”¨æˆ·çš„è®¢å•å¿«é€’å•å·');
                            }
                        }
                    } catch (err) {
                        console.error('æ›´æ–°å…¶ä»–ç”¨æˆ·è®¢å•å¤±è´¥:', err);
                    }
                }
            }
            
            renderOrdersTable();
            showNotification(t('trackingNumberUpdated'), 'success');

            if (cloudSync && cloudSync.isInitialized && currentUser && currentUser.role === 'admin') {
                cloudSync.loadAllOrders().catch(err => console.warn('åˆ·æ–°æ‰€æœ‰è®¢å•å¤±è´¥', err));
            }
        }

        // æ‰“å¼€è®¢å•çŠ¶æ€æ›´æ–°æ¨¡æ€æ¡†ï¼ˆä½¿ç”¨æŒ‰é’®é€‰æ‹©ï¼‰
        function openOrderStatusModal(orderId) {
            const order = findOrderById(orderId);
            
            if (!order) {
                console.error('æœªæ‰¾åˆ°è®¢å•ï¼Œè®¢å•ID:', orderId);
                console.log('userOrdersæ•°é‡:', userOrders.length);
                console.log('allOrdersæ•°é‡:', allOrders.length);
                showNotification(t('orderNotFound') || 'æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯', 'error');
                return;
            }

            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>${t('updateOrderStatus')}</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">${t('orderInfo')}</h4>
                            <p style="margin: 5px 0;"><strong>${t('orderId')}ï¼š</strong>${order.id}</p>
                            <p style="margin: 5px 0;"><strong>${t('product') || 'äº§å“'}ï¼š</strong>${order.productName}</p>
                            <p style="margin: 5px 0;"><strong>${t('customer') || 'å®¢æˆ·'}ï¼š</strong>${order.customerInfo.name}</p>
                            <p style="margin: 5px 0;"><strong>${t('currentStatus')}ï¼š</strong><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></p>
                        </div>
                        
                        <h4 style="margin-bottom: 15px;">${t('selectNewStatus')}</h4>
                        <div class="status-buttons" style="display: grid; gap: 10px;">
                            <button class="status-select-btn" data-status="review" style="padding: 15px; border: 2px solid #3498db; background: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; color: #3498db; transition: all 0.3s; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-hourglass-half" style="font-size: 20px;"></i>
                                <span>${t('orderReview')}</span>
                            </button>
                            <button class="status-select-btn" data-status="shipping" style="padding: 15px; border: 2px solid #9b59b6; background: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; color: #9b59b6; transition: all 0.3s; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-truck" style="font-size: 20px;"></i>
                                <span>${t('orderShipping')}</span>
                            </button>
                            <button class="status-select-btn" data-status="rejected" style="padding: 15px; border: 2px solid #e74c3c; background: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; color: #e74c3c; transition: all 0.3s; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-times-circle" style="font-size: 20px;"></i>
                                <span>${t('orderRejected')}</span>
                            </button>
                            <button class="status-select-btn" data-status="cancelled" style="padding: 15px; border: 2px solid #95a5a6; background: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; color: #95a5a6; transition: all 0.3s; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-ban" style="font-size: 20px;"></i>
                                <span>${t('orderCancelled')}</span>
                            </button>
                            <button class="status-select-btn" data-status="completed" style="padding: 15px; border: 2px solid #2ecc71; background: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; color: #2ecc71; transition: all 0.3s; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-check-circle" style="font-size: 20px;"></i>
                                <span>${t('orderCompleted')}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ä¸ºçŠ¶æ€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            modal.querySelectorAll('.status-select-btn').forEach(btn => {
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬ä¸ºå›½é™…åŒ–æ–‡æœ¬
                const status = btn.getAttribute('data-status');
                const span = btn.querySelector('span');
                if (span) {
                    if (status === 'review') span.textContent = t('orderReview');
                    else if (status === 'shipping') span.textContent = t('orderShipping');
                    else if (status === 'rejected') span.textContent = t('orderRejected');
                    else if (status === 'cancelled') span.textContent = t('orderCancelled');
                    else if (status === 'completed') span.textContent = t('orderCompleted');
                }
                
                // é«˜äº®å½“å‰çŠ¶æ€
                if (btn.getAttribute('data-status') === order.status) {
                    const color = btn.style.color;
                    btn.style.background = color;
                    btn.style.color = 'white';
                }

                // æ·»åŠ æ‚¬åœæ•ˆæœ
                btn.addEventListener('mouseenter', function () {
                    if (this.getAttribute('data-status') !== order.status) {
                        const color = this.style.color;
                        this.style.background = color;
                        this.style.color = 'white';
                    }
                });

                btn.addEventListener('mouseleave', function () {
                    if (this.getAttribute('data-status') !== order.status) {
                        this.style.background = 'white';
                        const borderColor = this.style.borderColor;
                        this.style.color = borderColor;
                    }
                });

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                btn.addEventListener('click', async function () {
                    const newStatus = this.getAttribute('data-status');
                    const statusText = this.querySelector('span').textContent;

                    if (confirm(`${t('confirmStatusUpdate')}"${statusText}"${t('confirmStatusUpdateSuffix')}`)) {
                        // æ˜¾ç¤ºæ›´æ–°ä¸­æç¤º
                        showNotification(t('updatingOrderStatus'), 'info');
                        
                        try {
                            let handledByCloud = false;

                            // ä¼˜å…ˆä½¿ç”¨â€œäº‘ç«¯ä¸ºå”¯ä¸€çœŸæºâ€çš„ç®¡ç†å‘˜ä¸“ç”¨æ›´æ–°é€»è¾‘
                            if (cloudSync && cloudSync.isInitialized && currentUser && currentUser.role === 'admin') {
                                handledByCloud = await adminUpdateOrderStatusOnCloud(order, newStatus, statusText);
                            }

                            if (handledByCloud) {
                                // äº‘ç«¯æ›´æ–°æˆåŠŸï¼šæœ¬åœ°åˆ—è¡¨ä¾èµ– loadAllOrders å’Œå®æ—¶ç›‘å¬åˆ·æ–°
                                showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º"${statusText}"ï¼Œå·²åŒæ­¥åˆ°äº‘ç«¯ï¼`, 'success');
                                
                                // ç«‹å³åˆ·æ–°åå°è¡¨æ ¼ï¼ˆä½¿ç”¨æœ€æ–°çš„ allOrdersï¼‰
                                if (typeof renderOrdersTable === 'function') {
                                    renderOrdersTable();
                                }
                                if (typeof renderUserOrders === 'function') {
                                    renderUserOrders();
                                }

                                modal.remove();
                                return;
                            }

                            // ===== äº‘ç«¯ä¸å¯ç”¨æˆ–è®¢å•æ‰¾ä¸åˆ°æ—¶ï¼Œå›é€€ä¸ºåŸæœ‰çš„æœ¬åœ° + äº‘ç«¯æ··åˆæ›´æ–°é€»è¾‘ =====

                            // ä½¿ç”¨è§„èŒƒåŒ–IDï¼Œé¿å…å­—ç¬¦ä¸²/æ•°å­—ä¸ä¸€è‡´å¯¼è‡´æ‰¾ä¸åˆ°è®¢å•
                            const targetId = normalizeOrderId(order.id);
                            // è®°å½•è¯¥è®¢å•æ˜¯å¦å­˜åœ¨äºå…¨å±€å’Œç”¨æˆ·è®¢å•æ•°ç»„ä¸­ï¼Œé¿å… isInAllOrders æœªå®šä¹‰å¯¼è‡´æŠ¥é”™
                            const isInAllOrders = Array.isArray(allOrders) && allOrders.some(o => o && normalizeOrderId(o.id) === targetId);
                            const isInUserOrders = Array.isArray(userOrders) && userOrders.some(o => o && normalizeOrderId(o.id) === targetId);

                            // æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆæœ¬åœ°å¯¹è±¡æœ¬èº«ï¼‰
                            order.status = newStatus;
                            order.updatedAt = Date.now();
                            
                            // å¦‚æœè®¢å•åœ¨allOrdersä¸­ï¼Œä¹Ÿéœ€è¦æ›´æ–°
                            const allOrder = allOrders.find(o => normalizeOrderId(o.id) === targetId);
                            if (allOrder) {
                                allOrder.status = newStatus;
                                allOrder.updatedAt = Date.now();
                                localStorage.setItem('allOrders', JSON.stringify(allOrders));
                            }
                            
                            // å¦‚æœè®¢å•åœ¨userOrdersä¸­ï¼Œä¿å­˜å¹¶åŒæ­¥
                            const userOrder = userOrders.find(o => normalizeOrderId(o.id) === targetId);
                            if (userOrder) {
                                // å…ˆæ›´æ–°æœ¬åœ°
                                userOrder.status = newStatus;
                                userOrder.updatedAt = Date.now();
                                // ç«‹å³ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                                if (currentUser && currentUser.account) {
                                    const userOrdersKey = `userOrders_${currentUser.account}`;
                                    localStorage.setItem(userOrdersKey, JSON.stringify(userOrders));
                                }
                                localStorage.setItem('userOrders', JSON.stringify(userOrders));
                                
                                // ç«‹å³åŒæ­¥åˆ°äº‘ç«¯
                                if (cloudSync && cloudSync.isInitialized) {
                                    try {
                                        cloudSync._syncState.inProgress = true;
                                        await cloudSync.syncOrders();
                                        console.log('âœ… è®¢å•çŠ¶æ€å·²åŒæ­¥åˆ°äº‘ç«¯ï¼ˆå›é€€é€»è¾‘ï¼‰');
                                        showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º"${statusText}"ï¼Œå·²åŒæ­¥åˆ°äº‘ç«¯ï¼`, 'success');
                                    } catch (err) {
                                        console.error('äº‘ç«¯åŒæ­¥å¤±è´¥:', err);
                                        showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º"${statusText}"ï¼Œä½†äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•`, 'warning');
                                    } finally {
                                        setTimeout(() => {
                                            cloudSync._syncState.inProgress = false;
                                        }, 2000);
                                    }
                                } else {
                                    showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º"${statusText}"`, 'success');
                                }
                            } else if (isInAllOrders && currentUser && currentUser.role === 'admin' && order.account) {
                                // å¦‚æœè®¢å•ä¸åœ¨userOrdersä¸­ä½†åœ¨allOrdersä¸­ï¼Œéœ€è¦åŒæ­¥åˆ°å¯¹åº”ç”¨æˆ·çš„äº‘ç«¯æ•°æ®
                                if (cloudSync && cloudSync.isInitialized) {
                                    try {
                                        const userOrdersRef = getCloudOrdersRefForOrder(order);
                                        if (!userOrdersRef) {
                                            console.warn('æœªèƒ½è·å–è®¢å•æ‰€å±ç”¨æˆ·çš„äº‘ç«¯è·¯å¾„');
                                            return;
                                        }
                                        const snapshot = await userOrdersRef.once('value');
                                        const cloudUserOrders = snapshot.val() || [];
                                        
                                        // æ›´æ–°è¯¥ç”¨æˆ·çš„è®¢å•
                                        const orderIndex = cloudUserOrders.findIndex(o => o.id === order.id);
                                        if (orderIndex !== -1) {
                                            // ä½¿ç”¨å½“å‰æ—¶é—´æˆ³ï¼Œç¡®ä¿æ¯”ä»»ä½•æœ¬åœ°æ•°æ®éƒ½æ–°
                                            // æ·»åŠ 1æ¯«ç§’ç¡®ä¿æ—¶é—´æˆ³å”¯ä¸€ä¸”æ¯”å½“å‰æ—¶é—´æ–°
                                            const updateTimestamp = Date.now() + 1;
                                            cloudUserOrders[orderIndex].status = newStatus;
                                            cloudUserOrders[orderIndex].updatedAt = updateTimestamp;
                                            
                                            // ç¡®ä¿ä¿ç•™è®¢å•çš„åŸå§‹åˆ›å»ºæ—¶é—´å’Œå…¶ä»–é‡è¦å­—æ®µ
                                            if (!cloudUserOrders[orderIndex].date && order.date) {
                                                cloudUserOrders[orderIndex].date = order.date;
                                            }
                                            // ä¿ç•™å…¶ä»–å­—æ®µ
                                            if (order.productId) cloudUserOrders[orderIndex].productId = order.productId;
                                            if (order.productName) cloudUserOrders[orderIndex].productName = order.productName;
                                            if (order.price !== undefined) cloudUserOrders[orderIndex].price = order.price;
                                            if (order.image) cloudUserOrders[orderIndex].image = order.image;
                                            if (order.customerInfo) cloudUserOrders[orderIndex].customerInfo = order.customerInfo;
                                            if (order.account) cloudUserOrders[orderIndex].account = order.account;
                                            
                                            // ä½¿ç”¨ set æ–¹æ³•æ›´æ–°ï¼Œè¿™ä¼šè§¦å‘æ‰€æœ‰å®¢æˆ·ç«¯çš„å®æ—¶ç›‘å¬å™¨
                                            await userOrdersRef.set(cloudUserOrders);
                                            console.log('âœ… å·²æ›´æ–°å…¶ä»–ç”¨æˆ·çš„è®¢å•çŠ¶æ€åˆ°äº‘ç«¯ï¼ˆå›é€€é€»è¾‘ï¼‰');
                                            console.log('   è®¢å•ID:', order.id);
                                            console.log('   æ–°çŠ¶æ€:', newStatus);
                                            console.log('   æ›´æ–°æ—¶é—´æˆ³:', updateTimestamp);
                                            console.log('ğŸ“¤ å·²è§¦å‘å®æ—¶åŒæ­¥ï¼Œå®¢æˆ·ç«¯å°†è‡ªåŠ¨æ›´æ–°');
                                            
                                            showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º"${statusText}"ï¼Œå·²åŒæ­¥åˆ°å®¢æˆ·è´¦æˆ·ï¼å®¢æˆ·ç«¯å°†è‡ªåŠ¨åˆ·æ–°ã€‚`, 'success');
                                            
                                            // é¢å¤–è§¦å‘ä¸€æ¬¡æ›´æ–°ï¼Œç¡®ä¿å®¢æˆ·ç«¯æ”¶åˆ°ï¼ˆä½¿ç”¨ç¨å¾®ä¸åŒçš„æ—¶é—´æˆ³ï¼‰
                                            setTimeout(async () => {
                                                try {
                                                    cloudUserOrders[orderIndex].updatedAt = Date.now() + 2;
                                                    await userOrdersRef.set(cloudUserOrders);
                                                    console.log('âœ… äºŒæ¬¡åŒæ­¥è§¦å‘æˆåŠŸï¼Œç¡®ä¿å®¢æˆ·ç«¯æ”¶åˆ°æ›´æ–°');
                                                } catch (err) {
                                                    console.warn('äºŒæ¬¡åŒæ­¥è§¦å‘å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', err);
                                                }
                                            }, 300);
                                        } else {
                                            showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º"${statusText}"ï¼Œä½†æœªåœ¨å®¢æˆ·è´¦æˆ·ä¸­æ‰¾åˆ°è¯¥è®¢å•`, 'warning');
                                        }
                                    } catch (err) {
                                        console.error('æ›´æ–°å…¶ä»–ç”¨æˆ·è®¢å•çŠ¶æ€å¤±è´¥:', err);
                                        showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º"${statusText}"ï¼Œä½†åŒæ­¥åˆ°å®¢æˆ·è´¦æˆ·å¤±è´¥`, 'error');
                                    }
                                } else {
                                    showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º"${statusText}"`, 'success');
                                }
                            } else {
                                showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸º"${statusText}"`, 'success');
                            }
                            
                            // ç«‹å³åˆ·æ–°æ˜¾ç¤º
                            renderOrdersTable();
                            renderUserOrders(); // åŒæ—¶æ›´æ–°ç”¨æˆ·ä¸­å¿ƒçš„è®¢å•åˆ—è¡¨
                            
                            modal.remove();

                            if (cloudSync && cloudSync.isInitialized && currentUser && currentUser.role === 'admin') {
                                cloudSync.loadAllOrders().catch(err => console.warn('åˆ·æ–°æ‰€æœ‰è®¢å•å¤±è´¥', err));
                            }
                        } catch (error) {
                            console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
                            showNotification('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                        }
                    }
                });
            });
        }

        // æ‰“å¼€è¯„ä»·æ¨¡æ€æ¡†
        function openReviewModal(orderId) {
            // æŸ¥æ‰¾è®¢å•
            const order = userOrders.find(o => o.id === orderId);
            if (!order) {
                showNotification(t('orderNotFound'), 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»è¯„ä»·è¿‡
            if (order.hasReview) {
                showNotification(t('reviewExists'), 'info');
                return;
            }

            // åˆ›å»ºè¯„ä»·æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'review-modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>${t('writeReview')}</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">${t('purchasedProduct')}ï¼š</h4>
                            <div style="display: flex; gap: 15px; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <img src="${order.image || ''}" alt="${order.productName}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                                <div>
                                    <p style="margin: 0; font-weight: 500; font-size: 16px;">${order.productName}</p>
                                    <p style="margin: 5px 0 0 0;">
                                        <span class="order-price-old">${formatCurrency(order.originalPrice ?? order.price)}</span>
                                        <span class="order-price-new">${formatCurrency(order.promoPrice ?? 0)}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 500;">${t('rating')}ï¼š</label>
                            <div class="rating-stars" style="display: flex; gap: 10px; font-size: 30px; cursor: pointer;">
                                <i class="far fa-star" data-rating="1" style="color: #ddd; transition: all 0.2s;"></i>
                                <i class="far fa-star" data-rating="2" style="color: #ddd; transition: all 0.2s;"></i>
                                <i class="far fa-star" data-rating="3" style="color: #ddd; transition: all 0.2s;"></i>
                                <i class="far fa-star" data-rating="4" style="color: #ddd; transition: all 0.2s;"></i>
                                <i class="far fa-star" data-rating="5" style="color: #ddd; transition: all 0.2s;"></i>
                            </div>
                            <p id="rating-text" style="margin-top: 10px; color: #666; font-size: 14px;"></p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 500;">${t('comment')}ï¼š</label>
                            <textarea id="review-comment" placeholder="${t('commentPlaceholder')}" 
                                      style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="text-align: right;">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="margin-right: 10px;">${t('cancel')}</button>
                            <button class="btn btn-primary" onclick="submitReview(${orderId})">${t('submitReview')}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ç»‘å®šæ˜Ÿçº§è¯„åˆ†äº‹ä»¶
            const stars = modal.querySelectorAll('.rating-stars i');
            let selectedRating = 0;

            stars.forEach((star, index) => {
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    for (let i = 0; i < rating; i++) {
                        stars[i].classList.remove('far');
                        stars[i].classList.add('fas');
                        stars[i].style.color = '#ffc107';
                    }
                    for (let i = rating; i < 5; i++) {
                        stars[i].classList.remove('fas');
                        stars[i].classList.add('far');
                        stars[i].style.color = '#ddd';
                    }
                });

                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.getAttribute('data-rating'));
                    const ratingText = modal.querySelector('#rating-text');
                    ratingText.textContent = `${selectedRating} ${t('stars')}`;
                });
            });

            modal.querySelector('.rating-stars').addEventListener('mouseleave', function() {
                if (selectedRating === 0) {
                    stars.forEach(star => {
                        star.classList.remove('fas');
                        star.classList.add('far');
                        star.style.color = '#ddd';
                    });
                } else {
                    for (let i = 0; i < selectedRating; i++) {
                        stars[i].classList.remove('far');
                        stars[i].classList.add('fas');
                        stars[i].style.color = '#ffc107';
                    }
                    for (let i = selectedRating; i < 5; i++) {
                        stars[i].classList.remove('fas');
                        stars[i].classList.add('far');
                        stars[i].style.color = '#ddd';
                    }
                }
            });
        }

        // æäº¤è¯„ä»·
        async function submitReview(orderId) {
            const order = userOrders.find(o => o.id === orderId);
            if (!order) {
                showNotification(t('orderNotFound'), 'error');
                return;
            }

            // è·å–è¯„åˆ†
            const stars = document.querySelectorAll('#review-modal .rating-stars i.fas');
            const rating = stars.length;
            if (rating === 0) {
                showNotification(t('ratingRequired'), 'error');
                return;
            }

            // è·å–è¯„ä»·å†…å®¹
            const comment = document.getElementById('review-comment').value.trim();
            if (!comment) {
                showNotification(t('reviewRequired'), 'error');
                return;
            }

            // ç¡®ä¿productIdå­˜åœ¨
            if (!order.productId) {
                console.error('è®¢å•ç¼ºå°‘productIdå­—æ®µ:', order);
                showNotification('è®¢å•ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•æäº¤è¯„ä»·', 'error');
                return;
            }

            // åˆ›å»ºè¯„ä»·å¯¹è±¡
            const review = {
                reviewId: 'review_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                productId: order.productId,
                orderId: orderId,
                userId: currentUser.account,
                userName: order.customerInfo.name,
                userPhone: order.customerInfo.phone ? order.customerInfo.phone.substring(0, 3) + '****' + order.customerInfo.phone.substring(7) : '',
                rating: rating,
                comment: comment,
                createdAt: Date.now(),
                productName: order.productName
            };

            // æ›´æ–°è®¢å•ï¼Œæ ‡è®°å·²è¯„ä»·
            order.hasReview = true;
            order.reviewId = review.reviewId;

            // ä¿å­˜è¯„ä»·åˆ°äº§å“ï¼ˆä½¿ç”¨è§„èŒƒåŒ– ID åŒ¹é…ï¼Œé¿å…å­—ç¬¦ä¸²/æ•°å­—ä¸ä¸€è‡´ï¼‰
            const product = products.find(p => normalizeOrderId(p.id) === normalizeOrderId(review.productId));
            if (product) {
                if (!product.reviews) {
                    product.reviews = [];
                }
                product.reviews.push(review);
                product.reviews.sort((a, b) => b.createdAt - a.createdAt); // æŒ‰æ—¶é—´å€’åº
            }

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆäº§å“ä¸è®¢å•ï¼‰
            try {
                localStorage.setItem('products', JSON.stringify(products));
            } catch (e) {
                console.warn('ä¿å­˜äº§å“è¯„ä»·åˆ°æœ¬åœ°å¤±è´¥:', e);
            }
            saveUserOrders();

            // åŒæ­¥åˆ°äº‘ç«¯ï¼ˆä»…åŒæ­¥å½“å‰äº§å“è¯„ä»· + è®¢å•ï¼Œé¿å…æ™®é€šç”¨æˆ·è¦†ç›–å…¨éƒ¨äº§å“ï¼‰
            if (cloudSync && cloudSync.isInitialized) {
                try {
                    // åªåŒæ­¥å½“å‰äº§å“çš„ reviews åˆ°äº‘ç«¯ï¼ˆä½¿ç”¨è§„èŒƒåŒ– ID åŒ¹é…ï¼‰
                    const productIndex = products.findIndex(p => normalizeOrderId(p.id) === normalizeOrderId(review.productId));
                    if (productIndex !== -1 && cloudSync.db) {
                        const reviewsToSync = products[productIndex].reviews || [];
                        await cloudSync.db.ref(`products/${productIndex}/reviews`).set(reviewsToSync);
                        console.log('âœ… å½“å‰äº§å“è¯„ä»·å·²åŒæ­¥åˆ°äº‘ç«¯');
                    } else {
                        console.warn('æœªæ‰¾åˆ°å¯¹åº”äº§å“æˆ– cloudSync.db ä¸å¯ç”¨ï¼Œè·³è¿‡è¯„ä»·äº‘ç«¯åŒæ­¥:', review.productId);
                    }

                    // åŒæ­¥è®¢å•ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
                    await cloudSync.syncOrders();
                } catch (err) {
                    console.error('è¯„ä»·äº‘ç«¯åŒæ­¥å¤±è´¥:', err);
                }
            }

            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('review-modal').remove();

            // æ›´æ–°è®¢å•åˆ—è¡¨ä¸­çš„â€œå†™è¯„ä»·â€æŒ‰é’®ä¸ºæ„Ÿè°¢æç¤º
            try {
                const selector = `.order-item[data-order-id="${orderId}"]`;
                const orderItemEl = document.querySelector(selector);
                if (orderItemEl) {
                    const smallReviewBtn = orderItemEl.querySelector('button.btn.btn-primary.btn-sm');
                    if (smallReviewBtn) {
                        const badge = document.createElement('div');
                        badge.className = 'review-thankyou-badge';
                        badge.innerHTML = `<i class="fas fa-check-circle"></i>${t('reviewThankYou')}`;
                        smallReviewBtn.replaceWith(badge);
                    }
                }

                // è®¢å•è¯¦æƒ…å¼¹çª—ä¸­çš„å¤§æŒ‰é’®ä¹Ÿæ›¿æ¢ä¸ºæ„Ÿè°¢æç¤º
                const orderDetailsModal = document.getElementById('order-details-modal');
                if (orderDetailsModal) {
                    const bigReviewBtn = orderDetailsModal.querySelector('button.btn.btn-primary');
                    if (bigReviewBtn) {
                        const badge = document.createElement('div');
                        badge.className = 'review-thankyou-badge';
                        badge.style.marginTop = '10px';
                        badge.innerHTML = `<i class="fas fa-check-circle"></i>${t('reviewThankYou')}`;
                        bigReviewBtn.replaceWith(badge);
                    }
                }
            } catch (e) {
                console.warn('æ›´æ–°è¯„ä»·æŒ‰é’®å¤–è§‚æ—¶å‡ºé”™:', e);
            }

            // å¦‚æœå½“å‰åœ¨äº§å“è¯¦æƒ…é¡µï¼Œåˆ·æ–°è¯„ä»·åˆ—è¡¨ï¼ˆä½¿ç”¨è§„èŒƒåŒ– ID åˆ¤æ–­æ˜¯å¦åŒä¸€äº§å“ï¼‰
            const productDetail = document.getElementById('product-detail');
            if (
                productDetail &&
                productDetail.style.display !== 'none' &&
                currentProduct &&
                normalizeOrderId(currentProduct.id) === normalizeOrderId(review.productId)
            ) {
                showProductDetail(review.productId);
            }
            
            // å…³é—­è®¢å•è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆå¦‚æœæ‰“å¼€ï¼‰
            const orderDetailsModal = document.getElementById('order-details-modal');
            if (orderDetailsModal) {
                orderDetailsModal.remove();
            }

            // ğŸ è¯„ä»·å®Œæˆï¼Œå¥–åŠ± 2 ä¸ªèœœç½
            try {
                if (currentUser) {
                    const user = allUsers.find(u => u.account === currentUser.account);
                    if (user) {
                        const oldPoints = (user.points == null || isNaN(user.points)) ? 1 : Number(user.points);
                        const newPoints = oldPoints + 2;
                        user.points = newPoints;
                        currentUser.points = newPoints;
                        saveAllUsers();
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));

                        // å³æ—¶æ›´æ–°ä¸ªäººä¸­å¿ƒèœœç½æ˜¾ç¤º
                        const badge = document.getElementById('user-points-badge');
                        const valueEl = document.getElementById('user-points-value');
                        if (badge && valueEl) {
                            badge.style.display = 'inline-flex';
                            valueEl.textContent = newPoints;
                        }

                        showNotification((t && t('reviewSubmitted')) || 'è¯„ä»·å·²æäº¤ï¼Œç§¯åˆ† +1', 'success');
                        showNotification((t && t('pointsReviewReward')) || 'ğŸ‰ è¯„ä»·å¥–åŠ±ï¼šç§¯åˆ† +1', 'success');
                        return;
                    }
                }
            } catch (err) {
                console.warn('æ›´æ–°è¯„ä»·ç§¯åˆ†æ—¶å‡ºé”™:', err);
            }

            showNotification(t('reviewSubmitted'), 'success');
        }

        // ä¿æŒåŸæœ‰çš„updateOrderStatuså‡½æ•°ä½œä¸ºå¤‡ç”¨ï¼ˆå·²å¼ƒç”¨ï¼‰
        function updateOrderStatus(orderId) {
            openOrderStatusModal(orderId);
        }

        function findReviewByOrder(order) {
            if (!order) return null;
            if (order.productId && order.reviewId) {
                const product = products.find(p => p.id === order.productId);
                if (product && Array.isArray(product.reviews)) {
                    const index = product.reviews.findIndex(r => r.reviewId === order.reviewId);
                    if (index > -1) {
                        return { product, index };
                    }
                }
            }
            return findReviewContextByOrderId(order.id);
        }

        async function replyToReview(orderId) {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†å‘˜å¯ä»¥å›å¤è¯„ä»·', 'warning');
                return;
            }

            const order = findOrderById(orderId);
            if (!order) {
                console.warn('æœªæ‰¾åˆ°è®¢å•ï¼Œä½†å°è¯•ç›´æ¥å®šä½è¯„ä»·è®°å½•');
            }

            const found = order ? findReviewByOrder(order) : findReviewContextByOrderId(orderId);
            if (!found || found.index === -1) {
                showNotification(t('reviewNotFound'), 'error');
                return;
            }

            const { product, index } = found;
            const currentReply = product.reviews[index].adminReply || '';
            const reply = prompt(t('adminReply'), currentReply);
            if (reply === null) return;

            product.reviews[index].adminReply = reply.trim();
            localStorage.setItem('products', JSON.stringify(products));

            if (cloudSync && cloudSync.isInitialized) {
                try {
                    await cloudSync.syncProducts();
                } catch (error) {
                    console.error('åŒæ­¥ç®¡ç†å‘˜å›å¤å¤±è´¥:', error);
                }
            }

            const productDetail = document.getElementById('product-detail');
            if (productDetail && productDetail.style.display !== 'none' && currentProduct && currentProduct.id === product.id) {
                showProductDetail(product.id);
            }
            const detailsModal = document.getElementById('order-details-modal');
            if (detailsModal) {
                detailsModal.remove();
                showOrderDetailsModal(orderId);
            }

            showNotification('å›å¤å·²ä¿å­˜', 'success');
        }

        async function deleteReview(orderId) {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤è¯„ä»·', 'warning');
                return;
            }

            const order = findOrderById(orderId);
            if (!order) {
                console.warn('æœªæ‰¾åˆ°è®¢å•è®°å½•ï¼Œå°†ç›´æ¥å°è¯•åˆ é™¤è¯„ä»·');
            } else if (!order.hasReview) {
                showNotification('è¯¥è®¢å•æš‚æ— è¯„ä»·', 'info');
                return;
            }

            if (!confirm(t('confirmDeleteReview'))) {
                return;
            }

            const found = order ? findReviewByOrder(order) : findReviewContextByOrderId(orderId);
            if (found && found.index > -1) {
                const { product, index } = found;
                product.reviews.splice(index, 1);
                localStorage.setItem('products', JSON.stringify(products));
            } else {
                showNotification('æœªæ‰¾åˆ°å¯¹åº”è¯„ä»·ï¼Œæ— æ³•åˆ é™¤', 'error');
                return;
            }

            if (order) {
                order.hasReview = false;
                delete order.reviewId;
                saveUserOrders();
            }

            if (cloudSync && cloudSync.isInitialized) {
                try {
                    await cloudSync.syncProducts();
                    await cloudSync.syncOrders();
                } catch (error) {
                    console.error('åˆ é™¤è¯„ä»·ååŒæ­¥å¤±è´¥:', error);
                }
            }

            const productDetail = document.getElementById('product-detail');
            if (productDetail && productDetail.style.display !== 'none' && currentProduct && currentProduct.id === order.productId) {
                showProductDetail(order.productId);
            }

            const detailsModal = document.getElementById('order-details-modal');
            if (detailsModal) {
                detailsModal.remove();
                showOrderDetailsModal(orderId);
            }

            showNotification('è¯„ä»·å·²åˆ é™¤', 'success');
        }

        async function handleReviewReply(productId, reviewId, targetType = 'review', targetReplyId = null, targetUserName = '') {
            if (!currentUser) {
                showNotification('è¯·å…ˆç™»å½•åå†å›å¤è¯„ä»·', 'warning');
                return;
            }

            const product = products.find(p => normalizeOrderId(p.id) === normalizeOrderId(productId));
            if (!product || !Array.isArray(product.reviews)) {
                showNotification('æœªæ‰¾åˆ°è¯¥è¯„ä»·', 'error');
                return;
            }

            const review = product.reviews.find(r => r.reviewId === reviewId);
            if (!review) {
                showNotification('æœªæ‰¾åˆ°è¯¥è¯„ä»·', 'error');
                return;
            }

            // æ„é€ æç¤ºæ–‡æ¡ˆï¼šåŒºåˆ†å›å¤ä¸»è¯„ä»·è¿˜æ˜¯å›å¤æŸæ¡å°è¯„è®º
            const basePlaceholder = t('replyPlaceholder');
            const promptLabel = targetUserName
                ? `${basePlaceholder} (@${targetUserName})`
                : basePlaceholder;

            const replyContent = prompt(promptLabel);
            if (replyContent === null) return;

            const message = replyContent.trim();
            if (!message) {
                showNotification(t('replyContentCannotBeEmpty'), 'warning');
                return;
            }

            if (!Array.isArray(review.replies)) {
                review.replies = [];
            }

            review.replies.push({
                replyId: 'reply_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6),
                account: currentUser.account,
                userName: currentUser.username || currentUser.account,
                message,
                createdAt: Date.now(),
                replyToType: targetType,
                replyToReplyId: targetReplyId,
                replyToUserName: targetUserName || (targetType === 'review' ? (review.userName || '') : '')
            });

            localStorage.setItem('products', JSON.stringify(products));

            // åŒæ­¥å½“å‰äº§å“çš„è¯„ä»·åˆ°äº‘ç«¯ï¼ˆåŒ…å«ç”¨æˆ·å›å¤ï¼‰
            if (cloudSync && cloudSync.isInitialized && cloudSync.db) {
                try {
                    const productIndex = products.findIndex(p => normalizeOrderId(p.id) === normalizeOrderId(product.id));
                    if (productIndex !== -1) {
                        const reviewsToSync = products[productIndex].reviews || [];
                        await cloudSync.db.ref(`products/${productIndex}/reviews`).set(reviewsToSync);
                        console.log('âœ… è¯„ä»·å›å¤å·²åŒæ­¥åˆ°äº‘ç«¯');
                    } else {
                        console.warn('æœªæ‰¾åˆ°å¯¹åº”äº§å“ï¼Œæ— æ³•åŒæ­¥è¯„ä»·å›å¤åˆ°äº‘ç«¯:', product.id);
                    }
                } catch (error) {
                    console.error('åŒæ­¥å›å¤å¤±è´¥:', error);
                }
            }

            showProductDetail(product.id);
            showNotification(t('replySuccess') || 'å›å¤å·²æäº¤', 'success');
        }

        // ç®¡ç†å‘˜åˆ é™¤å•æ¡ç”¨æˆ·å›å¤ï¼ˆå°è¯„è®ºï¼‰
        async function deleteReviewReply(productId, reviewId, replyId) {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ç”¨æˆ·å›å¤', 'warning');
                return;
            }

            const product = products.find(p => normalizeOrderId(p.id) === normalizeOrderId(productId));
            if (!product || !Array.isArray(product.reviews)) {
                showNotification('æœªæ‰¾åˆ°å¯¹åº”äº§å“æˆ–è¯„ä»·', 'error');
                return;
            }

            const review = product.reviews.find(r => r.reviewId === reviewId);
            if (!review || !Array.isArray(review.replies)) {
                showNotification('æœªæ‰¾åˆ°å¯¹åº”å›å¤', 'error');
                return;
            }

            if (!confirm(t('confirmDeleteReview') || 'ç¡®å®šè¦åˆ é™¤è¿™æ¡å›å¤å—ï¼Ÿ')) {
                return;
            }

            const index = review.replies.findIndex(r => r.replyId === replyId);
            if (index === -1) {
                showNotification('æœªæ‰¾åˆ°å¯¹åº”å›å¤', 'error');
                return;
            }

            review.replies.splice(index, 1);
            localStorage.setItem('products', JSON.stringify(products));

            // åŒæ­¥å½“å‰äº§å“çš„è¯„ä»·åˆ°äº‘ç«¯
            if (cloudSync && cloudSync.isInitialized && cloudSync.db) {
                try {
                    const productIndex = products.findIndex(p => normalizeOrderId(p.id) === normalizeOrderId(product.id));
                    if (productIndex !== -1) {
                        const reviewsToSync = products[productIndex].reviews || [];
                        await cloudSync.db.ref(`products/${productIndex}/reviews`).set(reviewsToSync);
                        console.log('âœ… ç”¨æˆ·å›å¤å·²ä»äº‘ç«¯åˆ é™¤');
                    } else {
                        console.warn('æœªæ‰¾åˆ°å¯¹åº”äº§å“ï¼Œæ— æ³•åŒæ­¥åˆ é™¤åçš„å›å¤åˆ°äº‘ç«¯:', product.id);
                    }
                } catch (error) {
                    console.error('åˆ é™¤å›å¤ååŒæ­¥å¤±è´¥:', error);
                }
            }

            // åˆ·æ–°å½“å‰äº§å“è¯¦æƒ…é¡µ
            showProductDetail(product.id);
            showNotification('å›å¤å·²åˆ é™¤', 'success');
        }

        // å¯¼å‡ºç”¨æˆ·æ•°æ®
        function exportUsersData() {
            const csvContent = "data:text/csv;charset=utf-8," +
                "ID,ç”¨æˆ·å,è´¦å·,è§’è‰²,æ³¨å†Œæ—¶é—´,èœœç½,çŠ¶æ€\n" +
                [...Object.entries(ADMIN_ACCOUNTS).map(([account, info]) =>
                    `${account},${info.username},${account},ç®¡ç†å‘˜,ç³»ç»Ÿé¢„è®¾,0,æ­£å¸¸`
                ), ...allUsers.map(user => {
                    const points = (user.points == null || isNaN(user.points)) ? 1 : Number(user.points);
                    return `${user.id},${user.username},${user.account},æ™®é€šç”¨æˆ·,${user.registerTime},${points},${user.status}`;
                })].join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "users_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // å¯¼å‡ºè®¢å•æ•°æ®
        function exportOrdersData() {
            const csvContent = "data:text/csv;charset=utf-8," +
                "è®¢å•ID,äº§å“åç§°,ä»·æ ¼,å®¢æˆ·å§“å,å®¢æˆ·ç”µè¯,å®¢æˆ·é‚®ç®±,å®¢æˆ·åœ°å€,è®¢å•çŠ¶æ€,å¿«é€’å•å·,ä¸‹å•æ—¶é—´\n" +
                userOrders.map(order =>
                    `${order.id},${order.productName},${order.price},${order.customerInfo.name},${order.customerInfo.phone},${order.customerInfo.email},${order.customerInfo.address},${getStatusText(order.status)},${order.trackingNumber || ''},${order.date}`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "orders_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æŒ‰é’®åé¦ˆæ•ˆæœ
        function showButtonFeedback(buttonId, callback) {
            const button = document.getElementById(buttonId);
            const originalText = button.textContent;

            // æ˜¾ç¤ºåˆ·æ–°çŠ¶æ€
            button.classList.add('btn-refreshing');
            button.disabled = true;

            // æ‰§è¡Œå›è°ƒå‡½æ•°
            try {
                callback();

                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                setTimeout(() => {
                    button.classList.remove('btn-refreshing');
                    button.classList.add('btn-success');

                    // æ¢å¤åŸå§‹çŠ¶æ€
                    setTimeout(() => {
                        button.classList.remove('btn-success');
                        button.disabled = false;
                    }, 1500);
                }, 800);

            } catch (error) {
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                button.classList.remove('btn-refreshing');
                button.classList.add('btn-danger');
                button.textContent = 'æ“ä½œå¤±è´¥';

                setTimeout(() => {
                    button.classList.remove('btn-danger');
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }

        // ä¸»é¡µè®¾ç½®æ•°æ®
        let homepageSettings = JSON.parse(localStorage.getItem('homepageSettings')) || {
            siteTitle: 'ç”µå•†å¹³å°',
            siteSlogan: 'ä¼˜è´¨å•†å“ï¼Œå€¼å¾—ä¿¡èµ–',
            siteLogo: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_acd40833aec9706776e6e1e4432f7198_ProductImage_PT02',
            primaryColor: '#3498db',
            secondaryColor: '#2ecc71',
            fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
            productsPerRow: 4,
            showCategories: true,
            showSearch: true,
            desktopCarousel: [
                {
                    id: 1,
                    image: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_74a4f2a269eeee0e43f867fff8416a45_ProductImage_MAIN',
                    title: 'æ–°å“ä¸Šå¸‚',
                    description: 'æ¢ç´¢æˆ‘ä»¬æœ€æ–°çš„äº§å“ç³»åˆ—ï¼Œäº«å—é™æ—¶ä¼˜æƒ ',
                    buttonText: 'ç«‹å³è´­ä¹°',
                    active: true
                },
                {
                    id: 2,
                    image: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_0c7821e20b2ca904579150a5c33caa82_ProductImage_PT01',
                    title: 'é™æ—¶ç‰¹æƒ ',
                    description: 'ç²¾é€‰å•†å“ä½è‡³5æŠ˜ï¼Œé”™è¿‡å†ç­‰ä¸€å¹´',
                    buttonText: 'æŸ¥çœ‹è¯¦æƒ…',
                    active: true
                }
            ],
            mobileCarousel: [
                {
                    id: 101,
                    image: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_74a4f2a269eeee0e43f867fff8416a45_ProductImage_MAIN',
                    title: 'ç§»åŠ¨ç«¯ä¸“äº«',
                    description: 'ä¸“ä¸ºæ‰‹æœºå±å¹•è£åˆ‡çš„è§†è§‰ä½“éªŒ',
                    buttonText: 'ç«‹å³æŸ¥çœ‹',
                    active: true
                },
                {
                    id: 102,
                    image: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_0c7821e20b2ca904579150a5c33caa82_ProductImage_PT01',
                    title: 'å£ç¢‘å¥½ç‰©',
                    description: 'çœŸå®ç”¨æˆ·åé¦ˆï¼Œæ”¾å¿ƒä½“éªŒ',
                    buttonText: 'æŸ¥çœ‹æ›´å¤š',
                    active: true
                }
            ]
        };

        homepageSettings = normalizeHomepageSettings(homepageSettings);

        function normalizeHomepageSettings(settings) {
            const normalized = { ...settings };

            if (!Array.isArray(normalized.desktopCarousel) && Array.isArray(normalized.carousel)) {
                normalized.desktopCarousel = normalized.carousel;
            }

            if (!Array.isArray(normalized.desktopCarousel)) {
                normalized.desktopCarousel = [];
            }

            if (!Array.isArray(normalized.mobileCarousel)) {
                normalized.mobileCarousel = JSON.parse(JSON.stringify(normalized.desktopCarousel));
            }

            normalized.desktopCarousel = normalized.desktopCarousel.map(item => ({
                active: true,
                ...item
            }));

            normalized.mobileCarousel = normalized.mobileCarousel.map(item => ({
                active: true,
                ...item
            }));

            if (normalized.carousel) {
                delete normalized.carousel;
            }

            return normalized;
        }

        // åŠ è½½ä¸»é¡µè®¾ç½®
        function loadHomepageSettings() {
            homepageSettings = normalizeHomepageSettings(homepageSettings);
            // åŠ è½½ç½‘ç«™ä¿¡æ¯
            document.getElementById('site-title').value = homepageSettings.siteTitle;
            document.getElementById('site-slogan').value = homepageSettings.siteSlogan;
            document.getElementById('site-logo').value = homepageSettings.siteLogo;

            // åŠ è½½ä¸»é¢˜è®¾ç½®
            document.getElementById('primary-color').value = homepageSettings.primaryColor;
            document.getElementById('secondary-color').value = homepageSettings.secondaryColor;
            document.getElementById('font-family').value = homepageSettings.fontFamily;

            // åŠ è½½å¸ƒå±€è®¾ç½®
            document.getElementById('products-per-row').value = homepageSettings.productsPerRow;
            document.getElementById('show-categories').checked = homepageSettings.showCategories;
            document.getElementById('show-search').checked = homepageSettings.showSearch;

            // æ¸²æŸ“è½®æ’­å›¾åˆ—è¡¨
            renderCarouselList('desktop');
            renderCarouselList('mobile');
        }

        // æ¸²æŸ“è½®æ’­å›¾åˆ—è¡¨
        function renderCarouselList(type = 'desktop') {
            const listId = type === 'mobile' ? 'carousel-list-mobile' : 'carousel-list-desktop';
            const carouselList = document.getElementById(listId);
            if (!carouselList) return;

            const carouselData = type === 'mobile'
                ? (homepageSettings.mobileCarousel || [])
                : (homepageSettings.desktopCarousel || []);

            if (carouselData.length === 0) {
                carouselList.innerHTML = `<p style="text-align: center; color: #999; padding: 20px;">æš‚æ— ${type === 'mobile' ? 'ç§»åŠ¨ç«¯' : 'PCç«¯'}è½®æ’­å›¾</p>`;
                return;
            }

            carouselList.innerHTML = carouselData.map(item => `
                <div class="carousel-item">
                    <div class="carousel-preview" style="background-image: url('${item.image}')"></div>
                    <div class="carousel-info">
                        <div class="carousel-title">${item.title}</div>
                        <div class="carousel-desc">${item.description}</div>
                    </div>
                    <div class="carousel-actions">
                        <button class="btn btn-sm btn-primary" onclick="editCarouselItem(${item.id}, '${type}')">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCarouselItem(${item.id}, '${type}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // ç¼–è¾‘è½®æ’­å›¾
        function editCarouselItem(id, type = 'desktop') {
            const collection = type === 'mobile'
                ? (homepageSettings.mobileCarousel || [])
                : (homepageSettings.desktopCarousel || []);
            const item = collection.find(c => c.id === id);
            if (!item) return;

            openCarouselEditModal(type, item);
        }

        // åˆ é™¤è½®æ’­å›¾
        function deleteCarouselItem(id, type = 'desktop') {
            const targetLabel = type === 'mobile' ? t('mobile') : t('desktop');
            customConfirm(t('confirmDeleteCarousel').replace('{targetLabel}', targetLabel), t('confirmTitle')).then(confirmed => {
                if (confirmed) {
                    if (type === 'mobile') {
                        homepageSettings.mobileCarousel = (homepageSettings.mobileCarousel || []).filter(c => c.id !== id);
                    } else {
                        homepageSettings.desktopCarousel = (homepageSettings.desktopCarousel || []).filter(c => c.id !== id);
                    }
                    saveHomepageSettings();
                    renderCarouselList(type);
                    showNotification(`${targetLabel}è½®æ’­å›¾å·²åˆ é™¤`, 'success');
                }
            });
        }

        // æ·»åŠ è½®æ’­å›¾
        function addCarouselItem(type = 'desktop') {
            openCarouselEditModal(type, null);
        }

        // ä¿å­˜ä¸»é¡µè®¾ç½®
        function saveHomepageSettings() {
            // æ›´æ–°è®¾ç½®å¯¹è±¡
            homepageSettings.siteTitle = document.getElementById('site-title').value;
            homepageSettings.siteSlogan = document.getElementById('site-slogan').value;
            homepageSettings.siteLogo = document.getElementById('site-logo').value;
            homepageSettings.primaryColor = document.getElementById('primary-color').value;
            homepageSettings.secondaryColor = document.getElementById('secondary-color').value;
            homepageSettings.fontFamily = document.getElementById('font-family').value;
            homepageSettings.productsPerRow = parseInt(document.getElementById('products-per-row').value);
            homepageSettings.showCategories = document.getElementById('show-categories').checked;
            homepageSettings.showSearch = document.getElementById('show-search').checked;

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('homepageSettings', JSON.stringify(homepageSettings));

            // åº”ç”¨è®¾ç½®åˆ°é¡µé¢
            applyHomepageSettings();

            // åŒæ­¥åˆ°äº‘ç«¯
            if (cloudSync && cloudSync.isInitialized) {
                cloudSync.syncHomepageSettings().catch(err => {
                    console.warn('ä¸»é¡µè®¾ç½®äº‘ç«¯åŒæ­¥å¤±è´¥:', err);
                });
            }

            showNotification('ä¸»é¡µè®¾ç½®å·²ä¿å­˜', 'success');
        }

        // åº”ç”¨ä¸»é¡µè®¾ç½®åˆ°é¡µé¢
        function applyHomepageSettings() {
            // ç¡®ä¿ä¸»é¡µè®¾ç½®ç»“æ„å®Œæ•´ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬æ•°æ®ï¼‰ï¼Œé¿å…è½®æ’­å›¾é¦–æ¬¡è¿›å…¥ä¸æ˜¾ç¤º
            try {
                homepageSettings = normalizeHomepageSettings(homepageSettings || {});
            } catch (e) {
                console.warn('è§„èŒƒåŒ–ä¸»é¡µè®¾ç½®å¤±è´¥ï¼Œæ¢å¤ä¸ºé»˜è®¤é…ç½®:', e);
                homepageSettings = normalizeHomepageSettings({
                    siteTitle: 'ç”µå•†å¹³å°',
                    siteSlogan: 'ä¼˜è´¨å•†å“ï¼Œå€¼å¾—ä¿¡èµ–',
                    siteLogo: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_acd40833aec9706776e6e1e4432f7198_ProductImage_PT02',
                    primaryColor: '#3498db',
                    secondaryColor: '#2ecc71',
                    fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                    productsPerRow: 4,
                    showCategories: true,
                    showSearch: true,
                    desktopCarousel: [],
                    mobileCarousel: []
                });
            }
            // æ›´æ–°ç½‘ç«™Logo
            const logoImg = document.getElementById('site-logo-img');
            if (logoImg) {
                const logoUrl = homepageSettings.siteLogo || 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_acd40833aec9706776e6e1e4432f7198_ProductImage_PT02';
                if (logoUrl) {
                    logoImg.src = logoUrl;
                    logoImg.style.display = 'block';
                    logoImg.style.visibility = 'visible';
                    logoImg.style.opacity = '1';
                    logoImg.style.height = '60px';
                    logoImg.style.maxWidth = '300px';
                    logoImg.style.width = 'auto';
                    // ç¡®ä¿logoå®¹å™¨ä¹Ÿå¯è§
                    const logoContainer = document.getElementById('home-link');
                    if (logoContainer) {
                        logoContainer.style.display = 'flex';
                        logoContainer.style.visibility = 'visible';
                        logoContainer.style.marginLeft = '20px';
                    }
                } else {
                    logoImg.style.display = 'none';
                }
            }

            // æ›´æ–°CSSå˜é‡
            document.documentElement.style.setProperty('--primary', homepageSettings.primaryColor);
            document.documentElement.style.setProperty('--secondary', homepageSettings.secondaryColor);
            document.documentElement.style.setProperty('--font-family', homepageSettings.fontFamily);

            // æ›´æ–°äº§å“ç½‘æ ¼å¸ƒå±€
            const productsGrid = document.getElementById('products-grid');
            if (productsGrid) {
                // productsGrid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${300 / homepageSettings.productsPerRow}px, 1fr))`;
            }

            // æ›´æ–°è½®æ’­å›¾
            updateCarousel();

            // æ›´æ–°åˆ†ç±»ç­›é€‰æ˜¾ç¤º
            const categoryFilter = document.querySelector('.category-filter');
            if (categoryFilter) {
                categoryFilter.style.display = homepageSettings.showCategories ? 'flex' : 'none';
            }

            // æ›´æ–°æœç´¢æ¡†æ˜¾ç¤º
            const searchBar = document.querySelector('.search-bar');
            if (searchBar) {
                searchBar.style.display = homepageSettings.showSearch ? 'flex' : 'none';
            }
        }

        // æ›´æ–°è½®æ’­å›¾
        function updateCarousel() {
            const carousel = document.querySelector('.carousel');
            if (!carousel) return;

            const activeSlides = getSlidesForViewport();

            const slidesHTML = activeSlides.map((item, index) => `
                <div class="carousel-slide ${index === 0 ? 'active' : ''}" style="background-image: url('${item.image}')">
                    <div class="carousel-content">
                        <h2>${item.title}</h2>
                        <p>${item.description}</p>
                        <a href="#" class="carousel-btn">${item.buttonText}</a>
                    </div>
                </div>
            `).join('');

            const indicatorsHTML = activeSlides.map((_, index) => `
                <div class="indicator ${index === 0 ? 'active' : ''}"></div>
            `).join('');

            carousel.innerHTML = `<div class="carousel-arrow prev">&#10094;</div>` + 
                                 slidesHTML + 
                                 `<div class="carousel-arrow next">&#10095;</div>` +
                                 `<div class="carousel-indicators">${indicatorsHTML}</div>`;
            
            // é‡æ–°åˆå§‹åŒ–è½®æ’­å›¾åŠŸèƒ½
            initCarousel();
        }

        function getSlidesForViewport() {
            const isMobileView = window.innerWidth <= 768;
            const source = isMobileView
                ? (homepageSettings.mobileCarousel || [])
                : (homepageSettings.desktopCarousel || []);
            return source.filter(item => item.active !== false);
        }

        window.addEventListener('resize', debounce(() => {
            updateCarousel();
        }, 200));

        // è½®æ’­å›¾è‡ªåŠ¨åˆ‡æ¢å®šæ—¶å™¨ï¼ˆå…¨å±€å˜é‡ï¼Œç”¨äºæ¸…é™¤ï¼‰
        let carouselInterval = null;

        // åˆå§‹åŒ–è½®æ’­å›¾åŠŸèƒ½
        function initCarousel() {
            const carouselContainer = document.querySelector('.carousel');
            if (!carouselContainer) return;

            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (carouselInterval) {
                clearInterval(carouselInterval);
                carouselInterval = null;
            }

            const slides = document.querySelectorAll('.carousel-slide');
            const indicators = document.querySelectorAll('.indicator');
            const prevArrow = document.querySelector('.carousel-arrow.prev');
            const nextArrow = document.querySelector('.carousel-arrow.next');
            
            if (slides.length === 0) return;

            let currentSlide = 0;
            
            // æ‰¾åˆ°å½“å‰æ¿€æ´»çš„slide
            slides.forEach((slide, index) => {
                if (slide.classList.contains('active')) {
                    currentSlide = index;
                }
            });

            // å®šä¹‰showSlideå‡½æ•°
            function showSlide(n) {
                slides.forEach(slide => slide.classList.remove('active'));
                indicators.forEach(indicator => indicator.classList.remove('active'));

                currentSlide = (n + slides.length) % slides.length;

                if (slides[currentSlide]) {
                    slides[currentSlide].classList.add('active');
                }
                if (indicators[currentSlide]) {
                    indicators[currentSlide].classList.add('active');
                }
            }

            // è‡ªåŠ¨è½®æ’­
            carouselInterval = setInterval(() => {
                showSlide(currentSlide + 1);
            }, 5000);

            // æŒ‡ç¤ºç‚¹ç‚¹å‡»åˆ‡æ¢
            indicators.forEach((indicator, index) => {
                indicator.addEventListener('click', () => {
                    if (carouselInterval) {
                        clearInterval(carouselInterval);
                    }
                    showSlide(index);
                    carouselInterval = setInterval(() => {
                        showSlide(currentSlide + 1);
                    }, 5000);
                });
            });

            // å·¦å³æŒ‰é’®ç‚¹å‡»åˆ‡æ¢
            if (prevArrow) {
                prevArrow.addEventListener('click', () => {
                    if (carouselInterval) {
                        clearInterval(carouselInterval);
                    }
                    showSlide(currentSlide - 1);
                    carouselInterval = setInterval(() => {
                        showSlide(currentSlide + 1);
                    }, 5000);
                });
            }

            if (nextArrow) {
                nextArrow.addEventListener('click', () => {
                    if (carouselInterval) {
                        clearInterval(carouselInterval);
                    }
                    showSlide(currentSlide + 1);
                    carouselInterval = setInterval(() => {
                        showSlide(currentSlide + 1);
                    }, 5000);
                });
            }

            // é¼ æ ‡æ‹–æ‹½ / è§¦æ‘¸æ»‘åŠ¨åˆ‡æ¢
            let dragStartX = null;
            let isDragging = false;

            function getClientX(event) {
                if (event.touches && event.touches.length) {
                    return event.touches[0].clientX;
                }
                if (event.changedTouches && event.changedTouches.length) {
                    return event.changedTouches[0].clientX;
                }
                return event.clientX;
            }

            function handleDragStart(event) {
                isDragging = true;
                dragStartX = getClientX(event);
            }

            function handleDragEnd(event) {
                if (!isDragging || dragStartX === null) return;
                const endX = getClientX(event);
                const deltaX = endX - dragStartX;
                const threshold = 50; // è¶…è¿‡ 50px åˆ¤å®šä¸ºæ»‘åŠ¨

                if (Math.abs(deltaX) > threshold) {
                    if (carouselInterval) {
                        clearInterval(carouselInterval);
                    }
                    if (deltaX < 0) {
                        // å‘å·¦æ‹–ï¼šä¸‹ä¸€å¼ 
                        showSlide(currentSlide + 1);
                    } else {
                        // å‘å³æ‹–ï¼šä¸Šä¸€å¼ 
                        showSlide(currentSlide - 1);
                    }
                    carouselInterval = setInterval(() => {
                        showSlide(currentSlide + 1);
                    }, 5000);
                }

                isDragging = false;
                dragStartX = null;
            }

            if (carouselContainer) {
                // é¼ æ ‡äº‹ä»¶
                carouselContainer.addEventListener('mousedown', handleDragStart);
                window.addEventListener('mouseup', handleDragEnd);

                // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                carouselContainer.addEventListener('touchstart', handleDragStart, { passive: true });
                carouselContainer.addEventListener('touchend', handleDragEnd);
            }
        }

        // é‡ç½®ä¸»é¡µè®¾ç½®
        function resetHomepageSettings() {
            if (confirm(t('confirmResetHomepageSettings'))) {
                homepageSettings = normalizeHomepageSettings({
                    siteTitle: 'ç”µå•†å¹³å°',
                    siteSlogan: 'ä¼˜è´¨å•†å“ï¼Œå€¼å¾—ä¿¡èµ–',
                    siteLogo: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_acd40833aec9706776e6e1e4432f7198_ProductImage_PT02',
                    primaryColor: '#3498db',
                    secondaryColor: '#2ecc71',
                    fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                    productsPerRow: 4,
                    showCategories: true,
                    showSearch: true,
                    desktopCarousel: [
                        {
                            id: 1,
                            image: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_74a4f2a269eeee0e43f867fff8416a45_ProductImage_MAIN',
                            title: 'æ–°å“ä¸Šå¸‚',
                            description: 'æ¢ç´¢æˆ‘ä»¬æœ€æ–°çš„äº§å“ç³»åˆ—ï¼Œäº«å—é™æ—¶ä¼˜æƒ ',
                            buttonText: 'ç«‹å³è´­ä¹°',
                            active: true
                        },
                        {
                            id: 2,
                            image: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_0c7821e20b2ca904579150a5c33caa82_ProductImage_PT01',
                            title: 'é™æ—¶ç‰¹æƒ ',
                            description: 'ç²¾é€‰å•†å“ä½è‡³5æŠ˜ï¼Œé”™è¿‡å†ç­‰ä¸€å¹´',
                            buttonText: 'æŸ¥çœ‹è¯¦æƒ…',
                            active: true
                        }
                    ],
                    mobileCarousel: [
                        {
                            id: 101,
                            image: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_74a4f2a269eeee0e43f867fff8416a45_ProductImage_MAIN',
                            title: 'ç§»åŠ¨ç«¯ä¸“äº«',
                            description: 'ä¸“ä¸ºæ‰‹æœºå±å¹•è£åˆ‡çš„è§†è§‰ä½“éªŒ',
                            buttonText: 'ç«‹å³æŸ¥çœ‹',
                            active: true
                        },
                        {
                            id: 102,
                            image: 'https://d92ap0lo8fr10.cloudfront.net/A14TLSYJXI3UM6_0c7821e20b2ca904579150a5c33caa82_ProductImage_PT01',
                            title: 'å£ç¢‘å¥½ç‰©',
                            description: 'çœŸå®ç”¨æˆ·åé¦ˆï¼Œæ”¾å¿ƒä½“éªŒ',
                            buttonText: 'æŸ¥çœ‹æ›´å¤š',
                            active: true
                        }
                    ]
                });

                saveHomepageSettings();
                loadHomepageSettings();
                showNotification('ä¸»é¡µè®¾ç½®å·²é‡ç½®', 'success');
            }
        }

        // æ¸²æŸ“åå°ç®¡ç†äº§å“
        function renderAdminProducts() {
            const adminProductsGrid = document.getElementById('admin-products-grid');
            const searchTerm = (adminProductSearchTerm || '').trim();
            const normalizedTerm = searchTerm.toLowerCase();
            const filteredProducts = normalizedTerm
                ? products.filter(product => {
                    if (!product) return false;
                    const searchFields = [
                        product.name,
                        product.category,
                        product.description,
                        product.id,
                        product.sku,
                        Array.isArray(product.tags) ? product.tags.join(' ') : ''
                    ];
                    return searchFields.some(field => {
                        if (field === undefined || field === null) return false;
                        return field.toString().toLowerCase().includes(normalizedTerm);
                    });
                })
                : [...products];

            if (filteredProducts.length === 0) {
                const emptyMessage = searchTerm
                    ? 'æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯'
                    : t('noProductsAddOrImport');
                adminProductsGrid.innerHTML = `<div class="no-products">${emptyMessage}</div>`;
                updatePaginationControls('products', 0);
                return;
            }

            const { items: paginatedProducts } = getPaginatedItems(filteredProducts, 'products');

            adminProductsGrid.innerHTML = paginatedProducts.map(product => `
                <div class="product-card" data-product-id="${product.id}">
                    <div style="position: absolute; top: 10px; left: 10px; z-index: 10;">
                        <input type="checkbox" class="product-checkbox" data-product-id="${product.id}" 
                               style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                    <div class="product-image" style="background-image: url('${getPrimaryProductImage(product)}')"></div>
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <div class="product-price">
                            <span style="text-decoration: line-through; color: #999; margin-right: 10px;">${formatCurrency(product.price)}</span>
                            <span style="color: #e74c3c; font-weight: bold; font-size: 1.1em;">${formatCurrency(product.newPrice !== undefined ? product.newPrice : 0)}</span>
                        </div>
                        <div class="product-category">${getCategoryName(product.category)}</div>
                        <div class="product-stock">${t('stock')}: ${product.stock}${t('pieces')}</div>
                        <div class="product-actions">
                            <button class="btn btn-primary edit-product">ç¼–è¾‘</button>
                            <button class="btn btn-danger delete-product">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');

            // æ·»åŠ ç¼–è¾‘äº‹ä»¶
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const productCard = this.closest('.product-card');
                    const productId = parseInt(productCard.getAttribute('data-product-id'));
                    const product = products.find(p => parseInt(p.id) === productId);
                    if (product) {
                        openEditProductModal(product);
                    }
                });
            });

            // åˆ é™¤äº‹ä»¶ä¿æŒä¸å˜...
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const productCard = this.closest('.product-card');
                    const productId = parseInt(productCard.getAttribute('data-product-id'));
                    const product = products.find(p => parseInt(p.id) === productId);

                    if (!product) {
                        customAlert(t('deleteFailedProductNotFound'), t('errorTitle'));
                        return;
                    }

                    if (confirm(t('confirmDeleteProduct').replace('{name}', product.name))) {
                        try {
                            products = products.filter(p => parseInt(p.id) !== productId);
                            saveProducts();

                            productCard.style.transition = 'all 0.3s ease';
                            productCard.style.transform = 'scale(0.8)';
                            productCard.style.opacity = '0';

                            setTimeout(() => {
                                productCard.remove();
                                if (products.length === 0) {
                                    adminProductsGrid.innerHTML = `<div class="no-products">${t('noProductsAddOrImport')}</div>`;
                                }
                                showNotification(`æˆåŠŸåˆ é™¤äº§å“: ${product.name}`, 'success');
                            }, 300);

                        } catch (error) {
                            showNotification('åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
                        }
                    }
                });
            });

            // å¤é€‰æ¡†å˜åŒ–ç›‘å¬
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateBatchButtons);
            });

            updatePaginationControls('products', filteredProducts.length, renderAdminProducts);
        }

        // æ‰“å¼€ç¼–è¾‘äº§å“æ¨¡æ€æ¡†
        function openEditProductModal(product) {
            console.log('ğŸ“ ç¼–è¾‘äº§å“:', product);

            if (!product) {
                customAlert(t('productDataError'), t('errorTitle'));
                return;
            }

            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-price').value = product.price;
            document.getElementById('edit-product-new-price').value = product.newPrice || 0;
            document.getElementById('edit-product-stock').value = product.stock;
            document.getElementById('edit-product-category').value = product.category;
            document.getElementById('edit-product-description').value = product.description;

            const editImageInputs = document.querySelectorAll('.edit-product-image-url');
            const storedImages = Array.isArray(product.imageUrls) && product.imageUrls.length
                ? product.imageUrls
                : (product.image ? [product.image] : []);
            editImageInputs.forEach((input, index) => {
                input.value = storedImages[index] || '';
            });

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('edit-product-modal').style.display = 'flex';
        }

        // é€šç”¨çš„æ¨¡æ€æ¡†å…³é—­å‡½æ•°
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                console.log('âœ… å…³é—­æ¨¡æ€æ¡†:', modalId);
            } else {
                console.error('âŒ æœªæ‰¾åˆ°æ¨¡æ€æ¡†:', modalId);
            }
        }
        
        // æ˜¾ç¤ºWhatsAppæç¤ºæ¨¡æ€æ¡†
        // å­˜å‚¨å½“å‰è®¢å•å·ï¼ˆç”¨äºWhatsAppæ¶ˆæ¯ï¼‰
        let currentOrderIdForWhatsApp = null;

        function showWhatsAppModal(orderId = null) {
            const whatsappModal = document.getElementById('whatsapp-modal');
            if (whatsappModal) {
                // ä¿å­˜è®¢å•å·
                currentOrderIdForWhatsApp = orderId;
                whatsappModal.style.display = 'flex';
            }
        }

        // æ‰“å¼€WhatsAppå¹¶è‡ªåŠ¨å¡«å……è®¢å•ç¡®è®¤æ¶ˆæ¯
        function openWhatsAppWithOrder() {
            const phoneNumber = '+17077902826'; // WhatsAppå·ç 
            let message = 'FREE';
            
            // å¦‚æœæœ‰è®¢å•å·ï¼Œä½¿ç”¨è®¢å•ç¡®è®¤æ¶ˆæ¯
            if (currentOrderIdForWhatsApp) {
                message = `Please confirm my Beefreebies order #${currentOrderIdForWhatsApp}`;
            }
            
            // æ„å»ºWhatsAppé“¾æ¥
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            
            // æ‰“å¼€WhatsApp
            window.open(whatsappUrl, '_blank');
            
            // å…³é—­æ¨¡æ€æ¡†
            closeModal('whatsapp-modal');
        }

        // å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
            });
            console.log('âœ… å·²å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†');
        }
        // åˆ†ç±»åç§°æ˜ å°„
        function getCategoryName(category) {
            const categoryMap = {
                'electronics': 'ç”µå­äº§å“',
                'home': 'å®¶å±…ç”¨å“',
                'clothing': 'æœè£…é‹å¸½',
                'beauty': 'ç¾å¦†æŠ¤è‚¤',
                'sports': 'è¿åŠ¨æˆ·å¤–',
                'other': 'å…¶ä»–'
            };
            return categoryMap[category] || category;
        }

        // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæ¶ˆæ¯
        function showDeleteSuccess(productName) {
            // åˆ›å»ºè‡ªå®šä¹‰æç¤ºæ¶ˆæ¯
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--secondary);
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            successMsg.innerHTML = `
                <i class="fas fa-check-circle"></i>
                æˆåŠŸåˆ é™¤äº§å“: ${productName}
            `;

            document.body.appendChild(successMsg);

            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }

        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .no-products {
                text-align: center;
                padding: 40px;
                color: var(--gray);
                font-size: 18px;
                grid-column: 1 / -1;
            }
        `;
        document.head.appendChild(style);

        // å¤„ç†Excelæ–‡ä»¶
        function handleExcelFile(file) {
            const fileName = file.name;

            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                customAlert(t('pleaseUploadExcel'), t('infoTitle'));
                return;
            }

            const excelUploadArea = document.getElementById('excel-upload-area');
            const setStatus = (state, title, message, iconHtml = '') => {
                excelUploadArea.innerHTML = `
                    ${iconHtml || ''}
                    <h3>${title}</h3>
                    <p>${message}</p>
                    ${state === 'success' || state === 'error' ? '<small>ç‚¹å‡»å¯é‡æ–°ä¸Šä¼ </small>' : ''}
                `;
                excelUploadArea.classList.remove('processing', 'success', 'error');
                if (state) {
                    excelUploadArea.classList.add(state);
                }
            };

            setStatus('processing', 'æ­£åœ¨è§£æExcelæ–‡ä»¶...', fileName, '<i class="fas fa-spinner fa-spin"></i>');

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const workbook = XLSX.read(event.target.result, { type: 'array' });
                    const parsedData = extractProductsFromWorkbook(workbook);

                    if (!parsedData.length) {
                        throw new Error(t('noProductDataDetected'));
                    }

                    setStatus('success', t('parseSuccess') || 'è§£ææˆåŠŸï¼', t('foundProducts')?.replace('{count}', parsedData.length) || `å‘ç° ${parsedData.length} ä¸ªäº§å“`, '<i class="fas fa-check-circle" style="color: #2ecc71;"></i>');
                    showExcelDataPreview(parsedData);
                } catch (error) {
                    console.error('è§£æExcelå¤±è´¥:', error);
                    setStatus('error', t('parseFailed'), error.message || t('checkExcelFormat'), '<i class="fas fa-times-circle" style="color: #e74c3c;"></i>');
                }
            };

            reader.onerror = () => {
                setStatus('error', t('readFailed'), t('fileReadError'), '<i class="fas fa-times-circle" style="color: #e74c3c;"></i>');
            };

            reader.readAsArrayBuffer(file);
        }

        function extractProductsFromWorkbook(workbook) {
            if (!workbook || !workbook.SheetNames || !workbook.SheetNames.length) {
                throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰å¯ç”¨çš„å·¥ä½œè¡¨');
            }

            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
            return convertRowsToProducts(rows);
        }

        function convertRowsToProducts(rows) {
            if (!Array.isArray(rows) || rows.length < 2) {
                throw new Error('Excelä¸­æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®è¡Œ');
            }

            const headerRow = rows[0].map(cell => cell?.toString().trim());
            const headerInfo = buildHeaderInfo(headerRow, rows[1]);

            if (headerInfo.name === -1) {
                throw new Error('è¯·åœ¨Excelä¸­æ·»åŠ â€œäº§å“åç§°â€åˆ—');
            }
            if (!headerInfo.imageIndexes.length) {
                throw new Error('è¯·åœ¨Excelä¸­è‡³å°‘æä¾›ä¸€åˆ—â€œå›¾ç‰‡URLâ€');
            }

            const parsedProducts = [];

            rows.slice(1).forEach((row, rowIdx) => {
                if (!row || row.every(cell => !String(cell || '').trim())) {
                    return;
                }

                const name = getCellValue(row, headerInfo.name) || `æœªå‘½åäº§å“ ${rowIdx + 1}`;
                const price = parseNumberCell(getCellValue(row, headerInfo.price));
                const newPrice = parseNumberCell(getCellValue(row, headerInfo.newPrice));
                const stock = parseStockCell(getCellValue(row, headerInfo.stock));
                const category = normalizeCategoryName(getCellValue(row, headerInfo.category));
                const description = getCellValue(row, headerInfo.description) || 'æš‚æ— æè¿°';
                const imageUrls = extractImageUrlsFromRow(row, headerInfo.imageIndexes);

                if (!imageUrls.length) {
                    console.warn(`ç¬¬ ${rowIdx + 2} è¡Œæ²¡æœ‰æ£€æµ‹åˆ°æœ‰æ•ˆå›¾ç‰‡URLï¼Œå·²è·³è¿‡è¯¥äº§å“ã€‚`);
                    return;
                }

                const product = {
                    name,
                    price: Number.isFinite(price) ? price : 0,
                    newPrice: Number.isFinite(newPrice) ? newPrice : (Number.isFinite(price) ? price : 0),
                    stock: Number.isFinite(stock) ? stock : 0,
                    category,
                    description,
                    image: imageUrls[0],
                    imageUrls
                };

                for (let i = 1; i <= 6; i++) {
                    product[`imageUrl${i}`] = imageUrls[i - 1] || '';
                }

                parsedProducts.push(product);
            });

            if (!parsedProducts.length) {
                throw new Error('æ‰€æœ‰æ•°æ®è¡Œå‡æ— æ•ˆï¼Œè¯·ç¡®è®¤å¡«å†™äº†äº§å“åç§°ä¸å›¾ç‰‡URL');
            }

            return parsedProducts;
        }

        function buildHeaderInfo(headers, sampleRow = []) {
            const normalizedHeaders = headers.map(h => (h || '').toString().trim().toLowerCase());

            const info = {
                name: findHeaderIndex(normalizedHeaders, ['äº§å“åç§°', 'å•†å“åç§°', 'name', 'title']),
                price: findHeaderIndex(normalizedHeaders, ['äº§å“ä»·æ ¼', 'ä»·æ ¼', 'åŸä»·', 'price']),
                newPrice: findHeaderIndex(normalizedHeaders, ['ç°ä»·', 'ä¿ƒé”€ä»·', 'æ–°ä»·æ ¼', 'æŠ˜åä»·', 'newprice', 'saleprice']),
                stock: findHeaderIndex(normalizedHeaders, ['åº“å­˜', 'stock', 'æ•°é‡', 'qty']),
                category: findHeaderIndex(normalizedHeaders, ['åˆ†ç±»', 'å“ç±»', 'category']),
                description: findHeaderIndex(normalizedHeaders, ['æè¿°', 'è¯¦æƒ…', 'è¯´æ˜', 'description', 'detail']),
                imageIndexes: []
            };

            if (info.name === -1 && headers.length > 1) info.name = 1;
            if (info.price === -1) info.price = 0;

            normalizedHeaders.forEach((header, idx) => {
                if (/å›¾ç‰‡.*url/.test(header) || /image.*url/.test(header) || /^url\d*/.test(header)) {
                    info.imageIndexes.push(idx);
                }
            });

            // æ— è®ºæ˜¯å¦åŒ¹é…åˆ°è¡¨å¤´ï¼Œåªè¦ç¤ºä¾‹è¡Œä¸­æœ‰ URLï¼Œå°±æŠŠè¯¥åˆ—è§†ä¸ºå›¾ç‰‡åˆ—ï¼ˆé¿å…åªè¯†åˆ«åˆ°â€œå›¾ç‰‡URL1â€ï¼‰
            if (Array.isArray(sampleRow)) {
                sampleRow.forEach((cell, idx) => {
                    const value = (cell || '').toString().trim();
                    if (/^https?:\/\//i.test(value) && !info.imageIndexes.includes(idx)) {
                        info.imageIndexes.push(idx);
                    }
                });
            }

            info.imageIndexes = info.imageIndexes.slice(0, 6);
            return info;
        }

        function findHeaderIndex(headers, keywords) {
            for (const keyword of keywords) {
                const normalizedKeyword = keyword.toLowerCase();
                const index = headers.findIndex(header => header === normalizedKeyword || header.includes(normalizedKeyword));
                if (index !== -1) {
                    return index;
                }
            }
            return -1;
        }

        function getCellValue(row, index) {
            if (!row || index === -1 || index >= row.length) {
                return '';
            }
            const cell = row[index];
            if (cell === undefined || cell === null) {
                return '';
            }
            return typeof cell === 'string' ? cell.trim() : cell.toString().trim();
        }

        function parseNumberCell(value) {
            if (value === '' || value === null || value === undefined) return NaN;
            if (typeof value === 'number') return value;
            const sanitized = value.replace(/[^\d.,-]/g, '').replace(/,/g, '');
            return sanitized ? parseFloat(sanitized) : NaN;
        }

        function parseStockCell(value) {
            if (value === '' || value === null || value === undefined) return NaN;
            if (typeof value === 'number') return value;
            const sanitized = value.replace(/[^\d-]/g, '');
            return sanitized ? parseInt(sanitized, 10) : NaN;
        }

        function normalizeCategoryName(value) {
            if (!value) return 'other';
            const text = value.toString().trim().toLowerCase();
            if (!text) return 'other';
            if (text.includes('ç”µ') || text.includes('æ•°ç ') || text.includes('tech') || text.includes('digital')) return 'electronics';
            if (text.includes('å®¶') || text.includes('home')) return 'home';
            if (text.includes('æœ') || text.includes('clo') || text.includes('é‹')) return 'clothing';
            if (text.includes('ç¾') || text.includes('beauty')) return 'beauty';
            if (text.includes('è¿') || text.includes('sport')) return 'sports';
            return text;
        }

        function extractImageUrlsFromRow(row, imageIndexes) {
            const urls = [];
            imageIndexes.forEach(idx => {
                const raw = getCellValue(row, idx);
                if (!raw) return;

                raw.split(/[\s\n\r]+/).forEach(segment => {
                    const candidate = segment.trim();
                    if (/^https?:\/\//i.test(candidate) && !urls.includes(candidate)) {
                        urls.push(candidate);
                    }
                });
            });
            return urls.slice(0, 6);
        }

        // å¤åˆ¶è®¢å•å·
        function copyOrderId(orderId) {
            // ä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(orderId).then(() => {
                    showNotification(t('orderIdCopied') || 'è®¢å•å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                    fallbackCopyOrderId(orderId);
                });
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                fallbackCopyOrderId(orderId);
            }
        }

        // é™çº§å¤åˆ¶æ–¹æ³•ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
        function fallbackCopyOrderId(orderId) {
            const textArea = document.createElement('textarea');
            textArea.value = orderId;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification(t('orderIdCopied') || 'è®¢å•å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }
            document.body.removeChild(textArea);
        }

        // å–æ¶ˆè®¢å•
        async function cancelOrder(orderId) {
            const order = userOrders.find(o => o.id === orderId);
            if (!order) {
                showNotification(t('orderNotFound') || 'æœªæ‰¾åˆ°è®¢å•ä¿¡æ¯', 'error');
                return;
            }

            // ç¡®è®¤å–æ¶ˆ
            if (!confirm(t('confirmCancelOrder'))) {
                return;
            }

            try {
                // æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å–æ¶ˆ
                order.status = 'cancelled';
                order.updatedAt = Date.now();

                // æ›´æ–°æœ¬åœ°å­˜å‚¨
                if (currentUser && currentUser.account) {
                    const userOrdersKey = `userOrders_${currentUser.account}`;
                    localStorage.setItem(userOrdersKey, JSON.stringify(userOrders));
                }
                localStorage.setItem('userOrders', JSON.stringify(userOrders));

                // åŒæ­¥åˆ°äº‘ç«¯
                if (cloudSync && cloudSync.isInitialized) {
                    try {
                        await cloudSync.syncOrders();
                        console.log('âœ… è®¢å•å–æ¶ˆçŠ¶æ€å·²åŒæ­¥åˆ°äº‘ç«¯');
                    } catch (err) {
                        console.error('äº‘ç«¯åŒæ­¥å¤±è´¥:', err);
                    }
                }

                // å¦‚æœè®¢å•åœ¨allOrdersä¸­ï¼Œä¹Ÿéœ€è¦æ›´æ–°
                const allOrder = allOrders.find(o => o.id === orderId);
                if (allOrder) {
                    allOrder.status = 'cancelled';
                    allOrder.updatedAt = Date.now();
                    localStorage.setItem('allOrders', JSON.stringify(allOrders));
                }

                // âœ… æ™®é€šç”¨æˆ·ï¼šè®¢å•å–æ¶ˆåè¿”è¿˜ 1 ä¸ªèœœç½ï¼ˆç®¡ç†å‘˜ä¸å—é™åˆ¶ï¼‰
                if (!isCurrentUserAdmin()) {
                    try {
                        if (currentUser && currentUser.account) {
                            const user = allUsers.find(u => u.account === currentUser.account);
                            let currentPoints = (user && typeof user.points === 'number' && !isNaN(user.points))
                                ? Number(user.points)
                                : (typeof currentUser.points === 'number' ? Number(currentUser.points) : 0);

                            const newPoints = currentPoints + 1;

                            if (user) {
                                user.points = newPoints;
                            }
                            currentUser.points = newPoints;
                            saveAllUsers();
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));

                            const badge = document.getElementById('user-points-badge');
                            const valueEl = document.getElementById('user-points-value');
                            if (badge && valueEl) {
                                badge.style.display = 'inline-flex';
                                valueEl.textContent = newPoints;
                            }

                            showNotification((t('orderCancelled') || 'è®¢å•å·²å–æ¶ˆ') + `ï¼Œèœœç½ +1`, 'success');
                        } else {
                            showNotification(t('orderCancelled') || 'è®¢å•å·²å–æ¶ˆ', 'success');
                        }
                    } catch (ptsErr) {
                        console.warn('å–æ¶ˆè®¢å•è¿”è¿˜èœœç½æ—¶å‡ºé”™:', ptsErr);
                        showNotification(t('orderCancelled') || 'è®¢å•å·²å–æ¶ˆ', 'success');
                    }
                } else {
                    showNotification(t('orderCancelled') || 'è®¢å•å·²å–æ¶ˆ', 'success');
                }
                
                // åˆ·æ–°è®¢å•åˆ—è¡¨
                renderUserOrders();
            } catch (error) {
                console.error('å–æ¶ˆè®¢å•å¤±è´¥:', error);
                showNotification('å–æ¶ˆè®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // ç”¨æˆ·é¡µé¢åˆ‡æ¢
        function showUserPage(tab) {
            const pages = document.querySelectorAll('.user-page');
            pages.forEach(page => page.classList.remove('active'));

            switch (tab) {
                case 'orders':
                    document.getElementById('user-orders').classList.add('active');
                    renderUserOrders();
                    break;
                case 'profile':
                    document.getElementById('user-profile').classList.add('active');
                    loadUserProfile();
                    break;
                case 'address':
                    document.getElementById('user-address').classList.add('active');
                    renderAddressList();
                    break;
                case 'security':
                    document.getElementById('user-security').classList.add('active');
                    loadSecuritySettings();
                    break;
            }
            
            // å¦‚æœæ˜¾ç¤ºè®¢å•é¡µé¢ä¸”ä¾§è¾¹æ è¢«éšè—ï¼Œè°ƒæ•´å¸ƒå±€
            const userSidebar = document.querySelector('.user-sidebar');
            const userCenter = document.getElementById('user-center');
            if (tab === 'orders' && userSidebar && userSidebar.style.display === 'none') {
                if (userCenter) {
                    userCenter.classList.add('sidebar-hidden');
                }
            } else {
                if (userCenter) {
                    userCenter.classList.remove('sidebar-hidden');
                }
            }
        }

        // åŠ è½½ç”¨æˆ·ä¸ªäººä¿¡æ¯
        function loadUserProfile() {
            if (!currentUser) return;

            // ä»allUsersæ•°ç»„ä¸­è·å–æœ€æ–°çš„ç”¨æˆ·ä¿¡æ¯
            const latestUserData = allUsers.find(u => u.account === currentUser.account);
            const username = latestUserData ? latestUserData.username : currentUser.username;

            const profile = userProfile[currentUser.account] || {};
            document.getElementById('profile-username').value = username || '';
            document.getElementById('profile-account').value = currentUser.account || '';
            document.getElementById('profile-nickname').value = profile.nickname || '';
            document.getElementById('profile-phone').value = extractUSPhoneDigits(profile.phone);
            document.getElementById('profile-email').value = profile.email || '';
            document.getElementById('profile-birthday').value = profile.birthday || '';
            document.getElementById('profile-gender').value = profile.gender || '';
        }

        // ä¿å­˜ç”¨æˆ·ä¸ªäººä¿¡æ¯
        function saveProfile() {
            if (!currentUser) return;

            const rawPhone = document.getElementById('profile-phone').value.trim();
            const normalizedPhone = rawPhone ? normalizeUSPhone(rawPhone) : '';

            if (rawPhone && !normalizedPhone) {
                customAlert(t('invalidPhoneFormat'), t('infoTitle'));
                const wrapper = document.getElementById('profile-phone')?.closest('.phone-input-wrapper');
                if (wrapper) wrapper.classList.add('error');
                return;
            }

            const profile = {
                nickname: document.getElementById('profile-nickname').value.trim(),
                phone: normalizedPhone,
                email: document.getElementById('profile-email').value.trim(),
                birthday: document.getElementById('profile-birthday').value,
                gender: document.getElementById('profile-gender').value
            };

            // éªŒè¯é‚®ç®±
            if (profile.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(profile.email)) {
                customAlert(t('invalidEmailFormat'), t('infoTitle'));
                return;
            }

            userProfile[currentUser.account] = profile;
            saveUserProfile();
            customAlert(t('profileSaveSuccess'), t('successTitle'));
        }

        // åŠ è½½å®‰å…¨è®¾ç½®
        function loadSecuritySettings() {
            if (!currentUser) return;

            // ç™»å½•ä¿æŠ¤åŠŸèƒ½å·²åˆ é™¤ï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºæœªæ¥æ‰©å±•
        }

        // ä¿®æ”¹å¯†ç 
        function changePassword() {
            if (!currentUser) return;

            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification(t('pleaseFillAllFields') || 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'warning');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification(t('passwordMismatch') || 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showNotification(t('passwordTooShort') || 'æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½', 'warning');
                return;
            }

            // éªŒè¯å½“å‰å¯†ç 
            let actualPassword = '';

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜è´¦å·
            if (ADMIN_ACCOUNTS[currentUser.account]) {
                actualPassword = ADMIN_ACCOUNTS[currentUser.account].password;
            } else {
                // æŸ¥æ‰¾æ™®é€šç”¨æˆ·çš„å¯†ç 
                const user = allUsers.find(u => u.account === currentUser.account);
                if (user) {
                    actualPassword = user.password;
                }
            }

            if (currentPassword !== actualPassword) {
                showNotification(t('currentPasswordIncorrect') || 'å½“å‰å¯†ç é”™è¯¯', 'error');
                return;
            }

            // æ›´æ–°å¯†ç 
            if (ADMIN_ACCOUNTS[currentUser.account]) {
                // ç®¡ç†å‘˜å¯†ç ä¸å…è®¸é€šè¿‡å‰ç«¯ä¿®æ”¹
                showNotification(t('adminPasswordCannotChange') || 'ç®¡ç†å‘˜å¯†ç ä¸å…è®¸ä¿®æ”¹ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜', 'warning');
                return;
            } else {
                // æ›´æ–°æ™®é€šç”¨æˆ·å¯†ç 
                const user = allUsers.find(u => u.account === currentUser.account);
                if (user) {
                    user.password = newPassword;
                    saveAllUsers();
                    
                    // åŒæ­¥åˆ°äº‘ç«¯
                    if (cloudSync && cloudSync.isInitialized) {
                        cloudSync.syncAllUsers().then(() => {
                            console.log('âœ… å¯†ç å·²åŒæ­¥åˆ°äº‘ç«¯');
                        }).catch(err => {
                            console.error('å¯†ç äº‘ç«¯åŒæ­¥å¤±è´¥:', err);
                        });
                    }
                    
                    showNotification(t('passwordChangedSuccess') || 'å¯†ç ä¿®æ”¹æˆåŠŸï¼è¯·ç‰¢è®°æ–°å¯†ç ', 'success');
                    document.getElementById('change-password-form').reset();
                } else {
                    showNotification(t('userNotFound') || 'æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯', 'error');
                }
            }
        }

        // æ‰“å¼€åœ°å€ç¼–è¾‘æ¨¡æ€æ¡†
        function openAddressModal(address = null) {
            const modal = document.getElementById('address-modal');
            const title = document.getElementById('address-modal-title');
            const form = document.getElementById('address-form');

            if (!modal || !form) {
                console.error('Address modal or form not found');
                return;
            }

            if (address) {
                title.textContent = 'Edit address';
                document.getElementById('address-id').value = address.id;
                document.getElementById('address-name').value = address.name || '';
                document.getElementById('address-phone').value = extractUSPhoneDigits(address.phone);
                document.getElementById('address-country').value = 'US';
                document.getElementById('address-detail').value = address.detail || '';
                document.getElementById('address-unit').value = address.unit || '';
                document.getElementById('address-city').value = address.city || '';
                document.getElementById('address-state').value = address.state || '';
                document.getElementById('address-postal').value = address.postal || '';
                document.getElementById('address-default').checked = address.isDefault || false;
            } else {
                title.textContent = 'Add a new address';
                form.reset();
                document.getElementById('address-id').value = '';
                document.getElementById('address-country').value = 'US';
            }

            // ä¸å†åœ¨è¿™é‡Œç»‘å®šäº‹ä»¶ï¼Œé¿å…é‡å¤ç»‘å®š
            // äº‹ä»¶å·²åœ¨DOMContentLoadedä¸­ç»‘å®š

            modal.style.display = 'flex';
        }

        // ä¿å­˜åœ°å€
        function saveAddress() {
            console.log('saveAddress called');
            
            const id = document.getElementById('address-id').value;
            const name = document.getElementById('address-name').value.trim();
            const phone = document.getElementById('address-phone').value.trim();
            const country = document.getElementById('address-country').value;
            const detail = document.getElementById('address-detail').value.trim();
            const unit = document.getElementById('address-unit').value.trim();
            const city = document.getElementById('address-city').value.trim();
            const state = document.getElementById('address-state').value;
            const postal = document.getElementById('address-postal').value.trim();
            const isDefault = document.getElementById('address-default').checked;

            console.log('Form values:', { name, phone, detail, city, state, postal });

            if (!name || !phone || !detail || !city || !state || !postal) {
                customAlert(t('pleaseFillAllFields'), t('infoTitle'));
                return;
            }

            // éªŒè¯ç”µè¯å·ç ï¼ˆç¾å›½æ ¼å¼ï¼‰
            const normalizedPhone = normalizeUSPhone(phone);
            if (!normalizedPhone) {
                customAlert(t('invalidPhoneFormat'), t('infoTitle'));
                const phoneWrapper = document.getElementById('address-phone')?.closest('.phone-input-wrapper');
                if (phoneWrapper) phoneWrapper.classList.add('error');
                return;
            }

            // éªŒè¯é‚®ç¼–ï¼ˆç¾å›½æ ¼å¼ï¼š5ä½æˆ–5+4ä½ï¼‰
            if (!/^\d{5}(-\d{4})?$/.test(postal)) {
                customAlert('Please enter a valid ZIP code (e.g., 12345 or 12345-6789)', 'æç¤º');
                return;
            }

            // ç”Ÿæˆå”¯ä¸€IDï¼ˆç¡®ä¿ä¸ä¼šé‡å¤ï¼‰
            let addressId;
            if (id) {
                addressId = String(id);
            } else {
                // ç”Ÿæˆå”¯ä¸€IDï¼šæ—¶é—´æˆ³ + éšæœºæ•°
                addressId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            }

            const address = {
                id: addressId,
                name,
                phone: normalizedPhone,
                country: country || 'US',
                detail,
                unit,
                city,
                state,
                postal,
                isDefault,
                account: currentUser ? currentUser.account : null // æ·»åŠ ç”¨æˆ·æ ‡è¯†
            };

            if (isDefault) {
                // å–æ¶ˆå…¶ä»–åœ°å€çš„é»˜è®¤çŠ¶æ€
                userAddresses.forEach(addr => {
                    if (String(addr.id) !== String(address.id)) {
                        addr.isDefault = false;
                    }
                });
            }

            if (id) {
                // ç¼–è¾‘åœ°å€ - ä½¿ç”¨ä¸¥æ ¼æ¯”è¾ƒ
                const index = userAddresses.findIndex(addr => String(addr.id) === String(id));
                if (index !== -1) {
                    userAddresses[index] = address;
                } else {
                    console.warn('è¦ç¼–è¾‘çš„åœ°å€æœªæ‰¾åˆ°ï¼Œå°†ä½œä¸ºæ–°åœ°å€æ·»åŠ ');
                    userAddresses.push(address);
                }
            } else {
                // æ·»åŠ æ–°åœ°å€å‰ï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé˜²æ­¢é‡å¤æ·»åŠ ï¼‰
                const existingIndex = userAddresses.findIndex(addr => 
                    String(addr.id) === String(address.id) ||
                    (addr.name === address.name && 
                     addr.phone === address.phone && 
                     addr.detail === address.detail &&
                     addr.city === address.city &&
                     addr.state === address.state &&
                     addr.postal === address.postal)
                );
                
                if (existingIndex === -1) {
                userAddresses.push(address);
                } else {
                    console.warn('åœ°å€å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ');
                    showNotification('This address already exists', 'warning');
                    return;
                }
            }

            saveUserAddresses();
            if (cloudSync && cloudSync.isInitialized) {
                cloudSync.syncAddresses();
            }
            closeModal('address-modal');
            renderAddressList();
            // å¦‚æœæŠ¥åæ¨¡æ€æ¡†æ‰“å¼€ç€ï¼Œåˆ·æ–°åœ°å€é€‰æ‹©å™¨
            const signupModal = document.getElementById('signup-modal');
            if (signupModal && signupModal.style.display === 'flex') {
                updateSignupAddressSelector();
            }
            showNotification('Address saved successfully!', 'success');

            if (shouldReturnToSignup) {
                setTimeout(() => {
                    shouldReturnToSignup = false;
                    if (typeof showHomePage === 'function') {
                        showHomePage();
                    }
                    const targetProduct = currentProduct || pendingSignupProduct;
                    if (targetProduct) {
                        openSignupModal(targetProduct);
                    }
                }, 300);
            }
        }

        // æ¸²æŸ“åœ°å€åˆ—è¡¨
        function renderAddressList() {
            const addressList = document.getElementById('address-list');

            if (!addressList) return;

            // ç¡®ä¿userAddressesæ˜¯æ•°ç»„ä¸”åªåŒ…å«å½“å‰ç”¨æˆ·çš„åœ°å€
            if (!Array.isArray(userAddresses)) {
                userAddresses = [];
            }

            // è¿‡æ»¤æ‰ä¸å±äºå½“å‰ç”¨æˆ·çš„åœ°å€ï¼ˆå¦‚æœæœ‰accountå­—æ®µï¼‰
            if (currentUser && currentUser.account) {
                userAddresses = userAddresses.filter(address => {
                    // å¦‚æœåœ°å€æœ‰accountå­—æ®µï¼Œåªæ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„åœ°å€
                    if (address.account) {
                        return address.account === currentUser.account;
                    }
                    // æ—§æ•°æ®æ²¡æœ‰accountå­—æ®µï¼Œä¿ç•™ï¼ˆå…¼å®¹æ€§ï¼‰
                    return true;
                });
            }

            // æ·»åŠ "Add Address"å¡ç‰‡
            let addressCardsHtml = `
                <div class="add-address-card" onclick="document.getElementById('add-address-btn').click()">
                    <div class="add-address-icon">+</div>
                    <div class="add-address-text">Add Address</div>
                </div>
            `;

            addressCardsHtml += userAddresses.map(address => {
                // å…¼å®¹æ—§æ•°æ®æ ¼å¼
                const fullAddress = address.state 
                    ? [
                        address.detail,
                        address.unit,
                        address.city,
                        address.state,
                        address.postal
                      ].filter(Boolean).join(', ')
                    : [
                        address.province || '',
                        address.city || '',
                        address.district || '',
                        address.detail || ''
                      ].filter(Boolean).join(' ');

                return `
                <div class="address-item ${address.isDefault ? 'default' : ''}">
                        ${address.isDefault ? '<div class="address-default-badge">Default</div>' : ''}
                    <div class="address-info">
                        <div class="address-name">${address.name}</div>
                        <div class="address-phone">${address.phone}</div>
                            <div class="address-full">${fullAddress}</div>
                            ${address.country ? `<div class="address-country">${address.country}</div>` : ''}
                    </div>
                    <div class="address-actions">
                            <button class="btn btn-primary edit-address" data-id="${address.id}">Edit</button>
                            <button class="btn btn-secondary set-default-address" data-id="${address.id}" ${address.isDefault ? 'disabled' : ''}>Set as default</button>
                            <button class="btn btn-danger delete-address" data-id="${address.id}">Delete</button>
                    </div>
                </div>
                `;
            }).join('');

            addressList.innerHTML = addressCardsHtml;

            // ç»‘å®šåœ°å€æ“ä½œäº‹ä»¶
            document.querySelectorAll('.edit-address').forEach(btn => {
                btn.addEventListener('click', () => {
                    const addressId = btn.getAttribute('data-id');
                    const address = userAddresses.find(addr => String(addr.id) === String(addressId));
                    if (address) {
                        openAddressModal(address);
                    }
                });
            });

            document.querySelectorAll('.set-default-address').forEach(btn => {
                btn.addEventListener('click', () => {
                    const addressId = btn.getAttribute('data-id');
                    setDefaultAddress(addressId);
                });
            });

            document.querySelectorAll('.delete-address').forEach(btn => {
                btn.addEventListener('click', () => {
                    const addressId = btn.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this address?')) {
                    deleteAddress(addressId);
                    }
                });
            });
        }

        // è®¾ç½®é»˜è®¤åœ°å€
        function setDefaultAddress(addressId) {
            // ä½¿ç”¨ä¸¥æ ¼æ¯”è¾ƒï¼Œç¡®ä¿åªè®¾ç½®ä¸€ä¸ªåœ°å€ä¸ºé»˜è®¤
            let found = false;
            userAddresses.forEach(addr => {
                if (String(addr.id) === String(addressId)) {
                    addr.isDefault = true;
                    found = true;
                } else {
                    addr.isDefault = false;
                }
            });
            
            if (!found) {
                console.error('è¦è®¾ç½®ä¸ºé»˜è®¤çš„åœ°å€æœªæ‰¾åˆ°:', addressId);
                showNotification('Address not found', 'error');
                return;
            }
            
            saveUserAddresses();
            if (cloudSync && cloudSync.isInitialized) {
                cloudSync.syncAddresses();
            }
            renderAddressList();
            showNotification('Default address updated', 'success');
        }

        // åˆ é™¤åœ°å€
        function deleteAddress(addressId) {
            // ä½¿ç”¨ä¸¥æ ¼æ¯”è¾ƒï¼Œç¡®ä¿åªåˆ é™¤ä¸€ä¸ªåœ°å€
            const initialLength = userAddresses.length;
            userAddresses = userAddresses.filter(addr => String(addr.id) !== String(addressId));
            
            if (userAddresses.length === initialLength) {
                console.error('è¦åˆ é™¤çš„åœ°å€æœªæ‰¾åˆ°:', addressId);
                showNotification('Address not found', 'error');
                return;
            }
            
                saveUserAddresses();
            if (cloudSync && cloudSync.isInitialized) {
                cloudSync.syncAddresses();
            }
                renderAddressList();
            showNotification('Address deleted', 'success');
        }

        // æ˜¾ç¤ºExcelæ•°æ®é¢„è§ˆ
        function showExcelDataPreview(importedProducts) {
            const adminContent = document.querySelector('.admin-content');

            // ç§»é™¤å·²å­˜åœ¨çš„é¢„è§ˆåŒºåŸŸ
            const existingPreview = document.querySelector('.excel-preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // åˆ›å»ºæ•°æ®é¢„è§ˆåŒºåŸŸ
            const previewSection = document.createElement('div');
            previewSection.className = 'excel-preview';
            previewSection.innerHTML = `
                <h4>Excelæ•°æ®é¢„è§ˆ</h4>
                <div class="preview-info">
                    <p>å…±å‘ç° <strong>${importedProducts.length}</strong> ä¸ªäº§å“ï¼Œè¯·ç¡®è®¤å¯¼å…¥ï¼š</p>
                </div>
                <div class="preview-products">
                    ${importedProducts.map((product, index) => `
                        <div class="preview-product-item">
                            <div class="preview-product-image" style="background-image: url('${getPrimaryProductImage(product)}')"></div>
                            <div class="preview-product-info">
                                <div class="preview-product-name">${product.name}</div>
                                <div class="preview-product-price">
                                    <span style="text-decoration: line-through; color: #999; margin-right: 8px; font-size: 0.9em;">${formatCurrency(product.price)}</span>
                                    <span style="color: #e74c3c; font-weight: bold;">${formatCurrency(product.newPrice !== undefined ? product.newPrice : 0)}</span>
                                </div>
                                <div class="preview-product-category">${product.category}</div>
                            </div>
                            <div class="preview-product-status">
                                <span class="status-pending">å¾…å¯¼å…¥</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="preview-actions">
                    <button class="btn btn-primary" id="confirm-import">ç¡®è®¤å¯¼å…¥äº§å“</button>
                    <button class="btn btn-secondary" id="cancel-import">å–æ¶ˆ</button>
                </div>
            `;

            // æ’å…¥åˆ°Excelä¸Šä¼ åŒºåŸŸåé¢
            const excelUploadArea = document.getElementById('excel-upload-area');
            excelUploadArea.parentNode.insertBefore(previewSection, excelUploadArea.nextSibling);

            // æ·»åŠ ç¡®è®¤å¯¼å…¥äº‹ä»¶
            document.getElementById('confirm-import').addEventListener('click', () => {
                // è·å–ç°æœ‰äº§å“çš„æœ€å¤§IDï¼ˆç¡®ä¿æ˜¯æ•°å­—ï¼‰
                const existingIds = products.map(p => parseInt(p.id));
                let maxId = existingIds.length > 0 ? Math.max(...existingIds) : 0;

                console.log('ğŸ”§ å¯¼å…¥è°ƒè¯• - å½“å‰æœ€å¤§ID:', maxId);
                console.log('ğŸ”§ å¯¼å…¥è°ƒè¯• - ç°æœ‰äº§å“ID:', existingIds);

                // ä¸ºå¯¼å…¥çš„äº§å“ç”Ÿæˆå”¯ä¸€IDï¼ˆç¡®ä¿æ˜¯æ•°å­—ï¼‰
                importedProducts.forEach((product, index) => {
                    const newId = maxId + index + 1;
                    product.id = newId;
                    product.stock = product.stock || 10;
                    product.category = product.category || 'other';
                    product.description = product.description || 'æš‚æ— æè¿°';

                    console.log(`ğŸ”§ å¯¼å…¥è°ƒè¯• - äº§å“ ${product.name} åˆ†é…ID:`, newId);
                });

                // æ·»åŠ åˆ°äº§å“åˆ—è¡¨
                products.push(...importedProducts);

                // ä¿å­˜æ•°æ®
                const saveResult = saveProducts();
                console.log('ğŸ”§ å¯¼å…¥è°ƒè¯• - ä¿å­˜ç»“æœ:', saveResult);
                console.log('ğŸ”§ å¯¼å…¥è°ƒè¯• - å¯¼å…¥åçš„äº§å“:', products);

                if (saveResult) {
                    customAlert(`âœ… ${t('importProductsSuccess').replace('{count}', importedProducts.length)}`, t('successTitle'));
                } else {
                    customAlert(t('importDataSaveError'), t('errorTitle'));
                }

                previewSection.remove();

                // é‡ç½®ä¸Šä¼ åŒºåŸŸ
                excelUploadArea.classList.remove('success');
                excelUploadArea.innerHTML = `
                    <i class="fas fa-file-excel"></i>
                    <h3>ç‚¹å‡»ä¸Šä¼ Excelæ–‡ä»¶</h3>
                    <p>æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼ï¼Œç”¨äºæ‰¹é‡ç¼–è¾‘äº§å“ä¿¡æ¯</p>
                    <p><small>è¯·ç¡®ä¿ExcelåŒ…å«"å›¾ç‰‡URL"åˆ—</small></p>
                    <p><small>æˆ–å°†Excelæ–‡ä»¶æ‹–æ‹½åˆ°æ­¤å¤„</small></p>
                `;

                // æ›´æ–°äº§å“æ˜¾ç¤º
                if (document.getElementById('home-page').style.display !== 'none') {
                    renderProducts(products);
                }
                if (document.getElementById('admin-panel').style.display !== 'none') {
                    renderAdminProducts();
                }
            });

            // æ·»åŠ å–æ¶ˆäº‹ä»¶
            document.getElementById('cancel-import').addEventListener('click', () => {
                previewSection.remove();
                excelUploadArea.classList.remove('success');
                excelUploadArea.innerHTML = `
                    <i class="fas fa-file-excel"></i>
                    <h3>ç‚¹å‡»ä¸Šä¼ Excelæ–‡ä»¶</h3>
                    <p>æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼ï¼Œç”¨äºæ‰¹é‡ç¼–è¾‘äº§å“ä¿¡æ¯</p>
                    <p><small>è¯·ç¡®ä¿ExcelåŒ…å«"å›¾ç‰‡URL"åˆ—</small></p>
                    <p><small>æˆ–å°†Excelæ–‡ä»¶æ‹–æ‹½åˆ°æ­¤å¤„</small></p>
                `;
            });
        }

        // ===================== æ‰¹é‡æ“ä½œåŠŸèƒ½ =====================

        // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function updateBatchButtons() {
            const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
            const allCheckboxes = document.querySelectorAll('.product-checkbox');
            const batchEditBtn = document.getElementById('batch-edit-btn');
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            const selectAllCheckbox = document.getElementById('select-all-products');

            // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®æ˜¾ç¤º
            if (selectedCheckboxes.length > 0) {
                batchEditBtn.style.display = 'inline-block';
                batchDeleteBtn.style.display = 'inline-block';
                batchEditBtn.textContent = `æ‰¹é‡ç¼–è¾‘ (${selectedCheckboxes.length})`;
                batchDeleteBtn.textContent = `æ‰¹é‡åˆ é™¤ (${selectedCheckboxes.length})`;
            } else {
                batchEditBtn.style.display = 'none';
                batchDeleteBtn.style.display = 'none';
                batchEditBtn.textContent = 'æ‰¹é‡ç¼–è¾‘';
                batchDeleteBtn.textContent = 'æ‰¹é‡åˆ é™¤';
            }

            // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
            if (allCheckboxes.length > 0) {
                if (selectedCheckboxes.length === allCheckboxes.length) {
                    // å…¨éƒ¨é€‰ä¸­
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else if (selectedCheckboxes.length > 0) {
                    // éƒ¨åˆ†é€‰ä¸­
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                } else {
                    // å…¨éƒ¨æœªé€‰ä¸­
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }
            }
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAllProducts() {
            const selectAllCheckbox = document.getElementById('select-all-products');
            const productCheckboxes = document.querySelectorAll('.product-checkbox');

            productCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });

            updateBatchButtons();
        }

        // è·å–é€‰ä¸­çš„äº§å“IDåˆ—è¡¨
        function getSelectedProductIds() {
            const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
            return Array.from(selectedCheckboxes).map(cb => parseInt(cb.getAttribute('data-product-id')));
        }

        // æ‰¹é‡åˆ é™¤äº§å“
        function batchDeleteProducts() {
            const selectedIds = getSelectedProductIds();

            if (selectedIds.length === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„äº§å“', 'warning');
                return;
            }

            const selectedProducts = products.filter(p => selectedIds.includes(parseInt(p.id)));
            const productNames = selectedProducts.map(p => p.name).join('ã€');

            if (!confirm(t('confirmDeleteSelectedProducts').replace('{count}', selectedIds.length).replace('{productNames}', productNames))) {
                return;
            }

            // åˆ é™¤äº§å“
            products = products.filter(p => !selectedIds.includes(parseInt(p.id)));
            saveProducts();

            // é‡æ–°æ¸²æŸ“äº§å“åˆ—è¡¨
            renderAdminProducts();

            // å–æ¶ˆå…¨é€‰çŠ¶æ€
            document.getElementById('select-all-products').checked = false;
            updateBatchButtons();

            showNotification(`æˆåŠŸåˆ é™¤ ${selectedIds.length} ä¸ªäº§å“`, 'success');
        }

        // æ‰“å¼€æ‰¹é‡ç¼–è¾‘æ¨¡æ€æ¡†
        function openBatchEditModal() {
            const selectedIds = getSelectedProductIds();

            if (selectedIds.length === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„äº§å“', 'warning');
                return;
            }

            // æ›´æ–°é€‰ä¸­æ•°é‡
            document.getElementById('batch-edit-count').textContent = selectedIds.length;

            // é‡ç½®è¡¨å•
            document.getElementById('batch-edit-form').reset();
            document.getElementById('batch-price-value-group').style.display = 'none';
            document.getElementById('batch-stock-value-group').style.display = 'none';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('batch-edit-modal').style.display = 'flex';
        }

        // åº”ç”¨æ‰¹é‡ç¼–è¾‘
        function applyBatchEdit(e) {
            e.preventDefault();

            const selectedIds = getSelectedProductIds();
            if (selectedIds.length === 0) {
                showNotification('æ²¡æœ‰é€‰ä¸­çš„äº§å“', 'error');
                return;
            }

            const priceAction = document.getElementById('batch-edit-price-action').value;
            const priceValue = parseFloat(document.getElementById('batch-edit-price-value').value) || 0;
            const stockAction = document.getElementById('batch-edit-stock-action').value;
            const stockValue = parseInt(document.getElementById('batch-edit-stock-value').value) || 0;
            const category = document.getElementById('batch-edit-category').value;

            let updatedCount = 0;

            // éå†é€‰ä¸­çš„äº§å“å¹¶åº”ç”¨ä¿®æ”¹
            products.forEach(product => {
                if (selectedIds.includes(parseInt(product.id))) {
                    // ä»·æ ¼æ“ä½œ
                    if (priceAction && priceValue) {
                        switch (priceAction) {
                            case 'set':
                                product.price = priceValue;
                                break;
                            case 'increase':
                                product.price += priceValue;
                                break;
                            case 'decrease':
                                product.price = Math.max(0, product.price - priceValue);
                                break;
                            case 'multiply':
                                product.price *= priceValue;
                                break;
                        }
                        product.price = Math.round(product.price * 100) / 100; // ä¿ç•™ä¸¤ä½å°æ•°
                    }

                    // åº“å­˜æ“ä½œ
                    if (stockAction && stockValue >= 0) {
                        switch (stockAction) {
                            case 'set':
                                product.stock = stockValue;
                                break;
                            case 'increase':
                                product.stock += stockValue;
                                break;
                            case 'decrease':
                                product.stock = Math.max(0, product.stock - stockValue);
                                break;
                        }
                    }

                    // åˆ†ç±»ä¿®æ”¹
                    if (category) {
                        product.category = category;
                    }

                    updatedCount++;
                }
            });

            // ä¿å­˜ä¿®æ”¹
            saveProducts();

            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('batch-edit-modal').style.display = 'none';

            // é‡æ–°æ¸²æŸ“äº§å“åˆ—è¡¨
            renderAdminProducts();

            // å–æ¶ˆå…¨é€‰çŠ¶æ€
            document.getElementById('select-all-products').checked = false;
            updateBatchButtons();

            showNotification(`æˆåŠŸç¼–è¾‘ ${updatedCount} ä¸ªäº§å“`, 'success');
        }

        // ===================== æ•°æ®åŒæ­¥æ”¹è¿› =====================

        // æ·»åŠ æ•°æ®åŒæ­¥é€šçŸ¥
        // å·²ç¦ç”¨åŒæ­¥é€šçŸ¥åŠŸèƒ½ï¼Œé¿å…å¼¹çª—å¹²æ‰°
        function showSyncNotification() {
            // åŠŸèƒ½å·²ç¦ç”¨ï¼Œä¸å†æ˜¾ç¤ºåŒæ­¥é€šçŸ¥
            return;
            /*
            const syncNotification = document.createElement('div');
            syncNotification.id = 'sync-notification';
            syncNotification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #ff9800;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10001;
                max-width: 400px;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            syncNotification.innerHTML = `
                <i class="fas fa-sync-alt fa-spin"></i>
                <div>
                    <div style="font-weight: 600;">æ•°æ®å·²æ›´æ–°</div>
                    <div style="font-size: 12px; opacity: 0.9;">å…¶ä»–è®¾å¤‡éœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°æœ€æ–°æ•°æ®</div>
                </div>
            `;

            document.body.appendChild(syncNotification);

            setTimeout(() => {
                syncNotification.remove();
            }, 5000);
            */
        }

        // æ”¹è¿›saveProductså‡½æ•°ï¼Œæ·»åŠ åŒæ­¥æç¤ºå’Œäº‘åŒæ­¥
        const originalSaveProducts = saveProducts;
        saveProducts = async function () {
            const result = originalSaveProducts();
            if (result && cloudSync && cloudSync.isInitialized) {
                try {
                    // åŒæ­¥åˆ°äº‘ç«¯ï¼Œç­‰å¾…å®Œæˆ
                    await cloudSync.syncProducts();
                    console.log('âœ… saveProducts: äº§å“æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°äº‘ç«¯ï¼ŒåŒ…æ‹¬newPriceå­—æ®µ');
                } catch (err) {
                    console.warn('âš ï¸ saveProducts: äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œä½†æœ¬åœ°å·²ä¿å­˜:', err);
                }
            }
            return result;
        };

        // æ”¹è¿›saveAllUserså‡½æ•°ï¼Œæ·»åŠ åŒæ­¥æç¤ºå’Œäº‘åŒæ­¥
        const originalSaveAllUsers = saveAllUsers;
        saveAllUsers = async function () {
            originalSaveAllUsers();
            // åŒæ­¥åˆ°äº‘ç«¯
            if (cloudSync && cloudSync.isInitialized) {
                await cloudSync.syncAllUsers();
            }
            if (isAdmin()) {
                showSyncNotification();
            }
        };

        // ===================== äº‘ç«¯åŒæ­¥æŒ‰é’®äº‹ä»¶ =====================

        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus() {
            const syncStatusText = document.getElementById('sync-status-text');
            if (!syncStatusText) return;

            if (cloudSync && cloudSync.isInitialized) {
                if (cloudSync.lastSyncTime) {
                    const timeAgo = getTimeAgo(cloudSync.lastSyncTime);
                    syncStatusText.textContent = `ä¸Šæ¬¡åŒæ­¥ï¼š${timeAgo}`;
                    syncStatusText.style.color = '#2ecc71';
                } else {
                    syncStatusText.textContent = 'ç­‰å¾…é¦–æ¬¡åŒæ­¥...';
                    syncStatusText.style.color = '#f39c12';
                }
            } else {
                syncStatusText.textContent = 'äº‘ç«¯åŒæ­¥æœªå¯ç”¨';
                syncStatusText.style.color = '#999';
            }
        }

        // è·å–ç›¸å¯¹æ—¶é—´
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'åˆšåˆš';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}åˆ†é’Ÿå‰`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}å°æ—¶å‰`;
            return `${Math.floor(seconds / 86400)}å¤©å‰`;
        }

        // æ‰‹åŠ¨åŒæ­¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function () {
            // åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ç‚¹å‡»äº‹ä»¶
            const syncStatus = document.getElementById('sync-status');
            if (syncStatus) {
                syncStatus.addEventListener('click', function () {
                    if (cloudSync && cloudSync.isInitialized) {
                        const lastSyncInfo = cloudSync.lastSyncTime
                            ? `ä¸Šæ¬¡åŒæ­¥ï¼š${getTimeAgo(cloudSync.lastSyncTime)}`
                            : 'ç­‰å¾…é¦–æ¬¡åŒæ­¥';

                        showNotification(
                            `âœ… äº‘ç«¯åŒæ­¥å·²å¯ç”¨\n\n` +
                            `${lastSyncInfo}\n` +
                            `æ•°æ®æ­£åœ¨æ‰€æœ‰è®¾å¤‡é—´å®æ—¶åŒæ­¥\n\n` +
                            `åŒæ­¥å†…å®¹ï¼š\n` +
                            `â€¢ äº§å“æ•°æ®\n` +
                            `â€¢ ç”¨æˆ·è´¦æˆ·\n` +
                            `â€¢ è®¢å•è®°å½•\n` +
                            `â€¢ æ”¶è´§åœ°å€`,
                            'info'
                        );
                    } else {
                        showNotification(
                            `ğŸ’¡ äº‘ç«¯åŒæ­¥æœªå¯ç”¨\n\n` +
                            `å½“å‰ä½¿ç”¨æœ¬åœ°æ¨¡å¼ï¼Œæ•°æ®ä»…ä¿å­˜åœ¨å½“å‰è®¾å¤‡\n\n` +
                            `å¦‚éœ€å¯ç”¨è·¨è®¾å¤‡åŒæ­¥ï¼Œè¯·ï¼š\n` +
                            `1. æŸ¥çœ‹æ§åˆ¶å°çš„é…ç½®è¯´æ˜\n` +
                            `2. é˜…è¯» FIREBASE_SETUP.md æ–‡ä»¶\n` +
                            `3. é…ç½®ä»…éœ€çº¦5åˆ†é’Ÿ\n\n` +
                            `å¯ç”¨åå¯å®ç°ï¼š\n` +
                            `âœ… å¤šè®¾å¤‡æ•°æ®åŒæ­¥\n` +
                            `âœ… å›¢é˜Ÿåä½œ\n` +
                            `âœ… æ•°æ®äº‘ç«¯å¤‡ä»½`,
                            'info'
                        );
                    }
                });
            }

            const manualSyncBtn = document.getElementById('manual-sync-btn');
            if (manualSyncBtn) {
                manualSyncBtn.addEventListener('click', async function () {
                    if (!cloudSync || !cloudSync.isInitialized) {
                        showNotification('äº‘ç«¯åŒæ­¥æœªå¯ç”¨', 'warning');
                        return;
                    }

                    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                    const icon = manualSyncBtn.querySelector('i');
                    const originalClass = icon.className;
                    icon.className = 'fas fa-sync-alt fa-spin';
                    manualSyncBtn.disabled = true;

                    try {
                        await cloudSync.manualSync();
                        updateSyncStatus();
                    } catch (error) {
                        console.error('æ‰‹åŠ¨åŒæ­¥å¤±è´¥:', error);
                        showNotification('åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    } finally {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        icon.className = originalClass;
                        manualSyncBtn.disabled = false;
                    }
                });
            }

            // è‡ªåŠ¨åŒæ­¥å¼€å…³
            const autoSyncCheckbox = document.getElementById('auto-sync');
            if (autoSyncCheckbox) {
                // ä»localStorageåŠ è½½è®¾ç½®
                const autoSyncEnabled = localStorage.getItem('autoSyncEnabled') !== 'false';
                autoSyncCheckbox.checked = autoSyncEnabled;

                autoSyncCheckbox.addEventListener('change', function () {
                    localStorage.setItem('autoSyncEnabled', this.checked);

                    if (this.checked) {
                        showNotification('è‡ªåŠ¨åŒæ­¥å·²å¼€å¯', 'success');
                        if (cloudSync && cloudSync.isInitialized) {
                            cloudSync.syncAllData();
                        }
                    } else {
                        showNotification('è‡ªåŠ¨åŒæ­¥å·²å…³é—­', 'info');
                    }
                });
            }

            // å®šæœŸæ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
            setInterval(updateSyncStatus, 10000); // æ¯10ç§’æ›´æ–°ä¸€æ¬¡

            // å®šæœŸæ£€æŸ¥ç”¨æˆ·çŠ¶æ€ï¼ˆè¢«ç¦ç”¨æ£€æµ‹ï¼‰
            setInterval(() => {
                if (currentUser) {
                    updateUserInterface();
                }
            }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ç”¨æˆ·çŠ¶æ€

            // åˆå§‹æ›´æ–°
            setTimeout(updateSyncStatus, 2000);
        });

        // ===================== ç¦»çº¿æ¨¡å¼æç¤º =====================

        // åœ¨é¡µé¢é¡¶éƒ¨æ·»åŠ ç¦»çº¿çŠ¶æ€æŒ‡ç¤ºå™¨
        function createOfflineIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'offline-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                background: #f39c12;
                color: white;
                text-align: center;
                padding: 10px;
                z-index: 9999;
                display: none;
                animation: slideDown 0.3s ease;
            `;
            indicator.innerHTML = `
                <i class="fas fa-wifi" style="text-decoration: line-through;"></i>
                æ‚¨å½“å‰å¤„äºç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥
            `;
            document.body.appendChild(indicator);

            // ç›‘å¬ç½‘ç»œçŠ¶æ€
            window.addEventListener('offline', () => {
                indicator.style.display = 'block';
            });

            window.addEventListener('online', () => {
                indicator.style.display = 'none';
            });

            // åˆå§‹çŠ¶æ€
            if (!navigator.onLine) {
                indicator.style.display = 'block';
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆ›å»ºç¦»çº¿æŒ‡ç¤ºå™¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', createOfflineIndicator);
        } else {
            createOfflineIndicator();
        }

        // ===================== Firebase è¯Šæ–­å·¥å…· =====================

        // æ£€æŸ¥ Firebase çŠ¶æ€
        window.checkFirebaseStatus = function () {
            console.log('');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“Š Firebase çŠ¶æ€è¯Šæ–­æŠ¥å‘Š');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('');

            // 1. æ£€æŸ¥ SDK åŠ è½½
            console.log('1ï¸âƒ£ Firebase SDK åŠ è½½çŠ¶æ€:');
            if (typeof firebase === 'undefined') {
                console.log('   âŒ Firebase SDK æœªåŠ è½½');
                console.log('   ğŸ’¡ å¯èƒ½åŸå› : CDN è¢«é˜»æ­¢æˆ–ç½‘ç»œé—®é¢˜');
            } else {
                console.log('   âœ… Firebase SDK å·²åŠ è½½');
                console.log('   ğŸ“¦ ç‰ˆæœ¬:', firebase.SDK_VERSION || 'unknown');
            }
            console.log('');

            // 2. æ£€æŸ¥ CloudSync å®ä¾‹
            console.log('2ï¸âƒ£ CloudSync ç®¡ç†å™¨çŠ¶æ€:');
            if (typeof cloudSync === 'undefined' || cloudSync === null) {
                console.log('   âŒ CloudSync ç®¡ç†å™¨æœªåˆ›å»º');
            } else {
                console.log('   âœ… CloudSync ç®¡ç†å™¨å·²åˆ›å»º');
                console.log('   ğŸ“Š åˆå§‹åŒ–çŠ¶æ€:', cloudSync.isInitialized ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–');
                console.log('   ğŸ“Š åŒæ­¥è¿›è¡Œä¸­:', cloudSync._syncState?.inProgress ? 'æ˜¯' : 'å¦');
                console.log('   ğŸ“Š æœ€ååŒæ­¥æ—¶é—´:', cloudSync._syncState?.lastSyncTime || cloudSync.lastSyncTime || 'ä»æœªåŒæ­¥');
            }
            console.log('');

            // 3. æ£€æŸ¥æ•°æ®åº“è¿æ¥
            console.log('3ï¸âƒ£ æ•°æ®åº“è¿æ¥çŠ¶æ€:');
            if (cloudSync && cloudSync.isInitialized && cloudSync.db) {
                console.log('   âœ… æ•°æ®åº“å®ä¾‹å·²åˆ›å»º');
                console.log('   ğŸ”— æ•°æ®åº“ URL:', cloudSync.firebaseConfig.databaseURL);

                // å°è¯•æ£€æŸ¥è¿æ¥çŠ¶æ€
                cloudSync.db.ref('.info/connected').once('value')
                    .then(snapshot => {
                        if (snapshot.val() === true) {
                            console.log('   âœ… å®æ—¶è¿æ¥å·²å»ºç«‹');
                        } else {
                            console.log('   âš ï¸ è¿æ¥çŠ¶æ€æœªçŸ¥');
                        }
                    })
                    .catch(error => {
                        console.log('   âŒ è¿æ¥æ£€æŸ¥å¤±è´¥:', error.message);
                    });
            } else {
                console.log('   âŒ æ•°æ®åº“æœªåˆå§‹åŒ–');
            }
            console.log('');

            // 4. ç½‘ç»œçŠ¶æ€
            console.log('4ï¸âƒ£ ç½‘ç»œçŠ¶æ€:');
            console.log('   ğŸ“¶ åœ¨çº¿çŠ¶æ€:', navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿');
            console.log('');

            // 5. æœ¬åœ°å­˜å‚¨æ•°æ®
            console.log('5ï¸âƒ£ æœ¬åœ°å­˜å‚¨æ•°æ®:');
            console.log('   ğŸ“¦ äº§å“æ•°é‡:', products.length);
            console.log('   ğŸ‘¥ ç”¨æˆ·æ•°é‡:', allUsers.length);
            console.log('   ğŸ“ è®¢å•æ•°é‡:', userOrders.length);
            console.log('   ğŸ“ åœ°å€æ•°é‡:', userAddresses.length);
            console.log('');

            // 6. å½“å‰ç”¨æˆ·
            console.log('6ï¸âƒ£ å½“å‰ç”¨æˆ·:');
            if (currentUser) {
                console.log('   âœ… å·²ç™»å½•');
                console.log('   ğŸ‘¤ ç”¨æˆ·å:', currentUser.username);
                console.log('   ğŸ“§ é‚®ç®±:', currentUser.email);
            } else {
                console.log('   â„¹ï¸ æœªç™»å½•ï¼ˆæ¸¸å®¢æ¨¡å¼ï¼‰');
            }
            console.log('');

            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ’¡ æç¤º: å¦‚éœ€é‡æ–°åˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('');

            return {
                sdkLoaded: typeof firebase !== 'undefined',
                cloudSyncCreated: cloudSync !== null,
                cloudSyncInitialized: cloudSync?.isInitialized || false,
                online: navigator.onLine,
                currentUser: currentUser?.username || 'guest'
            };
        };

        // åœ¨æ§åˆ¶å°æ˜¾ç¤ºæç¤º
        console.log('');
        console.log('ğŸ’¡ ä½¿ç”¨ checkFirebaseStatus() æŸ¥çœ‹å®Œæ•´çš„ Firebase çŠ¶æ€');
        console.log('');

        // ===================== æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ =====================

        // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
        function checkDataIntegrity() {
            console.log('ğŸ” æ£€æŸ¥æ•°æ®å®Œæ•´æ€§...');

            // æ£€æŸ¥äº§å“æ•°æ®
            if (!Array.isArray(products)) {
                console.warn('âš ï¸ äº§å“æ•°æ®å¼‚å¸¸ï¼Œæ­£åœ¨ä¿®å¤...');
                products = [];
                // ä¸è‡ªåŠ¨åˆå§‹åŒ–æ¼”ç¤ºæ•°æ®ï¼Œä¿æŒç©ºæ•°ç»„
                localStorage.setItem('products', JSON.stringify(products));
            }

            // æ£€æŸ¥ç”¨æˆ·æ•°æ®
            if (!Array.isArray(allUsers)) {
                console.warn('âš ï¸ ç”¨æˆ·æ•°æ®å¼‚å¸¸ï¼Œæ­£åœ¨ä¿®å¤...');
                allUsers = [];
                initDefaultUsers();
            }

            // æ£€æŸ¥è®¢å•æ•°æ®
            if (!Array.isArray(userOrders)) {
                console.warn('âš ï¸ è®¢å•æ•°æ®å¼‚å¸¸ï¼Œæ­£åœ¨ä¿®å¤...');
                userOrders = [];
            }

            // æ£€æŸ¥åœ°å€æ•°æ®
            if (!Array.isArray(userAddresses)) {
                console.warn('âš ï¸ åœ°å€æ•°æ®å¼‚å¸¸ï¼Œæ­£åœ¨ä¿®å¤...');
                userAddresses = [];
            }

            console.log('âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ');
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ•°æ®å®Œæ•´æ€§æ£€æŸ¥
        window.addEventListener('load', () => {
            checkDataIntegrity();
        });

        // ===================== æ€§èƒ½ä¼˜åŒ–ï¼šæ‡’åŠ è½½å›¾ç‰‡ =====================

        // å›¾ç‰‡æ‡’åŠ è½½
        function lazyLoadImages() {
            const images = document.querySelectorAll('img[data-src]');

            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                });
            });

            images.forEach(img => imageObserver.observe(img));
        }

        // é¡µé¢åŠ è½½æ—¶å¯ç”¨æ‡’åŠ è½½
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', lazyLoadImages);
        } else {
            lazyLoadImages();
        }

        console.log('âœ… ç”µå•†å¹³å°ç³»ç»Ÿå·²å®Œå…¨åŠ è½½');
        console.log('ğŸ“Š åŠŸèƒ½æ¨¡å—ï¼š');
        console.log('  - ç”¨æˆ·è®¤è¯ç³»ç»Ÿ');
        console.log('  - äº§å“ç®¡ç†ç³»ç»Ÿ');
        console.log('  - è®¢å•ç®¡ç†ç³»ç»Ÿ');
        console.log('  - åå°ç®¡ç†ç³»ç»Ÿ');
        console.log('  - å®æ—¶æœç´¢ä¸ç­›é€‰');
        console.log('  - è´­ç‰©è½¦ç³»ç»Ÿ');
        console.log('  - æ”¶è´§åœ°å€ç®¡ç†');
        console.log('  - æ•°æ®ç»Ÿè®¡åˆ†æ');
        console.log('  - ä¸»é¡µè‡ªå®šä¹‰ç¼–è¾‘');
        console.log('  - Excelæ‰¹é‡å¯¼å…¥å¯¼å‡º');
        console.log('  - äº‘ç«¯æ•°æ®åŒæ­¥');
        console.log('  - ç¦»çº¿ç¼“å­˜æ”¯æŒ');
        console.log('  - å®æ—¶åœ¨çº¿å®¢æœ');

        // ===================== åˆå§‹åŒ–äº‘ç«¯åŒæ­¥ =====================

        // å»¶è¿Ÿåˆå§‹åŒ–äº‘ç«¯åŒæ­¥ï¼Œç¡®ä¿ Firebase SDK å·²å®Œå…¨åŠ è½½
        window.addEventListener('load', async () => {
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿æ‰€æœ‰å¤–éƒ¨è„šæœ¬éƒ½å·²åŠ è½½
            await new Promise(resolve => setTimeout(resolve, 1000));

            console.log('');
            console.log('ğŸš€ ========== åˆå§‹åŒ–äº‘ç«¯åŒæ­¥ ==========');
            console.log('');

            // æ£€æŸ¥ Firebase SDK æ˜¯å¦å·²åŠ è½½
            if (typeof firebase === 'undefined') {
                console.error('âŒ Firebase SDK æœªåŠ è½½ï¼Œè·³è¿‡äº‘ç«¯åŒæ­¥åˆå§‹åŒ–');
                console.log('ğŸ’¡ åº”ç”¨å°†ä»¥æœ¬åœ°æ¨¡å¼è¿è¡Œ');
                console.log('');
                return;
            }

            try {
                // åˆ›å»º CloudSyncManager å®ä¾‹
                console.log('ğŸ”§ åˆ›å»º CloudSyncManager å®ä¾‹...');
                cloudSync = new CloudSyncManager();
                window.cloudSync = cloudSync; // åŒæ—¶è®¾ç½®ä¸ºå…¨å±€å¯¹è±¡å±æ€§ï¼Œæ–¹ä¾¿è°ƒè¯•

                // åˆå§‹åŒ–äº‘ç«¯åŒæ­¥
                console.log('ğŸ”§ å¼€å§‹åˆå§‹åŒ–äº‘ç«¯åŒæ­¥...');
                await cloudSync.init();

                console.log('');
                console.log('âœ… äº‘ç«¯åŒæ­¥åˆå§‹åŒ–å®Œæˆï¼');
                console.log('');
                console.log('========================================');
                console.log('');
            } catch (error) {
                console.error('âŒ äº‘ç«¯åŒæ­¥åˆå§‹åŒ–å¤±è´¥:', error);
                console.log('ğŸ’¡ åº”ç”¨å°†ä»¥æœ¬åœ°æ¨¡å¼è¿è¡Œ');
                console.log('');
            }
        });

        // ========== Firebase è°ƒè¯•æ§åˆ¶å° ==========
        // åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤è¿›è¡Œè°ƒè¯•ï¼š

        // é‡æ–°åˆå§‹åŒ– Firebase
        window.reinitFirebase = async function () {
            console.log('');
            console.log('ğŸ”„ ========== æ‰‹åŠ¨é‡æ–°åˆå§‹åŒ– Firebase ==========');
            console.log('');

            if (cloudSync) {
                // æ¸…ç†æ—§çš„å®ä¾‹
                if (cloudSync.syncInterval) {
                    clearInterval(cloudSync.syncInterval);
                    console.log('ğŸ§¹ å·²æ¸…ç†å®šæœŸåŒæ­¥ä»»åŠ¡');
                }

                if (cloudSync.listeners && cloudSync.listeners.length > 0) {
                    cloudSync.listeners.forEach(listener => {
                        if (listener && typeof listener.off === 'function') {
                            listener.off();
                        }
                    });
                    cloudSync.listeners = [];
                    console.log('ğŸ§¹ å·²æ¸…ç†å®æ—¶ç›‘å¬å™¨');
                }

                cloudSync.isInitialized = false;
                console.log('âœ… æ—§å®ä¾‹å·²æ¸…ç†');
                console.log('');
            }

            // åˆ›å»ºæ–°å®ä¾‹å¹¶åˆå§‹åŒ–
            console.log('ğŸ”„ åˆ›å»ºæ–°çš„ CloudSyncManager å®ä¾‹...');
            cloudSync = new CloudSyncManager();
            window.cloudSync = cloudSync;

            console.log('ğŸ”„ å¼€å§‹åˆå§‹åŒ–...');
            await cloudSync.init();

            console.log('');
            console.log('========================================');
            console.log('');
        };

        // è¯Šæ–­é…ç½®
        window.diagnoseFirebase = function () {
            if (cloudSync) {
                return cloudSync.diagnoseConfiguration();
            } else {
                console.error('âŒ CloudSyncManager æœªåˆå§‹åŒ–');
                return null;
            }
        };

        // æµ‹è¯•è¿æ¥
        window.testFirebaseConnection = async function () {
            if (cloudSync && cloudSync.db) {
                try {
                    await cloudSync.testConnection();
                    console.log('âœ… è¿æ¥æµ‹è¯•å®Œæˆ');
                } catch (error) {
                    console.error('âŒ è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                }
            } else {
                console.error('âŒ Firebase æœªåˆå§‹åŒ–æˆ–æ•°æ®åº“å®ä¾‹ä¸å­˜åœ¨');
            }
        };

        // æ˜¾ç¤ºå½“å‰çŠ¶æ€
        window.showFirebaseStatus = function () {
            console.log('');
            console.log('ğŸ“Š ========== Firebase çŠ¶æ€ ==========');
            console.log('');
            console.log('SDK åŠ è½½çŠ¶æ€:', typeof firebase !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½');
            if (typeof firebase !== 'undefined') {
                console.log('SDK ç‰ˆæœ¬:', firebase.SDK_VERSION || 'unknown');
            }
            console.log('');
            console.log('CloudSyncManager:');
            console.log('  - å·²åˆå§‹åŒ–:', cloudSync?.isInitialized ? 'âœ… æ˜¯' : 'âŒ å¦');
            console.log('  - æ•°æ®åº“å®ä¾‹:', cloudSync?.db ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
            console.log('  - åŒæ­¥è¿›è¡Œä¸­:', cloudSync?._syncState?.inProgress ? 'æ˜¯' : 'å¦');
            console.log('  - ä¸Šæ¬¡åŒæ­¥:', cloudSync?._syncState?.lastSyncTime ? new Date(cloudSync._syncState.lastSyncTime).toLocaleString() : (cloudSync?.lastSyncTime ? new Date(cloudSync.lastSyncTime).toLocaleString() : 'ä»æœªåŒæ­¥'));
            console.log('  - ç›‘å¬å™¨æ•°é‡:', cloudSync?.listeners?.length || 0);
            console.log('');

            if (cloudSync?.firebaseConfig) {
                console.log('é…ç½®ä¿¡æ¯:');
                console.log('  - Project ID:', cloudSync.firebaseConfig.projectId);
                console.log('  - Database URL:', cloudSync.firebaseConfig.databaseURL);
                console.log('  - Auth Domain:', cloudSync.firebaseConfig.authDomain);
            }

            console.log('');
            console.log('====================================');
            console.log('');
        };

        // æ‰‹åŠ¨è§¦å‘åŒæ­¥
        window.manualSync = async function () {
            if (cloudSync && cloudSync.isInitialized) {
                console.log('ğŸ”„ æ‰‹åŠ¨è§¦å‘æ•°æ®åŒæ­¥...');
                try {
                    await cloudSync.syncAllData();
                    console.log('âœ… åŒæ­¥å®Œæˆ');
                } catch (error) {
                    console.error('âŒ åŒæ­¥å¤±è´¥:', error);
                }
            } else {
                console.error('âŒ Firebase æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŒæ­¥');
            }
        };

        // æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
        window.firebaseHelp = function () {
            console.log('');
            console.log('ğŸ”§ ========== Firebase è°ƒè¯•å·¥å…· ==========');
            console.log('');
            console.log('å¯ç”¨å‘½ä»¤ï¼š');
            console.log('');
            console.log('  reinitFirebase()           - é‡æ–°åˆå§‹åŒ– Firebase');
            console.log('  diagnoseFirebase()         - è¯Šæ–­é…ç½®é—®é¢˜');
            console.log('  testFirebaseConnection()   - æµ‹è¯•æ•°æ®åº“è¿æ¥');
            console.log('  showFirebaseStatus()       - æ˜¾ç¤ºå½“å‰çŠ¶æ€');
            console.log('  manualSync()               - æ‰‹åŠ¨è§¦å‘åŒæ­¥');
            console.log('  firebaseHelp()             - æ˜¾ç¤ºæ­¤å¸®åŠ©');
            console.log('');
            console.log('ç¤ºä¾‹ï¼š');
            console.log('  1. æ£€æŸ¥çŠ¶æ€:  showFirebaseStatus()');
            console.log('  2. è¯Šæ–­é…ç½®:  diagnoseFirebase()');
            console.log('  3. æµ‹è¯•è¿æ¥:  testFirebaseConnection()');
            console.log('  4. é‡æ–°åˆå§‹åŒ–: reinitFirebase()');
            console.log('');
            console.log('========================================');
            console.log('');
        };

        // å¯åŠ¨æ—¶æ˜¾ç¤ºè°ƒè¯•æç¤ºï¼ˆä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼‰
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('');
            console.log('ğŸ’¡ Firebase è°ƒè¯•å·¥å…·å·²åŠ è½½ï¼');
            console.log('   è¾“å…¥ firebaseHelp() æŸ¥çœ‹å¯ç”¨å‘½ä»¤');
            console.log('');
        }
    </script>

    <!-- é€šç”¨æ¶ˆæ¯æ¨¡æ€æ¡†ï¼ˆæ›¿ä»£alertå’Œconfirmï¼‰ -->
    <div class="modal" id="message-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" id="message-modal-header">
                <h3 id="message-modal-title">æç¤º</h3>
                <button class="close-modal" onclick="closeMessageModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <p id="message-modal-text" style="margin: 0; color: var(--dark); font-size: 16px; line-height: 1.6;"></p>
            </div>
            <div class="modal-footer" id="message-modal-footer" style="padding: 15px 20px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid var(--border-subtle);">
                <button class="btn btn-secondary" id="message-modal-cancel" onclick="closeMessageModal()" style="display: none;">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="message-modal-confirm" onclick="confirmMessageModal()" style="display: none;">ç¡®å®š</button>
                <button class="btn btn-primary" id="message-modal-ok" onclick="closeMessageModal()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- è½®æ’­å›¾ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="carousel-edit-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="carousel-edit-title">æ·»åŠ è½®æ’­å›¾</h3>
                <button class="close-modal" onclick="closeCarouselEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="carousel-edit-form">
                    <div class="form-group">
                        <label for="carousel-title-input">è½®æ’­å›¾æ ‡é¢˜</label>
                        <input type="text" id="carousel-title-input" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="carousel-description-input">è½®æ’­å›¾æè¿°</label>
                        <textarea id="carousel-description-input" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="carousel-button-text-input">æŒ‰é’®æ–‡å­—</label>
                        <input type="text" id="carousel-button-text-input" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="carousel-image-input">å›¾ç‰‡URL</label>
                        <input type="url" id="carousel-image-input" class="form-control" required>
                        <small style="color: var(--gray); font-size: 12px; margin-top: 5px; display: block;">è¯·è¾“å…¥å®Œæ•´çš„å›¾ç‰‡URLåœ°å€</small>
                    </div>
                    <div class="form-group" id="carousel-preview-group" style="display: none;">
                        <label>å›¾ç‰‡é¢„è§ˆ</label>
                        <div style="width: 100%; height: 200px; border: 1px solid var(--border-subtle); border-radius: 2px; overflow: hidden; background: var(--light); display: flex; align-items: center; justify-content: center;">
                            <img id="carousel-preview-img" src="" alt="é¢„è§ˆ" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 15px 20px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid var(--border-subtle);">
                <button class="btn btn-secondary" onclick="closeCarouselEditModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveCarouselItem()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- äº§å“æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="product-edit-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="product-edit-title">æ·»åŠ äº§å“</h3>
                <button class="close-modal" onclick="closeProductEditModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="product-edit-form">
                    <div class="form-group">
                        <label for="product-name-input">äº§å“åç§° <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="product-name-input" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="product-price-input">äº§å“ä»·æ ¼ <span style="color: var(--danger);">*</span></label>
                        <input type="number" id="product-price-input" class="form-control" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-stock-input">äº§å“åº“å­˜</label>
                        <input type="number" id="product-stock-input" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="product-category-input">äº§å“åˆ†ç±»</label>
                        <select id="product-category-input" class="form-control">
                            <option value="electronics">Electronics</option>
                            <option value="home">Home & Living</option>
                            <option value="clothing">Clothing & Shoes</option>
                            <option value="beauty">Beauty & Skincare</option>
                            <option value="sports">Sports & Outdoors</option>
                            <option value="other" selected>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>äº§å“å›¾ç‰‡URLï¼ˆæœ€å¤š6å¼ ï¼‰ <span style="color: var(--danger);">*</span></label>
                        <div class="product-image-inputs">
                            <input type="url" id="product-image-input-1" class="form-control product-image-url-input" placeholder="å›¾ç‰‡URL 1ï¼ˆå¿…å¡«ï¼‰" required>
                            <input type="url" id="product-image-input-2" class="form-control product-image-url-input" placeholder="å›¾ç‰‡URL 2ï¼ˆå¯é€‰ï¼‰">
                            <input type="url" id="product-image-input-3" class="form-control product-image-url-input" placeholder="å›¾ç‰‡URL 3ï¼ˆå¯é€‰ï¼‰">
                            <input type="url" id="product-image-input-4" class="form-control product-image-url-input" placeholder="å›¾ç‰‡URL 4ï¼ˆå¯é€‰ï¼‰">
                            <input type="url" id="product-image-input-5" class="form-control product-image-url-input" placeholder="å›¾ç‰‡URL 5ï¼ˆå¯é€‰ï¼‰">
                            <input type="url" id="product-image-input-6" class="form-control product-image-url-input" placeholder="å›¾ç‰‡URL 6ï¼ˆå¯é€‰ï¼‰">
                        </div>
                        <small style="color: var(--gray); font-size: 12px; margin-top: 5px; display: block;">ç¬¬ä¸€å¼ å›¾ç‰‡å°†ä½œä¸ºå°é¢å±•ç¤ºï¼Œæ”¯æŒæœ€å¤š6å¼ å›¾ç‰‡URL</small>
                    </div>
                    <div class="form-group" id="product-preview-group" style="display: none;">
                        <label>å›¾ç‰‡é¢„è§ˆ</label>
                        <div style="width: 100%; height: 200px; border: 1px solid var(--border-subtle); border-radius: 2px; overflow: hidden; background: var(--light); display: flex; align-items: center; justify-content: center;">
                            <img id="product-preview-img" src="" alt="é¢„è§ˆ" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="product-description-input">äº§å“æè¿°</label>
                        <textarea id="product-description-input" class="form-control" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 15px 20px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid var(--border-subtle);">
                <button class="btn btn-secondary" onclick="closeProductEditModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveProductItem()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ========== é€šç”¨æ¶ˆæ¯æ¨¡æ€æ¡†å‡½æ•°ï¼ˆæ›¿ä»£alertå’Œconfirmï¼‰ ==========
        let messageModalCallback = null;
        let messageModalType = 'alert'; // 'alert' æˆ– 'confirm'

        // ç®€æ˜“ç¿»è¯‘æ˜ å°„ï¼ˆç”¨äºå…œåº•å°†å¸¸è§ä¸­æ–‡æç¤ºç¿»ä¸ºè‹±æ–‡ï¼‰
        const INLINE_CN_EN_MAP = {
            'ç½‘ç»œå·²è¿æ¥': 'Network connected',
            'æ‚¨å·²ç¦»çº¿ï¼Œæ•°æ®å°†è¢«ç¼“å­˜': 'You are offline. Data will be cached',
            'æ­£åœ¨åŒæ­¥æ•°æ®...': 'Syncing data...',
            'æˆåŠŸåŒæ­¥': 'Sync successful',
            'ç¼“å­˜å·²æ¸…é™¤': 'Cache cleared',
            'è¯·å…ˆç™»å½•': 'Please login first',
            'æƒé™ä¸è¶³': 'Insufficient permissions',
            'è´¦å·è¢«ç¦ç”¨': 'Account disabled',
            'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•': 'Login failed, please try again later',
            'æ³¨å†ŒæˆåŠŸï¼': 'Registration successful!',
            'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•': 'Registration failed, please try again later',
            'è¯·è¾“å…¥è´¦å·': 'Please enter account',
            'è´¦å·é•¿åº¦è‡³å°‘ä¸º3ä¸ªå­—ç¬¦': 'Account must be at least 3 characters',
            'è¯·è¾“å…¥å¯†ç ': 'Please enter password',
            'è¯·ç¡®è®¤å¯†ç ': 'Please confirm password',
            'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦': 'Password must be at least 6 characters',
            'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥': 'The two passwords do not match, please re-enter',
            'äº§å“åç§°ä¸èƒ½ä¸ºç©º': 'Product name cannot be empty',
            'è¯·è¾“å…¥æœ‰æ•ˆçš„äº§å“ä»·æ ¼': 'Please enter a valid price',
            'è¯·è‡³å°‘è¾“å…¥ä¸€å¼ äº§å“å›¾ç‰‡URL': 'Please enter at least one product image URL',
            'äº§å“å·²æ›´æ–°': 'Product updated',
            'äº§å“æ·»åŠ æˆåŠŸï¼': 'Product added successfully!',
            'äº§å“æ·»åŠ å¤±è´¥': 'Failed to add product',
            'ç”¨æˆ·ä¸å­˜åœ¨': 'User not found',
            'ç”¨æˆ·æ•°æ®å·²é‡ç½®': 'User data has been reset',
            'ç”¨æˆ·å·²ç¦ç”¨': 'User has been disabled',
            'ç”¨æˆ·å·²è§£ç¦': 'User has been unbanned',
            'è®¢å•å·²åˆ é™¤': 'Order deleted',
            'è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„è®¢å•': 'Please select orders to delete first'
        };
        function translateInline(msg){
            if (!msg || currentLanguage !== 'en') return msg;
            return INLINE_CN_EN_MAP[msg] || msg;
        }

        function showMessageModal(title, message, type = 'alert', callback = null) {
            const modal = document.getElementById('message-modal');
            const titleEl = document.getElementById('message-modal-title');
            const textEl = document.getElementById('message-modal-text');
            const headerEl = document.getElementById('message-modal-header');
            const okBtn = document.getElementById('message-modal-ok');
            const confirmBtn = document.getElementById('message-modal-confirm');
            const cancelBtn = document.getElementById('message-modal-cancel');

            // æ ‡é¢˜ä¸æ¶ˆæ¯ç»Ÿä¸€å›½é™…åŒ–
            const titleMap = { 'é”™è¯¯': (t('errorTitle')||'Error'), 'æˆåŠŸ': (t('successTitle')||'Success'), 'æç¤º': (t('infoTitle')||'Notice'), 'ç¡®è®¤': (t('confirmTitle')||'Confirm'), 'ç³»ç»Ÿé”™è¯¯': (t('errorTitle')||'Error')};
            const finalTitle = titleMap[title] || title || (t('infoTitle') || 'Notice');
            titleEl.textContent = finalTitle;
            // æ”¯æŒ HTML å†…å®¹ï¼ˆå¦‚æœ message åŒ…å« HTML æ ‡ç­¾åˆ™ä½¿ç”¨ innerHTMLï¼Œå¦åˆ™ä½¿ç”¨ textContentï¼‰
            if (typeof message === 'string' && (message.includes('<') && message.includes('>'))) {
                textEl.innerHTML = translateInline(message);
            } else {
                textEl.textContent = translateInline(message);
            }
            messageModalType = type;
            messageModalCallback = callback;

            // æ›´æ–°æŒ‰é’®æ–‡æ¡ˆ
            okBtn.textContent = (t('ok') || 'OK');
            confirmBtn.textContent = (t('confirm') || 'Confirm');
            cancelBtn.textContent = (t('cancel') || 'Cancel');

            if (type === 'confirm') {
                okBtn.style.display = 'none';
                confirmBtn.style.display = 'inline-flex';
                cancelBtn.style.display = 'inline-flex';
                headerEl.style.background = 'var(--primary)';
            } else {
                okBtn.style.display = 'inline-flex';
                confirmBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                headerEl.style.background = 'var(--primary)';
            }

            modal.style.display = 'flex';
        }

        function closeMessageModal() {
            const modal = document.getElementById('message-modal');
            modal.style.display = 'none';
            if (messageModalCallback && messageModalType === 'confirm') {
                messageModalCallback(false);
            }
            messageModalCallback = null;
        }

        function confirmMessageModal() {
            const modal = document.getElementById('message-modal');
            modal.style.display = 'none';
            if (messageModalCallback) {
                messageModalCallback(true);
            }
            messageModalCallback = null;
        }

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        document.getElementById('message-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMessageModal();
            }
        });

            // æ›¿ä»£alertå‡½æ•°ï¼ˆæ”¯æŒå¤šè¯­è¨€æ ‡é¢˜ï¼‰
            function customAlert(message, title) {
                const finalTitle = title || (typeof t === 'function' ? t('infoTitle') : 'Info');
            return new Promise((resolve) => {
                    showMessageModal(finalTitle, message, 'alert', () => resolve());
            });
        }

        // æ›¿ä»£confirmå‡½æ•°
            function customConfirm(message, title) {
                const finalTitle = title || (typeof t === 'function' ? t('confirmTitle') : 'Confirm');
            return new Promise((resolve) => {
                    showMessageModal(finalTitle, message, 'confirm', (result) => resolve(result));
            });
        }

        // ========== è½®æ’­å›¾ç¼–è¾‘æ¨¡æ€æ¡†å‡½æ•° ==========
        let currentCarouselEditData = { id: null, type: 'desktop', isEdit: false };

        function openCarouselEditModal(type = 'desktop', item = null) {
            const modal = document.getElementById('carousel-edit-modal');
            const titleEl = document.getElementById('carousel-edit-title');
            const form = document.getElementById('carousel-edit-form');

            currentCarouselEditData.type = type;
            currentCarouselEditData.isEdit = !!item;
            currentCarouselEditData.id = item ? item.id : null;

            if (item) {
                titleEl.textContent = `ç¼–è¾‘${type === 'mobile' ? 'ç§»åŠ¨ç«¯' : 'PCç«¯'}è½®æ’­å›¾`;
                document.getElementById('carousel-title-input').value = item.title || '';
                document.getElementById('carousel-description-input').value = item.description || '';
                document.getElementById('carousel-button-text-input').value = item.buttonText || '';
                document.getElementById('carousel-image-input').value = item.image || '';
                updateCarouselPreview(item.image);
            } else {
                titleEl.textContent = `æ·»åŠ ${type === 'mobile' ? 'ç§»åŠ¨ç«¯' : 'PCç«¯'}è½®æ’­å›¾`;
                form.reset();
                document.getElementById('carousel-preview-group').style.display = 'none';
            }

            modal.style.display = 'flex';
        }

        function closeCarouselEditModal() {
            const modal = document.getElementById('carousel-edit-modal');
            modal.style.display = 'none';
            document.getElementById('carousel-edit-form').reset();
            document.getElementById('carousel-preview-group').style.display = 'none';
            currentCarouselEditData = { id: null, type: 'desktop', isEdit: false };
        }

        function saveCarouselItem() {
            const title = document.getElementById('carousel-title-input').value.trim();
            const description = document.getElementById('carousel-description-input').value.trim();
            const buttonText = document.getElementById('carousel-button-text-input').value.trim();
            const image = document.getElementById('carousel-image-input').value.trim();

            if (!title || !description || !buttonText || !image) {
                showMessageModal(t('errorTitle'), t('pleaseFillAllRequiredFields'), 'alert');
                return;
            }

            if (currentCarouselEditData.isEdit && currentCarouselEditData.id) {
                // ç¼–è¾‘æ¨¡å¼
                const collection = currentCarouselEditData.type === 'mobile'
                    ? (homepageSettings.mobileCarousel || [])
                    : (homepageSettings.desktopCarousel || []);
                const item = collection.find(c => c.id === currentCarouselEditData.id);
                if (item) {
                    item.title = title;
                    item.description = description;
                    item.buttonText = buttonText;
                    item.image = image;
                    saveHomepageSettings();
                    renderCarouselList(currentCarouselEditData.type);
                    showMessageModal(t('successTitle'), t('carouselUpdated'), 'alert');
                    closeCarouselEditModal();
                }
            } else {
                // æ·»åŠ æ¨¡å¼
                const newItem = {
                    id: Date.now(),
                    title,
                    description,
                    buttonText,
                    image,
                    active: true
                };

                if (currentCarouselEditData.type === 'mobile') {
                    if (!Array.isArray(homepageSettings.mobileCarousel)) {
                        homepageSettings.mobileCarousel = [];
                    }
                    homepageSettings.mobileCarousel.push(newItem);
                } else {
                    if (!Array.isArray(homepageSettings.desktopCarousel)) {
                        homepageSettings.desktopCarousel = [];
                    }
                    homepageSettings.desktopCarousel.push(newItem);
                }
                saveHomepageSettings();
                renderCarouselList(currentCarouselEditData.type);
                showMessageModal(t('successTitle'), currentCarouselEditData.type === 'mobile' ? t('mobileCarouselAdded') : t('pcCarouselAdded'), 'alert');
                closeCarouselEditModal();
            }
        }

        function updateCarouselPreview(imageUrl) {
            const previewGroup = document.getElementById('carousel-preview-group');
            const previewImg = document.getElementById('carousel-preview-img');
            if (imageUrl) {
                previewImg.src = imageUrl;
                previewGroup.style.display = 'block';
                previewImg.onerror = function() {
                    previewImg.src = '';
                    previewImg.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                };
            } else {
                previewGroup.style.display = 'none';
            }
        }

        // å›¾ç‰‡URLè¾“å…¥æ—¶æ›´æ–°é¢„è§ˆ
        document.getElementById('carousel-image-input').addEventListener('input', function() {
            updateCarouselPreview(this.value);
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        document.getElementById('carousel-edit-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCarouselEditModal();
            }
        });

        // ========== äº§å“ç¼–è¾‘æ¨¡æ€æ¡†å‡½æ•° ==========
        let currentProductEditData = { id: null, isEdit: false };

        function openProductEditModal(product = null) {
            const modal = document.getElementById('product-edit-modal');
            const titleEl = document.getElementById('product-edit-title');
            const form = document.getElementById('product-edit-form');

            currentProductEditData.isEdit = !!product;
            currentProductEditData.id = product ? product.id : null;

            const imageInputs = document.querySelectorAll('.product-image-url-input');

            if (product) {
                titleEl.textContent = 'ç¼–è¾‘äº§å“';
                document.getElementById('product-name-input').value = product.name || '';
                document.getElementById('product-price-input').value = product.price || '';
                document.getElementById('product-stock-input').value = product.stock || 0;
                document.getElementById('product-category-input').value = product.category || 'other';
                document.getElementById('product-description-input').value = product.description || '';

                const storedImages = Array.isArray(product.imageUrls) && product.imageUrls.length
                    ? product.imageUrls
                    : (product.image ? [product.image] : []);

                imageInputs.forEach((input, index) => {
                    input.value = storedImages[index] || '';
                });

                updateProductPreview(storedImages[0] || '');
            } else {
                titleEl.textContent = 'æ·»åŠ äº§å“';
                form.reset();
                document.getElementById('product-preview-group').style.display = 'none';
                imageInputs.forEach(input => input.value = '');
            }

            modal.style.display = 'flex';
        }

        function closeProductEditModal() {
            const modal = document.getElementById('product-edit-modal');
            modal.style.display = 'none';
            document.getElementById('product-edit-form').reset();
            document.getElementById('product-preview-group').style.display = 'none';
            currentProductEditData = { id: null, isEdit: false };
        }

        function saveProductItem() {
            const name = document.getElementById('product-name-input').value.trim();
            const priceInput = document.getElementById('product-price-input').value;
            const stockInput = document.getElementById('product-stock-input').value;
            const category = document.getElementById('product-category-input').value;
            const imageInputs = Array.from(document.querySelectorAll('.product-image-url-input'));
            const imageUrls = imageInputs
                .map(input => input.value.trim())
                .filter(url => !!url)
                .slice(0, 6);
            const description = document.getElementById('product-description-input').value.trim();

            if (!name) {
                showMessageModal(t('errorTitle'), t('pleaseEnterProductName'), 'alert');
                return;
            }

            const price = parseFloat(priceInput);
            if (!priceInput || isNaN(price) || price <= 0) {
                showMessageModal(t('errorTitle'), t('pleaseEnterValidPrice'), 'alert');
                return;
            }

            if (imageUrls.length === 0) {
                showMessageModal(t('errorTitle'), t('pleaseEnterAtLeastOneImage'), 'alert');
                return;
            }

            const stock = parseInt(stockInput) || 0;

            if (currentProductEditData.isEdit && currentProductEditData.id) {
                // ç¼–è¾‘æ¨¡å¼ - éœ€è¦æ‰¾åˆ°äº§å“å¹¶æ›´æ–°
                const product = products.find(p => p.id == currentProductEditData.id);
                if (product) {
                    product.name = name;
                    product.price = price;
                    product.stock = stock;
                    product.category = category;
                    product.image = imageUrls[0];
                    product.imageUrls = imageUrls;
                    for (let i = 1; i <= 6; i++) {
                        product[`imageUrl${i}`] = imageUrls[i - 1] || '';
                    }
                    product.description = description;
                    saveProducts().then(() => {
                        renderAdminProducts();
                        renderProducts(products);
                        showMessageModal(t('successTitle'), t('productUpdated'), 'alert');
                        closeProductEditModal();
                    }).catch(err => {
                        showMessageModal(t('errorTitle'), t('productUpdateFailedError'), 'alert');
                    });
                }
            } else {
                // æ·»åŠ æ¨¡å¼
                let newId = 1;
                if (products.length > 0) {
                    const existingIds = products.map(p => parseInt(p.id) || 0);
                    const maxId = Math.max(...existingIds);
                    newId = maxId + 1;
                }

                const product = {
                    id: newId,
                    name,
                    price,
                    newPrice: 0,
                    stock: stock < 0 ? 0 : stock,
                    category,
                    image: imageUrls[0],
                    imageUrls,
                    description
                };

                for (let i = 1; i <= 6; i++) {
                    product[`imageUrl${i}`] = imageUrls[i - 1] || '';
                }

                products.push(product);
                saveProducts().then((saveResult) => {
                    if (saveResult) {
                        renderAdminProducts();
                        renderProducts(products);
                        showMessageModal(t('successTitle'), t('productAddedSuccess').replace('{id}', product.id), 'alert');
                        closeProductEditModal();
                    } else {
                        showMessageModal(t('errorTitle'), t('productAddFailedError'), 'alert');
                    }
                }).catch(err => {
                    showMessageModal(t('errorTitle'), t('productAddFailedError'), 'alert');
                });
            }
        }

        function updateProductPreview(imageUrl) {
            const previewGroup = document.getElementById('product-preview-group');
            const previewImg = document.getElementById('product-preview-img');
            if (imageUrl) {
                previewImg.src = imageUrl;
                previewGroup.style.display = 'block';
                previewImg.onerror = function() {
                    previewImg.src = '';
                    previewImg.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                };
            } else {
                previewGroup.style.display = 'none';
            }
        }

        // å›¾ç‰‡URLè¾“å…¥æ—¶æ›´æ–°é¢„è§ˆ
        const productCoverInput = document.getElementById('product-image-input-1');
        if (productCoverInput) {
            productCoverInput.addEventListener('input', function() {
            updateProductPreview(this.value);
            });
        }

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        document.getElementById('product-edit-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProductEditModal();
            }
        });
    </script>
</body>

</html>
